{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/lionelyu/Documents/New%20Version/piano-studio-prototype/app/api/webhooks/stripe/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport Stripe from 'stripe'\nimport { createClient } from '@supabase/supabase-js'\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!)\n\n// Create admin client for database updates (bypasses RLS)\nconst supabaseAdmin = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_KEY!,\n    {\n        auth: {\n            autoRefreshToken: false,\n            persistSession: false\n        }\n    }\n)\n\nexport async function POST(request: Request) {\n    const body = await request.text()\n    const signature = request.headers.get('stripe-signature')\n\n    if (!signature) {\n        return NextResponse.json({ error: 'No signature' }, { status: 400 })\n    }\n\n    let event: Stripe.Event\n\n    try {\n        event = stripe.webhooks.constructEvent(\n            body,\n            signature,\n            process.env.STRIPE_WEBHOOK_SECRET!\n        )\n    } catch (err) {\n        console.error('Webhook signature verification failed:', err)\n        return NextResponse.json({ error: 'Invalid signature' }, { status: 400 })\n    }\n\n    // Handle the event\n    if (event.type === 'checkout.session.completed') {\n        const session = event.data.object as Stripe.Checkout.Session\n\n        const userId = session.metadata?.userId\n        const creditAmount = parseInt(session.metadata?.creditAmount || '0', 10)\n\n        if (!userId || creditAmount <= 0) {\n            console.error('Missing metadata:', { userId, creditAmount })\n            return NextResponse.json({ error: 'Missing metadata' }, { status: 400 })\n        }\n\n        console.log(`Processing credit purchase: ${creditAmount} credits for user ${userId}`)\n\n        try {\n            // Get current credits\n            const { data: profile, error: fetchError } = await supabaseAdmin\n                .from('profiles')\n                .select('credits, credits_total')\n                .eq('id', userId)\n                .single()\n\n            if (fetchError) {\n                console.error('Error fetching profile:', fetchError)\n                return NextResponse.json({ error: 'User not found' }, { status: 404 })\n            }\n\n            const currentCredits = profile?.credits || 0\n            const currentTotal = profile?.credits_total || 0\n\n            // Update credits\n            const { error: updateError } = await supabaseAdmin\n                .from('profiles')\n                .update({\n                    credits: currentCredits + creditAmount,\n                    credits_total: currentTotal + creditAmount,\n                })\n                .eq('id', userId)\n\n            if (updateError) {\n                console.error('Error updating credits:', updateError)\n                return NextResponse.json({ error: 'Failed to update credits' }, { status: 500 })\n            }\n\n            console.log(`Successfully added ${creditAmount} credits to user ${userId}`)\n        } catch (error) {\n            console.error('Webhook processing error:', error)\n            return NextResponse.json({ error: 'Processing error' }, { status: 500 })\n        }\n    }\n\n    return NextResponse.json({ received: true })\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,SAAS,IAAI,0PAAM,CAAC,QAAQ,GAAG,CAAC,iBAAiB;AAEvD,0DAA0D;AAC1D,MAAM,gBAAgB,IAAA,mQAAY,gFAE9B,QAAQ,GAAG,CAAC,oBAAoB,EAChC;IACI,MAAM;QACF,kBAAkB;QAClB,gBAAgB;IACpB;AACJ;AAGG,eAAe,KAAK,OAAgB;IACvC,MAAM,OAAO,MAAM,QAAQ,IAAI;IAC/B,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;IAEtC,IAAI,CAAC,WAAW;QACZ,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACtE;IAEA,IAAI;IAEJ,IAAI;QACA,QAAQ,OAAO,QAAQ,CAAC,cAAc,CAClC,MACA,WACA,QAAQ,GAAG,CAAC,qBAAqB;IAEzC,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,0CAA0C;QACxD,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;IAC3E;IAEA,mBAAmB;IACnB,IAAI,MAAM,IAAI,KAAK,8BAA8B;QAC7C,MAAM,UAAU,MAAM,IAAI,CAAC,MAAM;QAEjC,MAAM,SAAS,QAAQ,QAAQ,EAAE;QACjC,MAAM,eAAe,SAAS,QAAQ,QAAQ,EAAE,gBAAgB,KAAK;QAErE,IAAI,CAAC,UAAU,gBAAgB,GAAG;YAC9B,QAAQ,KAAK,CAAC,qBAAqB;gBAAE;gBAAQ;YAAa;YAC1D,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,QAAQ,GAAG,CAAC,CAAC,4BAA4B,EAAE,aAAa,kBAAkB,EAAE,QAAQ;QAEpF,IAAI;YACA,sBAAsB;YACtB,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,cAC9C,IAAI,CAAC,YACL,MAAM,CAAC,0BACP,EAAE,CAAC,MAAM,QACT,MAAM;YAEX,IAAI,YAAY;gBACZ,QAAQ,KAAK,CAAC,2BAA2B;gBACzC,OAAO,+QAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAiB,GAAG;oBAAE,QAAQ;gBAAI;YACxE;YAEA,MAAM,iBAAiB,SAAS,WAAW;YAC3C,MAAM,eAAe,SAAS,iBAAiB;YAE/C,iBAAiB;YACjB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,cAChC,IAAI,CAAC,YACL,MAAM,CAAC;gBACJ,SAAS,iBAAiB;gBAC1B,eAAe,eAAe;YAClC,GACC,EAAE,CAAC,MAAM;YAEd,IAAI,aAAa;gBACb,QAAQ,KAAK,CAAC,2BAA2B;gBACzC,OAAO,+QAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAA2B,GAAG;oBAAE,QAAQ;gBAAI;YAClF;YAEA,QAAQ,GAAG,CAAC,CAAC,mBAAmB,EAAE,aAAa,iBAAiB,EAAE,QAAQ;QAC9E,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,6BAA6B;YAC3C,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;IACJ;IAEA,OAAO,+QAAY,CAAC,IAAI,CAAC;QAAE,UAAU;IAAK;AAC9C"}}]
}