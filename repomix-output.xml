This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: tsconfig.tsbuildinfo, _backup/**, piano_backup.sql, pnpm-lock.yaml, public/**, .next/**, node_modules/**, _temp/**, .DS_Store, .cursorrules, components/ui/**, supabase/migrations/**, supabase/.branches/**, supabase/.temp/**, supabase/snippets/**, hooks/**, lib/utils.ts, repomix-output.xml, components.json, tailwind.config.ts, postcss.config.mjs, next.config.ts, tsconfig.json
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/
  workflows/
    cron.yml
app/
  actions/
    announcements.ts
    billing.ts
    events.ts
    inquiries.ts
    lessons.ts
    makeup-slots.ts
    notifications.ts
    pricing.ts
    reminders.ts
    resources.ts
    reviews.ts
    site-editor.ts
    stripe.ts
    student-history.ts
    uploads.ts
    users.ts
  admin/
    editor2/
      page.tsx
    events/
      page.tsx
    library/
      page.tsx
    logs/
      page.tsx
    reviews/
      page.tsx
    actions.ts
    page.tsx
  api/
    cron/
      process-recordings/
        route.ts
      reminders/
        route.ts
    webhooks/
      lesson-recording/
        route.ts
      stripe/
        route.ts
  auth/
    callback/
      route.ts
  contact/
    page.tsx
  forgot-password/
    page.tsx
  login/
    actions.ts
    page.tsx
  messages/
    actions.ts
  reset-password/
    page.tsx
  reviews/
    page.tsx
    star-rating.tsx
    submit-review.tsx
  student/
    page.tsx
  globals.css
  icon.png
  layout.tsx
  page.tsx
components/
  admin/
    add-student-modal.tsx
    admin-chat.tsx
    admin-dashboard.tsx
    announcement-modal.tsx
    announcement-tab.tsx
    charge-student-modal.tsx
    completed-tab.tsx
    create-event-modal.tsx
    dashboard-tab.tsx
    edit-student-modal.tsx
    inquiries-tab.tsx
    lesson-detail-modal.tsx
    library-file-selector.tsx
    library-manager.tsx
    master-calendar.tsx
    pricing-manager.tsx
    roster-tab.tsx
    scheduled-tab.tsx
    student-profile-sheet.tsx
  auth/
    login-form.tsx
  emails/
    lesson-canceled-email.tsx
    lesson-logged-email.tsx
    lesson-rescheduled-email.tsx
    lesson-scheduled-email.tsx
    LessonReminderEmail.tsx
    message-notification.tsx
    payment-confirmation-email.tsx
  student/
    cancellation-modal.tsx
    chat-widget.tsx
    event-signup-modal.tsx
    makeup-scheduler.tsx
    messages-panel.tsx
    purchase-credits-modal.tsx
    student-dashboard.tsx
  chat-attachment-preview.tsx
  dynamic-landing-page.tsx
  inquiry-form.tsx
  inquiry-modal.tsx
  local-timestamp.tsx
  profile-settings-dialog.tsx
  static-landing-page.tsx
  theme-provider.tsx
  video-player.tsx
lib/
  supabase/
    client.ts
    database.types.ts
    middleware.ts
    server.ts
  google-calendar.ts
  logger.ts
  mock-data.ts
  zoom.ts
scripts/
  fix_resource_urls.ts
  seed.ts
styles/
  globals.css
supabase/
  alter_announcements_v2.sql
  create_announcements.sql
  schema.sql
types/
  admin.ts
.env.local.example
.gitignore
middleware.ts
next-env.d.ts
next.config.mjs
package.json
repomix.config.json
vercel.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/actions/events.ts">
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { createZoomMeeting } from '@/lib/zoom'

// ==========================================
// Types matching v0 UI expectations
// ==========================================

export type EventInvite = {
    student_id: string
    student_name: string
    status: "pending" | "going" | "declined"
    responded_at?: string
    student_notes?: string | null // Added to support notes
}

export type AdminEvent = {
    id: string
    title: string
    description: string
    date: string
    start_time: string
    duration_minutes: number
    location_type: "virtual" | "physical"
    location_address?: string
    zoom_link?: string
    rsvp_deadline: string
    invites: EventInvite[]
    created_at: string
}

export type CreateEventInput = {
    title: string
    description: string
    date: string
    start_time: string
    duration_minutes: number
    location_type: "virtual" | "physical"
    location_address?: string
    rsvp_deadline: string
    invited_student_ids: string[]
}

// Type for Student Dashboard (superset or compatible)
export interface StudentEvent extends Omit<AdminEvent, 'invites'> {
    invite_status: 'pending' | 'going' | 'not_going'
    student_notes: string | null
}

// ==========================================
// Server Actions
// ==========================================

/**
 * getAdminEvents
 * Fetches all events with invite details.
 * Returns a flat array of AdminEvent.
 */
export async function getAdminEvents(): Promise<AdminEvent[]> {
    const supabase = await createClient()

    // Fetch events with invites and student profiles
    const { data: events, error } = await supabase
        .from('events')
        .select(`
      *,
      event_invites (
        student_id,
        status,
        updated_at,
        student_notes,
        profiles (
          name
        )
      )
    `)
        .order('start_time', { ascending: false })

    if (error) {
        console.error('Error fetching admin events:', error)
        return []
    }

    // Fetch current user details to get Timezone
    const { data: { user } } = await supabase.auth.getUser()
    let timezone = 'America/Los_Angeles' // Default

    if (user) {
        const { data: profile } = await supabase
            .from('profiles')
            .select('timezone')
            .eq('id', user.id)
            .single()
        if (profile?.timezone) {
            timezone = profile.timezone
        }
        console.log(`[getAdminEvents] User: ${user.email}, Timezone: ${timezone}`)
    }

    // Transform to AdminEvent shape
    return events.map((event: any) => {
        const invites: EventInvite[] = event.event_invites.map((invite: any) => ({
            student_id: invite.student_id,
            student_name: invite.profiles?.name || 'Unknown',
            status: invite.status,
            responded_at: invite.updated_at,
            student_notes: invite.student_notes
        }))

        // Extract date and time from ISO start_time
        const startDateTime = new Date(event.start_time)
        const dateStr = startDateTime.toISOString().split('T')[0]
        const timeStr = startDateTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })

        // Handle RSVP Deadline (stored as ISO presumably)
        let rsvpStr = ''
        if (event.rsvp_deadline) {
            const rsvpDate = new Date(event.rsvp_deadline)
            rsvpStr = rsvpDate.toLocaleDateString('en-CA', {
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            })
        }

        return {
            id: event.id,
            title: event.title,
            description: event.description || '',
            date: dateStr,
            start_time: timeStr,
            duration_minutes: event.duration,
            location_type: event.location_type,
            location_address: event.location_details, // Mapping location_details -> location_address/zoom_link
            zoom_link: event.location_type === 'virtual' ? event.location_details : undefined,
            rsvp_deadline: event.rsvp_deadline?.split('T')[0] || '',
            invites: invites,
            created_at: event.created_at
        }
    })
}

/**
 * getActiveStudents
 * Fetches all students for invitation selection.
 */
export async function getActiveStudents(): Promise<{ id: string; name: string; email: string }[]> {
    const supabase = await createClient()

    const { data, error } = await supabase
        .from('profiles')
        .select('id, name, email')
        .eq('role', 'student')
        .order('name')

    if (error) {
        console.error('Error fetching students:', error)
        return []
    }

    return data as { id: string; name: string; email: string }[]
}

/**
 * createEvent
 * Creates a new event and invites students.
 */
export async function createEvent(
    input: CreateEventInput,
): Promise<{ success: boolean; event?: AdminEvent; error?: string }> {
    const supabase = await createClient()

    // 1. Zoom Logic
    let locationDetails = input.location_address || ''
    if (input.location_type === 'virtual') {
        // Construct full ISO string for Zoom
        const isoDateTime = new Date(`${input.date}T${input.start_time}`).toISOString()
        const zoomMeeting = await createZoomMeeting(
            input.title,
            isoDateTime,
            input.duration_minutes
        )
        if (zoomMeeting) {
            locationDetails = zoomMeeting.join_url
        }
    }

    // 2. Insert Event
    // Combine date and time into ISO string for DB storage
    // We assume DB `start_time` column is TIMESTAMPTZ
    const fullStartTime = new Date(`${input.date}T${input.start_time}`).toISOString()
    // RSVP deadline typically needs a time too, default to end of day? 
    // Input is just a date string.
    const fullRsvpDeadline = new Date(`${input.rsvp_deadline}T23:59:59`).toISOString()

    const { data: eventData, error: eventError } = await supabase
        .from('events')
        .insert({
            title: input.title,
            description: input.description,
            start_time: fullStartTime,
            duration: input.duration_minutes,
            location_type: input.location_type,
            location_details: locationDetails,
            rsvp_deadline: fullRsvpDeadline,
        })
        .select()
        .single()

    if (eventError || !eventData) {
        console.error('Error creating event:', eventError)
        return { success: false, error: 'Failed to create event in database' }
    }

    // 3. Invite Students
    if (input.invited_student_ids.length > 0) {
        const invites = input.invited_student_ids.map((studentId) => ({
            event_id: eventData.id,
            student_id: studentId,
            status: 'pending',
        }))

        const { error: inviteError } = await supabase
            .from('event_invites')
            .insert(invites)

        if (inviteError) {
            console.error('Error creating invites:', inviteError)
            // Non-fatal, return success with warning if possible, or just success
        }
    }

    revalidatePath('/admin/events')
    revalidatePath('/student/events')

    // Return partial AdminEvent (enough for the UI to update optimistically or refresh)
    // We'll call getAdminEvents usually to refresh, but returning the obj is good practice
    return { success: true }
}

/**
 * deleteEvent
 */
export async function deleteEvent(eventId: string): Promise<{ success: boolean; error?: string }> {
    const supabase = await createClient()

    // Explicitly delete invites first (in case cascade is missing on older data)
    const { error: inviteError } = await supabase
        .from('event_invites')
        .delete()
        .eq('event_id', eventId)

    if (inviteError) {
        console.error('Delete invites error:', inviteError)
        // We continue? No, if we can't delete invites, we probably can't delete event if FK restricts.
        // But if invites are deleted, we proceed.
        return { success: false, error: 'Failed to clear event invites: ' + inviteError.message }
    }

    const { error } = await supabase
        .from('events')
        .delete()
        .eq('id', eventId)

    if (error) {
        console.error('Delete event error:', error)
        return { success: false, error: 'Failed to delete event: ' + error.message }
    }

    revalidatePath('/admin/events')
    revalidatePath('/student/events')
    return { success: true }
}

/**
 * getStudentEvents
 * Fetches events where the current student is invited.
 */
export async function getStudentEvents(): Promise<{ upcoming: StudentEvent[], past: StudentEvent[] }> {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) return { upcoming: [], past: [] }

    // Fetch invites joined with events
    const { data: invites, error } = await supabase
        .from('event_invites')
        .select(`
        status,
        student_notes,
        events (
          *
        )
      `)
        .eq('student_id', user.id)

    if (error) {
        console.error('Error fetching student events:', error)
        return { upcoming: [], past: [] }
    }

    // Fetch student timezone
    // const { data: profile } = await supabase
    //     .from('profiles')
    //     .select('timezone')
    //     .eq('id', user.id)
    //     .single()

    // const timezone = profile?.timezone || 'America/Los_Angeles'

    const now = new Date()
    const upcoming: StudentEvent[] = []
    const past: StudentEvent[] = []

    invites?.forEach((invite: any) => {
        if (!invite.events) return

        const event = invite.events
        const startDateTime = new Date(event.start_time)
        const dateStr = startDateTime.toISOString().split('T')[0]
        const timeStr = startDateTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })

        const studentEvent: StudentEvent = {
            id: event.id,
            title: event.title,
            description: event.description || '',
            date: dateStr,
            start_time: timeStr,
            duration_minutes: event.duration,
            location_type: event.location_type,
            location_address: event.location_details,
            zoom_link: event.location_type === 'virtual' ? event.location_details : undefined,
            rsvp_deadline: event.rsvp_deadline?.split('T')[0] || '',
            created_at: event.created_at,
            invite_status: invite.status,
            student_notes: invite.student_notes
        }

        if (startDateTime > now) {
            upcoming.push(studentEvent)
        } else {
            past.push(studentEvent)
        }
    })

    // Sort
    upcoming.sort((a, b) => new Date(a.date + 'T' + a.start_time).getTime() - new Date(b.date + 'T' + b.start_time).getTime())
    past.sort((a, b) => new Date(b.date + 'T' + b.start_time).getTime() - new Date(a.date + 'T' + a.start_time).getTime())

    return { upcoming, past }
}

/**
 * rsvpToEvent
 * Updates RSVP status for the student.
 */
export async function rsvpToEvent(
    eventId: string,
    status: 'going' | 'not_going',
    notes: string
) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) return { error: 'Not authenticated' }

    // 1. Check Event & Deadline
    const { data: event, error: eventError } = await supabase
        .from('events')
        .select('rsvp_deadline')
        .eq('id', eventId)
        .single()

    if (eventError || !event) {
        return { error: 'Event not found' }
    }

    if (new Date() > new Date(event.rsvp_deadline)) {
        return { error: 'RSVP deadline has passed' }
    }

    // 2. Update Invite
    const { error: updateError } = await supabase
        .from('event_invites')
        .update({
            status,
            student_notes: notes,
            updated_at: new Date().toISOString()
        })
        .eq('event_id', eventId)
        .eq('student_id', user.id)

    if (updateError) {
        console.error('Error updating RSVP:', updateError)
        return { error: 'Failed to update RSVP' }
    }

    revalidatePath('/student/events')
    revalidatePath('/admin/events')

    return { success: true }
}

/**
 * updateEvent
 * Updates an existing event and its invites.
 */
export async function updateEvent(
    eventId: string,
    input: CreateEventInput
): Promise<{ success: boolean; error?: string }> {
    const supabase = await createClient()

    // 1. Zoom Logic (if changed to virtual, or updating details)
    let locationDetails = input.location_address || ''
    if (input.location_type === 'virtual') {
        // Construct full ISO string for Zoom
        // Note: Ideally we update the existing meeting rather than creating new, but for now this ensures link is valid.
        const isoDateTime = new Date(`${input.date}T${input.start_time}`).toISOString()
        const zoomMeeting = await createZoomMeeting(
            input.title,
            isoDateTime,
            input.duration_minutes
        )
        if (zoomMeeting) {
            locationDetails = zoomMeeting.join_url
        } else if (!locationDetails) {
            // Keep existing if we didn't get a new one and have none? 
            // Actually input.location_address likely contains the existing link if we prefilled it.
        }
    }

    // 2. Update Event
    const fullStartTime = new Date(`${input.date}T${input.start_time}`).toISOString()
    const fullRsvpDeadline = new Date(`${input.rsvp_deadline}T23:59:59`).toISOString()

    const { error: eventError } = await supabase
        .from('events')
        .update({
            title: input.title,
            description: input.description,
            start_time: fullStartTime,
            duration: input.duration_minutes,
            location_type: input.location_type,
            location_details: locationDetails,
            rsvp_deadline: fullRsvpDeadline,
        })
        .eq('id', eventId)

    if (eventError) {
        console.error('Error updating event:', eventError)
        return { success: false, error: 'Failed to update event' }
    }

    // 3. Update Invites (Sync logic)
    if (input.invited_student_ids) {
        // Get existing invites
        const { data: existingInvites } = await supabase
            .from('event_invites')
            .select('student_id')
            .eq('event_id', eventId)

        const existingIds = existingInvites?.map(i => i.student_id) || []

        // To Add
        const toAdd = input.invited_student_ids.filter(id => !existingIds.includes(id))
        // To Remove
        const toRemove = existingIds.filter(id => !input.invited_student_ids.includes(id))

        if (toAdd.length > 0) {
            const newInvites = toAdd.map(sid => ({
                event_id: eventId,
                student_id: sid,
                status: 'pending' // Default status for new invites
            }))
            await supabase.from('event_invites').insert(newInvites)
        }

        if (toRemove.length > 0) {
            await supabase
                .from('event_invites')
                .delete()
                .eq('event_id', eventId)
                .in('student_id', toRemove)
        }
    }

    revalidatePath('/admin/events')
    revalidatePath('/student/events')

    return { success: true }
}
</file>

<file path="app/actions/makeup-slots.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'
import { createClient as createAdminClient } from '@supabase/supabase-js'
import { checkAvailability } from '@/app/actions/lessons'

export type MakeupSlot = {
    id: string
    start_time: string
    end_time: string
    available: boolean
    // Formatted for UI
    day?: string
    date?: string
    time?: string
}

/**
 * Get available makeup slots dynamically based on teacher's master calendar
 */
export async function getAvailableMakeupSlots(limit: number = 5) {
    const supabase = await createClient()

    // 1. Get the admin profile to find available_hours
    // Assuming single admin for now or we just pick the first one with role 'admin'
    // In a multi-teacher app, we'd need to know WHICH teacher.
    // For this prototype, we'll fetch the first admin profile.

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('available_hours, timezone')
        .eq('role', 'admin')
        .limit(1)
        .single()

    if (!adminProfile || !adminProfile.available_hours) {
        // Fallback or empty if no admin/config found
        return { slots: [] }
    }

    const availabilityConfig = adminProfile.available_hours as any[]
    const slots: MakeupSlot[] = []

    // 2. Generate candidates for the next 14 days
    const today = new Date()
    const daysToCheck = 14
    let count = 0

    // Loop through days
    for (let i = 1; i <= daysToCheck; i++) {
        if (slots.length >= limit) break

        const currentDay = new Date(today)
        currentDay.setDate(today.getDate() + i)

        const dayName = currentDay.toLocaleDateString('en-US', { weekday: 'long' })
        const config = availabilityConfig.find(c => c.day === dayName && c.enabled)

        if (config) {
            // Day is enabled, generating fixed slots (e.g. every 60 mins)
            // Using simple logic: Start at config.start, increment by 60 mins until config.end
            const [startHour, startMin] = config.start.split(':').map(Number)
            const [endHour, endMin] = config.end.split(':').map(Number)

            let timeDate = new Date(currentDay)
            timeDate.setHours(startHour, startMin, 0, 0)

            const endTimeDate = new Date(currentDay)
            endTimeDate.setHours(endHour, endMin, 0, 0)

            while (timeDate < endTimeDate) {
                if (slots.length >= limit) break

                // Format "YYYY-MM-DD" and "HH:MM"
                const dateStr = timeDate.toISOString().split('T')[0] // Careful with timezone, using simplified
                // For proper timezone handling, we should construct strings carefully.
                // Assuming server time / simple date math for prototype:
                const year = timeDate.getFullYear()
                const month = String(timeDate.getMonth() + 1).padStart(2, '0')
                const day = String(timeDate.getDate()).padStart(2, '0')
                const dateParam = `${year}-${month}-${day}`

                const hour = String(timeDate.getHours()).padStart(2, '0')
                const minute = String(timeDate.getMinutes()).padStart(2, '0')
                const timeParam = `${hour}:${minute}`

                // 3. CHECK MASTER CALENDAR availability
                const isFree = await checkAvailability(dateParam, timeParam, 60) // assuming 60m slots

                if (isFree) {
                    // Create synthetic ID: "YYYY-MM-DD_HH:MM"
                    const slotId = `${dateParam}_${timeParam}`

                    slots.push({
                        id: slotId,
                        start_time: timeDate.toISOString(), // ISO string for sorting/parsing
                        end_time: new Date(timeDate.getTime() + 60 * 60000).toISOString(),
                        available: true,
                        day: dayName,
                        date: timeDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        time: timeDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
                    })
                }

                // Increment by 60 mins
                timeDate.setHours(timeDate.getHours() + 1)
            }
        }
    }

    return { slots }
}

/**
 * Claim a makeup slot and reschedule a lesson
 * Expects slotId to be "YYYY-MM-DD_HH:MM"
 */
export async function claimMakeupSlot(slotId: string, lessonId: string) {
    const supabase = await createClient()

    // Get current user
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    // Verify the lesson belongs to this student
    const { data: lesson, error: lessonError } = await supabase
        .from('lessons')
        .select('*')
        .eq('id', lessonId)
        .eq('student_id', user.id)
        .single()

    if (lessonError || !lesson) {
        console.error('Lesson verification error:', lessonError)
        return { error: 'Lesson not found or unauthorized' }
    }

    // Parse the synthetic ID
    // Format: "YYYY-MM-DD_HH:MM"
    const [date, time] = slotId.split('_')
    if (!date || !time) {
        return { error: 'Invalid slot ID' }
    }

    // Verify availability one last time (Race Condition check)
    const isFree = await checkAvailability(date, time, 60, lessonId) // exclude current lesson (though usually we are MOVING it to a NEW time)
    // Actually, if we are rescheduling, we are moving the pointer.
    // checkAvailability excludes 'cancelled' lessons.
    // The current lesson status is 'scheduled' or 'cancelled'.
    // If it's 'scheduled', we technically check if `date` and `time` are taken.
    // If we are moving to a NEW time, we just check that NEW time.
    // ExcludeLessonId helps if we are keeping the SAME time (which is not rescheduling).

    if (!isFree) {
        return { error: 'This slot is no longer available. Please choose another.' }
    }

    // Create admin client to bypass RLS for updates
    const supabaseAdmin = createAdminClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    )

    console.log(`Rescheduling lesson ${lessonId} to ${date} at ${time}`)

    // Update the lesson with new date/time
    const { data: updatedLesson, error: updateLessonError } = await supabaseAdmin
        .from('lessons')
        .update({
            date: date,
            time: time,
            status: 'scheduled',
            updated_at: new Date().toISOString()
        })
        .eq('id', lessonId)
        .select()
        .single()

    if (updateLessonError) {
        console.error('Update lesson error:', updateLessonError)
        return { error: 'Failed to reschedule lesson: ' + updateLessonError.message }
    }

    // Revalidate paths to refresh UI
    revalidatePath('/student')
    revalidatePath('/admin')

    const dateObj = new Date(`${date}T${time}:00`)
    const formattedDate = dateObj.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric'
    })
    const formattedTime = dateObj.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit'
    })

    return {
        success: true,
        message: `Lesson rescheduled to ${formattedDate} at ${formattedTime}`
    }
}

// Deprecated: createMakeupSlot, deleteMakeupSlot
// These are no longer needed with the dynamic system but kept empty to avoid breaking imports if any.
export async function createMakeupSlot(startTime: string, endTime: string) {
    return { error: 'Deprecated: Slots are now generated dynamically.' }
}
export async function deleteMakeupSlot(slotId: string) {
    return { error: 'Deprecated: Slots are now generated dynamically.' }
}
</file>

<file path="app/actions/resources.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'

// Types
export type ResourceCategory = 'Sheet Music' | 'Theory' | 'Scales' | 'Exercises' | 'Recording'

export interface Resource {
    id: string
    title: string
    description: string | null
    category: ResourceCategory
    file_url: string
    file_type: string
    created_at: string
    assignment_count?: number
}

export interface ResourceWithAssignments extends Resource {
    assigned_students: { id: string; name: string }[]
}

/**
 * Get all resources with assignment counts (admin only)
 */
export async function getResources(): Promise<{ resources: Resource[]; error?: string }> {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { resources: [], error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { resources: [], error: 'Only admins can view all resources' }
    }

    // Fetch resources with assignment counts
    const { data: resources, error } = await supabase
        .from('resources')
        .select(`
            *,
            resource_assignments(count)
        `)
        .order('created_at', { ascending: false })

    if (error) {
        console.error('Error fetching resources:', error)
        return { resources: [], error: error.message }
    }

    // Transform to include assignment_count
    const transformedResources = (resources || []).map(r => ({
        ...r,
        assignment_count: r.resource_assignments?.[0]?.count || 0,
        resource_assignments: undefined
    }))

    return { resources: transformedResources }
}

/**
 * Get a single resource with its assigned students
 */
export async function getResourceWithAssignments(resourceId: string): Promise<{ resource: ResourceWithAssignments | null; error?: string }> {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { resource: null, error: 'Unauthorized' }
    }

    // Fetch resource
    const { data: resource, error: resourceError } = await supabase
        .from('resources')
        .select('*')
        .eq('id', resourceId)
        .single()

    if (resourceError || !resource) {
        return { resource: null, error: 'Resource not found' }
    }

    // Fetch assignments with student names
    const { data: assignments, error: assignmentsError } = await supabase
        .from('resource_assignments')
        .select(`
            student_id,
            profiles!resource_assignments_student_id_fkey(id, name)
        `)
        .eq('resource_id', resourceId)

    if (assignmentsError) {
        console.error('Error fetching assignments:', assignmentsError)
    }

    const assigned_students = (assignments || []).map(a => ({
        id: (a.profiles as any)?.id || a.student_id,
        name: (a.profiles as any)?.name || 'Unknown'
    }))

    return {
        resource: {
            ...resource,
            assigned_students
        }
    }
}

/**
 * Get resources assigned to a specific student
 */
export async function getStudentResources(studentId?: string): Promise<{ resources: Resource[]; error?: string }> {
    const supabase = await createClient()

    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { resources: [], error: 'Unauthorized' }
    }

    // Use current user if no studentId provided
    const targetStudentId = studentId || user.id

    // Fetch resources assigned to this student
    const { data: assignments, error } = await supabase
        .from('resource_assignments')
        .select(`
            resource:resources(*)
        `)
        .eq('student_id', targetStudentId)

    if (error) {
        console.error('Error fetching student resources:', error)
        return { resources: [], error: error.message }
    }

    const resources = (assignments || [])
        .map(a => a.resource)
        .filter(Boolean) as Resource[]

    // Sort by category then by title
    resources.sort((a, b) => {
        if (a.category !== b.category) {
            return a.category.localeCompare(b.category)
        }
        return a.title.localeCompare(b.title)
    })

    return { resources }
}

/**
 * Create a new resource and assign to students
 */
export async function createResource(
    data: {
        title: string
        description?: string
        category: ResourceCategory
        file_url: string
        file_type: string
    },
    studentIds: string[]
): Promise<{ success: boolean; resourceId?: string; error?: string }> {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { success: false, error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { success: false, error: 'Only admins can create resources' }
    }

    // Create the resource
    const { data: resource, error: createError } = await supabase
        .from('resources')
        .insert({
            title: data.title,
            description: data.description || null,
            category: data.category,
            file_url: data.file_url,
            file_type: data.file_type
        })
        .select()
        .single()

    if (createError || !resource) {
        console.error('Error creating resource:', createError)
        return { success: false, error: createError?.message || 'Failed to create resource' }
    }

    // Assign to students
    if (studentIds.length > 0) {
        const assignments = studentIds.map(studentId => ({
            resource_id: resource.id,
            student_id: studentId
        }))

        const { error: assignError } = await supabase
            .from('resource_assignments')
            .insert(assignments)

        if (assignError) {
            console.error('Error creating assignments:', assignError)
            // Resource was created, but assignments failed
            return { success: true, resourceId: resource.id, error: 'Resource created but some assignments failed' }
        }
    }

    revalidatePath('/admin/library')
    revalidatePath('/student')

    return { success: true, resourceId: resource.id }
}

/**
 * Update a resource's metadata
 */
export async function updateResource(
    resourceId: string,
    data: {
        title?: string
        description?: string
        category?: ResourceCategory
        file_url?: string
        file_type?: string
    }
): Promise<{ success: boolean; error?: string }> {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { success: false, error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { success: false, error: 'Only admins can update resources' }
    }

    // Build update object with only provided fields
    const updateData: Record<string, any> = {}
    if (data.title !== undefined) updateData.title = data.title
    if (data.description !== undefined) updateData.description = data.description
    if (data.category !== undefined) updateData.category = data.category
    if (data.file_url !== undefined) updateData.file_url = data.file_url
    if (data.file_type !== undefined) updateData.file_type = data.file_type

    const { error } = await supabase
        .from('resources')
        .update(updateData)
        .eq('id', resourceId)

    if (error) {
        console.error('Error updating resource:', error)
        return { success: false, error: error.message }
    }

    revalidatePath('/admin/library')
    revalidatePath('/student')

    return { success: true }
}

/**
 * Update resource assignments (replace all assignments)
 */
export async function updateResourceAssignments(
    resourceId: string,
    studentIds: string[]
): Promise<{ success: boolean; error?: string }> {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { success: false, error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { success: false, error: 'Only admins can update assignments' }
    }

    // Delete existing assignments
    const { error: deleteError } = await supabase
        .from('resource_assignments')
        .delete()
        .eq('resource_id', resourceId)

    if (deleteError) {
        console.error('Error deleting old assignments:', deleteError)
        return { success: false, error: deleteError.message }
    }

    // Insert new assignments
    if (studentIds.length > 0) {
        const assignments = studentIds.map(studentId => ({
            resource_id: resourceId,
            student_id: studentId
        }))

        const { error: insertError } = await supabase
            .from('resource_assignments')
            .insert(assignments)

        if (insertError) {
            console.error('Error creating new assignments:', insertError)
            return { success: false, error: insertError.message }
        }
    }

    revalidatePath('/admin/library')
    revalidatePath('/student')

    return { success: true }
}

/**
 * Delete a resource (assignments cascade delete)
 */
export async function deleteResource(resourceId: string): Promise<{ success: boolean; error?: string }> {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { success: false, error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { success: false, error: 'Only admins can delete resources' }
    }

    const { error } = await supabase
        .from('resources')
        .delete()
        .eq('id', resourceId)

    if (error) {
        console.error('Error deleting resource:', error)
        return { success: false, error: error.message }
    }

    revalidatePath('/admin/library')
    revalidatePath('/student')

    return { success: true }
}

/**
 * Upload a file to Supabase Storage (library bucket)
 */
export async function uploadLibraryFile(formData: FormData): Promise<{ url?: string; error?: string }> {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can upload files' }
    }

    const file = formData.get('file') as File
    if (!file) {
        return { error: 'No file provided' }
    }

    // Generate unique filename
    const timestamp = Date.now()
    const sanitizedName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_')
    const filePath = `library/${timestamp}_${sanitizedName}`

    // Upload to lesson_materials bucket (reusing existing bucket)
    const { data, error } = await supabase.storage
        .from('lesson_materials')
        .upload(filePath, file, {
            cacheControl: '3600',
            upsert: false
        })

    if (error) {
        console.error('Error uploading file:', error)
        return { error: error.message }
    }

    // Get public URL
    const { data: { publicUrl } } = supabase.storage
        .from('lesson_materials')
        .getPublicUrl(data.path)

    return { url: publicUrl }
}
</file>

<file path="app/actions/reviews.ts">
"use server"

import { createClient } from "@/lib/supabase/server"
import { revalidatePath } from "next/cache"

export async function submitReview(formData: FormData) {
    const supabase = await createClient()

    const name = formData.get("name") as string
    const ratingStr = formData.get("rating") as string
    const text = formData.get("review") as string

    if (!name || !ratingStr || !text) {
        return { error: "Missing required fields" }
    }

    const rating = parseInt(ratingStr, 10)

    // Get current user (nullable)
    const { data: { user } } = await supabase.auth.getUser()

    const { error } = await supabase.from("reviews").insert({
        student_id: user?.id || null,
        name,
        rating,
        text,
        status: "pending",
    })

    if (error) {
        console.error("Error submitting review:", error)
        return { error: "Failed to submit review" }
    }

    return { success: true }
}

export async function getApprovedReviews() {
    const supabase = await createClient()

    const { data, error } = await supabase
        .from("reviews")
        .select("*, profiles(created_at)")
        .eq("status", "approved")
        .order("created_at", { ascending: false })

    if (error) {
        console.error("Error fetching reviews:", error)
        return []
    }

    return data
}

export async function getAllReviews() {
    const supabase = await createClient()

    // Check auth
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: "Unauthorized" }

    // Check admin role
    const { data: profile } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single()

    if (profile?.role !== 'admin') {
        return { error: "Unauthorized" }
    }

    const { data, error } = await supabase
        .from("reviews")
        .select("*, profiles(email)")
        .order("created_at", { ascending: false })

    if (error) {
        console.error("Error fetching all reviews:", error)
        return { error: "Failed to fetch reviews" }
    }

    return { data }
}

export async function updateReviewStatus(id: string, status: 'approved' | 'rejected' | 'pending') {
    const supabase = await createClient()

    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: "Unauthorized" }

    const { data: profile } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single()

    if (profile?.role !== 'admin') {
        return { error: "Unauthorized" }
    }

    const { error } = await supabase
        .from("reviews")
        .update({ status })
        .eq("id", id)

    if (error) {
        console.error("Error updating review:", error)
        return { error: "Failed to update review" }
    }

    revalidatePath("/admin/reviews")
    revalidatePath("/reviews") // Update public page
    return { success: true }
}

export async function deleteReview(id: string) {
    const supabase = await createClient()

    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: "Unauthorized" }

    const { data: profile } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single()

    if (profile?.role !== 'admin') {
        return { error: "Unauthorized" }
    }

    const { error } = await supabase
        .from("reviews")
        .delete()
        .eq("id", id)

    if (error) {
        console.error("Error deleting review:", error)
        return { error: "Failed to delete review" }
    }

    revalidatePath("/admin/reviews")
    revalidatePath("/reviews")
    return { success: true }
}
</file>

<file path="app/actions/site-editor.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'
import { createClient as createSupabaseClient } from '@supabase/supabase-js'

export interface SitePage {
    id: string
    html_template: string | null
    script_content: string | null
    variable_values: Record<string, string> | null
    created_at: string
    updated_at: string
}

/**
 * Get a site page by ID
 */
export async function getPage(id: string = 'home'): Promise<{ page: SitePage | null; error?: string }> {
    const supabase = await createClient()

    const { data, error } = await supabase
        .from('site_pages')
        .select('*')
        .eq('id', id)
        .single()

    if (error) {
        // If no rows found, return null (not an error for our use case)
        if (error.code === 'PGRST116') {
            return { page: null }
        }
        console.error('Get page error:', error)
        return { page: null, error: error.message }
    }

    return { page: data }
}

/**
 * Save (upsert) a site page
 * Requires admin authentication
 */
export async function savePage(
    id: string,
    htmlTemplate: string,
    scriptContent: string,
    variableValues: Record<string, string>
): Promise<{ success: boolean; error?: string }> {

    console.log("Attempting to save page:", { id })
    const supabase = await createClient()

    // Verify user is authenticated and is admin (using regular client)
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { success: false, error: 'Not authenticated' }
    }

    const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (!profile || profile.role !== 'admin') {
        return { success: false, error: 'Admin access required' }
    }

    // Use Service Role client for valid Admin operations to bypass RLS complexities
    const hasServiceKey = !!process.env.SUPABASE_SERVICE_KEY
    console.log("Has Service Key:", hasServiceKey)

    const supabaseAdmin = createSupabaseClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    )

    // Upsert the page
    const payload = {
        id,
        html_template: htmlTemplate,
        script_content: scriptContent,
        variable_values: variableValues,
        updated_at: new Date().toISOString()
    }
    console.log("Upserting Payload ID:", id)

    const { data: upsertData, error } = await supabaseAdmin
        .from('site_pages')
        .upsert(payload, {
            onConflict: 'id'
        })
        .select()

    if (error) {
        console.error('Save page error:', error)
        return { success: false, error: error.message }
    }

    console.log("Upsert Success. Data:", upsertData)

    // Revalidate the public page
    revalidatePath('/')

    return { success: true }
}
</file>

<file path="app/admin/editor2/page.tsx">
"use client"

import { useState, useEffect, useMemo, useCallback } from "react"
import { useRouter } from "next/navigation"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Separator } from "@/components/ui/separator"
import { Music, ArrowLeft, Save, Monitor, Smartphone, Code, Eye, Settings } from "lucide-react"
import { useToast } from "@/hooks/use-toast"
import { savePage, getPage } from "@/app/actions/site-editor"

const DEFAULT_HTML_TEMPLATE = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{site_title}}</title>
</head>
<body class="bg-white text-black font-sans">
  <!-- Navigation -->
  <nav class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-b border-black/10 z-50">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">â™ª</span>
        <span class="font-serif text-xl font-semibold">{{studio_name}}</span>
      </div>
      <a href="/login" class="px-4 py-2 border border-black text-sm hover:bg-black hover:text-white transition-colors">
        {{login_button_text}}
      </a>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="min-h-screen flex items-center pt-20">
    <div class="max-w-6xl mx-auto px-6 grid lg:grid-cols-2 gap-12 items-center">
      <div>
        <h1 class="font-serif text-5xl lg:text-6xl font-bold leading-tight mb-6">
          {{hero_headline}}
        </h1>
        <p class="text-xl text-gray-600 mb-8 leading-relaxed">
          {{hero_subheadline}}
        </p>
        <div class="flex flex-col sm:flex-row gap-4">
          <a href="#contact" class="px-8 py-4 bg-black text-white text-center hover:bg-gray-800 transition-colors">
            {{cta_primary}}
          </a>
          <a href="/login" class="px-8 py-4 border border-black text-center hover:bg-black hover:text-white transition-colors">
            {{cta_secondary}}
          </a>
        </div>
        <div class="flex gap-12 mt-12 pt-8 border-t border-gray-200">
          <div>
            <div class="font-serif text-3xl font-bold">{{stat_1_number}}</div>
            <div class="text-gray-500 text-sm">{{stat_1_label}}</div>
          </div>
          <div>
            <div class="font-serif text-3xl font-bold">{{stat_2_number}}</div>
            <div class="text-gray-500 text-sm">{{stat_2_label}}</div>
          </div>
          <div>
            <div class="font-serif text-3xl font-bold">{{stat_3_number}}</div>
            <div class="text-gray-500 text-sm">{{stat_3_label}}</div>
          </div>
        </div>
      </div>
      <div class="relative">
        <img src="{{hero_image_url}}" alt="Piano Teacher" class="w-full rounded-lg shadow-2xl" />
      </div>
    </div>
  </section>

  <!-- About Section -->
  <section class="py-24 bg-black text-white">
    <div class="max-w-6xl mx-auto px-6">
      <h2 class="font-serif text-4xl font-bold mb-6">{{about_title}}</h2>
      <div class="grid lg:grid-cols-2 gap-12">
        <p class="text-xl text-gray-300 leading-relaxed">
          {{about_paragraph_1}}
        </p>
        <p class="text-xl text-gray-300 leading-relaxed">
          {{about_paragraph_2}}
        </p>
      </div>
    </div>
  </section>

  <!-- Testimonials Section -->
  <section class="py-24">
    <div class="max-w-6xl mx-auto px-6">
      <h2 class="font-serif text-4xl font-bold mb-12 text-center">{{testimonials_title}}</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="p-8 border border-gray-200">
          <p class="text-gray-600 mb-6 italic">"{{testimonial_1_quote}}"</p>
          <div class="font-semibold">{{testimonial_1_name}}</div>
          <div class="text-sm text-gray-500">{{testimonial_1_role}}</div>
        </div>
        <div class="p-8 border border-gray-200">
          <p class="text-gray-600 mb-6 italic">"{{testimonial_2_quote}}"</p>
          <div class="font-semibold">{{testimonial_2_name}}</div>
          <div class="text-sm text-gray-500">{{testimonial_2_role}}</div>
        </div>
        <div class="p-8 border border-gray-200">
          <p class="text-gray-600 mb-6 italic">"{{testimonial_3_quote}}"</p>
          <div class="font-semibold">{{testimonial_3_name}}</div>
          <div class="text-sm text-gray-500">{{testimonial_3_role}}</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-12 bg-black text-white">
    <div class="max-w-6xl mx-auto px-6 text-center">
      <p class="text-gray-400">{{footer_copyright}}</p>
    </div>
  </footer>
</body>
</html>`

const DEFAULT_VARIABLES: Record<string, string> = {
    site_title: "Piano Studio",
    studio_name: "Piano Studio",
    login_button_text: "Student Login",
    hero_headline: "Master Piano with Excellence",
    hero_subheadline:
        "Transform your musical journey with personalized instruction, flexible scheduling, and a proven system designed for serious students.",
    cta_primary: "Inquire for Lessons",
    cta_secondary: "Student Portal",
    stat_1_number: "15+",
    stat_1_label: "Years Teaching",
    stat_2_number: "200+",
    stat_2_label: "Students Taught",
    stat_3_number: "98%",
    stat_3_label: "Satisfaction Rate",
    hero_image_url: "/professional-piano-teacher-at-grand-piano-in-elega.jpg",
    about_title: "About Your Teacher",
    about_paragraph_1:
        "With over 15 years of dedicated teaching experience, I bring a wealth of knowledge from my training at prestigious conservatories and years of professional performance.",
    about_paragraph_2:
        "My teaching philosophy centers on building strong fundamentals while nurturing each student's unique musical voice. I believe in structured progress with room for creative exploration.",
    testimonials_title: "What Students Say",
    testimonial_1_quote:
        "The structured approach combined with flexibility has been perfect for my busy schedule. I've made more progress in 6 months than years of previous lessons.",
    testimonial_1_name: "Sarah Chen",
    testimonial_1_role: "Adult Student, 2 years",
    testimonial_2_quote:
        "My daughter has flourished under this instruction. The recitals and group classes have built her confidence tremendously.",
    testimonial_2_name: "Michael Torres",
    testimonial_2_role: "Parent of Emma, age 12",
    testimonial_3_quote:
        "Professional, demanding, but always supportive. Exactly what I needed to prepare for my conservatory auditions.",
    testimonial_3_name: "James Kim",
    testimonial_3_role: "Pre-Conservatory Student",
    footer_copyright: "Â© 2025 Piano Studio. All rights reserved.",
}

export default function Editor2Page() {
    const router = useRouter()
    const { toast } = useToast()

    // State
    const [htmlCode, setHtmlCode] = useState(DEFAULT_HTML_TEMPLATE)
    const [variables, setVariables] = useState<Record<string, string>>(DEFAULT_VARIABLES)
    const [scriptCode, setScriptCode] = useState("")
    const [deviceMode, setDeviceMode] = useState<"desktop" | "mobile">("desktop")
    const [isSaving, setIsSaving] = useState(false)
    const [isLoading, setIsLoading] = useState(true)

    // Load existing page data
    useEffect(() => {
        async function loadPage() {
            setIsLoading(true)
            const { page, error } = await getPage('home')
            if (error) {
                toast({ variant: "destructive", title: "Error", description: error })
            } else if (page) {
                // If we have saved content, use it. Otherwise fall back to default template
                setHtmlCode(page.html_template || DEFAULT_HTML_TEMPLATE)
                setScriptCode(page.script_content || "")
                // For variables, merge saved values with defaults to ensure all needed keys exist
                setVariables(prev => ({
                    ...DEFAULT_VARIABLES,
                    ...(page.variable_values || {})
                }))
            }
            setIsLoading(false)
        }
        loadPage()
    }, [toast])

    // Parse HTML for {{variable}} patterns
    const detectedVariables = useMemo(() => {
        const regex = /\{\{([\w_]+)\}\}/g
        const matches: string[] = []
        let match
        while ((match = regex.exec(htmlCode)) !== null) {
            if (!matches.includes(match[1])) {
                matches.push(match[1])
            }
        }
        return matches
    }, [htmlCode])

    // Initialize new variables when detected
    useEffect(() => {
        setVariables((prev) => {
            const updated = { ...prev }
            detectedVariables.forEach((varName) => {
                if (!(varName in updated)) {
                    updated[varName] = ""
                }
            })
            return updated
        })
    }, [detectedVariables])

    // Generate preview HTML with variables replaced
    const previewHtml = useMemo(() => {
        let result = htmlCode
        Object.entries(variables).forEach(([key, value]) => {
            const regex = new RegExp(`\\{\\{${key}\\}\\}`, "g")
            result = result.replace(regex, value || `{{${key}}}`)
        })

        // Inject Tailwind CDN into head
        if (result.includes("<head>")) {
            result = result.replace("<head>", `<head>\n  <script src="https://cdn.tailwindcss.com"><\/script>\n  <script>${scriptCode}<\/script>`)
        }

        return result
    }, [htmlCode, variables, scriptCode])

    const handleVariableChange = useCallback((varName: string, value: string) => {
        setVariables((prev) => ({ ...prev, [varName]: value }))
    }, [])

    const handleSave = async () => {
        setIsSaving(true)
        const result = await savePage('home', htmlCode, scriptCode, variables)
        setIsSaving(false)

        if (result.success) {
            toast({ title: "Saved!", description: "Landing page updated successfully." })
            router.refresh()
        } else {
            toast({ variant: "destructive", title: "Error", description: result.error })
        }
    }

    // Format variable name for display
    const formatLabel = (varName: string) => {
        return varName
            .split("_")
            .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ")
    }

    // Group variables by section
    const groupedVariables = useMemo(() => {
        const groups: Record<string, string[]> = {
            General: [],
            "Hero Section": [],
            Statistics: [],
            "About Section": [],
            Testimonials: [],
            Footer: [],
            Other: [],
        }

        detectedVariables.forEach((varName) => {
            if (varName.includes("site_") || varName.includes("studio_") || varName.includes("login_")) {
                groups["General"].push(varName)
            } else if (varName.includes("hero_") || varName.includes("cta_")) {
                groups["Hero Section"].push(varName)
            } else if (varName.includes("stat_")) {
                groups["Statistics"].push(varName)
            } else if (varName.includes("about_")) {
                groups["About Section"].push(varName)
            } else if (varName.includes("testimonial")) {
                groups["Testimonials"].push(varName)
            } else if (varName.includes("footer_")) {
                groups["Footer"].push(varName)
            } else {
                groups["Other"].push(varName)
            }
        })

        return Object.entries(groups).filter(([, vars]) => vars.length > 0)
    }, [detectedVariables])

    if (isLoading) {
        return (
            <div className="min-h-screen flex items-center justify-center">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            </div>
        )
    }

    return (
        <div className="h-screen flex flex-col bg-background">
            {/* Header */}
            <header className="h-14 border-b border-border bg-card flex items-center justify-between px-4 shrink-0">
                <div className="flex items-center gap-4">
                    <Button variant="ghost" size="sm" onClick={() => router.push("/admin")} className="gap-2">
                        <ArrowLeft className="h-4 w-4" />
                        Back to Admin
                    </Button>
                    <Separator orientation="vertical" className="h-6" />
                    <div className="flex items-center gap-2">
                        <Music className="h-5 w-5" />
                        <span className="font-serif font-semibold">Site Builder</span>
                    </div>
                </div>
                <div className="flex items-center gap-2">
                    <div className="flex items-center border border-border rounded-md overflow-hidden">
                        <Button
                            variant={deviceMode === "desktop" ? "default" : "ghost"}
                            size="sm"
                            onClick={() => setDeviceMode("desktop")}
                            className="rounded-none gap-1.5"
                        >
                            <Monitor className="h-4 w-4" />
                            Desktop
                        </Button>
                        <Button
                            variant={deviceMode === "mobile" ? "default" : "ghost"}
                            size="sm"
                            onClick={() => setDeviceMode("mobile")}
                            className="rounded-none gap-1.5"
                        >
                            <Smartphone className="h-4 w-4" />
                            Mobile
                        </Button>
                    </div>
                    <Separator orientation="vertical" className="h-6" />
                    <Button onClick={handleSave} disabled={isSaving} className="gap-2">
                        <Save className="h-4 w-4" />
                        {isSaving ? "Saving..." : "Save Changes"}
                    </Button>
                </div>
            </header>

            {/* Main Content - 3 Column Layout */}
            <div className="flex-1 grid grid-cols-[280px_1fr_1fr] min-h-0">
                {/* Left Sidebar - Variables */}
                <div className="border-r border-border bg-card flex flex-col min-h-0">
                    <div className="p-4 border-b border-border shrink-0">
                        <div className="flex items-center gap-2 text-sm font-medium">
                            <Settings className="h-4 w-4" />
                            Variables
                        </div>
                        <p className="text-xs text-muted-foreground mt-1">Edit content without touching code</p>
                    </div>
                    <ScrollArea className="flex-1">
                        <div className="p-4 space-y-6">
                            {groupedVariables.map(([groupName, vars]) => (
                                <div key={groupName}>
                                    <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">
                                        {groupName}
                                    </h3>
                                    <div className="space-y-3">
                                        {vars.map((varName) => (
                                            <div key={varName}>
                                                <Label htmlFor={varName} className="text-xs font-medium">
                                                    {formatLabel(varName)}
                                                </Label>
                                                {variables[varName]?.length > 80 ? (
                                                    <Textarea
                                                        id={varName}
                                                        value={variables[varName] || ""}
                                                        onChange={(e) => handleVariableChange(varName, e.target.value)}
                                                        className="mt-1 text-sm min-h-[80px]"
                                                        placeholder={`Enter ${formatLabel(varName).toLowerCase()}`}
                                                    />
                                                ) : (
                                                    <Input
                                                        id={varName}
                                                        value={variables[varName] || ""}
                                                        onChange={(e) => handleVariableChange(varName, e.target.value)}
                                                        className="mt-1 text-sm"
                                                        placeholder={`Enter ${formatLabel(varName).toLowerCase()}`}
                                                    />
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </ScrollArea>
                </div>

                {/* Middle - Code Editor */}
                <div className="border-r border-border bg-zinc-950 flex flex-col min-h-0">
                    <div className="p-4 border-b border-zinc-800 shrink-0">
                        <div className="flex items-center gap-2 text-sm font-medium text-white">
                            <Code className="h-4 w-4" />
                            HTML Editor
                        </div>
                        <p className="text-xs text-zinc-400 mt-1">Use {"{{variable_name}}"} for dynamic content</p>
                    </div>
                    <div className="flex-1 min-h-0">
                        <Textarea
                            value={htmlCode}
                            onChange={(e) => setHtmlCode(e.target.value)}
                            className="h-full w-full resize-none rounded-none border-0 bg-zinc-950 text-zinc-100 font-mono text-sm p-4 focus-visible:ring-0 focus-visible:ring-offset-0"
                            spellCheck={false}
                        />
                    </div>
                </div>

                {/* Right - Live Preview */}
                <div className="bg-zinc-100 flex flex-col min-h-0">
                    <div className="p-4 border-b border-zinc-200 shrink-0 bg-white">
                        <div className="flex items-center gap-2 text-sm font-medium">
                            <Eye className="h-4 w-4" />
                            Live Preview
                        </div>
                        <p className="text-xs text-muted-foreground mt-1">
                            {deviceMode === "desktop" ? "Desktop view" : "Mobile view (375px)"}
                        </p>
                    </div>
                    <div className="flex-1 p-4 flex items-start justify-center overflow-auto">
                        <div
                            className={`bg-white shadow-2xl transition-all duration-300 ${deviceMode === "mobile" ? "w-[375px] rounded-[2rem] ring-8 ring-zinc-800" : "w-full h-full"
                                }`}
                            style={deviceMode === "mobile" ? { height: "667px" } : {}}
                        >
                            <iframe
                                srcDoc={previewHtml}
                                className={`w-full h-full ${deviceMode === "mobile" ? "rounded-[1.5rem]" : ""}`}
                                title="Live Preview"
                                sandbox="allow-scripts"
                            />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="app/admin/events/page.tsx">
"use client"

import { useState, useEffect } from "react"
import { Card, CardContent } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Music, Plus, Video, MapPin, Calendar, Clock, CheckCircle2, HelpCircle, ArrowLeft } from "lucide-react"
import Link from "next/link"
import { getAdminEvents, type AdminEvent } from "@/app/actions/events"
import { CreateEventModal } from "@/components/admin/create-event-modal"

export default function EventsPage() {
  const [events, setEvents] = useState<AdminEvent[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [showCreateModal, setShowCreateModal] = useState(false)

  const loadEvents = async () => {
    setIsLoading(true)
    const data = await getAdminEvents()
    setEvents(data)
    setIsLoading(false)
  }

  useEffect(() => {
    loadEvents()
  }, [])

  const today = new Date().toISOString().split("T")[0]
  const upcomingEvents = events.filter((e) => e.date >= today)
  const previousEvents = events.filter((e) => e.date < today)

  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr)
    return {
      month: date.toLocaleString("en-US", { month: "short" }).toUpperCase(),
      day: date.getDate(),
      weekday: date.toLocaleString("en-US", { weekday: "short" }),
    }
  }

  const formatTime = (time: string) => {
    const [hours, minutes] = time.split(":")
    const h = Number.parseInt(hours)
    const ampm = h >= 12 ? "PM" : "AM"
    const hour12 = h % 12 || 12
    return `${hour12}:${minutes} ${ampm}`
  }

  const getRsvpStats = (invites: AdminEvent["invites"]) => {
    const going = invites.filter((i) => i.status === "going").length
    const pending = invites.filter((i) => i.status === "pending").length
    const declined = invites.filter((i) => i.status === "declined").length
    return { going, pending, declined }
  }

  const EventCard = ({ event }: { event: AdminEvent }) => {
    const { month, day } = formatDate(event.date)
    const { going, pending } = getRsvpStats(event.invites)

    return (
      <Card className="hover:shadow-md transition-shadow">
        <CardContent className="p-0">
          <div className="flex items-stretch">
            {/* Date Column */}
            <div className="flex flex-col items-center justify-center px-6 py-4 bg-primary text-primary-foreground min-w-[100px]">
              <span className="text-xs font-medium tracking-wider">{month}</span>
              <span className="text-3xl font-serif font-bold">{day}</span>
            </div>

            {/* Content Column */}
            <div className="flex-1 p-4 flex items-center justify-between gap-4">
              <div className="space-y-1 min-w-0">
                <h3 className="font-semibold text-lg truncate">{event.title}</h3>
                <div className="flex items-center gap-4 text-sm text-muted-foreground">
                  <div className="flex items-center gap-1">
                    <Clock className="h-3.5 w-3.5" />
                    <span>{formatTime(event.start_time)}</span>
                  </div>
                  <div className="flex items-center gap-1">
                    {event.location_type === "virtual" ? (
                      <>
                        <Video className="h-3.5 w-3.5" />
                        <span>Zoom</span>
                      </>
                    ) : (
                      <>
                        <MapPin className="h-3.5 w-3.5" />
                        <span className="truncate max-w-[200px]">{event.location_address}</span>
                      </>
                    )}
                  </div>
                </div>
              </div>

              {/* RSVP Stats */}
              <div className="flex items-center gap-2 shrink-0">
                <Badge variant="default" className="gap-1">
                  <CheckCircle2 className="h-3 w-3" />
                  {going} Going
                </Badge>
                {pending > 0 && (
                  <Badge variant="secondary" className="gap-1">
                    <HelpCircle className="h-3 w-3" />
                    {pending} Pending
                  </Badge>
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    )
  }

  const EmptyState = ({ type }: { type: "upcoming" | "previous" }) => (
    <div className="flex flex-col items-center justify-center py-16 text-center">
      <div className="h-16 w-16 bg-muted rounded-full flex items-center justify-center mb-4">
        <Calendar className="h-8 w-8 text-muted-foreground" />
      </div>
      <h3 className="font-semibold text-lg mb-1">
        {type === "upcoming" ? "No upcoming events scheduled" : "No previous events"}
      </h3>
      <p className="text-muted-foreground text-sm max-w-sm">
        {type === "upcoming"
          ? "Create your first event to invite students to recitals, workshops, and group classes."
          : "Your past events will appear here for reference."}
      </p>
      {type === "upcoming" && (
        <Button className="mt-4" onClick={() => setShowCreateModal(true)}>
          <Plus className="h-4 w-4 mr-2" />
          Create Event
        </Button>
      )}
    </div>
  )

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="border-b bg-card sticky top-0 z-10">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Button variant="ghost" size="icon" asChild>
                <Link href="/admin">
                  <ArrowLeft className="h-5 w-5" />
                </Link>
              </Button>
              <div className="h-10 w-10 bg-primary rounded-full flex items-center justify-center">
                <Music className="h-5 w-5 text-primary-foreground" />
              </div>
              <div>
                <h1 className="text-xl font-serif font-semibold">Event Management</h1>
                <p className="text-sm text-muted-foreground">Schedule and manage studio events</p>
              </div>
            </div>
            <Button onClick={() => setShowCreateModal(true)}>
              <Plus className="h-4 w-4 mr-2" />
              Create Event
            </Button>
          </div>
        </div>
      </header>

      <main className="container mx-auto px-4 py-8">
        <Tabs defaultValue="upcoming" className="space-y-6">
          <TabsList className="grid w-full max-w-xs grid-cols-2">
            <TabsTrigger value="upcoming" className="gap-2">
              Upcoming
              {upcomingEvents.length > 0 && (
                <Badge variant="secondary" className="h-5 px-1.5">
                  {upcomingEvents.length}
                </Badge>
              )}
            </TabsTrigger>
            <TabsTrigger value="previous">Previous</TabsTrigger>
          </TabsList>

          <TabsContent value="upcoming" className="space-y-4">
            {isLoading ? (
              <div className="space-y-4">
                {[1, 2, 3].map((i) => (
                  <Card key={i} className="animate-pulse">
                    <CardContent className="p-0">
                      <div className="flex items-stretch">
                        <div className="w-[100px] h-[88px] bg-muted" />
                        <div className="flex-1 p-4 space-y-2">
                          <div className="h-5 bg-muted rounded w-1/3" />
                          <div className="h-4 bg-muted rounded w-1/2" />
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            ) : upcomingEvents.length === 0 ? (
              <EmptyState type="upcoming" />
            ) : (
              <div className="space-y-4">
                {upcomingEvents.map((event) => (
                  <EventCard key={event.id} event={event} />
                ))}
              </div>
            )}
          </TabsContent>

          <TabsContent value="previous" className="space-y-4">
            {previousEvents.length === 0 ? (
              <EmptyState type="previous" />
            ) : (
              <div className="space-y-4 opacity-75">
                {previousEvents.map((event) => (
                  <EventCard key={event.id} event={event} />
                ))}
              </div>
            )}
          </TabsContent>
        </Tabs>
      </main>

      {/* Create Event Modal */}
      <CreateEventModal open={showCreateModal} onOpenChange={setShowCreateModal} onEventCreated={loadEvents} />
    </div>
  )
}
</file>

<file path="app/admin/library/page.tsx">
import { redirect } from "next/navigation"
import { createClient } from "@/lib/supabase/server"
import { getResources } from "@/app/actions/resources"
import { LibraryManager } from "@/components/admin/library-manager"

export default async function LibraryPage() {
    const supabase = await createClient()

    // Check authentication
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
        redirect("/login")
    }

    // Verify admin role
    const { data: profile } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single()

    if (profile?.role !== "admin") {
        redirect("/student")
    }

    // Fetch resources
    const { resources, error } = await getResources()

    if (error) {
        console.error("Error fetching resources:", error)
    }

    // Fetch all students for assignment dropdown
    const { data: students } = await supabase
        .from("profiles")
        .select("id, name, email")
        .eq("role", "student")
        .order("name")

    return (
        <div className="min-h-screen bg-background">
            <div className="container mx-auto py-8 px-4">
                <LibraryManager
                    initialResources={resources || []}
                    students={students || []}
                />
            </div>
        </div>
    )
}
</file>

<file path="app/admin/logs/page.tsx">
import { createClient } from '@/lib/supabase/server'
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table"
import { Badge } from "@/components/ui/badge"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { ShieldAlert } from "lucide-react"
import Link from "next/link"
import { Button } from "@/components/ui/button"
import { LocalTimestamp } from "@/components/local-timestamp"

export const dynamic = 'force-dynamic'

export default async function AuthLogsPage() {
    const supabase = await createClient()

    // Fetch logs (admin only policed by RLS / layout)
    const { data: logs, error } = await supabase
        .from('auth_audit_logs')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(50)

    if (error) {
        return (
            <div className="p-4 text-red-500">
                Failed to load logs: {error.message}
            </div>
        )
    }



    const getStatusBadge = (status: string) => {
        if (status === 'success') return <Badge className="bg-green-600">Success</Badge>
        if (status === 'failure') return <Badge variant="destructive">Failure</Badge>
        return <Badge variant="outline">{status}</Badge>
    }

    const getEventBadge = (type: string) => {
        switch (type) {
            case 'login': return <Badge variant="outline" className="border-blue-200 bg-blue-50 text-blue-700">Login</Badge>
            case 'failed_login': return <Badge variant="outline" className="border-red-200 bg-red-50 text-red-700">Failed Login</Badge>
            case 'reset_request': return <Badge variant="outline" className="border-yellow-200 bg-yellow-50 text-yellow-700">Reset Req</Badge>
            case 'reset_completed': return <Badge variant="outline" className="border-green-200 bg-green-50 text-green-700">Reset Done</Badge>
            default: return <Badge variant="secondary">{type}</Badge>
        }
    }

    return (
        <div className="space-y-6">
            <div className="flex items-center space-x-2">
                <ShieldAlert className="h-6 w-6 text-muted-foreground" />
                <h1 className="text-3xl font-bold tracking-tight">Login & Security Logs</h1>
            </div>

            <div className="flex justify-end">
                <Button variant="outline" asChild>
                    <Link href="/admin">
                        Back to Admin Dashboard
                    </Link>
                </Button>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle>Recent Activity</CardTitle>
                    <CardDescription>
                        Showing the last 50 authentication events.
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead className="w-[180px]">Timestamp</TableHead>
                                <TableHead>User / Email</TableHead>
                                <TableHead>Event</TableHead>
                                <TableHead>Status</TableHead>
                                <TableHead>Details</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {logs?.map((log) => (
                                <TableRow key={log.id}>
                                    <TableCell className="font-mono text-xs text-muted-foreground">
                                        <LocalTimestamp date={log.created_at} />
                                    </TableCell>
                                    <TableCell>{log.user_email}</TableCell>
                                    <TableCell>{getEventBadge(log.event_type)}</TableCell>
                                    <TableCell>{getStatusBadge(log.status)}</TableCell>
                                    <TableCell className="text-sm text-muted-foreground max-w-[300px] truncate">
                                        {log.details || '-'}
                                    </TableCell>
                                </TableRow>
                            ))}
                            {logs?.length === 0 && (
                                <TableRow>
                                    <TableCell colSpan={5} className="text-center py-8 text-muted-foreground">
                                        No logs found.
                                    </TableCell>
                                </TableRow>
                            )}
                        </TableBody>
                    </Table>
                </CardContent>
            </Card>
        </div>
    )
}
</file>

<file path="app/admin/reviews/page.tsx">
"use client"

import { useEffect, useState } from "react"
import { getAllReviews, updateReviewStatus, deleteReview } from "@/app/actions/reviews"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { Trash2, CheckCircle, XCircle, ArrowLeft } from "lucide-react"
import { useToast } from "@/hooks/use-toast"
import { StarRating } from "@/app/reviews/star-rating"
import Link from "next/link"

interface Review {
    id: string
    name: string
    rating: number
    text: string
    status: 'pending' | 'approved' | 'rejected'
    created_at: string
    student_id: string | null
    profiles?: {
        email?: string
    }
}

export default function AdminReviewsPage() {
    const [reviews, setReviews] = useState<Review[]>([])
    const [isLoading, setIsLoading] = useState(true)
    const { toast } = useToast()

    const fetchReviews = async () => {
        setIsLoading(true)
        const result = await getAllReviews()
        if (result.error) {
            toast({
                variant: "destructive",
                title: "Error fetching reviews",
                description: result.error
            })
        } else {
            setReviews(result.data as any || [])
        }
        setIsLoading(false)
    }

    useEffect(() => {
        fetchReviews()
    }, [])

    const handleUpdateStatus = async (id: string, status: 'approved' | 'rejected') => {
        const result = await updateReviewStatus(id, status)
        if (result.error) {
            toast({
                variant: "destructive",
                title: "Update Failed",
                description: result.error
            })
        } else {
            toast({
                title: "Status Updated",
                description: `Review marked as ${status}`
            })
            fetchReviews()
        }
    }

    const handleDelete = async (id: string) => {
        if (!confirm("Are you sure you want to delete this review?")) return

        const result = await deleteReview(id)
        if (result.error) {
            toast({
                variant: "destructive",
                title: "Delete Failed",
                description: result.error
            })
        } else {
            toast({
                title: "Review Deleted",
                description: "The review has been permanently deleted."
            })
            fetchReviews()
        }
    }

    const getStatusBadge = (status: string) => {
        switch (status) {
            case 'approved': return <Badge className="bg-green-600">Approved</Badge>
            case 'rejected': return <Badge variant="destructive">Rejected</Badge>
            default: return <Badge variant="secondary">Pending</Badge>
        }
    }

    return (
        <div className="container mx-auto px-4 py-8 max-w-7xl">
            <div className="mb-8 flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-serif font-bold">Reviews Management</h1>
                    <p className="text-muted-foreground">Approve, reject, or delete student reviews.</p>
                </div>
                <Button variant="outline" asChild>
                    <Link href="/admin" className="gap-2">
                        <ArrowLeft className="h-4 w-4" />
                        Back to Dashboard
                    </Link>
                </Button>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle>All Reviews</CardTitle>
                    <CardDescription>
                        {reviews.length} reviews found
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    {isLoading ? (
                        <div className="text-center py-10">Loading reviews...</div>
                    ) : reviews.length === 0 ? (
                        <div className="text-center py-10 text-muted-foreground">No reviews found.</div>
                    ) : (
                        <div className="rounded-md border">
                            <Table>
                                <TableHeader>
                                    <TableRow>
                                        <TableHead className="w-[150px]">Date</TableHead>
                                        <TableHead className="w-[150px]">Student</TableHead>
                                        <TableHead className="w-[100px]">Rating</TableHead>
                                        <TableHead>Review</TableHead>
                                        <TableHead className="w-[100px]">Status</TableHead>
                                        <TableHead className="text-right">Actions</TableHead>
                                    </TableRow>
                                </TableHeader>
                                <TableBody>
                                    {reviews.map((review) => (
                                        <TableRow key={review.id}>
                                            <TableCell className="font-medium">
                                                {new Date(review.created_at).toLocaleDateString()}
                                            </TableCell>
                                            <TableCell>
                                                <div className="flex flex-col">
                                                    <span className="font-medium">{review.name}</span>
                                                    {review.profiles?.email && (
                                                        <span className="text-xs text-muted-foreground truncate max-w-[140px]" title={review.profiles.email}>
                                                            {review.profiles.email}
                                                        </span>
                                                    )}
                                                </div>
                                            </TableCell>
                                            <TableCell>
                                                <StarRating rating={review.rating} />
                                            </TableCell>
                                            <TableCell>
                                                <p className="max-w-[400px] truncate" title={review.text}>
                                                    "{review.text}"
                                                </p>
                                            </TableCell>
                                            <TableCell>
                                                {getStatusBadge(review.status)}
                                            </TableCell>
                                            <TableCell className="text-right">
                                                <div className="flex justify-end gap-2">
                                                    {review.status !== 'approved' && (
                                                        <Button size="icon" variant="outline" className="h-8 w-8 text-green-600 hover:text-green-700 hover:bg-green-50" onClick={() => handleUpdateStatus(review.id, 'approved')} title="Approve">
                                                            <CheckCircle className="h-4 w-4" />
                                                        </Button>
                                                    )}
                                                    {review.status !== 'rejected' && (
                                                        <Button size="icon" variant="outline" className="h-8 w-8 text-orange-600 hover:text-orange-700 hover:bg-orange-50" onClick={() => handleUpdateStatus(review.id, 'rejected')} title="Reject">
                                                            <XCircle className="h-4 w-4" />
                                                        </Button>
                                                    )}
                                                    <Button size="icon" variant="ghost" className="h-8 w-8 text-destructive hover:bg-destructive/10" onClick={() => handleDelete(review.id)} title="Delete">
                                                        <Trash2 className="h-4 w-4" />
                                                    </Button>
                                                </div>
                                            </TableCell>
                                        </TableRow>
                                    ))}
                                </TableBody>
                            </Table>
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    )
}
</file>

<file path="app/admin/actions.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'

/**
 * Log a completed lesson - updates status to 'completed' and deducts 1 credit
 */
export async function logLesson(
    lessonId: string,
    notes: string,
    videoUrl?: string,
    sheetMusicUrl?: string
) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can log lessons' }
    }

    // Get the lesson to find the student_id
    const { data: lesson, error: lessonFetchError } = await supabase
        .from('lessons')
        .select('student_id')
        .eq('id', lessonId)
        .single()

    if (lessonFetchError || !lesson) {
        return { error: 'Lesson not found' }
    }

    // Update the lesson
    const { error: lessonError } = await supabase
        .from('lessons')
        .update({
            status: 'completed',
            notes,
            video_url: videoUrl || null,
            sheet_music_url: sheetMusicUrl || null
        })
        .eq('id', lessonId)

    if (lessonError) {
        return { error: lessonError.message }
    }

    // Deduct 1 credit from the student
    const { error: creditError } = await supabase.rpc('deduct_credit', {
        student_id: lesson.student_id
    })

    // If RPC doesn't exist, try direct update
    if (creditError) {
        const { data: student } = await supabase
            .from('profiles')
            .select('credits')
            .eq('id', lesson.student_id)
            .single()

        if (student && student.credits > 0) {
            await supabase
                .from('profiles')
                .update({ credits: student.credits - 1 })
                .eq('id', lesson.student_id)
        }
    }

    revalidatePath('/admin')
    return { success: true }
}

/**
 * Mark a lesson as no-show - updates status and deducts 1 credit without refund
 */
export async function markNoShow(lessonId: string) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can mark no-shows' }
    }

    // Get the lesson to find the student_id
    const { data: lesson, error: lessonFetchError } = await supabase
        .from('lessons')
        .select('student_id')
        .eq('id', lessonId)
        .single()

    if (lessonFetchError || !lesson) {
        return { error: 'Lesson not found' }
    }

    // Update the lesson status to cancelled (treating no-show as cancelled)
    const { error: lessonError } = await supabase
        .from('lessons')
        .update({
            status: 'cancelled',
            notes: 'Marked as No-Show by teacher'
        })
        .eq('id', lessonId)

    if (lessonError) {
        return { error: lessonError.message }
    }

    // Deduct 1 credit from the student (no refund for no-show)
    const { data: student } = await supabase
        .from('profiles')
        .select('credits')
        .eq('id', lesson.student_id)
        .single()

    if (student && student.credits > 0) {
        await supabase
            .from('profiles')
            .update({ credits: student.credits - 1 })
            .eq('id', lesson.student_id)
    }

    revalidatePath('/admin')
    return { success: true }
}
</file>

<file path="app/api/cron/process-recordings/route.ts">
import { NextResponse } from 'next/server'
import { Dropbox } from 'dropbox'
import { createClient } from '@/lib/supabase/server'

// Force dynamic to ensure it runs every time (no caching)
export const dynamic = 'force-dynamic'

export async function GET(request: Request) {
    // Initialize a log array to return to the user for easy debugging
    const logs: string[] = []
    const log = (message: string) => {
        console.log(message) // Log to Vercel Console
        logs.push(message)   // Add to response array
    }

    log("ðŸš€ Starting Nightly Janitor Process...")

    // 1. Initialize Dropbox & Supabase
    const refresh_token = process.env.DROPBOX_REFRESH_TOKEN
    const clientId = process.env.DROPBOX_CLIENT_ID
    const clientSecret = process.env.DROPBOX_CLIENT_SECRET

    // Default to root if variable is missing, but log it clearly
    const sourceRoot = process.env.DROPBOX_SOURCE_PATH || ''
    log(`ðŸ“‚ Target Source Folder: "${sourceRoot || '(Dropbox Root)'}"`)

    if (!refresh_token || !clientId || !clientSecret) {
        const error = 'âŒ CRITICAL: Missing Dropbox Credentials in Environment Variables'
        console.error(error)
        return NextResponse.json({ error, logs }, { status: 500 })
    }

    const dbx = new Dropbox({
        clientId,
        clientSecret,
        refreshToken: refresh_token
    })

    const supabase = await createClient()
    const results = []
    const errors = []

    try {
        // 2. List all folders in the source directory
        log("ðŸ” Scanning Dropbox for folders...")
        const listResponse = await dbx.filesListFolder({ path: sourceRoot })
        const entries = listResponse.result.entries

        log(`ðŸ“Š Found ${entries.length} items in source folder.`)

        if (entries.length === 0) {
            log("âš ï¸ WARNING: Source folder is empty. Is 'DROPBOX_SOURCE_PATH' correct?")
        }

        for (const entry of entries) {
            const folderName = entry.name

            // We only care about FOLDERS (Zoom creates a folder per meeting)
            if (entry['.tag'] !== 'folder') {
                log(`â­ï¸ Skipping "${folderName}" (Not a folder)`)
                continue
            }

            // 3. Parse the Folder Name
            // Regex: Match Date (YYYY_MM_DD) and Name (between space and "_ Piano Lesson")
            const regex = /^(\d{4}_\d{2}_\d{2})T[\d-]+\s+(.+?)\s+_\s+Piano Lesson/
            const match = folderName.match(regex)

            if (!match) {
                log(`âš ï¸ Skipping "${folderName}": Name format does not match regex.`)
                continue
            }

            const rawDate = match[1] // 2025_12_15
            const studentName = match[2].trim() // Padhma Berk
            const lessonDate = rawDate.replace(/_/g, '-') // 2025-12-15

            log(`âœ… Processing Match: Student="${studentName}", Date="${lessonDate}"`)

            // 4. Find the Student in Supabase
            log(`ðŸ”Ž Database: Searching for student "${studentName}"...`)
            const { data: student } = await supabase
                .from('profiles')
                .select('id')
                .eq('name', studentName)
                .single()

            if (!student) {
                const msg = `âŒ Student not found in DB: "${studentName}"`
                log(msg)
                errors.push({ file: folderName, error: msg })
                continue
            }
            log(`ðŸ‘¤ Student Found! ID: ${student.id}`)

            // 5. Find the Lesson in Supabase
            log(`ðŸ”Ž Database: Searching for lesson on ${lessonDate}...`)
            const { data: lesson } = await supabase
                .from('lessons')
                .select('id')
                .eq('student_id', student.id)
                .eq('date', lessonDate)
                .single()

            if (!lesson) {
                const msg = `âŒ Lesson row not found for ${studentName} on ${lessonDate}`
                log(msg)
                errors.push({ file: folderName, error: msg })
                continue
            }
            log(`ðŸ“… Lesson Found! ID: ${lesson.id}`)

            // 6. Move the Folder on Dropbox
            const targetFolder = `/Lesson Recordings/${studentName} Recordings/${folderName}`
            log(`ðŸšš Moving Dropbox folder to: "${targetFolder}"...`)

            try {
                // Move the entire folder
                await dbx.filesMoveV2({
                    from_path: entry.path_lower!,
                    to_path: targetFolder,
                    autorename: true
                })
                log(`âœ… Move Successful.`)

                // 7. Find the .mp4 file INSIDE the moved folder
                log(`ðŸŽ¥ Scanning inside new folder for .mp4...`)
                const folderContent = await dbx.filesListFolder({ path: targetFolder })
                const videoFile = folderContent.result.entries.find(f => f.name.endsWith('.mp4'))

                if (!videoFile) {
                    throw new Error('No .mp4 file found inside moved folder')
                }
                log(`âœ… Found video file: "${videoFile.name}"`)

                // 8. Generate Link for the .mp4
                log(`ðŸ”— Generating shared link...`)
                const linkResponse = await dbx.sharingCreateSharedLinkWithSettings({
                    path: videoFile.path_lower!
                })
                const videoUrl = linkResponse.result.url
                log(`âœ… Link Created: ${videoUrl}`)

                // 9. Update Supabase
                log(`ðŸ’¾ Updating Supabase Lesson ID ${lesson.id}...`)
                const { error: updateError } = await supabase
                    .from('lessons')
                    .update({
                        video_url: videoUrl,
                        status: 'completed'
                    })
                    .eq('id', lesson.id)

                if (updateError) throw updateError
                log(`ðŸŽ‰ SUCCESS: Lesson updated completely.`)

                results.push({
                    student: studentName,
                    date: lessonDate,
                    status: 'Success',
                    video: videoUrl
                })

            } catch (err: any) {
                const msg = `âŒ Error during Dropbox Ops/DB Update: ${err.message}`
                console.error(msg)
                log(msg)
                errors.push({ file: folderName, error: err.message })
            }
        }

        log("ðŸ Janitor Run Complete.")

        return NextResponse.json({
            success: true,
            processed: results.length,
            results,
            errors,
            logs // We return the full log history in the JSON response
        })

    } catch (globalError: any) {
        console.error('Critical Script Failure:', globalError)
        return NextResponse.json({
            error: globalError.message,
            logs
        }, { status: 500 })
    }
}
</file>

<file path="app/auth/callback/route.ts">
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
    const { searchParams, origin } = new URL(request.url)
    const code = searchParams.get('code')
    const next = searchParams.get('next') ?? '/student'

    if (code) {
        const supabase = await createClient()
        const { error } = await supabase.auth.exchangeCodeForSession(code)

        if (!error) {
            return NextResponse.redirect(`${origin}${next}`)
        }
    }

    // Return the user to an error page with instructions
    return NextResponse.redirect(`${origin}/login?error=Could not authenticate`)
}
</file>

<file path="app/forgot-password/page.tsx">
"use client"

import { useState } from "react"
import Link from "next/link"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Music, ArrowLeft, Loader2, Mail, CheckCircle } from "lucide-react"
import { sendResetLink } from "@/app/login/actions"

export default function ForgotPasswordPage() {
    const [isLoading, setIsLoading] = useState(false)
    const [error, setError] = useState("")
    const [success, setSuccess] = useState(false)

    async function handleSubmit(formData: FormData) {
        setIsLoading(true)
        setError("")

        const result = await sendResetLink(formData)

        setIsLoading(false)

        if (result.error) {
            setError(result.error)
        } else if (result.success) {
            setSuccess(true)
        }
    }

    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4">
            <Card className="w-full max-w-md">
                <CardHeader className="text-center">
                    <div className="flex justify-center mb-4">
                        <div className="h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center">
                            <Music className="h-8 w-8 text-primary" />
                        </div>
                    </div>
                    <CardTitle className="text-2xl font-serif">Reset Password</CardTitle>
                    <CardDescription>
                        Enter your email and we&apos;ll send you a link to reset your password
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    {success ? (
                        <div className="text-center space-y-4">
                            <div className="h-16 w-16 rounded-full bg-green-100 flex items-center justify-center mx-auto">
                                <CheckCircle className="h-8 w-8 text-green-600" />
                            </div>
                            <h3 className="font-semibold text-lg">Check your email</h3>
                            <p className="text-muted-foreground text-sm">
                                We&apos;ve sent a password reset link to your email address.
                                Click the link in the email to reset your password.
                            </p>
                            <Link href="/login">
                                <Button variant="outline" className="mt-4">
                                    <ArrowLeft className="h-4 w-4 mr-2" />
                                    Back to Login
                                </Button>
                            </Link>
                        </div>
                    ) : (
                        <form action={handleSubmit} className="space-y-4">
                            <div className="space-y-2">
                                <Label htmlFor="email">Email</Label>
                                <div className="relative">
                                    <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                                    <Input
                                        id="email"
                                        name="email"
                                        type="email"
                                        placeholder="you@example.com"
                                        className="pl-10"
                                        required
                                    />
                                </div>
                            </div>

                            {error && (
                                <p className="text-sm text-red-600 bg-red-50 p-3 rounded-md">
                                    {error}
                                </p>
                            )}

                            <Button type="submit" className="w-full" disabled={isLoading}>
                                {isLoading ? (
                                    <>
                                        <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                                        Sending...
                                    </>
                                ) : (
                                    "Send Reset Link"
                                )}
                            </Button>

                            <div className="text-center">
                                <Link
                                    href="/login"
                                    className="text-sm text-muted-foreground hover:text-primary transition-colors"
                                >
                                    <ArrowLeft className="h-3 w-3 inline mr-1" />
                                    Back to Login
                                </Link>
                            </div>
                        </form>
                    )}
                </CardContent>
            </Card>
        </div>
    )
}
</file>

<file path="app/login/actions.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { headers } from 'next/headers'
import { logAuthEvent } from '@/lib/logger'

export async function login(formData: FormData) {
    const supabase = await createClient()

    const data = {
        email: formData.get('email') as string,
        password: formData.get('password') as string,
    }

    const { error } = await supabase.auth.signInWithPassword(data)

    if (error) {
        await logAuthEvent(data.email, 'failed_login', 'failure', error.message)
        return { error: error.message }
    }

    await logAuthEvent(data.email, 'login', 'success')

    // Get user profile to determine redirect
    const { data: { user } } = await supabase.auth.getUser()

    if (user) {
        const { data: profile } = await supabase
            .from('profiles')
            .select('role')
            .eq('id', user.id)
            .single()

        revalidatePath('/', 'layout')

        if (profile?.role === 'admin') {
            redirect('/admin')
        } else {
            redirect('/student')
        }
    }

    revalidatePath('/', 'layout')
    redirect('/student')
}

export async function logout() {
    const supabase = await createClient()
    await supabase.auth.signOut()
    revalidatePath('/', 'layout')
    redirect('/login')
}

export async function sendResetLink(formData: FormData) {
    const supabase = await createClient()
    const email = formData.get('email') as string

    if (!email) {
        return { error: 'Email is required' }
    }

    // Get the origin from headers
    const headersList = await headers()
    const origin = headersList.get('origin') || 'http://localhost:3000'

    const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${origin}/auth/callback?next=/reset-password`,
    })

    if (error) {
        return { error: error.message }
    }

    await logAuthEvent(email, 'reset_request', 'success')
    return { success: true, message: 'Password reset link sent to your email' }
}

export async function updatePassword(formData: FormData) {
    const supabase = await createClient()
    const password = formData.get('password') as string
    const confirmPassword = formData.get('confirmPassword') as string

    if (!password || !confirmPassword) {
        return { error: 'Both password fields are required' }
    }

    if (password !== confirmPassword) {
        return { error: 'Passwords do not match' }
    }

    if (password.length < 6) {
        return { error: 'Password must be at least 6 characters' }
    }

    const { error } = await supabase.auth.updateUser({ password })

    if (error) {
        return { error: error.message }
    }

    // Get user profile to determine redirect
    const { data: { user } } = await supabase.auth.getUser()

    if (user?.email) {
        await logAuthEvent(user.email, 'reset_completed', 'success')
    }

    if (user) {
        const { data: profile } = await supabase
            .from('profiles')
            .select('role')
            .eq('id', user.id)
            .single()

        revalidatePath('/', 'layout')

        if (profile?.role === 'admin') {
            redirect('/admin')
        } else {
            redirect('/student')
        }
    }

    revalidatePath('/', 'layout')
    redirect('/student')
}
</file>

<file path="app/reset-password/page.tsx">
"use client"

import { useState } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Music, Loader2, Lock, Eye, EyeOff } from "lucide-react"
import { updatePassword } from "@/app/login/actions"

export default function ResetPasswordPage() {
    const [isLoading, setIsLoading] = useState(false)
    const [error, setError] = useState("")
    const [showPassword, setShowPassword] = useState(false)
    const [showConfirmPassword, setShowConfirmPassword] = useState(false)

    async function handleSubmit(formData: FormData) {
        setIsLoading(true)
        setError("")

        const result = await updatePassword(formData)

        setIsLoading(false)

        if (result?.error) {
            setError(result.error)
        }
        // On success, the action will redirect
    }

    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4">
            <Card className="w-full max-w-md">
                <CardHeader className="text-center">
                    <div className="flex justify-center mb-4">
                        <div className="h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center">
                            <Music className="h-8 w-8 text-primary" />
                        </div>
                    </div>
                    <CardTitle className="text-2xl font-serif">Set New Password</CardTitle>
                    <CardDescription>
                        Enter your new password below
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <form action={handleSubmit} className="space-y-4">
                        <div className="space-y-2">
                            <Label htmlFor="password">New Password</Label>
                            <div className="relative">
                                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                                <Input
                                    id="password"
                                    name="password"
                                    type={showPassword ? "text" : "password"}
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                    className="pl-10 pr-10"
                                    minLength={6}
                                    required
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowPassword(!showPassword)}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground"
                                >
                                    {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                                </button>
                            </div>
                            <p className="text-xs text-muted-foreground">
                                Must be at least 6 characters
                            </p>
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="confirmPassword">Confirm Password</Label>
                            <div className="relative">
                                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                                <Input
                                    id="confirmPassword"
                                    name="confirmPassword"
                                    type={showConfirmPassword ? "text" : "password"}
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                    className="pl-10 pr-10"
                                    minLength={6}
                                    required
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground"
                                >
                                    {showConfirmPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                                </button>
                            </div>
                        </div>

                        {error && (
                            <p className="text-sm text-red-600 bg-red-50 p-3 rounded-md">
                                {error}
                            </p>
                        )}

                        <Button type="submit" className="w-full" disabled={isLoading}>
                            {isLoading ? (
                                <>
                                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                                    Updating...
                                </>
                            ) : (
                                "Update Password"
                            )}
                        </Button>
                    </form>
                </CardContent>
            </Card>
        </div>
    )
}
</file>

<file path="app/reviews/page.tsx">
import Link from "next/link"
import { Music } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Card, CardContent } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { getApprovedReviews } from "@/app/actions/reviews"
import { StarRating } from "./star-rating"
import { SubmitReview } from "./submit-review"

// Format date utility
const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
    })
}

const getStudentSinceYear = (profileCreatedAt?: string) => {
    if (!profileCreatedAt) return null
    return new Date(profileCreatedAt).getFullYear()
}

export default async function ReviewsPage() {
    const reviews = await getApprovedReviews()

    return (
        <div className="min-h-screen bg-background">
            {/* Navigation */}
            <nav className="border-b bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/60 sticky top-0 z-50">
                <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                    <Link href="/" className="flex items-center gap-2">
                        <Music className="h-6 w-6" />
                        <span className="font-serif text-xl font-bold">Lionel Yu Piano Studio</span>
                    </Link>
                    <Link href="/login">
                        <Button variant="outline" size="sm">
                            Student Login
                        </Button>
                    </Link>
                </div>
            </nav>

            {/* Header */}
            <section className="py-16 border-b">
                <div className="container mx-auto px-4">
                    <div className="max-w-3xl mx-auto text-center space-y-4">
                        <h1 className="font-serif text-5xl lg:text-6xl font-bold tracking-tight">Student Reviews</h1>
                        <p className="text-xl text-muted-foreground">Hear from the studio community.</p>
                        <div className="h-1 w-20 bg-foreground mx-auto" />
                    </div>
                </div>
            </section>

            {/* Reviews Masonry Grid */}
            <section className="py-16">
                <div className="container mx-auto px-4">
                    <div className="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6">
                        {reviews.map((review: any) => {
                            const profile = review.profiles
                            const studentSince = profile?.created_at ? getStudentSinceYear(profile.created_at) : null

                            return (
                                <Card
                                    key={review.id}
                                    className="break-inside-avoid border bg-background shadow-sm hover:shadow-md transition-shadow"
                                >
                                    <CardContent className="pt-6 space-y-4">
                                        {/* Star Rating */}
                                        <StarRating rating={review.rating} />

                                        {/* Review Text */}
                                        <blockquote className="text-lg leading-relaxed text-foreground">"{review.text}"</blockquote>

                                        {/* Footer */}
                                        <div className="pt-4 border-t flex items-center justify-between">
                                            <span className="font-serif font-semibold text-foreground">{review.name}</span>
                                            {studentSince ? (
                                                <Badge variant="secondary" className="text-xs font-normal">
                                                    Student since {studentSince}
                                                </Badge>
                                            ) : (
                                                <span className="text-xs text-muted-foreground">{formatDate(review.created_at)}</span>
                                            )}
                                        </div>
                                    </CardContent>
                                </Card>
                            )
                        })}
                        {reviews.length === 0 && (
                            <div className="col-span-full text-center py-10 text-muted-foreground">
                                No reviews yet. Be the first to share your experience!
                            </div>
                        )}
                    </div>
                </div>
            </section>

            {/* Floating Action Button & Modal */}
            <SubmitReview />

            {/* Footer */}
            <footer className="border-t bg-muted/30">
                <div className="container mx-auto px-4 py-8">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <Link href="/" className="flex items-center gap-2">
                            <Music className="h-5 w-5" />
                            <span className="font-serif font-bold">Piano Studio</span>
                        </Link>
                        <p className="text-sm text-muted-foreground">Â© 2025 Piano Studio. All rights reserved.</p>
                    </div>
                </div>
            </footer>
        </div>
    )
}
</file>

<file path="app/reviews/star-rating.tsx">
"use client"

import { useState } from "react"
import { Star } from "lucide-react"

interface StarRatingProps {
    rating: number
    onRatingChange?: (rating: number) => void
    interactive?: boolean
}

export function StarRating({
    rating,
    onRatingChange,
    interactive = false,
}: StarRatingProps) {
    const [hoverRating, setHoverRating] = useState(0)

    return (
        <div className="flex gap-1">
            {[1, 2, 3, 4, 5].map((star) => (
                <button
                    key={star}
                    type="button"
                    disabled={!interactive}
                    onClick={() => interactive && onRatingChange?.(star)}
                    onMouseEnter={() => interactive && setHoverRating(star)}
                    onMouseLeave={() => interactive && setHoverRating(0)}
                    className={interactive ? "cursor-pointer transition-transform hover:scale-110" : "cursor-default"}
                >
                    <Star
                        className={`h-5 w-5 transition-colors ${star <= (hoverRating || rating) ? "fill-foreground text-foreground" : "text-muted-foreground/30"
                            }`}
                    />
                </button>
            ))}
        </div>
    )
}
</file>

<file path="app/reviews/submit-review.tsx">
"use client"

import { useState } from "react"
import { Button } from "@/components/ui/button"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Label } from "@/components/ui/label"
import { PenLine, CheckCircle } from "lucide-react"
import { StarRating } from "./star-rating"
import { submitReview } from "@/app/actions/reviews"

export function SubmitReview() {
    const [isModalOpen, setIsModalOpen] = useState(false)
    const [isSubmitted, setIsSubmitted] = useState(false)
    const [formData, setFormData] = useState({
        name: "",
        review: "",
        rating: 0,
    })
    const [isSubmitting, setIsSubmitting] = useState(false)
    const [error, setError] = useState<string | null>(null)

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        setIsSubmitting(true)
        setError(null)

        const data = new FormData()
        data.append("name", formData.name)
        data.append("review", formData.review)
        data.append("rating", formData.rating.toString())

        try {
            const result = await submitReview(data)

            if (result.error) {
                setError(result.error)
                setIsSubmitting(false)
                return
            }

            setIsSubmitting(false)
            setIsSubmitted(true)
        } catch (err) {
            console.error(err)
            setError("An unexpected error occurred.")
            setIsSubmitting(false)
        }
    }

    const handleCloseModal = () => {
        setIsModalOpen(false)
        // Reset form after modal closes
        setTimeout(() => {
            setIsSubmitted(false)
            setFormData({ name: "", review: "", rating: 0 })
            setError(null)
        }, 300)
    }

    return (
        <>
            <Button
                onClick={() => setIsModalOpen(true)}
                className="fixed bottom-8 right-8 h-auto py-4 px-6 rounded-full shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-200 z-40 bg-foreground text-background hover:bg-foreground/90"
            >
                <PenLine className="h-5 w-5 mr-3 flex-shrink-0" />
                <span className="text-sm font-medium">Are you a student of Lionel's? Submit a review here!</span>
            </Button>

            <Dialog open={isModalOpen} onOpenChange={handleCloseModal}>
                <DialogContent className="sm:max-w-md">
                    {!isSubmitted ? (
                        <>
                            <DialogHeader>
                                <DialogTitle className="font-serif text-2xl">Share Your Experience</DialogTitle>
                                <DialogDescription>Your feedback helps others discover the studio.</DialogDescription>
                            </DialogHeader>

                            <form onSubmit={handleSubmit} className="space-y-6 pt-4">
                                {error && (
                                    <div className="text-red-500 text-sm bg-red-50 p-2 rounded">
                                        {error}
                                    </div>
                                )}

                                {/* Name Input */}
                                <div className="space-y-2">
                                    <Label htmlFor="name">Your Name</Label>
                                    <Input
                                        id="name"
                                        placeholder="e.g., Sarah M."
                                        value={formData.name}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        required
                                    />
                                    <p className="text-xs text-muted-foreground">Displayed as shown (e.g., first name + last initial)</p>
                                </div>

                                {/* Star Rating */}
                                <div className="space-y-2">
                                    <Label>Rating</Label>
                                    <StarRating
                                        rating={formData.rating}
                                        onRatingChange={(rating) => setFormData({ ...formData, rating })}
                                        interactive
                                    />
                                </div>

                                {/* Review Textarea */}
                                <div className="space-y-2">
                                    <Label htmlFor="review">Your Review</Label>
                                    <Textarea
                                        id="review"
                                        placeholder="Tell us about your experience at the studio..."
                                        rows={4}
                                        value={formData.review}
                                        onChange={(e) => setFormData({ ...formData, review: e.target.value })}
                                        required
                                        className="resize-none"
                                    />
                                </div>

                                {/* Submit Button */}
                                <Button type="submit" className="w-full" disabled={isSubmitting || formData.rating === 0}>
                                    {isSubmitting ? (
                                        <span className="flex items-center gap-2">
                                            <span className="h-4 w-4 border-2 border-current border-t-transparent rounded-full animate-spin" />
                                            Submitting...
                                        </span>
                                    ) : (
                                        "Submit Review"
                                    )}
                                </Button>
                            </form>
                        </>
                    ) : (
                        // Success State
                        <div className="py-8 text-center space-y-4">
                            <div className="mx-auto w-16 h-16 bg-foreground rounded-full flex items-center justify-center">
                                <CheckCircle className="h-8 w-8 text-background" />
                            </div>
                            <div className="space-y-2">
                                <h3 className="font-serif text-2xl font-bold">Review Received</h3>
                                <p className="text-muted-foreground">Your review is awaiting approval to be published. Thank you!</p>
                            </div>
                            <Button onClick={handleCloseModal} variant="outline" className="mt-4 bg-transparent border-input">
                                Close
                            </Button>
                        </div>
                    )}
                </DialogContent>
            </Dialog>
        </>
    )
}
</file>

<file path="app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

:root {
  /* Piano Keys Theme - High Contrast Black & White */
  --background: oklch(1 0 0);
  --foreground: oklch(0.15 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.15 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.15 0 0);
  --primary: oklch(0.15 0 0);
  --primary-foreground: oklch(1 0 0);
  --secondary: oklch(0.95 0 0);
  --secondary-foreground: oklch(0.15 0 0);
  --muted: oklch(0.96 0 0);
  --muted-foreground: oklch(0.45 0 0);
  --accent: oklch(0.92 0 0);
  --accent-foreground: oklch(0.15 0 0);
  --destructive: oklch(0.55 0.22 25);
  --destructive-foreground: oklch(1 0 0);
  --border: oklch(0.88 0 0);
  --input: oklch(0.92 0 0);
  --ring: oklch(0.15 0 0);
  --chart-1: oklch(0.15 0 0);
  --chart-2: oklch(0.45 0 0);
  --chart-3: oklch(0.7 0 0);
  --chart-4: oklch(0.85 0 0);
  --chart-5: oklch(0.95 0 0);
  --radius: 0.375rem;
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
  /* Custom colors for Piano Studio */
  --success: oklch(0.5 0.15 145);
  --success-foreground: oklch(1 0 0);
  --warning: oklch(0.65 0.18 75);
  --warning-foreground: oklch(0.15 0 0);
}

.dark {
  /* Dark mode - Inverted Piano Keys */
  --background: oklch(0.12 0 0);
  --foreground: oklch(0.98 0 0);
  --card: oklch(0.15 0 0);
  --card-foreground: oklch(0.98 0 0);
  --popover: oklch(0.15 0 0);
  --popover-foreground: oklch(0.98 0 0);
  --primary: oklch(0.98 0 0);
  --primary-foreground: oklch(0.15 0 0);
  --secondary: oklch(0.2 0 0);
  --secondary-foreground: oklch(0.98 0 0);
  --muted: oklch(0.2 0 0);
  --muted-foreground: oklch(0.6 0 0);
  --accent: oklch(0.22 0 0);
  --accent-foreground: oklch(0.98 0 0);
  --destructive: oklch(0.55 0.22 25);
  --destructive-foreground: oklch(1 0 0);
  --border: oklch(0.25 0 0);
  --input: oklch(0.2 0 0);
  --ring: oklch(0.7 0 0);
  --chart-1: oklch(0.98 0 0);
  --chart-2: oklch(0.7 0 0);
  --chart-3: oklch(0.5 0 0);
  --chart-4: oklch(0.3 0 0);
  --chart-5: oklch(0.2 0 0);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(0.269 0 0);
  --sidebar-ring: oklch(0.439 0 0);
  /* Custom colors for Piano Studio */
  --success: oklch(0.5 0.15 145);
  --success-foreground: oklch(1 0 0);
  --warning: oklch(0.65 0.18 75);
  --warning-foreground: oklch(0.15 0 0);
}

@theme inline {
  --font-sans: "Geist", "Geist Fallback";
  --font-mono: "Geist Mono", "Geist Mono Fallback";
  --font-serif: "Playfair Display", Georgia, serif;
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-success: var(--success);
  --color-success-foreground: var(--success-foreground);
  --color-warning: var(--warning);
  --color-warning-foreground: var(--warning-foreground);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    @apply font-serif;
  }
}
</file>

<file path="app/layout.tsx">
import type React from "react"
import type { Metadata } from "next"
import { Geist, Geist_Mono, Playfair_Display } from "next/font/google"
import { Analytics } from "@vercel/analytics/next"
import "./globals.css"

const _geist = Geist({ subsets: ["latin"] })
const _geistMono = Geist_Mono({ subsets: ["latin"] })
const _playfair = Playfair_Display({ subsets: ["latin"] })

export const metadata: Metadata = {
  title: "Lionel Yu Piano Studio",
  description:
    "Master piano with personalized instruction, flexible scheduling, and a proven credit-based system designed for serious students.",

}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="en">
      <body className={`font-sans antialiased`}>
        {children}
        <Analytics />
      </body>
    </html>
  )
}
</file>

<file path="app/page.tsx">
import { createClient } from "@/lib/supabase/server"
import { DynamicLandingPage } from "@/components/dynamic-landing-page"
import { StaticLandingPage } from "@/components/static-landing-page"

export const dynamic = 'force-dynamic'

export default async function LandingPage() {
  const supabase = await createClient()

  // Fetch the home page content
  const { data: page } = await supabase
    .from('site_pages')
    .select('*')
    .eq('id', 'home')
    .single()

  // If dynamic content exists, render it
  if (page && page.html_template) {
    // Replace variables in the template
    let html = page.html_template
    const variables = page.variable_values || {}

    Object.entries(variables).forEach(([key, value]) => {
      html = html.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), value as string)
    })

    return (
      <DynamicLandingPage
        html={html}
        script={page.script_content || ""}
      />
    )
  }

  // Otherwise, render the static landing page
  return <StaticLandingPage />
}
</file>

<file path="components/admin/create-event-modal.tsx">
"use client"

import { useState, useEffect } from "react"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Checkbox } from "@/components/ui/checkbox"
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group"
import { Badge } from "@/components/ui/badge"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Loader2, Video, MapPin, Sparkles, Users } from "lucide-react"
import { getActiveStudents, createEvent, updateEvent, type CreateEventInput, type AdminEvent } from "@/app/actions/events"

// Helper to extract LOCAL date and time from an ISO string
const getLocalDateTime = (isoString: string) => {
  const date = new Date(isoString); // Creates a date object in User's Local Time (PST)

  // Manually build YYYY-MM-DD using local methods
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const localDate = `${year}-${month}-${day}`;

  // Manually build HH:mm using local methods
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const localTime = `${hours}:${minutes}`;

  return { localDate, localTime };
};

type Student = {
  id: string
  name: string
  email: string
}

type CreateEventModalProps = {
  open: boolean
  onOpenChange: (open: boolean) => void
  onEventCreated?: () => void
  eventToEdit?: AdminEvent | null
}

export function CreateEventModal({ open, onOpenChange, onEventCreated, eventToEdit }: CreateEventModalProps) {
  const [students, setStudents] = useState<Student[]>([])
  const [isLoadingStudents, setIsLoadingStudents] = useState(true)
  const [isSubmitting, setIsSubmitting] = useState(false)

  // Form state
  const [title, setTitle] = useState("")
  const [description, setDescription] = useState("")
  const [date, setDate] = useState("")
  const [startTime, setStartTime] = useState("")
  const [duration, setDuration] = useState("60")
  const [locationType, setLocationType] = useState<"virtual" | "physical">("virtual")
  const [locationAddress, setLocationAddress] = useState("")
  const [rsvpDeadline, setRsvpDeadline] = useState("")
  const [selectedStudents, setSelectedStudents] = useState<string[]>([])

  useEffect(() => {
    if (open) {
      setIsLoadingStudents(true)
      getActiveStudents().then((data) => {
        setStudents(data)
        setIsLoadingStudents(false)
      })

      if (eventToEdit) {
        setTitle(eventToEdit.title)
        setDescription(eventToEdit.description)

        // --- THE FIX: Convert UTC timestamp to Local Time before setting state ---
        // --- FIX: Handle both ISO (fresh fetch) and HH:MM (from Calendar) formats ---
        const timeValue = eventToEdit.start_time || ''
        const dateValue = eventToEdit.date || ''

        // Check if timeValue is an ISO string (contains 'T')
        if (timeValue.includes('T')) {
          const { localDate, localTime } = getLocalDateTime(timeValue)
          setDate(localDate)
          setStartTime(localTime)
        } else {
          // Assume it's already HH:MM and Date is YYYY-MM-DD
          setDate(dateValue)
          setStartTime(timeValue)
        }
        // ------------------------------------------------------------------------

        setDuration(eventToEdit.duration_minutes.toString())
        setLocationType(eventToEdit.location_type)
        setLocationAddress(eventToEdit.location_address || "")

        if (eventToEdit.rsvp_deadline) {
          if (eventToEdit.rsvp_deadline.includes('T')) {
            const { localDate: rsvpDate } = getLocalDateTime(eventToEdit.rsvp_deadline)
            setRsvpDeadline(rsvpDate)
          } else {
            setRsvpDeadline(eventToEdit.rsvp_deadline)
          }
        } else {
          setRsvpDeadline("")
        }

        // Invitees
        const invitedIds = eventToEdit.invites.map(i => i.student_id)
        setSelectedStudents(invitedIds)
      } else {
        resetForm()
      }
    }
  }, [open, eventToEdit])

  const handleSelectAll = () => {
    if (selectedStudents.length === students.length) {
      setSelectedStudents([])
    } else {
      setSelectedStudents(students.map((s) => s.id))
    }
  }

  const toggleStudent = (studentId: string) => {
    setSelectedStudents((prev) =>
      prev.includes(studentId) ? prev.filter((id) => id !== studentId) : [...prev, studentId],
    )
  }

  const resetForm = () => {
    setTitle("")
    setDescription("")
    setDate("")
    setStartTime("")
    setDuration("60")
    setLocationType("virtual")
    setLocationAddress("")
    setRsvpDeadline("")
    setSelectedStudents([])
  }

  const handleSubmit = async () => {
    if (!title || !date || !startTime || !rsvpDeadline || selectedStudents.length === 0) {
      return
    }

    setIsSubmitting(true)

    const input: CreateEventInput = {
      title,
      description,
      date,
      start_time: startTime,
      duration_minutes: Number.parseInt(duration),
      location_type: locationType,
      location_address: locationType === "physical" ? locationAddress : undefined,
      rsvp_deadline: rsvpDeadline,
      invited_student_ids: selectedStudents,
    }

    let result
    if (eventToEdit) {
      result = await updateEvent(eventToEdit.id, input)
    } else {
      result = await createEvent(input)
    }

    setIsSubmitting(false)

    if (result.success) {
      if (!eventToEdit) resetForm()
      onOpenChange(false)
      onEventCreated?.()
    }
  }

  // Calculate max RSVP date (must be before event date)
  const maxRsvpDate = date || undefined

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <DialogHeader>
          <DialogTitle className="text-2xl font-serif">{eventToEdit ? 'Edit Event' : 'Create Event'}</DialogTitle>
          <DialogDescription>
            {eventToEdit ? 'Update event details and manage invites' : 'Schedule a recital, workshop, or group class for your students'}
          </DialogDescription>
        </DialogHeader>

        <ScrollArea className="flex-1 pr-4">
          <div className="space-y-6 py-4">
            {/* Title */}
            <div className="space-y-2">
              <Label htmlFor="title">Event Title *</Label>
              <Input
                id="title"
                placeholder="e.g., Winter Recital 2025"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
              />
            </div>

            {/* Description */}
            <div className="space-y-2">
              <Label htmlFor="description">Description</Label>
              <Textarea
                id="description"
                placeholder="Describe the event..."
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                rows={3}
              />
            </div>

            {/* Date & Time Row */}
            <div className="grid grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label htmlFor="date">Date *</Label>
                <Input id="date" type="date" value={date} onChange={(e) => setDate(e.target.value)} />
              </div>
              <div className="space-y-2">
                <Label htmlFor="time">Start Time *</Label>
                <Input id="time" type="time" value={startTime} onChange={(e) => setStartTime(e.target.value)} />
              </div>
              <div className="space-y-2">
                <Label htmlFor="duration">Duration</Label>
                <select
                  id="duration"
                  value={duration}
                  onChange={(e) => setDuration(e.target.value)}
                  className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                >
                  <option value="30">30 min</option>
                  <option value="45">45 min</option>
                  <option value="60">1 hour</option>
                  <option value="90">1.5 hours</option>
                  <option value="120">2 hours</option>
                </select>
              </div>
            </div>

            {/* Location Type */}
            <div className="space-y-3">
              <Label>Location *</Label>
              <RadioGroup
                value={locationType}
                onValueChange={(v) => setLocationType(v as "virtual" | "physical")}
                className="flex gap-4"
              >
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="virtual" id="virtual" />
                  <Label htmlFor="virtual" className="flex items-center gap-2 font-normal cursor-pointer">
                    <Video className="h-4 w-4" />
                    Virtual (Zoom)
                  </Label>
                </div>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="physical" id="physical" />
                  <Label htmlFor="physical" className="flex items-center gap-2 font-normal cursor-pointer">
                    <MapPin className="h-4 w-4" />
                    Physical Location
                  </Label>
                </div>
              </RadioGroup>

              {locationType === "virtual" ? (
                <Badge variant="secondary" className="gap-1">
                  <Sparkles className="h-3 w-3" />
                  Zoom link will be {eventToEdit?.zoom_link ? 'updated' : 'auto-generated'}
                </Badge>
              ) : (
                <Input
                  placeholder="Enter address..."
                  value={locationAddress}
                  onChange={(e) => setLocationAddress(e.target.value)}
                />
              )}
            </div>

            {/* RSVP Deadline */}
            <div className="space-y-2">
              <Label htmlFor="rsvp">RSVP Deadline *</Label>
              <Input
                id="rsvp"
                type="date"
                value={rsvpDeadline}
                onChange={(e) => setRsvpDeadline(e.target.value)}
                max={maxRsvpDate}
              />
              <p className="text-xs text-muted-foreground">Students must respond by this date</p>
            </div>

            {/* Student Selector */}
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <Label>Invite Students *</Label>
                <Button type="button" variant="outline" size="sm" onClick={handleSelectAll}>
                  {selectedStudents.length === students.length ? "Deselect All" : "Select All"}
                </Button>
              </div>

              {isLoadingStudents ? (
                <div className="flex items-center justify-center py-8">
                  <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
                </div>
              ) : (
                <div className="border rounded-lg divide-y max-h-48 overflow-y-auto">
                  {students.map((student) => (
                    <label
                      key={student.id}
                      className="flex items-center gap-3 p-3 hover:bg-muted/50 cursor-pointer transition-colors"
                    >
                      <Checkbox
                        checked={selectedStudents.includes(student.id)}
                        onCheckedChange={() => toggleStudent(student.id)}
                      />
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-sm">{student.name}</p>
                        <p className="text-xs text-muted-foreground truncate">{student.email}</p>
                      </div>
                      {eventToEdit?.invites.find(i => i.student_id === student.id) && (
                        <div className="text-xs text-muted-foreground mr-2">
                          {eventToEdit.invites.find(i => i.student_id === student.id)?.status}
                        </div>
                      )}
                    </label>
                  ))}
                </div>
              )}

              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                <Users className="h-4 w-4" />
                <span>
                  Inviting {selectedStudents.length} student{selectedStudents.length !== 1 ? "s" : ""}
                </span>
              </div>
            </div>
          </div>
        </ScrollArea>

        {/* Footer */}
        <div className="flex gap-3 justify-end pt-4 border-t">
          <Button variant="outline" onClick={() => onOpenChange(false)} disabled={isSubmitting}>
            Cancel
          </Button>
          <Button
            onClick={handleSubmit}
            disabled={!title || !date || !startTime || !rsvpDeadline || selectedStudents.length === 0 || isSubmitting}
          >
            {isSubmitting ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                {eventToEdit ? 'Updating...' : 'Creating...'}
              </>
            ) : (
              eventToEdit ? "Update Event" : "Create Event"
            )}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  )
}
</file>

<file path="components/admin/library-manager.tsx">
'use client'

import { useState, useRef, useCallback } from 'react'
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Badge } from '@/components/ui/badge'
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
} from '@/components/ui/dialog'
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from '@/components/ui/select'
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { useToast } from '@/hooks/use-toast'
import {
    Plus,
    Upload,
    MoreHorizontal,
    Pencil,
    Trash2,
    FileText,
    Music,
    Loader2,
    Users,
    ArrowLeft,
    CheckSquare,
    Square,
    Download,
} from 'lucide-react'
import Link from 'next/link'
import {
    Resource,
    ResourceCategory,
    createResource,
    updateResource,
    updateResourceAssignments,
    deleteResource,
    uploadLibraryFile,
    getResourceWithAssignments,
} from '@/app/actions/resources'

interface Student {
    id: string
    name: string
    email: string
}

interface LibraryManagerProps {
    initialResources: Resource[]
    students: Student[]
}

const CATEGORIES: ResourceCategory[] = ['Sheet Music', 'Theory', 'Scales', 'Exercises', 'Recording']

const categoryColors: Record<ResourceCategory, string> = {
    'Sheet Music': 'bg-blue-100 text-blue-800',
    'Theory': 'bg-purple-100 text-purple-800',
    'Scales': 'bg-green-100 text-green-800',
    'Exercises': 'bg-orange-100 text-orange-800',
    'Recording': 'bg-pink-100 text-pink-800',
}

export function LibraryManager({ initialResources, students }: LibraryManagerProps) {
    const { toast } = useToast()
    const [resources, setResources] = useState<Resource[]>(initialResources)
    const [isLoading, setIsLoading] = useState(false)

    // Upload Modal State
    const [showUploadModal, setShowUploadModal] = useState(false)
    const [uploadFile, setUploadFile] = useState<File | null>(null)
    const [uploadTitle, setUploadTitle] = useState('')
    const [uploadCategory, setUploadCategory] = useState<ResourceCategory>('Sheet Music')
    const [uploadDescription, setUploadDescription] = useState('')
    const [selectedStudents, setSelectedStudents] = useState<string[]>([])
    const [isDragging, setIsDragging] = useState(false)
    const fileInputRef = useRef<HTMLInputElement>(null)

    // Edit Modal State
    const [showEditModal, setShowEditModal] = useState(false)
    const [editingResource, setEditingResource] = useState<Resource | null>(null)
    const [editTitle, setEditTitle] = useState('')
    const [editCategory, setEditCategory] = useState<ResourceCategory>('Sheet Music')
    const [editDescription, setEditDescription] = useState('')
    const [editSelectedStudents, setEditSelectedStudents] = useState<string[]>([])
    const [replaceFile, setReplaceFile] = useState<File | null>(null)
    const editFileInputRef = useRef<HTMLInputElement>(null)

    // File handling
    const handleFileDrop = useCallback((e: React.DragEvent) => {
        e.preventDefault()
        setIsDragging(false)
        const file = e.dataTransfer.files[0]
        if (file) {
            setUploadFile(file)
            setUploadTitle(file.name.replace(/\.[^/.]+$/, '').replace(/_/g, ' '))
        }
    }, [])

    const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0]
        if (file) {
            setUploadFile(file)
            setUploadTitle(file.name.replace(/\.[^/.]+$/, '').replace(/_/g, ' '))
        }
    }, [])

    const handleReplaceFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0]
        if (file) {
            setReplaceFile(file)
        }
    }, [])

    // Upload resource
    const handleUpload = async () => {
        if (!uploadFile || !uploadTitle) {
            toast({ variant: 'destructive', title: 'Error', description: 'Please provide a file and title' })
            return
        }

        setIsLoading(true)

        try {
            // Upload file first
            const formData = new FormData()
            formData.append('file', uploadFile)
            const { url, error: uploadError } = await uploadLibraryFile(formData)

            if (uploadError || !url) {
                throw new Error(uploadError || 'Failed to upload file')
            }

            // Create resource
            const fileType = uploadFile.name.split('.').pop()?.toLowerCase() || 'pdf'
            const result = await createResource(
                {
                    title: uploadTitle,
                    description: uploadDescription || undefined,
                    category: uploadCategory,
                    file_url: url,
                    file_type: fileType,
                },
                selectedStudents
            )

            if (!result.success) {
                throw new Error(result.error || 'Failed to create resource')
            }

            toast({ title: 'Success', description: 'Resource uploaded successfully' })

            // Refresh resources list
            setResources(prev => [{
                id: result.resourceId!,
                title: uploadTitle,
                description: uploadDescription || null,
                category: uploadCategory,
                file_url: url,
                file_type: fileType,
                created_at: new Date().toISOString(),
                assignment_count: selectedStudents.length
            }, ...prev])

            // Reset form
            setShowUploadModal(false)
            setUploadFile(null)
            setUploadTitle('')
            setUploadCategory('Sheet Music')
            setUploadDescription('')
            setSelectedStudents([])
        } catch (error: any) {
            toast({ variant: 'destructive', title: 'Error', description: error.message })
        } finally {
            setIsLoading(false)
        }
    }

    // Open edit modal
    const handleEdit = async (resource: Resource) => {
        setIsLoading(true)
        setEditingResource(resource)
        setEditTitle(resource.title)
        setEditCategory(resource.category)
        setEditDescription(resource.description || '')
        setReplaceFile(null)

        // Fetch current assignments
        const { resource: fullResource } = await getResourceWithAssignments(resource.id)
        if (fullResource) {
            setEditSelectedStudents(fullResource.assigned_students.map(s => s.id))
        }

        setIsLoading(false)
        setShowEditModal(true)
    }

    // Save edit
    const handleSaveEdit = async () => {
        if (!editingResource) return

        setIsLoading(true)

        try {
            // Handle file replacement if needed
            let newFileUrl = editingResource.file_url
            let newFileType = editingResource.file_type

            if (replaceFile) {
                const formData = new FormData()
                formData.append('file', replaceFile)
                const { url, error: uploadError } = await uploadLibraryFile(formData)

                if (uploadError || !url) {
                    throw new Error(uploadError || 'Failed to upload new file')
                }

                newFileUrl = url
                newFileType = replaceFile.name.split('.').pop()?.toLowerCase() || 'pdf'
            }

            // Update resource metadata
            const updateResult = await updateResource(editingResource.id, {
                title: editTitle,
                description: editDescription || undefined,
                category: editCategory,
                file_url: newFileUrl,
                file_type: newFileType,
            })

            if (!updateResult.success) {
                throw new Error(updateResult.error || 'Failed to update resource')
            }

            // Update assignments
            const assignResult = await updateResourceAssignments(editingResource.id, editSelectedStudents)

            if (!assignResult.success) {
                throw new Error(assignResult.error || 'Failed to update assignments')
            }

            toast({ title: 'Success', description: 'Resource updated successfully' })

            // Update local state
            setResources(prev => prev.map(r =>
                r.id === editingResource.id
                    ? {
                        ...r,
                        title: editTitle,
                        description: editDescription || null,
                        category: editCategory,
                        file_url: newFileUrl,
                        file_type: newFileType,
                        assignment_count: editSelectedStudents.length
                    }
                    : r
            ))

            setShowEditModal(false)
            setEditingResource(null)
        } catch (error: any) {
            toast({ variant: 'destructive', title: 'Error', description: error.message })
        } finally {
            setIsLoading(false)
        }
    }

    // Delete resource
    const handleDelete = async (resource: Resource) => {
        if (!confirm(`Delete "${resource.title}"? This will remove it from all students.`)) return

        setIsLoading(true)

        const result = await deleteResource(resource.id)

        if (result.success) {
            toast({ title: 'Deleted', description: 'Resource removed successfully' })
            setResources(prev => prev.filter(r => r.id !== resource.id))
        } else {
            toast({ variant: 'destructive', title: 'Error', description: result.error })
        }

        setIsLoading(false)
    }

    // Toggle student selection
    const toggleStudent = (studentId: string, selectedList: string[], setSelectedList: (ids: string[]) => void) => {
        if (selectedList.includes(studentId)) {
            setSelectedList(selectedList.filter(id => id !== studentId))
        } else {
            setSelectedList([...selectedList, studentId])
        }
    }

    // Select all students
    const selectAllStudents = (selectedList: string[], setSelectedList: (ids: string[]) => void) => {
        if (selectedList.length === students.length) {
            setSelectedList([])
        } else {
            setSelectedList(students.map(s => s.id))
        }
    }

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <Link href="/admin">
                        <Button variant="ghost" size="icon">
                            <ArrowLeft className="h-4 w-4" />
                        </Button>
                    </Link>
                    <div>
                        <h1 className="text-3xl font-serif font-bold">Resource Library</h1>
                        <p className="text-muted-foreground">Manage practice materials for your students</p>
                    </div>
                </div>
                <Button onClick={() => setShowUploadModal(true)}>
                    <Plus className="h-4 w-4 mr-2" />
                    Upload Resource
                </Button>
            </div>

            {/* Resources Table */}
            <div className="border rounded-lg">
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead>Title</TableHead>
                            <TableHead>Category</TableHead>
                            <TableHead>Assigned To</TableHead>
                            <TableHead className="text-right">Actions</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {resources.length === 0 ? (
                            <TableRow>
                                <TableCell colSpan={4} className="text-center py-12 text-muted-foreground">
                                    No resources yet. Click "Upload Resource" to add your first one.
                                </TableCell>
                            </TableRow>
                        ) : (
                            resources.map(resource => (
                                <TableRow key={resource.id}>
                                    <TableCell>
                                        <div className="flex items-center gap-2">
                                            {resource.file_type === 'mp3' ? (
                                                <Music className="h-4 w-4 text-muted-foreground" />
                                            ) : (
                                                <FileText className="h-4 w-4 text-muted-foreground" />
                                            )}
                                            <span className="font-medium">{resource.title}</span>
                                        </div>
                                    </TableCell>
                                    <TableCell>
                                        <Badge variant="secondary" className={categoryColors[resource.category]}>
                                            {resource.category}
                                        </Badge>
                                    </TableCell>
                                    <TableCell>
                                        <div className="flex items-center gap-1 text-muted-foreground">
                                            <Users className="h-4 w-4" />
                                            <span>{resource.assignment_count || 0} students</span>
                                        </div>
                                    </TableCell>
                                    <TableCell className="text-right">
                                        <DropdownMenu>
                                            <DropdownMenuTrigger asChild>
                                                <Button variant="ghost" size="icon">
                                                    <MoreHorizontal className="h-4 w-4" />
                                                </Button>
                                            </DropdownMenuTrigger>
                                            <DropdownMenuContent align="end">
                                                <DropdownMenuItem onClick={() => window.open(resource.file_url, '_blank')}>
                                                    <Download className="h-4 w-4 mr-2" />
                                                    Download
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => handleEdit(resource)}>
                                                    <Pencil className="h-4 w-4 mr-2" />
                                                    Edit
                                                </DropdownMenuItem>
                                                <DropdownMenuItem
                                                    onClick={() => handleDelete(resource)}
                                                    className="text-red-600"
                                                >
                                                    <Trash2 className="h-4 w-4 mr-2" />
                                                    Delete
                                                </DropdownMenuItem>
                                            </DropdownMenuContent>
                                        </DropdownMenu>
                                    </TableCell>
                                </TableRow>
                            ))
                        )}
                    </TableBody>
                </Table>
            </div>

            {/* Upload Modal */}
            <Dialog open={showUploadModal} onOpenChange={setShowUploadModal}>
                <DialogContent className="sm:max-w-xl">
                    <DialogHeader>
                        <DialogTitle className="text-2xl font-serif">Upload Resource</DialogTitle>
                        <DialogDescription>
                            Add a new practice material to the library
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-4 py-4">
                        {/* Drag & Drop Zone */}
                        <div
                            className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${isDragging ? 'border-primary bg-primary/5' : 'border-muted-foreground/25 hover:border-primary/50'
                                }`}
                            onDragOver={(e) => { e.preventDefault(); setIsDragging(true) }}
                            onDragLeave={() => setIsDragging(false)}
                            onDrop={handleFileDrop}
                            onClick={() => fileInputRef.current?.click()}
                        >
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".pdf,.mp3,.wav,.png,.jpg,.jpeg"
                                className="hidden"
                                onChange={handleFileSelect}
                            />
                            {uploadFile ? (
                                <div className="flex items-center justify-center gap-2">
                                    <FileText className="h-6 w-6 text-primary" />
                                    <span className="font-medium">{uploadFile.name}</span>
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    <Upload className="h-8 w-8 mx-auto text-muted-foreground" />
                                    <p className="text-muted-foreground">
                                        Drag & drop a file here, or click to browse
                                    </p>
                                    <p className="text-xs text-muted-foreground">
                                        PDF, MP3, WAV, PNG, JPG
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Title */}
                        <div className="space-y-2">
                            <Label htmlFor="title">Title</Label>
                            <Input
                                id="title"
                                value={uploadTitle}
                                onChange={(e) => setUploadTitle(e.target.value)}
                                placeholder="Resource title"
                            />
                        </div>

                        {/* Category */}
                        <div className="space-y-2">
                            <Label>Category</Label>
                            <Select value={uploadCategory} onValueChange={(v) => setUploadCategory(v as ResourceCategory)}>
                                <SelectTrigger>
                                    <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                    {CATEGORIES.map(cat => (
                                        <SelectItem key={cat} value={cat}>{cat}</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>

                        {/* Description */}
                        <div className="space-y-2">
                            <Label htmlFor="description">Description (optional)</Label>
                            <Textarea
                                id="description"
                                value={uploadDescription}
                                onChange={(e) => setUploadDescription(e.target.value)}
                                placeholder="Brief description of this resource"
                                rows={2}
                            />
                        </div>

                        {/* Student Assignment */}
                        <div className="space-y-2">
                            <div className="flex items-center justify-between">
                                <Label>Assign to Students</Label>
                                <Button
                                    type="button"
                                    variant="ghost"
                                    size="sm"
                                    onClick={() => selectAllStudents(selectedStudents, setSelectedStudents)}
                                >
                                    {selectedStudents.length === students.length ? 'Deselect All' : 'Select All'}
                                </Button>
                            </div>
                            <div className="border rounded-lg max-h-40 overflow-y-auto">
                                {students.map(student => (
                                    <div
                                        key={student.id}
                                        className="flex items-center gap-2 px-3 py-2 hover:bg-muted/50 cursor-pointer"
                                        onClick={() => toggleStudent(student.id, selectedStudents, setSelectedStudents)}
                                    >
                                        {selectedStudents.includes(student.id) ? (
                                            <CheckSquare className="h-4 w-4 text-primary" />
                                        ) : (
                                            <Square className="h-4 w-4 text-muted-foreground" />
                                        )}
                                        <span>{student.name}</span>
                                    </div>
                                ))}
                            </div>
                            <p className="text-xs text-muted-foreground">
                                {selectedStudents.length} student(s) selected
                            </p>
                        </div>
                    </div>

                    <div className="flex gap-3 justify-end">
                        <Button variant="outline" onClick={() => setShowUploadModal(false)} disabled={isLoading}>
                            Cancel
                        </Button>
                        <Button onClick={handleUpload} disabled={isLoading || !uploadFile}>
                            {isLoading ? (
                                <>
                                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                                    Uploading...
                                </>
                            ) : (
                                <>
                                    <Upload className="h-4 w-4 mr-2" />
                                    Upload
                                </>
                            )}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>

            {/* Edit Modal */}
            <Dialog open={showEditModal} onOpenChange={setShowEditModal}>
                <DialogContent className="sm:max-w-xl">
                    <DialogHeader>
                        <DialogTitle className="text-2xl font-serif">Edit Resource</DialogTitle>
                        <DialogDescription>
                            Update resource details and assignments
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-4 py-4">
                        {/* Replace File */}
                        <div className="space-y-2">
                            <Label>Replace File (optional)</Label>
                            <div className="flex items-center gap-2">
                                <Input
                                    ref={editFileInputRef}
                                    type="file"
                                    accept=".pdf,.mp3,.wav,.png,.jpg,.jpeg"
                                    onChange={handleReplaceFileSelect}
                                    className="flex-1"
                                />
                            </div>
                            {replaceFile && (
                                <p className="text-sm text-green-600">
                                    New file: {replaceFile.name}
                                </p>
                            )}
                        </div>

                        {/* Title */}
                        <div className="space-y-2">
                            <Label htmlFor="edit-title">Title</Label>
                            <Input
                                id="edit-title"
                                value={editTitle}
                                onChange={(e) => setEditTitle(e.target.value)}
                            />
                        </div>

                        {/* Category */}
                        <div className="space-y-2">
                            <Label>Category</Label>
                            <Select value={editCategory} onValueChange={(v) => setEditCategory(v as ResourceCategory)}>
                                <SelectTrigger>
                                    <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                    {CATEGORIES.map(cat => (
                                        <SelectItem key={cat} value={cat}>{cat}</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>

                        {/* Description */}
                        <div className="space-y-2">
                            <Label htmlFor="edit-description">Description</Label>
                            <Textarea
                                id="edit-description"
                                value={editDescription}
                                onChange={(e) => setEditDescription(e.target.value)}
                                rows={2}
                            />
                        </div>

                        {/* Student Assignment */}
                        <div className="space-y-2">
                            <div className="flex items-center justify-between">
                                <Label>Assigned Students</Label>
                                <Button
                                    type="button"
                                    variant="ghost"
                                    size="sm"
                                    onClick={() => selectAllStudents(editSelectedStudents, setEditSelectedStudents)}
                                >
                                    {editSelectedStudents.length === students.length ? 'Deselect All' : 'Select All'}
                                </Button>
                            </div>
                            <div className="border rounded-lg max-h-40 overflow-y-auto">
                                {students.map(student => (
                                    <div
                                        key={student.id}
                                        className="flex items-center gap-2 px-3 py-2 hover:bg-muted/50 cursor-pointer"
                                        onClick={() => toggleStudent(student.id, editSelectedStudents, setEditSelectedStudents)}
                                    >
                                        {editSelectedStudents.includes(student.id) ? (
                                            <CheckSquare className="h-4 w-4 text-primary" />
                                        ) : (
                                            <Square className="h-4 w-4 text-muted-foreground" />
                                        )}
                                        <span>{student.name}</span>
                                    </div>
                                ))}
                            </div>
                            <p className="text-xs text-muted-foreground">
                                {editSelectedStudents.length} student(s) selected
                            </p>
                        </div>
                    </div>

                    <div className="flex gap-3 justify-end">
                        <Button variant="outline" onClick={() => setShowEditModal(false)} disabled={isLoading}>
                            Cancel
                        </Button>
                        <Button onClick={handleSaveEdit} disabled={isLoading}>
                            {isLoading ? (
                                <>
                                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                                    Saving...
                                </>
                            ) : (
                                <>
                                    <Pencil className="h-4 w-4 mr-2" />
                                    Save Changes
                                </>
                            )}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>
        </div>
    )
}
</file>

<file path="components/emails/lesson-logged-email.tsx">
import {
    Body,
    Container,
    Head,
    Heading,
    Html,
    Preview,
    Text,
    Section,
    Hr,
    Link,
} from "@react-email/components";
import * as React from "react";

interface LessonLoggedEmailProps {
    studentName: string;
    date: string;
    notes: string;
    nextLessonDate?: string;
    sheetMusicUrl?: string;
    sheetMusicFileName?: string;
}

export const LessonLoggedEmail = ({
    studentName,
    date,
    notes,
    nextLessonDate,
    sheetMusicUrl,
    sheetMusicFileName,
}: LessonLoggedEmailProps) => (
    <Html>
        <Head />
        <Preview>Here are the notes from your lesson on {date}</Preview>
        <Body style={main}>
            <Container style={container}>
                <Heading style={h1}>Lesson Summary</Heading>
                <Text style={text}>Hi {studentName},</Text>
                <Text style={text}>
                    Great work today! Here are the notes and practice assignments from your lesson on <strong>{date}</strong>.
                </Text>

                <Section style={box}>
                    <Heading as="h2" style={h2}>Instructor Notes:</Heading>
                    <Text style={notesText}>{notes}</Text>
                </Section>

                {sheetMusicUrl && (
                    <Section style={sheetMusicBox}>
                        <Heading as="h2" style={h2}>ðŸ“„ Sheet Music Attached:</Heading>
                        <Text style={text}>
                            <Link href={sheetMusicUrl} style={linkStyle}>
                                {sheetMusicFileName || 'Download Sheet Music (PDF)'}
                            </Link>
                        </Text>
                    </Section>
                )}

                {nextLessonDate && (
                    <Text style={text}>
                        We look forward to seeing you again on <strong>{nextLessonDate}</strong>!
                    </Text>
                )}

                <Hr style={hr} />

                <Text style={footer}>
                    Keep practicing! ðŸŽ¹<br />
                    Lionel Yu Piano Studio
                </Text>
            </Container>
        </Body>
    </Html>
);

export default LessonLoggedEmail;

// Styles (Matching your minimalist aesthetic)
const main = {
    backgroundColor: "#ffffff",
    fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif',
};

const container = {
    margin: "0 auto",
    padding: "20px 0 48px",
    maxWidth: "560px",
};

const h1 = {
    fontSize: "24px",
    fontWeight: "bold",
    color: "#1a1a1a",
    marginBottom: "24px",
};

const h2 = {
    fontSize: "16px",
    fontWeight: "bold",
    color: "#444",
    marginTop: "0",
};

const text = {
    fontSize: "16px",
    lineHeight: "26px",
    color: "#333",
    marginBottom: "16px",
};

const notesText = {
    fontSize: "15px",
    lineHeight: "24px",
    color: "#333",
    whiteSpace: "pre-wrap" as const, // Preserves line breaks in your notes
};

const box = {
    padding: "24px",
    backgroundColor: "#f9f9f9",
    borderRadius: "12px",
    border: "1px solid #eaeaea",
    marginBottom: "24px",
};

const hr = {
    borderColor: "#e6ebf1",
    margin: "20px 0",
};

const sheetMusicBox = {
    padding: "16px 24px",
    backgroundColor: "#f0fdf4",
    borderRadius: "12px",
    border: "1px solid #bbf7d0",
    marginBottom: "24px",
};

const linkStyle = {
    color: "#16a34a",
    textDecoration: "underline",
    fontWeight: "500" as const,
};

const footer = {
    color: "#8898aa",
    fontSize: "12px",
};
</file>

<file path="components/emails/payment-confirmation-email.tsx">
import * as React from 'react';

interface PaymentConfirmationEmailProps {
    amount: number;
    credits: number;
    date: string;
}

export const PaymentConfirmationEmail: React.FC<PaymentConfirmationEmailProps> = ({
    amount,
    credits,
    date,
}) => (
    <div style={{ fontFamily: 'sans-serif', lineHeight: '1.6', color: '#333' }}>
        <h1 style={{ color: '#111' }}>Payment Successful</h1>
        <p>Thank you for your purchase!</p>
        <p>We have successfully processed your payment and added credits to your account.</p>

        <div style={{ background: '#f9f9f9', padding: '20px', borderRadius: '8px', margin: '20px 0' }}>
            <p style={{ margin: '5px 0' }}><strong>Amount Paid:</strong> ${amount.toFixed(2)}</p>
            <p style={{ margin: '5px 0' }}><strong>Credits Added:</strong> {credits}</p>
            <p style={{ margin: '5px 0' }}><strong>Date:</strong> {date}</p>
        </div>

        <p>You can now book lessons using your credits.</p>
        <p style={{ fontSize: '12px', color: '#666', marginTop: '30px' }}>
            This represents a receipt for your purchase.
        </p>
    </div>
);
</file>

<file path="components/student/event-signup-modal.tsx">
"use client"

import { useState } from "react"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import { Label } from "@/components/ui/label"
import { Input } from "@/components/ui/input"
import { Calendar, Clock, Video, MapPin, Send } from "lucide-react"
import type { StudentEvent } from "@/app/actions/events"

interface EventSignupModalProps {
    event: StudentEvent | null
    studentName: string
    open: boolean
    onOpenChange: (open: boolean) => void
    onConfirm: (eventId: string, message: string) => Promise<void>
}

export function EventSignupModal({ event, studentName, open, onOpenChange, onConfirm }: EventSignupModalProps) {
    const [message, setMessage] = useState("")
    const [isSubmitting, setIsSubmitting] = useState(false)

    if (!event) return null

    const handleConfirm = async () => {
        if (!event) return
        setIsSubmitting(true)
        try {
            await onConfirm(event.id, message)
            setMessage("") // Clear message on success
            onOpenChange(false)
        } catch (error) {
            console.error("Signup failed", error)
            // Error handling is likely done in onConfirm or parent
        } finally {
            setIsSubmitting(false)
        }
    }

    const isVirtual = event.location_type === 'virtual'

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent className="sm:max-w-lg">
                <DialogHeader className="space-y-4">
                    <DialogTitle className="text-2xl font-serif">{event.title}</DialogTitle>
                    <DialogDescription className="hidden">
                        Sign up for {event.title}
                    </DialogDescription>

                    {/* Date, Time & Location */}
                    <div className="flex flex-wrap gap-4 text-sm">
                        <div className="flex items-center gap-2 text-muted-foreground">
                            <Calendar className="h-4 w-4" />
                            <span>{event.date}</span>
                        </div>
                        <div className="flex items-center gap-2 text-muted-foreground">
                            <Clock className="h-4 w-4" />
                            <span>{event.start_time}</span>
                        </div>
                        <div className="flex items-center gap-2 text-muted-foreground">
                            {isVirtual ? (
                                <>
                                    <Video className="h-4 w-4" />
                                    <span className="text-primary font-medium">Zoom Meeting</span>
                                </>
                            ) : (
                                <>
                                    <MapPin className="h-4 w-4" />
                                    <span>{event.location_address || "Studio"}</span>
                                </>
                            )}
                        </div>
                    </div>
                </DialogHeader>

                <div className="space-y-6 py-4">
                    {/* Teacher's Note Section */}
                    <div className="rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 p-4">
                        <p className="text-xs font-semibold uppercase tracking-wider text-amber-700 dark:text-amber-400 mb-2">
                            Note from Teacher
                        </p>
                        <p className="text-sm text-amber-900 dark:text-amber-100 leading-relaxed">
                            {event.description || "Please let me know what piece you plan to perform!"}
                        </p>
                    </div>

                    {/* RSVP Form */}
                    <div className="space-y-4">
                        {/* Student Name (Read-only) */}
                        <div className="space-y-2">
                            <Label htmlFor="student-name" className="text-sm font-medium">
                                Student Name
                            </Label>
                            <Input id="student-name" value={studentName} readOnly className="bg-muted cursor-not-allowed" />
                        </div>

                        {/* Student Message */}
                        <div className="space-y-2">
                            <Label htmlFor="message" className="text-sm font-medium">
                                Your Message / Repertoire Info
                            </Label>
                            <Textarea
                                id="message"
                                value={message}
                                onChange={(e) => setMessage(e.target.value)}
                                placeholder="I would like to play FÃ¼r Elise..."
                                className="min-h-[100px] resize-none"
                            />
                        </div>
                    </div>
                </div>

                <DialogFooter className="flex-col sm:flex-row gap-2">
                    <Button variant="ghost" onClick={() => onOpenChange(false)} disabled={isSubmitting}>
                        Cancel
                    </Button>
                    <Button onClick={handleConfirm} disabled={isSubmitting}>
                        {isSubmitting ? (
                            <>
                                <span className="h-4 w-4 border-2 border-current border-t-transparent rounded-full animate-spin mr-2" />
                                Confirming...
                            </>
                        ) : (
                            <>
                                <Send className="h-4 w-4 mr-2" />
                                Confirm Attendance
                            </>
                        )}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/local-timestamp.tsx">
"use client"

import { useEffect, useState } from "react"

interface LocalTimestampProps {
    date: string
}

export function LocalTimestamp({ date }: LocalTimestampProps) {
    const [localTime, setLocalTime] = useState<string>("")

    useEffect(() => {
        setLocalTime(new Date(date).toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit'
        }))
    }, [date])

    if (!localTime) {
        // Render a placeholder or the server time with a specific style to indicate loading?
        // Or just render nothing / skeleton to avoid flicker. 
        // Rendering UTC time might be confusing if it flips. 
        // Let's render a simple formatted UTC or "..." to keep layout stable.
        return <span className="opacity-50">...</span>
    }

    return <span>{localTime}</span>
}
</file>

<file path="components/profile-settings-dialog.tsx">
"use client"

import { useState, useEffect } from "react"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Checkbox } from "@/components/ui/checkbox"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Clock, Copy, Save, User as UserIcon } from "lucide-react"
import { useToast } from "@/hooks/use-toast"
import { updateProfileSettings } from "@/app/actions/users"
import type { Profile } from "@/lib/supabase/database.types"

interface ProfileSettingsDialogProps {
    profile: Profile
    open?: boolean
    onOpenChange?: (open: boolean) => void
    trigger?: React.ReactNode
}

type DayAvailability = {
    day: string
    enabled: boolean
    start: string
    end: string
}

const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
const DEFAULT_START = "09:00"
const DEFAULT_END = "17:00"

export function ProfileSettingsDialog({ profile, open, onOpenChange, trigger }: ProfileSettingsDialogProps) {
    const { toast } = useToast()
    const [isOpen, setIsOpen] = useState(false)
    const [isLoading, setIsLoading] = useState(false)

    // Controlled open state
    const show = open !== undefined ? open : isOpen
    const setShow = onOpenChange || setIsOpen

    // Form State
    const [name, setName] = useState(profile.name || "")
    const [studioName, setStudioName] = useState(profile.studio_name || "")
    const [zoomLink, setZoomLink] = useState(profile.zoom_link || "")
    const [email, setEmail] = useState(profile.email || "")
    const [password, setPassword] = useState("")
    const [timezone, setTimezone] = useState(profile.timezone as string || "UTC")
    const [availability, setAvailability] = useState<DayAvailability[]>([])

    // Initialize availability from profile or default
    useEffect(() => {
        if (profile.available_hours) {
            try {
                // Merge saved availability with all days to ensure complete list
                const saved = profile.available_hours as DayAvailability[]
                const merged = DAYS.map(day => {
                    const found = saved.find(d => d.day === day)
                    return found || { day, enabled: false, start: DEFAULT_START, end: DEFAULT_END }
                })
                setAvailability(merged)
            } catch (e) {
                console.error("Failed to parse availability", e)
                setDefaultAvailability()
            }
        } else {
            setDefaultAvailability()
        }
    }, [profile])


    const setDefaultAvailability = () => {
        setAvailability(DAYS.map(day => ({
            day,
            enabled: false,
            start: DEFAULT_START,
            end: DEFAULT_END
        })))
    }

    const handleAvailabilityChange = (index: number, field: keyof DayAvailability, value: any) => {
        const newAvailability = [...availability]
        newAvailability[index] = { ...newAvailability[index], [field]: value }
        setAvailability(newAvailability)
    }

    const copyToAll = (sourceIndex: number) => {
        const source = availability[sourceIndex]
        const newAvailability = availability.map(day => ({
            ...day,
            enabled: source.enabled,
            start: source.start,
            end: source.end
        }))
        setAvailability(newAvailability)
        toast({ title: "Copied!", description: `Copied ${source.day}'s schedule to all days.` })
    }

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        setIsLoading(true)

        const formData = new FormData()
        formData.append('name', name)
        formData.append('studioName', studioName)
        formData.append('zoomLink', zoomLink)
        formData.append('email', email)
        if (password) formData.append('password', password)
        formData.append('timezone', timezone)
        formData.append('availableHours', JSON.stringify(availability))

        const result = await updateProfileSettings(formData)

        setIsLoading(false)

        if (result.error) {
            toast({
                variant: "destructive",
                title: "Error",
                description: result.error
            })
        } else {
            toast({
                title: "Settings Saved",
                description: "Your profile has been updated successfully."
            })
            setShow(false)
        }
    }

    return (
        <Dialog open={show} onOpenChange={setShow}>
            {trigger && <DialogTrigger asChild>{trigger}</DialogTrigger>}
            <DialogContent className="sm:max-w-[700px] max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle className="text-2xl font-serif">Profile Settings</DialogTitle>
                    <DialogDescription>
                        Update your personal information and teaching availability.
                    </DialogDescription>
                </DialogHeader>

                <Tabs defaultValue="general" className="w-full">
                    <TabsList className="grid w-full grid-cols-2">
                        <TabsTrigger value="general">General Info</TabsTrigger>
                        <TabsTrigger value="availability">Availability</TabsTrigger>
                    </TabsList>

                    <form onSubmit={handleSubmit}>
                        <TabsContent value="general" className="space-y-4 py-4">
                            <div className="grid gap-4">
                                <div className="space-y-2">
                                    <Label htmlFor="name">Full Name</Label>
                                    <Input
                                        id="name"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        required
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="studioName">Studio Name</Label>
                                    <Input
                                        id="studioName"
                                        placeholder="e.g. Lionel Yu Piano Studio"
                                        value={studioName}
                                        onChange={(e) => setStudioName(e.target.value)}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="zoomLink">Default Zoom Link</Label>
                                    <Input
                                        id="zoomLink"
                                        placeholder="e.g. https://zoom.us/j/1234567890"
                                        value={zoomLink}
                                        onChange={(e) => setZoomLink(e.target.value)}
                                    />
                                    <p className="text-xs text-muted-foreground">Used if automatic link generation fails.</p>
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="email">Email Address</Label>
                                    <Input
                                        id="email"
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="password">Change Password</Label>
                                    <Input
                                        id="password"
                                        type="password"
                                        placeholder="Leave blank to keep current password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="timezone">Timezone</Label>
                                    <Select value={timezone} onValueChange={setTimezone}>
                                        <SelectTrigger>
                                            <SelectValue placeholder="Select timezone" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="UTC">UTC</SelectItem>
                                            <SelectItem value="America/Los_Angeles">Pacific Time (Standard)</SelectItem>
                                            <SelectItem value="America/New_York">Eastern Time</SelectItem>
                                            <SelectItem value="Europe/London">London</SelectItem>
                                            {/* Add more as needed */}
                                        </SelectContent>
                                    </Select>
                                </div>
                            </div>
                        </TabsContent>

                        <TabsContent value="availability" className="space-y-4 py-4">
                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <h3 className="font-medium">Weekly Schedule</h3>
                                    <Button
                                        type="button"
                                        variant="outline"
                                        size="sm"
                                        onClick={() => copyToAll(0)}
                                    >
                                        <Copy className="h-4 w-4 mr-2" />
                                        Copy Mon to All
                                    </Button>
                                </div>

                                <div className="space-y-2">
                                    {availability.map((day, index) => (
                                        <div key={day.day} className="flex items-center gap-4 p-3 border rounded-lg bg-card">
                                            <Checkbox
                                                id={`day-${index}`}
                                                checked={day.enabled}
                                                onCheckedChange={(checked) => handleAvailabilityChange(index, 'enabled', checked)}
                                            />
                                            <Label htmlFor={`day-${index}`} className="w-24 font-medium cursor-pointer">
                                                {day.day}
                                            </Label>

                                            {day.enabled ? (
                                                <div className="flex items-center gap-2 flex-1">
                                                    <Input
                                                        type="time"
                                                        value={day.start}
                                                        onChange={(e) => handleAvailabilityChange(index, 'start', e.target.value)}
                                                        className="w-32"
                                                    />
                                                    <span className="text-muted-foreground">to</span>
                                                    <Input
                                                        type="time"
                                                        value={day.end}
                                                        onChange={(e) => handleAvailabilityChange(index, 'end', e.target.value)}
                                                        className="w-32"
                                                    />
                                                </div>
                                            ) : (
                                                <div className="flex-1 text-muted-foreground text-sm italic">
                                                    Unavailable
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </TabsContent>

                        <div className="flex justify-end pt-4 border-t mt-4">
                            <Button type="submit" disabled={isLoading} className="min-w-[120px]">
                                {isLoading ? (
                                    "Saving..."
                                ) : (
                                    <>
                                        <Save className="h-4 w-4 mr-2" />
                                        Save Changes
                                    </>
                                )}
                            </Button>
                        </div>
                    </form>
                </Tabs>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/theme-provider.tsx">
'use client'

import * as React from 'react'
import {
  ThemeProvider as NextThemesProvider,
  type ThemeProviderProps,
} from 'next-themes'

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}
</file>

<file path="components/video-player.tsx">
"use client"

import { useState } from "react"
import { Play, Pause } from "lucide-react"
import { Button } from "@/components/ui/button"

interface VideoPlayerProps {
  url: string
  title?: string
}

export function VideoPlayer({ url, title }: VideoPlayerProps) {
  const [isPlaying, setIsPlaying] = useState(false)
  const [isMuted, setIsMuted] = useState(false)

  return (
    <div className="relative w-full aspect-video bg-black rounded-lg overflow-hidden group">
      {/* Video element */}
      <video
        className="w-full h-full"
        src={url}
        controls
        controlsList="nodownload"
        onPlay={() => setIsPlaying(true)}
        onPause={() => setIsPlaying(false)}
      >
        <track kind="captions" />
      </video>

      {/* Custom overlay controls */}
      <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
        <div className="absolute bottom-4 left-4 right-4 flex items-center gap-3 pointer-events-auto">
          <Button
            size="icon"
            variant="ghost"
            className="h-8 w-8 text-white hover:bg-white/20"
            onClick={(e) => {
              const video = e.currentTarget.closest(".group")?.querySelector("video")
              if (video) {
                isPlaying ? video.pause() : video.play()
              }
            }}
          >
            {isPlaying ? <Pause className="h-4 w-4" /> : <Play className="h-4 w-4" />}
          </Button>
          {title && <span className="text-sm text-white font-medium">{title}</span>}
        </div>
      </div>
    </div>
  )
}
</file>

<file path="lib/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
    return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )
}
</file>

<file path="lib/supabase/middleware.ts">
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
    let supabaseResponse = NextResponse.next({
        request,
    })

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return request.cookies.getAll()
                },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
                    supabaseResponse = NextResponse.next({
                        request,
                    })
                    cookiesToSet.forEach(({ name, value, options }) =>
                        supabaseResponse.cookies.set(name, value, options)
                    )
                },
            },
        }
    )

    // IMPORTANT: Avoid writing any logic between createServerClient and
    // supabase.auth.getUser(). A simple mistake could make it very hard to debug
    // issues with users being randomly logged out.

    const {
        data: { user },
    } = await supabase.auth.getUser()

    // If you want to protect routes, uncomment and modify the following:
    // if (
    //   !user &&
    //   !request.nextUrl.pathname.startsWith('/login') &&
    //   !request.nextUrl.pathname.startsWith('/auth')
    // ) {
    //   const url = request.nextUrl.clone()
    //   url.pathname = '/login'
    //   return NextResponse.redirect(url)
    // }

    return supabaseResponse
}
</file>

<file path="lib/supabase/server.ts">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
    const cookieStore = await cookies()

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return cookieStore.getAll()
                },
                setAll(cookiesToSet) {
                    try {
                        cookiesToSet.forEach(({ name, value, options }) =>
                            cookieStore.set(name, value, options)
                        )
                    } catch {
                        // The `setAll` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
            },
        }
    )
}
</file>

<file path="lib/logger.ts">
import { createClient } from '@supabase/supabase-js'

/**
 * Log an authentication event to the audit logs.
 * Uses the Service Role key to bypass RLS, ensuring failed logins (unauthenticated) are logged.
 */
export async function logAuthEvent(
    email: string,
    eventType: 'login' | 'failed_login' | 'reset_request' | 'reset_completed',
    status: 'success' | 'failure',
    details?: string
) {
    // Basic validation
    if (!email) return

    try {
        // Create a Supabase client with the Service Role key
        const supabase = createClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.SUPABASE_SERVICE_KEY!,
            {
                auth: {
                    persistSession: false,
                    autoRefreshToken: false,
                }
            }
        )

        const { error } = await supabase
            .from('auth_audit_logs')
            .insert({
                user_email: email,
                event_type: eventType,
                status,
                details
            })

        if (error) {
            console.error('Failed to log auth event:', error)
        }
    } catch (error) {
        // Fail silently so we don't block the actual auth flow
        console.error('Error in logAuthEvent:', error)
    }
}
</file>

<file path="lib/mock-data.ts">
// Mock data for Piano Studio Student Portal
// Structured for easy Supabase migration

export type Student = {
  id: string
  name: string
  email: string
  phone: string
  credits_remaining: number
  credits_total: number
  balance_due: number
  zoom_link: string
  last_lesson_date: string
  next_lesson?: {
    date: string
    time: string
    duration: number
  }
}

export type Lesson = {
  id: string
  student_id: string
  date: string
  time: string
  duration: number
  status: "scheduled" | "completed" | "cancelled" | "no-show" | "rescheduled"
  teacher_notes?: string
  video_url?: string
  sheet_music_url?: string
  homework?: string
}

export type Event = {
  id: string
  title: string
  description: string
  date: string
  time: string
  type: "recital" | "group-class" | "workshop"
  spots_available: number
  signed_up: boolean
}

export type Download = {
  id: string
  title: string
  description: string
  category: "scales" | "exercises" | "theory" | "sheet-music"
  file_url: string
  uploaded_date: string
}

export type Tutorial = {
  id: string
  title: string
  description: string
  category: "technique" | "theory" | "repertoire" | "practice-tips"
  video_url: string
  duration: string
  thumbnail_url?: string
}

export type Message = {
  id: string
  student_id: string
  sender: "student" | "teacher"
  content: string
  timestamp: string
  read: boolean
}

export type CreditPackage = {
  id: string
  name: string
  credits: number
  price: number
  price_per_lesson: number
  popular?: boolean
}

export type MakeupSlot = {
  id: string
  day: string
  date: string
  time: string
  available: boolean
}

// Mock Students
export const mockStudents: Student[] = [
  {
    id: "student-1",
    name: "Emily Chen",
    email: "student@piano.com",
    phone: "(555) 123-4567",
    credits_remaining: 2,
    credits_total: 4,
    balance_due: 0,
    zoom_link: "https://zoom.us/j/123456789",
    last_lesson_date: "2025-11-22",
    next_lesson: {
      date: "2025-12-02",
      time: "3:00 PM",
      duration: 60,
    },
  },
  {
    id: "student-2",
    name: "Marcus Johnson",
    email: "marcus@email.com",
    phone: "(555) 234-5678",
    credits_remaining: 1,
    credits_total: 4,
    balance_due: 20,
    zoom_link: "https://zoom.us/j/987654321",
    last_lesson_date: "2025-11-25",
    next_lesson: {
      date: "2025-12-02",
      time: "4:30 PM",
      duration: 60,
    },
  },
  {
    id: "student-3",
    name: "Sophie Martinez",
    email: "sophie@email.com",
    phone: "(555) 345-6789",
    credits_remaining: 4,
    credits_total: 4,
    balance_due: 0,
    zoom_link: "https://zoom.us/j/456789123",
    last_lesson_date: "2025-11-20",
    next_lesson: {
      date: "2025-12-02",
      time: "5:00 PM",
      duration: 45,
    },
  },
  {
    id: "student-4",
    name: "David Kim",
    email: "david@email.com",
    phone: "(555) 456-7890",
    credits_remaining: 0,
    credits_total: 4,
    balance_due: 40,
    zoom_link: "https://zoom.us/j/789123456",
    last_lesson_date: "2025-11-15",
  },
]

// Mock Lessons
export const mockLessons: Lesson[] = [
  {
    id: "lesson-1",
    student_id: "student-1",
    date: "2025-11-22",
    time: "3:00 PM",
    duration: 60,
    status: "completed",
    teacher_notes:
      "Excellent progress on Bach Prelude in C Major. Focus on dynamics and phrasing. Continue practicing scales - C, G, and D major with hands together. Work on articulation in the left hand.",
    video_url: "https://example.com/lesson-1.mp4",
    sheet_music_url: "https://example.com/bach-prelude.pdf",
    homework: "Practice Bach Prelude bars 1-16 slowly. Hanon exercises 1-5 daily.",
  },
  {
    id: "lesson-2",
    student_id: "student-1",
    date: "2025-11-15",
    time: "3:00 PM",
    duration: 60,
    status: "completed",
    teacher_notes: "Great work on Czerny Etude. Continue with finger independence exercises.",
    video_url: "https://example.com/lesson-2.mp4",
    homework: "Complete Czerny Op. 299 No. 1",
  },
  {
    id: "lesson-3",
    student_id: "student-1",
    date: "2025-11-08",
    time: "3:00 PM",
    duration: 60,
    status: "completed",
    teacher_notes: "Introduced new piece: Clementi Sonatina. Working on sight-reading skills.",
    sheet_music_url: "https://example.com/clementi.pdf",
  },
  {
    id: "lesson-4",
    student_id: "student-2",
    date: "2025-11-25",
    time: "4:30 PM",
    duration: 60,
    status: "completed",
    teacher_notes: "Strong improvement on jazz standards. Work on improvisation over ii-V-I progressions.",
    video_url: "https://example.com/lesson-jazz.mp4",
  },
]

// Mock Events
export const mockEvents: Event[] = [
  {
    id: "event-1",
    title: "Winter Recital 2025",
    description: "Annual student performance showcase at the Community Arts Center",
    date: "2025-12-15",
    time: "6:00 PM",
    type: "recital",
    spots_available: 12,
    signed_up: false,
  },
  {
    id: "event-2",
    title: "Jazz Theory Workshop",
    description: "Learn jazz harmony and improvisation techniques",
    date: "2025-12-08",
    time: "2:00 PM",
    type: "workshop",
    spots_available: 5,
    signed_up: true,
  },
  {
    id: "event-3",
    title: "Group Masterclass",
    description: "Performance practice and peer feedback session",
    date: "2025-12-10",
    time: "4:00 PM",
    type: "group-class",
    spots_available: 8,
    signed_up: false,
  },
]

// Mock Makeup Slots
export const mockMakeupSlots: MakeupSlot[] = [
  {
    id: "slot-1",
    day: "Tuesday",
    date: "12/03",
    time: "4:00 PM",
    available: true,
  },
  {
    id: "slot-2",
    day: "Wednesday",
    date: "12/04",
    time: "2:00 PM",
    available: true,
  },
  {
    id: "slot-3",
    day: "Thursday",
    date: "12/05",
    time: "6:00 PM",
    available: true,
  },
]

// Mock Admin Data
export const mockAdmin = {
  id: "admin-1",
  name: "Professor Williams",
  email: "admin@piano.com",
}

// Mock Downloads Data
export const mockDownloads: Download[] = [
  {
    id: "download-1",
    title: "C Major Scale - All Forms",
    description: "Complete scale patterns with fingering",
    category: "scales",
    file_url: "https://example.com/c-major-scales.pdf",
    uploaded_date: "2025-11-01",
  },
  {
    id: "download-2",
    title: "Hanon Exercises 1-10",
    description: "Daily finger independence exercises",
    category: "exercises",
    file_url: "https://example.com/hanon-1-10.pdf",
    uploaded_date: "2025-10-15",
  },
  {
    id: "download-3",
    title: "Music Theory Basics",
    description: "Circle of fifths and key signatures",
    category: "theory",
    file_url: "https://example.com/theory-basics.pdf",
    uploaded_date: "2025-09-20",
  },
  {
    id: "download-4",
    title: "Czerny Etude Op. 299 No. 1",
    description: "Technical study for velocity",
    category: "sheet-music",
    file_url: "https://example.com/czerny-299-1.pdf",
    uploaded_date: "2025-11-10",
  },
  {
    id: "download-5",
    title: "G Major Arpeggios",
    description: "Four octave arpeggio patterns",
    category: "scales",
    file_url: "https://example.com/g-arpeggios.pdf",
    uploaded_date: "2025-10-28",
  },
  {
    id: "download-6",
    title: "Chord Progressions Guide",
    description: "Common progressions in all keys",
    category: "theory",
    file_url: "https://example.com/chord-progressions.pdf",
    uploaded_date: "2025-11-05",
  },
]

// Mock Tutorials Data
export const mockTutorials: Tutorial[] = [
  {
    id: "tutorial-1",
    title: "Proper Hand Position & Posture",
    description: "Essential technique for preventing injury and improving sound quality",
    category: "technique",
    video_url: "https://example.com/hand-position.mp4",
    duration: "8:45",
    thumbnail_url: "/pianist-hands-proper-position.jpg",
  },
  {
    id: "tutorial-2",
    title: "Understanding Time Signatures",
    description: "Master 3/4, 4/4, 6/8 and other common time signatures",
    category: "theory",
    video_url: "https://example.com/time-signatures.mp4",
    duration: "12:20",
    thumbnail_url: "/music-notation-time-signature.jpg",
  },
  {
    id: "tutorial-3",
    title: "How to Practice Scales Effectively",
    description: "Daily routine for building speed and accuracy",
    category: "practice-tips",
    video_url: "https://example.com/scale-practice.mp4",
    duration: "10:15",
    thumbnail_url: "/piano-scales-practice.jpg",
  },
  {
    id: "tutorial-4",
    title: "Interpreting Bach's Prelude in C",
    description: "Phrasing, dynamics, and historical context",
    category: "repertoire",
    video_url: "https://example.com/bach-prelude.mp4",
    duration: "15:30",
    thumbnail_url: "/sheet-music-bach-prelude.jpg",
  },
  {
    id: "tutorial-5",
    title: "Pedaling Techniques",
    description: "When and how to use the sustain pedal",
    category: "technique",
    video_url: "https://example.com/pedaling.mp4",
    duration: "9:50",
    thumbnail_url: "/piano-pedals-close-up.jpg",
  },
  {
    id: "tutorial-6",
    title: "Building a Daily Practice Routine",
    description: "Maximize progress with structured practice sessions",
    category: "practice-tips",
    video_url: "https://example.com/practice-routine.mp4",
    duration: "11:40",
    thumbnail_url: "/practice-schedule-planner.jpg",
  },
]

export const mockMessages: Message[] = [
  {
    id: "msg-1",
    student_id: "student-1",
    sender: "teacher",
    content:
      "Great job on your Bach Prelude today! Remember to focus on keeping the left hand softer than the right in the melodic sections.",
    timestamp: "2025-11-22T15:30:00",
    read: true,
  },
  {
    id: "msg-2",
    student_id: "student-1",
    sender: "student",
    content: "Thank you! I've been practicing the fingering you showed me. Should I use the same pattern in bar 15?",
    timestamp: "2025-11-22T18:45:00",
    read: true,
  },
  {
    id: "msg-3",
    student_id: "student-1",
    sender: "teacher",
    content:
      "Yes, the same fingering works well there. Also, I've uploaded a new tutorial on pedaling that will help with the legato passages. Check the Tutorials section!",
    timestamp: "2025-11-23T09:15:00",
    read: true,
  },
  {
    id: "msg-4",
    student_id: "student-1",
    sender: "student",
    content: "Perfect, I'll watch it tonight. Also, is it okay if I arrive 5 minutes early next week to warm up?",
    timestamp: "2025-11-23T12:20:00",
    read: true,
  },
  {
    id: "msg-5",
    student_id: "student-1",
    sender: "teacher",
    content: "Of course! The studio will be open. See you then.",
    timestamp: "2025-11-23T14:00:00",
    read: true,
  },
  {
    id: "msg-6",
    student_id: "student-1",
    sender: "teacher",
    content:
      "Reminder: Don't forget to prepare your piece selection for the Winter Recital by next lesson. Let me know if you need help choosing!",
    timestamp: "2025-11-28T10:00:00",
    read: false,
  },
  // Student 2 messages
  {
    id: "msg-7",
    student_id: "student-2",
    sender: "teacher",
    content: "Marcus, your jazz improvisation is coming along nicely! Keep working on the ii-V-I progressions.",
    timestamp: "2025-11-25T17:00:00",
    read: true,
  },
  {
    id: "msg-8",
    student_id: "student-2",
    sender: "student",
    content: "Thanks! I've been listening to a lot of Bill Evans. Should I transcribe some of his solos?",
    timestamp: "2025-11-25T19:30:00",
    read: true,
  },
  {
    id: "msg-9",
    student_id: "student-2",
    sender: "teacher",
    content: "Start with 'Waltz for Debby' - the harmonies are beautiful and manageable.",
    timestamp: "2025-11-26T10:15:00",
    read: true,
  },
  {
    id: "msg-10",
    student_id: "student-2",
    sender: "student",
    content: "Quick question - I noticed I have a balance due. Is that from the late cancellation last week?",
    timestamp: "2025-11-27T14:00:00",
    read: false,
  },
  // Student 3 messages
  {
    id: "msg-11",
    student_id: "student-3",
    sender: "student",
    content: "Hi Professor! I just purchased a new practice keyboard. Any tips for setting it up?",
    timestamp: "2025-11-20T11:00:00",
    read: true,
  },
  {
    id: "msg-12",
    student_id: "student-3",
    sender: "teacher",
    content:
      "Congratulations Sophie! Make sure it's at the correct height - your forearms should be parallel to the floor.",
    timestamp: "2025-11-20T13:30:00",
    read: true,
  },
  {
    id: "msg-13",
    student_id: "student-3",
    sender: "student",
    content:
      "Got it! Also wanted to ask - is there a way to practice quietly at night without losing touch sensitivity?",
    timestamp: "2025-11-21T20:45:00",
    read: true,
  },
  {
    id: "msg-14",
    student_id: "student-3",
    sender: "teacher",
    content:
      "Use headphones and practice at a moderate volume. Many keyboards have a 'touch' setting - keep it on 'medium' or 'hard'.",
    timestamp: "2025-11-22T08:00:00",
    read: true,
  },
  // Student 4 messages
  {
    id: "msg-15",
    student_id: "student-4",
    sender: "teacher",
    content: "David, I noticed you're out of credits. Would you like to renew your package?",
    timestamp: "2025-11-15T16:00:00",
    read: true,
  },
  {
    id: "msg-16",
    student_id: "student-4",
    sender: "student",
    content: "Yes, I've been meaning to. I'll purchase a new package this week. Sorry about the delay!",
    timestamp: "2025-11-16T09:00:00",
    read: true,
  },
  {
    id: "msg-17",
    student_id: "student-4",
    sender: "teacher",
    content:
      "No problem! Just let me know when you're ready to schedule. Looking forward to continuing our Chopin work.",
    timestamp: "2025-11-16T11:30:00",
    read: false,
  },
]

// Mock Credit Packages
export const mockCreditPackages: CreditPackage[] = [
  {
    id: "pkg-single",
    name: "Single Lesson",
    credits: 1,
    price: 75,
    price_per_lesson: 75,
  },
  {
    id: "pkg-standard",
    name: "4-Lesson Package",
    credits: 4,
    price: 260,
    price_per_lesson: 65,
    popular: true,
  },
]

// Helper functions for mock data (will be replaced with Supabase calls)
export const getStudentByEmail = (email: string): Student | undefined => {
  return mockStudents.find((s) => s.email === email)
}

export const getLessonsByStudentId = (studentId: string): Lesson[] => {
  return mockLessons.filter((l) => l.student_id === studentId)
}

export const getTodaysLessons = (): Array<Lesson & { student: Student }> => {
  const today = "2025-12-02"
  return mockStudents
    .filter((s) => s.next_lesson?.date === today)
    .map((student) => ({
      id: `today-${student.id}`,
      student_id: student.id,
      date: student.next_lesson!.date,
      time: student.next_lesson!.time,
      duration: student.next_lesson!.duration,
      status: "scheduled" as const,
      student,
    }))
}

export const getMessagesByStudentId = (studentId: string): Message[] => {
  return mockMessages
    .filter((m) => m.student_id === studentId)
    .sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime())
}

export const getStudentsWithLastMessage = (): Array<Student & { lastMessage?: Message; unreadCount: number }> => {
  return mockStudents.map((student) => {
    const studentMessages = mockMessages.filter((m) => m.student_id === student.id)
    const sortedMessages = studentMessages.sort(
      (a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime(),
    )
    const unreadCount = studentMessages.filter((m) => !m.read && m.sender === "student").length
    return {
      ...student,
      lastMessage: sortedMessages[0],
      unreadCount,
    }
  })
}

export const getUnreadCountForStudent = (studentId: string): number => {
  return mockMessages.filter((m) => m.student_id === studentId && !m.read && m.sender === "student").length
}

export const getTotalUnreadForTeacher = (): number => {
  return mockMessages.filter((m) => !m.read && m.sender === "student").length
}
</file>

<file path="lib/zoom.ts">
// Basic in-memory cache for the token
let cachedToken: string | null = null
let tokenExpiry: number | null = null

export async function getZoomAccessToken(): Promise<string | null> {
    // Check cache
    if (cachedToken && tokenExpiry && Date.now() < tokenExpiry) {
        return cachedToken
    }

    const accountId = process.env.ZOOM_ACCOUNT_ID
    const clientId = process.env.ZOOM_CLIENT_ID
    const clientSecret = process.env.ZOOM_CLIENT_SECRET

    if (!accountId || !clientId || !clientSecret) {
        console.error('Missing Zoom credentials')
        return null
    }

    const authHeader = Buffer.from(`${clientId}:${clientSecret}`).toString('base64')

    try {
        const response = await fetch(
            `https://zoom.us/oauth/token?grant_type=account_credentials&account_id=${accountId}`,
            {
                method: 'POST',
                headers: {
                    Authorization: `Basic ${authHeader}`,
                },
            }
        )

        if (!response.ok) {
            const errorText = await response.text()
            console.error('Zoom OAuth error:', errorText)
            return null
        }

        const data = await response.json()

        // Cache token (subtract 60s buffer for safety)
        cachedToken = data.access_token
        tokenExpiry = Date.now() + (data.expires_in - 60) * 1000

        return data.access_token
    } catch (error) {
        console.error('Failed to get Zoom access token:', error)
        return null
    }
}

export async function createZoomMeeting(
    topic: string,
    startTime: string, // ISO format
    durationMinutes: number,
    inviteeEmails: string[] = []
): Promise<{ id: string, join_url: string } | null> {
    const token = await getZoomAccessToken()

    if (!token) {
        console.error('Could not obtain Zoom access token')
        return null
    }

    try {
        // Construct payload
        const payload: any = {
            topic,
            type: 2, // Scheduled meeting
            start_time: startTime,
            duration: durationMinutes,
            timezone: 'America/Los_Angeles', // Hardcoded for this studio
            settings: {
                join_before_host: false,
                waiting_room: true,
                mute_upon_entry: true,
                auto_recording: 'cloud', // Enable cloud recording by default if requested
                meeting_invitees: inviteeEmails.map(email => ({ email }))
            }
        }

        const response = await fetch('https://api.zoom.us/v2/users/me/meetings', {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        })

        if (!response.ok) {
            const errorText = await response.text()
            console.error('Zoom create meeting error:', errorText)
            return null
        }

        const data = await response.json()
        return {
            id: String(data.id),
            join_url: data.join_url
        }
    } catch (error) {
        console.error('Failed to create Zoom meeting:', error)
        return null
    }
}

export async function deleteZoomMeeting(meetingId: string): Promise<boolean> {
    const token = await getZoomAccessToken()
    if (!token) return false

    try {
        const response = await fetch(`https://api.zoom.us/v2/meetings/${meetingId}`, {
            method: 'DELETE',
            headers: {
                Authorization: `Bearer ${token}`
            }
        })

        if (!response.ok && response.status !== 404) { // 404 means already deleted
            const errorText = await response.text()
            console.error('Zoom delete meeting error:', errorText)
            return false
        }

        return true
    } catch (error) {
        console.error('Failed to delete Zoom meeting:', error)
        return false
    }
}

export async function updateZoomMeeting(
    meetingId: string,
    topic: string,
    startTime: string,
    duration: number
): Promise<boolean> {
    const token = await getZoomAccessToken()
    if (!token) return false

    try {
        const response = await fetch(`https://api.zoom.us/v2/meetings/${meetingId}`, {
            method: 'PATCH',
            headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                topic,
                start_time: startTime,
                duration,
                timezone: 'America/Los_Angeles'
            })
        })

        if (!response.ok) {
            const errorText = await response.text()
            console.error('Zoom update meeting error:', errorText)
            return false
        }

        return true
    } catch (error) {
        console.error('Failed to update Zoom meeting:', error)
        return false
    }
}
</file>

<file path="scripts/seed.ts">
import { createClient } from '@supabase/supabase-js'
import { config } from 'dotenv';
config({ path: '.env.local' });

// This script uses the service role key to bypass RLS
// Run with: pnpm run seed

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY!

if (!supabaseUrl || !supabaseServiceKey) {
    console.error('Missing environment variables. Make sure .env.local exists with:')
    console.error('  NEXT_PUBLIC_SUPABASE_URL')
    console.error('  SUPABASE_SERVICE_KEY')
    process.exit(1)
}

const supabase = createClient(supabaseUrl, supabaseServiceKey, {
    auth: {
        autoRefreshToken: false,
        persistSession: false
    }
})

async function seed() {
    console.log('ðŸŒ± Starting seed...\n')

    // 1. Create/update student user
    const studentId = await createOrGetUser('student@demo.com', 'password123')
    if (studentId) {
        await seedStudentProfile(studentId)
    }

    // 2. Create/update admin user
    const adminId = await createOrGetUser('support@musicalbasics.com', 'password123')
    if (adminId) {
        await seedAdminProfile(adminId)
    }

    console.log('\nðŸŽ‰ Seed completed successfully!')
    console.log('\nðŸ“‹ Test credentials:')
    console.log('  Student: student@demo.com / password123')
    console.log('  Admin:   support@musicalbasics.com / password123')
}

async function createOrGetUser(email: string, password: string): Promise<string | null> {
    console.log(`\nðŸ‘¤ Creating user: ${email}`)

    const { data: userData, error: userError } = await supabase.auth.admin.createUser({
        email,
        password,
        email_confirm: true
    })

    if (userError) {
        if (userError.message.includes('already been registered')) {
            console.log('   âš ï¸  User already exists, fetching existing user...')
            const { data: existingUsers } = await supabase.auth.admin.listUsers()
            const existingUser = existingUsers?.users?.find(u => u.email === email)
            if (existingUser) {
                console.log(`   âœ… Found existing user: ${existingUser.id}`)
                return existingUser.id
            }
        } else {
            console.error('   âŒ Error creating user:', userError)
            return null
        }
    } else if (userData.user) {
        console.log(`   âœ… User created: ${userData.user.id}`)
        return userData.user.id
    }
    return null
}

async function seedStudentProfile(userId: string) {
    console.log('\nðŸ“ Setting up student profile for Emily Chen...')

    const { error: profileError } = await supabase
        .from('profiles')
        .upsert({
            id: userId,
            name: 'Emily Chen',
            email: 'student@demo.com',
            phone: '(555) 123-4567',
            role: 'student',
            credits: 2,
            credits_total: 4,
            balance_due: 0.00,
            zoom_link: 'https://zoom.us/j/123456789'
        })

    if (profileError) {
        console.error('   âŒ Error updating profile:', profileError)
        return
    }
    console.log('   âœ… Profile updated')

    // Clear and insert lessons
    console.log('   ðŸ“š Setting up lessons...')
    await supabase.from('lessons').delete().eq('student_id', userId)

    const today = new Date()
    const todayStr = today.toISOString().split('T')[0]

    const pastDate = new Date(today)
    pastDate.setDate(today.getDate() - 7)

    const upcomingDate = new Date(today)
    upcomingDate.setDate(today.getDate() + 3)

    const cancelledDate = new Date(today)
    cancelledDate.setDate(today.getDate() - 14)

    const lessons = [
        {
            student_id: userId,
            date: pastDate.toISOString().split('T')[0],
            time: '15:00:00',
            status: 'completed',
            notes: 'Excellent progress on Bach Prelude in C Major. Focus on dynamics and phrasing.',
            video_url: 'https://example.com/lesson-recording.mp4',
            sheet_music_url: 'https://example.com/bach-prelude.pdf'
        },
        {
            student_id: userId,
            date: todayStr, // Lesson for today (for admin dashboard)
            time: '15:00:00',
            status: 'scheduled',
            notes: null,
            video_url: null,
            sheet_music_url: null
        },
        {
            student_id: userId,
            date: upcomingDate.toISOString().split('T')[0],
            time: '15:00:00',
            status: 'scheduled',
            notes: null,
            video_url: null,
            sheet_music_url: null
        },
        {
            student_id: userId,
            date: cancelledDate.toISOString().split('T')[0],
            time: '15:00:00',
            status: 'cancelled',
            notes: 'Student requested cancellation due to illness.',
            video_url: null,
            sheet_music_url: null
        }
    ]

    const { error: lessonsError } = await supabase
        .from('lessons')
        .insert(lessons)

    if (lessonsError) {
        console.error('   âŒ Error inserting lessons:', lessonsError)
        return
    }
    console.log('   âœ… 4 lessons inserted (1 past, 1 today, 1 upcoming, 1 cancelled)')
}

async function seedAdminProfile(userId: string) {
    console.log('\nðŸ“ Setting up admin profile for Professor Williams...')

    const { error: profileError } = await supabase
        .from('profiles')
        .upsert({
            id: userId,
            name: 'Professor Williams',
            email: 'support@musicalbasics.com',
            phone: '(555) 987-6543',
            role: 'admin',
            credits: 0,
            credits_total: 0,
            balance_due: 0.00,
            zoom_link: 'https://zoom.us/j/admin-studio'
        })

    if (profileError) {
        console.error('   âŒ Error updating admin profile:', profileError)
        return
    }
    console.log('   âœ… Admin profile created with role: admin')
}

seed().catch(console.error)
</file>

<file path="styles/globals.css">
@import 'tailwindcss';
@import 'tw-animate-css';

@custom-variant dark (&:is(.dark *));

:root {
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --destructive-foreground: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --radius: 0.625rem;
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.145 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.145 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.985 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.396 0.141 25.723);
  --destructive-foreground: oklch(0.637 0.237 25.331);
  --border: oklch(0.269 0 0);
  --input: oklch(0.269 0 0);
  --ring: oklch(0.439 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(0.269 0 0);
  --sidebar-ring: oklch(0.439 0 0);
}

@theme inline {
  --font-sans: 'Geist', 'Geist Fallback';
  --font-mono: 'Geist Mono', 'Geist Mono Fallback';
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="supabase/schema.sql">
-- =============================================
-- Piano Studio Management App - Database Schema
-- =============================================

-- Enable UUID extension (if not already enabled)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =============================================
-- TABLES
-- =============================================

-- Profiles table (extends auth.users)
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT,
  email TEXT,
  phone TEXT,
  role TEXT NOT NULL CHECK (role IN ('student', 'admin')) DEFAULT 'student',
  credits INTEGER NOT NULL DEFAULT 0,
  credits_total INTEGER NOT NULL DEFAULT 0,
  balance_due NUMERIC(10,2) NOT NULL DEFAULT 0.00,
  zoom_link TEXT,
  stripe_customer_id TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Lessons table
CREATE TABLE public.lessons (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  student_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  time TIME NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('scheduled', 'completed', 'cancelled')) DEFAULT 'scheduled',
  notes TEXT,
  video_url TEXT,
  sheet_music_url TEXT,
  duration INTEGER NOT NULL DEFAULT 60, -- Duration in minutes (30, 45, 60)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Messages table
CREATE TABLE public.messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sender_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  recipient_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  is_read BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- =============================================
-- INDEXES
-- =============================================

-- Lessons indexes
CREATE INDEX idx_lessons_student_id ON public.lessons(student_id);
CREATE INDEX idx_lessons_date ON public.lessons(date);
CREATE INDEX idx_lessons_status ON public.lessons(status);

-- Messages indexes
CREATE INDEX idx_messages_sender_id ON public.messages(sender_id);
CREATE INDEX idx_messages_recipient_id ON public.messages(recipient_id);
CREATE INDEX idx_messages_created_at ON public.messages(created_at DESC);

-- =============================================
-- FUNCTIONS
-- =============================================

-- Function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to create a profile when a new user signs up
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, role)
  VALUES (NEW.id, 'student');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =============================================
-- TRIGGERS
-- =============================================

-- Auto-update updated_at for profiles
CREATE TRIGGER on_profiles_updated
  BEFORE UPDATE ON public.profiles
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_updated_at();

-- Auto-update updated_at for lessons
CREATE TRIGGER on_lessons_updated
  BEFORE UPDATE ON public.lessons
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_updated_at();

-- Auto-create profile on user signup
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();

-- =============================================
-- ROW LEVEL SECURITY (RLS)
-- =============================================

-- Enable RLS on all tables
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.lessons ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;

-- =============================================
-- RLS POLICIES - PROFILES
-- =============================================

-- Helper function to check if user is admin
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid() AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Profiles: Users can view their own profile
CREATE POLICY "Users can view own profile"
  ON public.profiles
  FOR SELECT
  USING (auth.uid() = id);

-- Profiles: Admins can view all profiles
CREATE POLICY "Admins can view all profiles"
  ON public.profiles
  FOR SELECT
  USING (public.is_admin());

-- Profiles: All authenticated users can view admin profiles (for messaging)
CREATE POLICY "Users can view admin profiles"
  ON public.profiles
  FOR SELECT
  USING (role = 'admin' AND auth.uid() IS NOT NULL);

-- Profiles: Users can update their own profile (non-role fields)
CREATE POLICY "Users can update own profile"
  ON public.profiles
  FOR UPDATE
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id AND role = (SELECT role FROM public.profiles WHERE id = auth.uid()));

-- Profiles: Admins can update any profile
CREATE POLICY "Admins can update all profiles"
  ON public.profiles
  FOR UPDATE
  USING (public.is_admin());

-- =============================================
-- RLS POLICIES - LESSONS
-- =============================================

-- Lessons: Students can view their own lessons
CREATE POLICY "Students can view own lessons"
  ON public.lessons
  FOR SELECT
  USING (auth.uid() = student_id);

-- Lessons: Admins can view all lessons
CREATE POLICY "Admins can view all lessons"
  ON public.lessons
  FOR SELECT
  USING (public.is_admin());

-- Lessons: Only admins can insert lessons
CREATE POLICY "Admins can insert lessons"
  ON public.lessons
  FOR INSERT
  WITH CHECK (public.is_admin());

-- Lessons: Only admins can update lessons
CREATE POLICY "Admins can update lessons"
  ON public.lessons
  FOR UPDATE
  USING (public.is_admin());

-- Lessons: Only admins can delete lessons
CREATE POLICY "Admins can delete lessons"
  ON public.lessons
  FOR DELETE
  USING (public.is_admin());

-- =============================================
-- RLS POLICIES - MESSAGES
-- =============================================

-- Messages: Users can view messages they sent or received
CREATE POLICY "Users can view own messages"
  ON public.messages
  FOR SELECT
  USING (auth.uid() = sender_id OR auth.uid() = recipient_id);

-- Messages: Admins can view all messages
CREATE POLICY "Admins can view all messages"
  ON public.messages
  FOR SELECT
  USING (public.is_admin());

-- Messages: Users can send messages (insert)
CREATE POLICY "Users can send messages"
  ON public.messages
  FOR INSERT
  WITH CHECK (auth.uid() = sender_id);

-- Messages: Users can update their received messages (mark as read)
CREATE POLICY "Users can mark received messages as read"
  ON public.messages
  FOR UPDATE
  USING (auth.uid() = recipient_id)
  WITH CHECK (auth.uid() = recipient_id);

-- Messages: Admins can delete any message
CREATE POLICY "Admins can delete messages"
  ON public.messages
  FOR DELETE
  USING (public.is_admin());
</file>

<file path=".env.local.example">
# ===========================================
# Piano Studio Management App - Environment Variables
# ===========================================
# Copy this file to .env.local and fill in your values

# Supabase Configuration
# Get these from: https://supabase.com/dashboard/project/_/settings/api
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_KEY=your_supabase_service_role_key

# Resend Email Configuration
# Get this from: https://resend.com/api-keys
RESEND_API_KEY=re_your_resend_api_key

# Stripe Payments Configuration
# Get these from: https://dashboard.stripe.com/apikeys
STRIPE_SECRET_KEY=sk_test_your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret

# Optional: Stripe publishable key for client-side
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_publishable_key
</file>

<file path="middleware.ts">
import { type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase/middleware'

export async function middleware(request: NextRequest) {
    return await updateSession(request)
}

export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * Feel free to modify this pattern to include more paths.
         */
        '/((?!_next/static|_next/image|favicon.ico|api/webhooks|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
    ],
}
</file>

<file path="app/actions/billing.ts">
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { sendMessage } from '@/app/messages/actions'

/**
 * Admin: Add an ad-hoc charge to a student's balance
 */
export async function addAdHocCharge(studentId: string, amount: number, description: string) {
    const supabase = await createClient()

    // 1. Verify Admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can add charges' }
    }

    // 2. Get current balance
    const { data: profile } = await supabase
        .from('profiles')
        .select('balance_due, name')
        .eq('id', studentId)
        .single()

    if (!profile) return { error: 'Student not found' }

    // 3. Update Balance
    const newBalance = Number(profile.balance_due) + amount

    const { error } = await supabase
        .from('profiles')
        .update({ balance_due: newBalance })
        .eq('id', studentId)

    if (error) return { error: error.message }

    // 4. Send a system message to notify the student
    await sendMessage(
        studentId,
        `New Charge Added: $${amount.toFixed(2)} for "${description}".\nCurrent Balance Due: $${newBalance.toFixed(2)}.`
    )

    revalidatePath('/admin')
    revalidatePath('/student')

    return { success: true, message: `Charged $${amount} to ${profile.name}` }
}
</file>

<file path="app/actions/notifications.ts">
'use server'

import { createClient } from '@/lib/supabase/server'
import { Resend } from 'resend'

const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null

/**
 * Notify the admin when a student joins Classroom or Zoom from their student page.
 * Fire-and-forget â€” callers don't need to await this.
 */
export async function notifyStudentJoined(type: 'classroom' | 'zoom') {
    const supabase = await createClient()

    // 1. Authenticate the student
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    // 2. Fetch student name
    const { data: student } = await supabase
        .from('profiles')
        .select('name')
        .eq('id', user.id)
        .single()

    const studentName = student?.name || 'A student'

    // 3. Find admin email
    const { data: admin } = await supabase
        .from('profiles')
        .select('email, studio_name')
        .eq('role', 'admin')
        .limit(1)
        .single()

    if (!admin?.email) {
        console.error('[notifyStudentJoined] No admin email found')
        return { error: 'No admin email found' }
    }

    // 4. Format the current time for the email body
    const now = new Date()
    const formattedTime = now.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
        timeZone: 'America/Los_Angeles',
    })
    const formattedDate = now.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'short',
        day: 'numeric',
        timeZone: 'America/Los_Angeles',
    })

    const label = type === 'classroom' ? 'Classroom' : 'Zoom'

    // 5. Send email
    if (!resend) {
        console.log(`[notifyStudentJoined] Resend not configured. ${studentName} joined ${label}.`)
        return { success: true }
    }

    try {
        const studioName = admin.studio_name || 'Lionel Yu Piano Studio'

        await resend.emails.send({
            from: `${studioName} <notifications@updates.musicalbasics.com>`,
            to: admin.email,
            subject: `${studentName} just joined ${label}`,
            html: `
                <div style="font-family: -apple-system, sans-serif; max-width: 480px; margin: 0 auto; padding: 32px 20px;">
                    <h2 style="font-size: 20px; margin: 0 0 16px; color: #1a1a1a;">
                        ðŸŽ¹ Student Joined ${label}
                    </h2>
                    <p style="font-size: 15px; color: #555; line-height: 1.6; margin: 0;">
                        <strong>${studentName}</strong> joined the <strong>${label}</strong> at ${formattedTime} on ${formattedDate}.
                    </p>
                </div>
            `,
        })

        console.log(`[notifyStudentJoined] Email sent: ${studentName} joined ${label}`)
        return { success: true }
    } catch (err) {
        console.error('[notifyStudentJoined] Failed to send email:', err)
        return { error: 'Failed to send notification' }
    }
}
</file>

<file path="app/actions/student-history.ts">
'use server'

import { createClient } from '@/lib/supabase/server'

export async function getStudentLessonHistory(studentId: string) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    // Fetch the student's completed lessons, most recent first
    const { data: lessons, error } = await supabase
        .from('lessons')
        .select('id, date, time, duration, status, notes, credit_snapshot, credit_snapshot_before, video_url, sheet_music_url')
        .eq('student_id', studentId)
        .eq('status', 'completed')
        .order('date', { ascending: false })
        .order('time', { ascending: false })
        .limit(30)

    if (error) {
        console.error('getStudentLessonHistory error:', error)
        return { error: error.message }
    }

    return { lessons: lessons || [] }
}
</file>

<file path="app/actions/uploads.ts">
'use server'

import { createClient } from '@supabase/supabase-js'

export async function uploadSheetMusic(formData: FormData, lessonId: string) {
    const file = formData.get('file') as File
    if (!file || !lessonId) {
        return { error: 'Missing file or lesson ID' }
    }

    // Use Service Role Key to bypass RLS
    const supabaseAdmin = createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!
    )

    const timestamp = Date.now()
    // Sanitize filename to prevent issues
    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_')
    const filePath = `sheet_music/${lessonId}/${timestamp}_${safeName}`

    try {
        // 1. Upload File
        const { error: uploadError } = await supabaseAdmin.storage
            .from('lesson_materials')
            .upload(filePath, file, {
                contentType: file.type,
                upsert: true
            })

        if (uploadError) throw uploadError

        // 2. Get Public URL
        const { data } = supabaseAdmin.storage
            .from('lesson_materials')
            .getPublicUrl(filePath)

        return { success: true, url: data.publicUrl }

    } catch (error: any) {
        console.error('Upload failed:', error)
        return { error: error.message }
    }
}
</file>

<file path="app/login/page.tsx">
import { createClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"
import { LoginForm } from "@/components/auth/login-form"

export default async function LoginPage() {
  const supabase = await createClient()

  // 1. Check if the user is already logged in
  const { data: { user } } = await supabase.auth.getUser()

  // 2. If they are, kick them to the dashboard immediately
  if (user) {
    redirect('/student')
  }

  // 3. If not, render the login page as usual
  return <LoginForm />
}
</file>

<file path="components/admin/add-student-modal.tsx">
"use client"

import { useState } from "react"
import { useRouter } from "next/navigation"
import { useFormStatus } from "react-dom"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import { UserPlus, Loader2 } from "lucide-react"
import { createStudent } from "@/app/actions/users"
import { useToast } from "@/hooks/use-toast"

function SubmitButton() {
    const { pending } = useFormStatus()

    return (
        <Button type="submit" disabled={pending} className="w-full">
            {pending ? (
                <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Creating...
                </>
            ) : (
                <>
                    <UserPlus className="h-4 w-4 mr-2" />
                    Create Student
                </>
            )}
        </Button>
    )
}

export function AddStudentModal() {
    const [open, setOpen] = useState(false)
    const { toast } = useToast()
    const router = useRouter()

    async function handleSubmit(formData: FormData) {
        const result = await createStudent(formData)

        if (result.error) {
            toast({
                variant: "destructive",
                title: "Error",
                description: result.error
            })
        } else if (result.success) {
            toast({
                title: "Student Created!",
                description: `${result.message} Temporary password: ${result.tempPassword}`
            })
            setOpen(false)
            router.refresh()
        }
    }

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button size="sm">
                    <UserPlus className="h-4 w-4 mr-2" />
                    Add Student
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-md">
                <DialogHeader>
                    <DialogTitle className="text-2xl font-serif">Add New Student</DialogTitle>
                    <DialogDescription>
                        Create a new student account. They can log in with the temporary password.
                    </DialogDescription>
                </DialogHeader>

                <form action={handleSubmit} className="space-y-4 py-4">
                    <div className="space-y-2">
                        <Label htmlFor="name">Full Name *</Label>
                        <Input
                            id="name"
                            name="name"
                            type="text"
                            placeholder="Emily Chen"
                            required
                        />
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="email">Email *</Label>
                        <Input
                            id="email"
                            name="email"
                            type="email"
                            placeholder="emily@example.com"
                            required
                        />
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="parentEmail">Parent Email (Optional - for CC)</Label>
                        <Input
                            id="parentEmail"
                            name="parentEmail"
                            type="email"
                            placeholder="parent@example.com"
                        />
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="phone">Phone (optional)</Label>
                        <Input
                            id="phone"
                            name="phone"
                            type="tel"
                            placeholder="(555) 123-4567"
                        />
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="credits">Initial Credits</Label>
                        <Input
                            id="credits"
                            name="credits"
                            type="number"
                            min="0"
                            defaultValue="0"
                            placeholder="0"
                        />
                    </div>

                    <div className="space-y-2">
                        <Label>Lesson Duration</Label>
                        <div className="flex gap-2">
                            {[30, 45, 60].map((mins) => (
                                <label key={mins} className="flex-1">
                                    <input
                                        type="radio"
                                        name="lessonDuration"
                                        value={mins}
                                        defaultChecked={mins === 30}
                                        className="sr-only peer"
                                    />
                                    <div className="text-center py-2 px-3 rounded-md border-2 cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50">
                                        <span className="font-medium">{mins}</span>
                                        <span className="text-muted-foreground text-sm"> min</span>
                                    </div>
                                </label>
                            ))}
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="lessonDay">Recurring Lesson Day</Label>
                        <select
                            id="lessonDay"
                            name="lessonDay"
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                        >
                            <option value="">None</option>
                            {['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => (
                                <option key={day} value={day}>{day}</option>
                            ))}
                        </select>
                    </div>

                    <input type="hidden" name="password" value="piano123" />

                    <div className="pt-4">
                        <SubmitButton />
                    </div>

                    <p className="text-xs text-muted-foreground text-center">
                        Default password: <span className="font-mono">piano123</span>
                    </p>
                </form>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/admin/charge-student-modal.tsx">
"use client"

import { useState } from "react"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Loader2, DollarSign } from "lucide-react"
import { addAdHocCharge } from "@/app/actions/billing"
import { useToast } from "@/hooks/use-toast"

interface ChargeStudentModalProps {
    studentId: string
    studentName: string
    open: boolean
    onOpenChange: (open: boolean) => void
}

export function ChargeStudentModal({ studentId, studentName, open, onOpenChange }: ChargeStudentModalProps) {
    const { toast } = useToast()
    const [amount, setAmount] = useState("")
    const [description, setDescription] = useState("")
    const [isLoading, setIsLoading] = useState(false)

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        if (!amount || !description) return

        setIsLoading(true)
        const result = await addAdHocCharge(studentId, parseFloat(amount), description)
        setIsLoading(false)

        if (result.error) {
            toast({ variant: "destructive", title: "Error", description: result.error })
        } else {
            toast({ title: "Charge Added", description: result.message })
            onOpenChange(false)
            setAmount("")
            setDescription("")
        }
    }

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>Charge {studentName}</DialogTitle>
                    <DialogDescription>
                        Add a manual charge to the student's outstanding balance.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit} className="space-y-4 pt-4">
                    <div className="space-y-2">
                        <Label htmlFor="amount">Amount ($)</Label>
                        <div className="relative">
                            <DollarSign className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                            <Input
                                id="amount"
                                type="number"
                                placeholder="0.00"
                                className="pl-9"
                                step="0.01"
                                min="0.50"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                required
                            />
                        </div>
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="description">Reason</Label>
                        <Input
                            id="description"
                            placeholder="e.g. Sheet Music: Bach Prelude"
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            required
                        />
                    </div>
                    <div className="flex justify-end pt-2">
                        <Button type="submit" disabled={isLoading}>
                            {isLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : "Confirm Charge"}
                        </Button>
                    </div>
                </form>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/admin/completed-tab.tsx">
"use client"

import React from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Calendar, Clock, Music, Video, FileText, Pencil } from "lucide-react"
import type { LessonWithStudent } from "@/types/admin"

interface CompletedTabProps {
    lessons: LessonWithStudent[]
    onEdit: (lesson: LessonWithStudent) => void
}

export function CompletedTab({ lessons, onEdit }: CompletedTabProps) {
    const formatDate = (dateStr: string) => {
        const date = new Date(dateStr + 'T00:00:00')
        return date.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
        })
    }

    const formatTime = (timeStr: string) => {
        const [hours, minutes] = timeStr.split(':').map(Number)
        const ampm = hours >= 12 ? 'PM' : 'AM'
        const displayHours = hours % 12 || 12
        return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`
    }

    return (
        <Card>
            <CardHeader>
                <div className="flex items-center justify-between">
                    <div>
                        <CardTitle className="text-2xl font-serif">Completed Lessons</CardTitle>
                        <CardDescription>Past lesson history</CardDescription>
                    </div>
                    <Badge variant="secondary" className="text-base px-4 py-2">
                        {lessons.length} Lessons
                    </Badge>
                </div>
            </CardHeader>
            <CardContent>
                <div className="space-y-4">
                    {lessons.length === 0 ? (
                        <p className="text-center text-muted-foreground py-8">No completed lessons</p>
                    ) : (
                        lessons.map((lesson) => (
                            <Card key={lesson.id} className="border">
                                <CardContent className="p-6">
                                    <div className="flex items-start justify-between">
                                        <div className="flex items-center gap-4">
                                            <div className="flex flex-col items-center justify-center h-14 w-14 bg-muted rounded-lg">
                                                <Music className="h-6 w-6 text-muted-foreground" />
                                            </div>
                                            <div>
                                                <h3 className="font-semibold text-lg">{lesson.student.name || 'Student'}</h3>
                                                <div className="flex items-center gap-4 text-sm text-muted-foreground mt-1">
                                                    <div className="flex items-center gap-1">
                                                        <Calendar className="h-3 w-3" />
                                                        <span>{formatDate(lesson.date)}</span>
                                                    </div>
                                                    <div className="flex items-center gap-1">
                                                        <Clock className="h-3 w-3" />
                                                        <span>{formatTime(lesson.time)}</span>
                                                    </div>
                                                </div>
                                                {lesson.notes && (
                                                    <p className="text-sm text-muted-foreground mt-2 line-clamp-2">
                                                        {lesson.notes}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex flex-col items-end gap-2">
                                            <div className="flex items-center gap-2">
                                                <Button
                                                    size="sm"
                                                    variant="outline"
                                                    onClick={() => onEdit(lesson)}
                                                >
                                                    <Pencil className="h-3 w-3 mr-1" />
                                                    Edit
                                                </Button>
                                                <Badge variant="default" className="bg-green-600">Completed</Badge>
                                            </div>
                                            {(lesson.video_url || lesson.sheet_music_url) && (
                                                <div className="flex gap-2">
                                                    {lesson.video_url && (
                                                        <a
                                                            href={lesson.video_url}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 text-xs font-medium transition-colors"
                                                        >
                                                            <Video className="h-3 w-3" />
                                                            Video
                                                        </a>
                                                    )}
                                                    {lesson.sheet_music_url && (
                                                        <a
                                                            href={lesson.sheet_music_url}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-purple-100 text-purple-700 hover:bg-purple-200 text-xs font-medium transition-colors"
                                                        >
                                                            <FileText className="h-3 w-3" />
                                                            Sheet Music
                                                        </a>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </CardContent>
                            </Card>
                        ))
                    )}
                </div>
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/admin/inquiries-tab.tsx">
"use client"

import { useState } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Mail, Phone, Calendar, CheckCircle2, Archive, MessageSquare } from "lucide-react"
import type { Database } from "@/lib/supabase/database.types"
import { updateInquiryStatus } from "@/app/actions/inquiries"
import { useToast } from "@/hooks/use-toast"
import { useRouter } from "next/navigation"

// Define a local type if not yet in database.types.ts explicitly
type Inquiry = {
    id: string
    name: string
    email: string
    phone: string | null
    experience: string
    goals: string
    status: 'new' | 'contacted' | 'student' | 'archived'
    created_at: string
}

interface InquiriesTabProps {
    inquiries: Inquiry[]
}

export function InquiriesTab({ inquiries }: InquiriesTabProps) {
    const { toast } = useToast()
    const router = useRouter()
    const [selectedInquiry, setSelectedInquiry] = useState<Inquiry | null>(null)
    const [isStatusUpdating, setIsStatusUpdating] = useState(false)

    // Sort by status (new first) then date
    const sortedInquiries = [...inquiries].sort((a, b) => {
        if (a.status === 'new' && b.status !== 'new') return -1
        if (a.status !== 'new' && b.status === 'new') return 1
        return new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
    })

    const handleStatusUpdate = async (newStatus: Inquiry['status']) => {
        if (!selectedInquiry) return

        setIsStatusUpdating(true)
        const result = await updateInquiryStatus(selectedInquiry.id, newStatus)

        if (result.success) {
            toast({
                title: "Status Updated",
                description: `Inquiry marked as ${newStatus}.`
            })
            router.refresh()
            // Optionally close dialog if moving to archived/student
            if (newStatus === 'archived' || newStatus === 'student') {
                setSelectedInquiry(null)
            } else {
                // Update local state for immediate feedback in modal
                setSelectedInquiry(prev => prev ? { ...prev, status: newStatus } : null)
            }
        } else {
            toast({
                variant: "destructive",
                title: "Error",
                description: "Failed to update status."
            })
        }
        setIsStatusUpdating(false)
    }

    const getStatusBadge = (status: string) => {
        switch (status) {
            case 'new': return <Badge className="bg-blue-500 hover:bg-blue-600">New</Badge>
            case 'contacted': return <Badge variant="secondary" className="bg-yellow-100 text-yellow-800 hover:bg-yellow-200">Contacted</Badge>
            case 'student': return <Badge className="bg-green-500 hover:bg-green-600">Enrolled</Badge>
            case 'archived': return <Badge variant="outline" className="text-muted-foreground">Archived</Badge>
            default: return <Badge variant="outline">{status}</Badge>
        }
    }

    return (
        <Card className="h-full border-none shadow-none">
            <CardHeader className="px-0 pt-0">
                <div className="flex items-center justify-between">
                    <div>
                        <CardTitle className="text-2xl font-serif">Inquiries</CardTitle>
                        <CardDescription>Manage new lesson requests</CardDescription>
                    </div>
                </div>
            </CardHeader>
            <CardContent className="px-0">
                <div className="rounded-md border">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>Date</TableHead>
                                <TableHead>Name</TableHead>
                                <TableHead>Experience</TableHead>
                                <TableHead>Status</TableHead>
                                <TableHead className="text-right">Actions</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {sortedInquiries.length === 0 ? (
                                <TableRow>
                                    <TableCell colSpan={5} className="h-24 text-center text-muted-foreground">
                                        No inquiries yet.
                                    </TableCell>
                                </TableRow>
                            ) : (
                                sortedInquiries.map((inquiry) => (
                                    <TableRow key={inquiry.id}>
                                        <TableCell className="whitespace-nowrap">
                                            {new Date(inquiry.created_at).toLocaleDateString()}
                                        </TableCell>
                                        <TableCell>
                                            <div className="flex flex-col">
                                                <span className="font-medium">{inquiry.name}</span>
                                                <span className="text-xs text-muted-foreground">{inquiry.email}</span>
                                            </div>
                                        </TableCell>
                                        <TableCell>{inquiry.experience}</TableCell>
                                        <TableCell>{getStatusBadge(inquiry.status)}</TableCell>
                                        <TableCell className="text-right">
                                            <Button variant="ghost" size="sm" onClick={() => setSelectedInquiry(inquiry)}>
                                                View Details
                                            </Button>
                                        </TableCell>
                                    </TableRow>
                                ))
                            )}
                        </TableBody>
                    </Table>
                </div>
            </CardContent>

            <Dialog open={!!selectedInquiry} onOpenChange={(open) => !open && setSelectedInquiry(null)}>
                <DialogContent className="sm:max-w-[600px]">
                    <DialogHeader>
                        <DialogTitle className="font-serif text-2xl">Inquiry Details</DialogTitle>
                        <DialogDescription>
                            Received on {selectedInquiry && new Date(selectedInquiry.created_at).toLocaleString()}
                        </DialogDescription>
                    </DialogHeader>

                    {selectedInquiry && (
                        <div className="grid gap-6 py-4">
                            <div className="flex items-center justify-between p-4 bg-muted/50 rounded-lg">
                                <div className="space-y-1">
                                    <h3 className="font-semibold text-lg">{selectedInquiry.name}</h3>
                                    <div className="flex items-center gap-4 text-sm text-muted-foreground">
                                        <div className="flex items-center gap-1">
                                            <Mail className="h-3 w-3" />
                                            {selectedInquiry.email}
                                        </div>
                                        {selectedInquiry.phone && (
                                            <div className="flex items-center gap-1">
                                                <Phone className="h-3 w-3" />
                                                {selectedInquiry.phone}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                {getStatusBadge(selectedInquiry.status)}
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <Label className="text-muted-foreground">Experience Level</Label>
                                    <div className="font-medium">{selectedInquiry.experience}</div>
                                </div>
                                <div className="space-y-2">
                                    <Label className="text-muted-foreground">Current Status</Label>
                                    <Select
                                        value={selectedInquiry.status}
                                        onValueChange={(val: any) => handleStatusUpdate(val)}
                                        disabled={isStatusUpdating}
                                    >
                                        <SelectTrigger>
                                            <SelectValue />
                                        </SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="new">New</SelectItem>
                                            <SelectItem value="contacted">Contacted</SelectItem>
                                            <SelectItem value="student">Enrolled</SelectItem>
                                            <SelectItem value="archived">Archived</SelectItem>
                                        </SelectContent>
                                    </Select>
                                </div>
                            </div>

                            <div className="space-y-2">
                                <Label className="text-muted-foreground">Musical Goals</Label>
                                <div className="p-4 bg-muted/30 rounded-md text-sm leading-relaxed whitespace-pre-wrap">
                                    {selectedInquiry.goals}
                                </div>
                            </div>

                            <div className="flex justify-end gap-2 pt-4">
                                <Button variant="outline" onClick={() => setSelectedInquiry(null)}>
                                    Close
                                </Button>
                                <Button asChild>
                                    <a href={`mailto:${selectedInquiry.email}?subject=Piano Lesson Inquiry`}>
                                        <Mail className="mr-2 h-4 w-4" />
                                        Reply via Email
                                    </a>
                                </Button>
                            </div>
                        </div>
                    )}
                </DialogContent>
            </Dialog>
        </Card>
    )
}
</file>

<file path="components/admin/lesson-detail-modal.tsx">
"use client"

import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Separator } from "@/components/ui/separator"
import { Calendar, Clock, Download, Music } from "lucide-react"
import { VideoPlayer } from "@/components/video-player"
import type { Lesson } from "@/lib/mock-data"

interface LessonDetailModalProps {
  lesson: Lesson
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function LessonDetailModal({ lesson, open, onOpenChange }: LessonDetailModalProps) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-2xl font-serif">Lesson Details</DialogTitle>
          <div className="flex items-center gap-4 text-sm text-muted-foreground pt-2">
            <div className="flex items-center gap-1">
              <Calendar className="h-4 w-4" />
              <span>{lesson.date}</span>
            </div>
            <div className="flex items-center gap-1">
              <Clock className="h-4 w-4" />
              <span>{lesson.time}</span>
            </div>
            <div className="flex items-center gap-1">
              <Music className="h-4 w-4" />
              <span>{lesson.duration} minutes</span>
            </div>
          </div>
        </DialogHeader>

        <div className="space-y-6 py-4">
          {/* Teacher Notes */}
          {lesson.teacher_notes && (
            <div>
              <h3 className="font-semibold text-lg mb-3 font-serif">Teacher Notes</h3>
              <div className="bg-muted p-4 rounded-lg">
                <p className="text-sm leading-relaxed whitespace-pre-line">{lesson.teacher_notes}</p>
              </div>
            </div>
          )}

          {/* Homework */}
          {lesson.homework && (
            <div>
              <h3 className="font-semibold text-lg mb-3 font-serif">Homework</h3>
              <div className="bg-accent p-4 rounded-lg border-l-4 border-primary">
                <p className="text-sm leading-relaxed">{lesson.homework}</p>
              </div>
            </div>
          )}

          <Separator />

          {/* Lesson Video */}
          {lesson.video_url && (
            <div>
              <h3 className="font-semibold text-lg mb-3 font-serif">Lesson Recording</h3>
              <VideoPlayer url={lesson.video_url} title={`Lesson - ${lesson.date}`} />
            </div>
          )}

          {/* Sheet Music */}
          {lesson.sheet_music_url && (
            <div>
              <h3 className="font-semibold text-lg mb-3 font-serif">Sheet Music</h3>
              <Button variant="outline" className="w-full bg-transparent" asChild>
                <a href={lesson.sheet_music_url} download>
                  <Download className="h-4 w-4 mr-2" />
                  Download Sheet Music (PDF)
                </a>
              </Button>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  )
}
</file>

<file path="components/admin/library-file-selector.tsx">
"use client"

import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Search, Folder, File, FileText, Music, Loader2 } from "lucide-react"
import { getResources, type Resource } from "@/app/actions/resources"
import { Badge } from "@/components/ui/badge"

interface LibraryFileSelectorProps {
    onSelect: (file: { url: string; name: string; type: string; size: number }) => void
    trigger?: React.ReactNode
}

export function LibraryFileSelector({ onSelect, trigger }: LibraryFileSelectorProps) {
    const [isOpen, setIsOpen] = useState(false)
    const [resources, setResources] = useState<Resource[]>([])
    const [isLoading, setIsLoading] = useState(false)
    const [searchQuery, setSearchQuery] = useState("")
    const [selectedCategory, setSelectedCategory] = useState<string | null>(null)

    useEffect(() => {
        if (isOpen) {
            loadResources()
        }
    }, [isOpen])

    async function loadResources() {
        setIsLoading(true)
        try {
            const { resources: data, error } = await getResources()
            if (data) {
                setResources(data)
            } else if (error) {
                console.error("Failed to load resources:", error)
            }
        } catch (err) {
            console.error("Error loading resources:", err)
        } finally {
            setIsLoading(false)
        }
    }

    const filteredResources = resources.filter(resource => {
        const matchesSearch = resource.title.toLowerCase().includes(searchQuery.toLowerCase())
        const matchesCategory = selectedCategory ? resource.category === selectedCategory : true
        return matchesSearch && matchesCategory
    })

    const categories = Array.from(new Set(resources.map(r => r.category)))

    const handleSelect = (resource: Resource) => {
        onSelect({
            url: resource.file_url,
            name: resource.title, // Use title as name for better readability
            type: resource.file_type,
            size: 0 // We might not have size readily available, checking...
        })
        setIsOpen(false)
    }

    const getFileIcon = (type: string) => {
        if (type.includes('image')) return <FileText className="h-4 w-4 text-blue-500" />
        if (type.includes('pdf')) return <FileText className="h-4 w-4 text-red-500" />
        if (type.includes('audio')) return <Music className="h-4 w-4 text-purple-500" />
        return <File className="h-4 w-4 text-gray-500" />
    }

    return (
        <Dialog open={isOpen} onOpenChange={setIsOpen}>
            <DialogTrigger asChild>
                {trigger || (
                    <Button variant="ghost" size="icon" title="Add from Library">
                        <Folder className="h-4 w-4" />
                    </Button>
                )}
            </DialogTrigger>
            <DialogContent className="max-w-2xl h-[80vh] flex flex-col p-0 gap-0">
                <DialogHeader className="p-6 pb-2">
                    <DialogTitle>Select from Library</DialogTitle>
                </DialogHeader>

                <div className="px-6 py-2 gap-4 flex flex-col border-b bg-muted/20">
                    <div className="relative">
                        <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                        <Input
                            placeholder="Search resources..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="pl-9 bg-background"
                        />
                    </div>
                    <div className="flex gap-2 pb-2 overflow-x-auto">
                        <Badge
                            variant={selectedCategory === null ? "default" : "outline"}
                            className="cursor-pointer whitespace-nowrap"
                            onClick={() => setSelectedCategory(null)}
                        >
                            All
                        </Badge>
                        {categories.map(cat => (
                            <Badge
                                key={cat}
                                variant={selectedCategory === cat ? "default" : "outline"}
                                className="cursor-pointer whitespace-nowrap"
                                onClick={() => setSelectedCategory(cat)}
                            >
                                {cat}
                            </Badge>
                        ))}
                    </div>
                </div>

                <ScrollArea className="flex-1 p-6">
                    {isLoading ? (
                        <div className="flex items-center justify-center h-40">
                            <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                        </div>
                    ) : filteredResources.length === 0 ? (
                        <div className="text-center py-12 text-muted-foreground">
                            <Folder className="h-12 w-12 mx-auto mb-3 opacity-20" />
                            <p>No resources found</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {filteredResources.map((resource) => (
                                <button
                                    key={resource.id}
                                    onClick={() => handleSelect(resource)}
                                    className="flex items-start gap-3 p-3 rounded-lg border bg-card hover:bg-accent/50 hover:border-accent transition-all text-left group"
                                >
                                    <div className="h-10 w-10 shrink-0 rounded-lg bg-muted flex items-center justify-center group-hover:bg-background transition-colors">
                                        {getFileIcon(resource.file_type)}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className="font-medium text-sm truncate">{resource.title}</p>
                                        <div className="flex items-center gap-2 mt-1">
                                            <span className="text-[10px] text-muted-foreground px-1.5 py-0.5 rounded-full bg-muted">
                                                {resource.category}
                                            </span>
                                            {resource.description && (
                                                <p className="text-xs text-muted-foreground truncate max-w-[120px]">
                                                    {resource.description}
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                </button>
                            ))}
                        </div>
                    )}
                </ScrollArea>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/admin/master-calendar.tsx">
"use client"

import { useState, useEffect } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover"
import { ChevronLeft, ChevronRight, Loader2, Calendar as CalendarIcon, Clock, Pencil, Trash2, MoreHorizontal } from "lucide-react"
import { getLessonsForDateRange } from "@/app/actions/lessons"
import type { Lesson, Profile } from "@/lib/supabase/database.types"
import type { AdminEvent, EventInvite } from "@/app/actions/events"

// Helper to format date as YYYY-MM-DD for comparison/filtering
const formatDateKey = (date: Date) => {
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
}

// Helper to extract LOCAL date and time from an ISO string
// (Same as in create-event-modal.tsx)
const getLocalDateTime = (isoString: string) => {
    if (!isoString) return { localDate: '', localTime: '' }

    const date = new Date(isoString);
    if (isNaN(date.getTime())) return { localDate: '', localTime: '' }

    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const localDate = `${year}-${month}-${day}`;

    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const localTime = `${hours}:${minutes}`;

    return { localDate, localTime };
};

export type CalendarLesson = Lesson & {
    student: {
        name: string | null
        email: string | null
    } | null
    type: 'lesson'
}

type CalendarEvent = AdminEvent & {
    type: 'event'
}

type CalendarItem = CalendarLesson | CalendarEvent

interface MasterCalendarProps {
    onEditLesson?: (lesson: CalendarLesson) => void
    onDeleteLesson?: (lesson: CalendarLesson) => void
    onEditEvent?: (event: AdminEvent) => void
    onDeleteEvent?: (event: AdminEvent) => void
    refreshTrigger?: number
}

export function MasterCalendar({ onEditLesson, onDeleteLesson, onEditEvent, onDeleteEvent, refreshTrigger = 0 }: MasterCalendarProps) {
    const [currentDate, setCurrentDate] = useState(new Date())
    const [items, setItems] = useState<CalendarItem[]>([])
    const [isLoading, setIsLoading] = useState(true)

    // Get start/end of current month view (including padding days from prev/next months)
    const getMonthBounds = (date: Date) => {
        const year = date.getFullYear()
        const month = date.getMonth()

        const firstDayOfMonth = new Date(year, month, 1)
        const lastDayOfMonth = new Date(year, month + 1, 0)

        const startDayOfWeek = firstDayOfMonth.getDay() // 0 (Sun) - 6 (Sat)

        // Start date for the grid (go back to Sunday)
        const startDate = new Date(firstDayOfMonth)
        startDate.setDate(startDate.getDate() - startDayOfWeek)

        // End date for the grid (go forward to Saturday)
        const endDayOfWeek = lastDayOfMonth.getDay()
        const endDate = new Date(lastDayOfMonth)
        endDate.setDate(endDate.getDate() + (6 - endDayOfWeek))

        return { startDate, endDate }
    }

    const loadLessons = async () => {
        setIsLoading(true)
        const { startDate, endDate } = getMonthBounds(currentDate)

        // Format for DB query
        const startStr = formatDateKey(startDate)
        const endStr = formatDateKey(endDate)

        const result = await getLessonsForDateRange(startStr, endStr)

        // Process Lessons
        const loadedLessons = (result.lessons as any[]).map(l => ({
            ...l,
            type: 'lesson'
        })) as CalendarLesson[]

        // Process Events
        const loadedEvents = (result.events || []).map((e: any) => {
            // Map invites individually
            const invites: EventInvite[] = e.event_invites?.map((invite: any) => ({
                student_id: invite.student_id,
                student_name: invite.profiles?.name || 'Unknown',
                status: invite.status,
                responded_at: invite.updated_at,
                student_notes: invite.student_notes
            })) || []



            // Fix: Use Local Time for Calendar Display (avoids timezone shift)
            const { localDate, localTime } = getLocalDateTime(e.start_time)

            // Fallback if parsing failed
            const dateStr = localDate
            const timeStr = localTime

            return {
                id: e.id,
                title: e.title,
                description: e.description || '',
                date: dateStr,
                start_time: timeStr,
                duration_minutes: e.duration,
                location_type: e.location_type,
                location_address: e.location_details, // or logic from getAdminEvents
                zoom_link: e.location_type === 'virtual' ? e.location_details : undefined,
                rsvp_deadline: e.rsvp_deadline ? getLocalDateTime(e.rsvp_deadline).localDate : '',
                invites: invites,
                created_at: e.created_at,
                type: 'event'
            }
        }) as CalendarEvent[]

        setItems([...loadedLessons, ...loadedEvents])
        setIsLoading(false)
    }

    useEffect(() => {
        loadLessons()
    }, [currentDate, refreshTrigger])

    const handlePrevMonth = () => {
        setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))
    }

    const handleNextMonth = () => {
        setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))
    }

    const handleToday = () => {
        setCurrentDate(new Date())
    }

    const monthName = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
    const { startDate, endDate } = getMonthBounds(currentDate)

    // Generate days for the grid
    const days: Date[] = []
    let day = new Date(startDate)
    while (day <= endDate) {
        days.push(new Date(day))
        day.setDate(day.getDate() + 1)
    }

    const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']

    return (
        <div className="space-y-4">
            <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                <h2 className="text-2xl font-bold font-serif">{monthName}</h2>
                <div className="flex items-center gap-2">
                    <Button variant="outline" size="sm" onClick={handlePrevMonth}>
                        <ChevronLeft className="h-4 w-4" />
                    </Button>
                    <Button variant="outline" size="sm" onClick={handleToday}>
                        Today
                    </Button>
                    <Button variant="outline" size="sm" onClick={handleNextMonth}>
                        <ChevronRight className="h-4 w-4" />
                    </Button>
                </div>
            </div>

            <div className="bg-background rounded-lg border shadow-sm overflow-hidden">
                {/* Week headers */}
                <div className="grid grid-cols-7 border-b bg-muted/30">
                    {weekDays.map(d => (
                        <div key={d} className="py-2 text-center text-sm font-semibold text-muted-foreground border-r last:border-r-0">
                            {d}
                        </div>
                    ))}
                </div>

                {/* Days grid */}
                <div className="grid grid-cols-7 auto-rows-fr">
                    {days.map((date, idx) => {
                        const dateKey = formatDateKey(date)
                        const isCurrentMonth = date.getMonth() === currentDate.getMonth()
                        const isToday = formatDateKey(new Date()) === dateKey

                        // Filter items for this day
                        const dayItems = items.filter(item => {
                            if (item.type === 'lesson') {
                                return item.date === dateKey
                            } else {
                                // Event start_time is ISO, checks were dateKey
                                // We parsed dateStr in map
                                return item.date === dateKey
                            }
                        })

                        return (
                            <div
                                key={dateKey}
                                className={`min-h-[120px] p-2 border-b border-r last:border-r-0 relative group transition-colors
                    ${!isCurrentMonth ? 'bg-muted/10 text-muted-foreground' : 'bg-background'}
                    ${isToday ? 'bg-primary/5' : ''}
                `}
                            >
                                <div className={`flex justify-between items-start mb-1`}>
                                    <span className={`text-sm font-medium h-7 w-7 flex items-center justify-center rounded-full
                        ${isToday ? 'bg-primary text-primary-foreground' : ''}
                    `}>
                                        {date.getDate()}
                                    </span>
                                    {dayItems.length > 0 && (
                                        <span className="text-xs text-muted-foreground font-mono">
                                            {dayItems.length}
                                        </span>
                                    )}
                                </div>

                                <div className="space-y-1">
                                    {isLoading && idx === 0 ? (
                                        <div className="flex justify-center pt-4">
                                            <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                                        </div>
                                    ) : (
                                        dayItems.map(item => {
                                            if (item.type === 'lesson') {
                                                const timeDisplay = item.time.substring(0, 5) // HH:MM
                                                return (
                                                    <Popover key={item.id}>
                                                        <PopoverTrigger asChild>
                                                            <div
                                                                className="text-xs p-1.5 rounded bg-secondary/50 border border-secondary hover:bg-secondary truncate cursor-pointer transition-colors"
                                                                title={`${timeDisplay} - ${item.student?.name || 'Unknown Student'}`}
                                                            >
                                                                <div className="flex items-center gap-1 font-semibold text-primary/80">
                                                                    <Clock className="h-3 w-3" />
                                                                    {timeDisplay}
                                                                </div>
                                                                <div className="truncate">
                                                                    {item.student?.name}
                                                                </div>
                                                            </div>
                                                        </PopoverTrigger>
                                                        <PopoverContent className="w-40 p-1" align="start">
                                                            <div className="flex flex-col gap-0.5">
                                                                <Button
                                                                    variant="ghost"
                                                                    size="sm"
                                                                    className="justify-start h-8 px-2 font-normal"
                                                                    onClick={() => onEditLesson?.(item)}
                                                                >
                                                                    <Pencil className="h-3 w-3 mr-2" />
                                                                    Edit
                                                                </Button>
                                                                <Button
                                                                    variant="ghost"
                                                                    size="sm"
                                                                    className="justify-start h-8 px-2 font-normal text-destructive hover:text-destructive"
                                                                    onClick={() => onDeleteLesson?.(item)}
                                                                >
                                                                    <Trash2 className="h-3 w-3 mr-2" />
                                                                    Delete
                                                                </Button>
                                                            </div>
                                                        </PopoverContent>
                                                    </Popover>
                                                )
                                            } else {
                                                // Event Rendering
                                                return (
                                                    <Popover key={item.id}>
                                                        <PopoverTrigger asChild>
                                                            <div
                                                                className="text-xs p-1.5 rounded bg-primary/10 border border-primary/20 hover:bg-primary/20 truncate cursor-pointer transition-colors"
                                                                title={`${item.start_time} - ${item.title}`}
                                                            >
                                                                <div className="flex items-center gap-1 font-semibold text-primary">
                                                                    <CalendarIcon className="h-3 w-3" />
                                                                    {item.start_time}
                                                                </div>
                                                                <div className="truncate font-medium">
                                                                    {item.title}
                                                                </div>
                                                            </div>
                                                        </PopoverTrigger>
                                                        <PopoverContent className="w-40 p-1" align="start">
                                                            <div className="flex flex-col gap-0.5">
                                                                <Button
                                                                    variant="ghost"
                                                                    size="sm"
                                                                    className="justify-start h-8 px-2 font-normal"
                                                                    onClick={() => onEditEvent?.(item)}
                                                                >
                                                                    <Pencil className="h-3 w-3 mr-2" />
                                                                    Edit
                                                                </Button>
                                                                <Button
                                                                    variant="ghost"
                                                                    size="sm"
                                                                    className="justify-start h-8 px-2 font-normal text-destructive hover:text-destructive"
                                                                    onClick={() => onDeleteEvent?.(item)}
                                                                >
                                                                    <Trash2 className="h-3 w-3 mr-2" />
                                                                    Delete
                                                                </Button>
                                                            </div>
                                                        </PopoverContent>
                                                    </Popover>
                                                )
                                            }
                                        })
                                    )}
                                </div>
                            </div>
                        )
                    })}
                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/admin/scheduled-tab.tsx">
"use client"

import React from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Calendar, Clock, Music, Video, Plus, XCircle, MoreVertical } from "lucide-react"
import type { LessonWithStudent } from "@/types/admin"

interface ScheduledTabProps {
    lessons: LessonWithStudent[]
    adminZoomLink?: string
    onReschedule: (lesson: LessonWithStudent) => void
    onCancel: (lessonId: string, studentName: string) => void
    onScheduleNew: () => void
}

export function ScheduledTab({ lessons, adminZoomLink, onReschedule, onCancel, onScheduleNew }: ScheduledTabProps) {
    const formatDate = (dateStr: string) => {
        const date = new Date(dateStr + 'T00:00:00')
        return date.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
        })
    }

    const formatTime = (timeStr: string) => {
        const [hours, minutes] = timeStr.split(':').map(Number)
        const ampm = hours >= 12 ? 'PM' : 'AM'
        const displayHours = hours % 12 || 12
        return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`
    }

    return (
        <Card>
            <CardHeader>
                <div className="flex items-center justify-between">
                    <div>
                        <CardTitle className="text-2xl font-serif">Upcoming Lessons</CardTitle>
                        <CardDescription>All scheduled lessons</CardDescription>
                    </div>
                    <div className="flex items-center gap-3">
                        <Badge variant="secondary" className="text-base px-4 py-2">
                            {lessons.length} Lessons
                        </Badge>
                        <Button onClick={onScheduleNew}>
                            <Plus className="h-4 w-4 mr-2" />
                            Schedule Lesson
                        </Button>
                    </div>
                </div>
            </CardHeader>
            <CardContent>
                <div className="space-y-4">
                    {lessons.length === 0 ? (
                        <p className="text-center text-muted-foreground py-8">No scheduled lessons</p>
                    ) : (
                        lessons.map((lesson) => (
                            <Card key={lesson.id} className="border-2">
                                <CardContent className="flex items-center justify-between p-6">
                                    <div className="flex items-center gap-4">
                                        <div className="flex flex-col items-center justify-center h-14 w-14 bg-primary text-primary-foreground rounded-lg">
                                            <span className="text-xs font-medium">{formatDate(lesson.date).split(',')[0]}</span>
                                            <span className="text-xs">{formatDate(lesson.date).split(' ')[1]}</span>
                                        </div>
                                        <div>
                                            <h3 className="font-semibold text-lg">{lesson.student.name || 'Student'}</h3>
                                            <div className="flex items-center gap-4 text-sm text-muted-foreground mt-1">
                                                <div className="flex items-center gap-1">
                                                    <Calendar className="h-3 w-3" />
                                                    <span>{formatDate(lesson.date)}</span>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <Clock className="h-3 w-3" />
                                                    <span>{formatTime(lesson.time)}</span>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <Music className="h-3 w-3" />
                                                    <span>{lesson.duration || 60} min</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <Badge variant="outline">Scheduled</Badge>
                                    <div className="flex gap-2 ml-4">
                                        {(lesson.zoom_link || lesson.student.zoom_link || adminZoomLink) && (
                                            <Button
                                                size="sm"
                                                className="bg-blue-600 hover:bg-blue-700"
                                                asChild
                                            >
                                                <a
                                                    href={lesson.zoom_link || lesson.student.zoom_link || adminZoomLink || '#'}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    <Video className="h-4 w-4 mr-1" />
                                                    Zoom
                                                </a>
                                            </Button>
                                        )}
                                        <Button
                                            variant="outline"
                                            size="sm"
                                            onClick={() => onReschedule(lesson)}
                                        >
                                            <Calendar className="h-4 w-4 mr-1" />
                                            Reschedule
                                        </Button>
                                        <Button
                                            variant="destructive"
                                            size="sm"
                                            onClick={() => onCancel(lesson.id, lesson.student.name || 'Student')}
                                        >
                                            <XCircle className="h-4 w-4 mr-1" />
                                            Cancel
                                        </Button>
                                    </div>
                                </CardContent>
                            </Card>
                        ))
                    )}
                </div>
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/admin/student-profile-sheet.tsx">
"use client"

import React, { useEffect, useState } from "react"
import {
    Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription
} from "@/components/ui/sheet"
import { Badge } from "@/components/ui/badge"
import { Loader2, Music, Calendar, Clock, ArrowDown, ArrowRight, FileText, Video } from "lucide-react"
import { getStudentLessonHistory } from "@/app/actions/student-history"
import type { StudentRoster } from "@/types/admin"

interface StudentProfileSheetProps {
    student: StudentRoster | null
    open: boolean
    onOpenChange: (open: boolean) => void
}

type LessonHistory = {
    id: string
    date: string
    time: string
    duration: number
    status: string
    notes: string | null
    credit_snapshot: number | null
    credit_snapshot_before: number | null
    video_url: string | null
    sheet_music_url: string | null
}

export function StudentProfileSheet({ student, open, onOpenChange }: StudentProfileSheetProps) {
    const [lessons, setLessons] = useState<LessonHistory[]>([])
    const [loading, setLoading] = useState(false)

    useEffect(() => {
        if (open && student) {
            setLoading(true)
            getStudentLessonHistory(student.id).then((res) => {
                if ('lessons' in res) {
                    setLessons(res.lessons as LessonHistory[])
                }
                setLoading(false)
            })
        } else {
            setLessons([])
        }
    }, [open, student?.id])

    if (!student) return null

    const formatDate = (dateStr: string) => {
        const d = new Date(`${dateStr}T00:00:00`)
        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
    }

    const formatTime = (timeStr: string) => {
        const [h, m] = timeStr.split(':')
        const hn = parseInt(h, 10)
        const ap = hn >= 12 ? 'PM' : 'AM'
        const h12 = hn % 12 || 12
        return `${h12}:${m} ${ap}`
    }

    return (
        <Sheet open={open} onOpenChange={onOpenChange}>
            <SheetContent side="right" className="w-full sm:max-w-lg overflow-y-auto">
                <SheetHeader>
                    <SheetTitle className="text-xl">{student.name || 'Student'}</SheetTitle>
                    <SheetDescription>{student.email}</SheetDescription>
                </SheetHeader>

                {/* Student Info Summary */}
                <div className="px-4 pb-2">
                    <div className="flex items-center gap-3 flex-wrap">
                        <div className="flex items-center gap-2 bg-muted rounded-lg px-3 py-2">
                            <span className="text-xs text-muted-foreground font-medium">Credits</span>
                            <Badge variant={student.credits <= 1 ? "destructive" : "secondary"} className="text-sm">
                                {student.credits}
                            </Badge>
                        </div>
                        {student.lesson_day && (
                            <div className="flex items-center gap-2 bg-muted rounded-lg px-3 py-2">
                                <Calendar className="h-3.5 w-3.5 text-muted-foreground" />
                                <span className="text-sm">{student.lesson_day}s{student.lesson_time ? ` at ${student.lesson_time}` : ''}</span>
                            </div>
                        )}
                        {student.phone && (
                            <div className="flex items-center gap-2 bg-muted rounded-lg px-3 py-2">
                                <span className="text-xs text-muted-foreground">{student.phone}</span>
                            </div>
                        )}
                    </div>
                </div>

                {/* Lesson History */}
                <div className="px-4 pb-6">
                    <h3 className="text-sm font-semibold text-muted-foreground uppercase tracking-wider mb-3">
                        Completed Lessons
                    </h3>

                    {loading ? (
                        <div className="flex items-center justify-center py-12">
                            <Loader2 className="h-5 w-5 animate-spin text-muted-foreground" />
                        </div>
                    ) : lessons.length === 0 ? (
                        <p className="text-sm text-muted-foreground text-center py-8">
                            No completed lessons yet
                        </p>
                    ) : (
                        <div className="space-y-3">
                            {lessons.map((lesson) => (
                                <div
                                    key={lesson.id}
                                    className="border rounded-lg p-3 space-y-2 hover:bg-muted/30 transition-colors"
                                >
                                    {/* Date + Time row */}
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <Music className="h-4 w-4 text-muted-foreground" />
                                            <span className="text-sm font-medium">
                                                {formatDate(lesson.date)}
                                            </span>
                                            <span className="text-xs text-muted-foreground flex items-center gap-1">
                                                <Clock className="h-3 w-3" />
                                                {formatTime(lesson.time)}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            {lesson.video_url && (
                                                <a href={lesson.video_url} target="_blank" rel="noopener noreferrer"
                                                    className="text-blue-500 hover:text-blue-600">
                                                    <Video className="h-3.5 w-3.5" />
                                                </a>
                                            )}
                                            {lesson.sheet_music_url && (
                                                <a href={lesson.sheet_music_url} target="_blank" rel="noopener noreferrer"
                                                    className="text-green-500 hover:text-green-600">
                                                    <FileText className="h-3.5 w-3.5" />
                                                </a>
                                            )}
                                        </div>
                                    </div>

                                    {/* Credit row */}
                                    {(lesson.credit_snapshot !== null || lesson.credit_snapshot_before !== null) && (
                                        <div className="flex items-center gap-2 text-xs bg-muted/50 rounded px-2 py-1.5">
                                            <span className="text-muted-foreground font-medium">Credits:</span>
                                            <span className="font-mono font-semibold">
                                                {lesson.credit_snapshot_before ?? '?'}
                                            </span>
                                            <ArrowRight className="h-3 w-3 text-muted-foreground" />
                                            <span className="text-red-500 font-mono font-semibold">-1</span>
                                            <ArrowRight className="h-3 w-3 text-muted-foreground" />
                                            <span className="font-mono font-semibold">
                                                {lesson.credit_snapshot ?? '?'}
                                            </span>
                                        </div>
                                    )}

                                    {/* Notes */}
                                    {lesson.notes && (
                                        <p className="text-xs text-muted-foreground leading-relaxed line-clamp-3">
                                            {lesson.notes}
                                        </p>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </SheetContent>
        </Sheet>
    )
}
</file>

<file path="components/auth/login-form.tsx">
"use client"

import type React from "react"
import Link from "next/link"

import { useState } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Music, Lock, Mail, AlertCircle } from "lucide-react"
import { login } from "@/app/login/actions"

export function LoginForm() {
    const [error, setError] = useState<string | null>(null)
    const [isLoading, setIsLoading] = useState(false)

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        setIsLoading(true)
        setError(null)

        const formData = new FormData(e.currentTarget)
        const result = await login(formData)

        if (result?.error) {
            setError(result.error)
            setIsLoading(false)
        }
        // If successful, the server action will redirect
    }

    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background via-muted/30 to-background p-4">
            {/* Background Piano Keys Pattern */}
            <div className="absolute inset-0 opacity-[0.02] pointer-events-none">
                <div
                    className="w-full h-full"
                    style={{
                        backgroundImage: `repeating-linear-gradient(
            90deg,
            #000 0px,
            #000 60px,
            #fff 60px,
            #fff 70px,
            #000 70px,
            #000 100px,
            #fff 100px,
            #fff 110px
          )`,
                        backgroundSize: "100% 200px",
                    }}
                />
            </div>

            <Card className="w-full max-w-md relative shadow-2xl border-2">
                <CardHeader className="space-y-4 pb-8">
                    <div className="flex justify-center">
                        <div className="h-16 w-16 bg-primary rounded-full flex items-center justify-center">
                            <Music className="h-8 w-8 text-primary-foreground" />
                        </div>
                    </div>
                    <div className="text-center space-y-2">
                        <CardTitle className="text-3xl font-serif text-balance">Lionel Yu Piano Studio</CardTitle>
                        <CardDescription className="text-base">Enter your credentials to access your account</CardDescription>
                    </div>
                </CardHeader>

                <CardContent>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        {error && (
                            <div className="flex items-center gap-2 p-3 text-sm text-destructive bg-destructive/10 rounded-md">
                                <AlertCircle className="h-4 w-4" />
                                <span>{error}</span>
                            </div>
                        )}

                        <div className="space-y-2">
                            <Label htmlFor="email" className="text-sm font-medium">
                                Email Address
                            </Label>
                            <div className="relative">
                                <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                                <Input
                                    id="email"
                                    name="email"
                                    type="email"
                                    placeholder="student@gmail.com"
                                    className="pl-10 h-11"
                                    required
                                />
                            </div>
                        </div>

                        <div className="space-y-2">
                            <div className="flex items-center justify-between">
                                <Label htmlFor="password" className="text-sm font-medium">
                                    Password
                                </Label>
                                <Link
                                    href="/forgot-password"
                                    className="text-xs text-muted-foreground hover:text-primary transition-colors"
                                >
                                    Forgot password?
                                </Link>
                            </div>
                            <div className="relative">
                                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                                <Input
                                    id="password"
                                    name="password"
                                    type="password"
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                    className="pl-10 h-11"
                                    required
                                />
                            </div>
                        </div>

                        <Button type="submit" className="w-full h-11 text-base" disabled={isLoading}>
                            {isLoading ? "Signing in..." : "Sign In"}
                        </Button>
                    </form>
                </CardContent>
            </Card>
        </div>
    )
}
</file>

<file path="components/emails/lesson-canceled-email.tsx">
import {
    Body,
    Button,
    Container,
    Head,
    Heading,
    Html,
    Preview,
    Section,
    Text,
} from '@react-email/components'

interface LessonCanceledEmailProps {
    studentName: string
    date: string
    time: string
    recipientName: string
    studioName?: string
}

export function LessonCanceledEmail({
    studentName,
    date,
    time,
    recipientName,
    studioName = 'Lionel Yu Piano Studio',
}: LessonCanceledEmailProps) {
    const loginUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lessons.musicalbasics.com'

    return (
        <Html>
            <Head />
            <Preview>Lesson Canceled: {date} at {time}</Preview>
            <Body style={main}>
                <Container style={container}>
                    <Heading style={heading}>ðŸŽ¹ {studioName}</Heading>

                    <Section style={section}>
                        <Text style={greeting}>Hi {recipientName},</Text>
                        <Text style={text}>
                            The lesson with <strong>{studentName}</strong> scheduled for <strong>{date} at {time}</strong> has been <strong>canceled</strong>.
                        </Text>

                        <Section style={detailsBox}>
                            <Text style={detailsRow}>
                                This lesson has been removed from your schedule.
                            </Text>
                        </Section>

                        <Text style={text}>
                            If you have any questions, please contact your teacher.
                        </Text>

                        <Button style={button} href={`${loginUrl}/login`}>
                            View Dashboard
                        </Button>
                    </Section>

                    <Text style={footer}>
                        Â© {studioName} â€¢ You received this email because you have an account with us.
                    </Text>
                </Container>
            </Body>
        </Html>
    )
}

// Styles
const main = {
    backgroundColor: '#f6f9fc',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Ubuntu, sans-serif',
}

const container = {
    backgroundColor: '#ffffff',
    margin: '0 auto',
    padding: '40px 20px',
    maxWidth: '560px',
    borderRadius: '8px',
}

const heading = {
    fontSize: '24px',
    fontWeight: '600' as const,
    textAlign: 'center' as const,
    margin: '0 0 30px',
    color: '#1a1a1a',
}

const section = {
    padding: '0 20px',
}

const greeting = {
    fontSize: '16px',
    color: '#333',
    margin: '0 0 16px',
}

const text = {
    fontSize: '14px',
    lineHeight: '24px',
    color: '#555',
    margin: '0 0 16px',
}

const detailsBox = {
    backgroundColor: '#fef2f2', // Light red
    borderRadius: '8px',
    padding: '16px 20px',
    margin: '16px 0 24px',
    borderLeft: '4px solid #ef4444', // Red border
}

const detailsRow = {
    fontSize: '15px',
    lineHeight: '24px',
    color: '#333',
    margin: '4px 0',
}

const button = {
    backgroundColor: '#ef4444', // Red button for cancel styling
    borderRadius: '6px',
    color: '#fff',
    fontSize: '14px',
    fontWeight: '600' as const,
    textDecoration: 'none',
    textAlign: 'center' as const,
    display: 'block',
    padding: '12px 24px',
    margin: '24px auto',
}

const footer = {
    fontSize: '12px',
    color: '#8898aa',
    textAlign: 'center' as const,
    marginTop: '32px',
}

export default LessonCanceledEmail
</file>

<file path="components/emails/lesson-rescheduled-email.tsx">
import {
    Body,
    Button,
    Container,
    Head,
    Heading,
    Html,
    Preview,
    Section,
    Text,
} from '@react-email/components'

interface LessonRescheduledEmailProps {
    studentName: string
    oldDate: string
    oldTime: string
    newDate: string
    newTime: string
    newDuration: number
    recipientName: string
    studioName?: string
}

export function LessonRescheduledEmail({
    studentName,
    oldDate,
    oldTime,
    newDate,
    newTime,
    newDuration,
    recipientName,
    studioName = 'Lionel Yu Piano Studio',
}: LessonRescheduledEmailProps) {
    const loginUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lessons.musicalbasics.com'

    return (
        <Html>
            <Head />
            <Preview>Lesson Rescheduled: {newDate} at {newTime}</Preview>
            <Body style={main}>
                <Container style={container}>
                    <Heading style={heading}>ðŸŽ¹ {studioName}</Heading>

                    <Section style={section}>
                        <Text style={greeting}>Hi {recipientName},</Text>
                        <Text style={text}>
                            The lesson with <strong>{studentName}</strong> originally scheduled for {oldDate} at {oldTime} has been <strong>rescheduled</strong>.
                        </Text>

                        <Section style={detailsBox}>
                            <Text style={detailsRow}>
                                <strong>New Date:</strong> {newDate}
                            </Text>
                            <Text style={detailsRow}>
                                <strong>New Time:</strong> {newTime}
                            </Text>
                            <Text style={detailsRow}>
                                <strong>Duration:</strong> {newDuration} minutes
                            </Text>
                        </Section>

                        <Text style={text}>
                            Please update your calendar accordingly.
                        </Text>

                        <Button style={button} href={`${loginUrl}/login`}>
                            View Dashboard
                        </Button>
                    </Section>

                    <Text style={footer}>
                        Â© {studioName} â€¢ You received this email because you have an account with us.
                    </Text>
                </Container>
            </Body>
        </Html>
    )
}

// Styles
const main = {
    backgroundColor: '#f6f9fc',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Ubuntu, sans-serif',
}

const container = {
    backgroundColor: '#ffffff',
    margin: '0 auto',
    padding: '40px 20px',
    maxWidth: '560px',
    borderRadius: '8px',
}

const heading = {
    fontSize: '24px',
    fontWeight: '600' as const,
    textAlign: 'center' as const,
    margin: '0 0 30px',
    color: '#1a1a1a',
}

const section = {
    padding: '0 20px',
}

const greeting = {
    fontSize: '16px',
    color: '#333',
    margin: '0 0 16px',
}

const text = {
    fontSize: '14px',
    lineHeight: '24px',
    color: '#555',
    margin: '0 0 16px',
}

const detailsBox = {
    backgroundColor: '#fffbeb', // Light yellow for change notice
    borderRadius: '8px',
    padding: '16px 20px',
    margin: '16px 0 24px',
    borderLeft: '4px solid #f59e0b', // Amber/Yellow border
}

const detailsRow = {
    fontSize: '15px',
    lineHeight: '24px',
    color: '#333',
    margin: '4px 0',
}

const button = {
    backgroundColor: '#3b82f6',
    borderRadius: '6px',
    color: '#fff',
    fontSize: '14px',
    fontWeight: '600' as const,
    textDecoration: 'none',
    textAlign: 'center' as const,
    display: 'block',
    padding: '12px 24px',
    margin: '24px auto',
}

const footer = {
    fontSize: '12px',
    color: '#8898aa',
    textAlign: 'center' as const,
    marginTop: '32px',
}

export default LessonRescheduledEmail
</file>

<file path="components/emails/lesson-scheduled-email.tsx">
import {
    Body,
    Button,
    Container,
    Head,
    Heading,
    Html,
    Preview,
    Section,
    Text,
} from '@react-email/components'

interface LessonScheduledEmailProps {
    studentName: string
    date: string
    time: string
    duration: number
    zoomLink?: string | null
    recipientName: string
    studioName?: string
}

export function LessonScheduledEmail({
    studentName,
    date,
    time,
    duration,
    zoomLink,
    recipientName,
    studioName = 'Lionel Yu Piano Studio',
}: LessonScheduledEmailProps) {
    const loginUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lessons.musicalbasics.com'

    return (
        <Html>
            <Head />
            <Preview>Lesson scheduled: {date} at {time}</Preview>
            <Body style={main}>
                <Container style={container}>
                    <Heading style={heading}>ðŸŽ¹ {studioName}</Heading>

                    <Section style={section}>
                        <Text style={greeting}>Hi {recipientName},</Text>
                        <Text style={text}>
                            A new piano lesson has been scheduled for <strong>{studentName}</strong>.
                        </Text>

                        <Section style={detailsBox}>
                            <Text style={detailsRow}>
                                <strong>Date:</strong> {date}
                            </Text>
                            <Text style={detailsRow}>
                                <strong>Time:</strong> {time}
                            </Text>
                            <Text style={detailsRow}>
                                <strong>Duration:</strong> {duration} minutes
                            </Text>
                            {zoomLink && (
                                <Text style={detailsRow}>
                                    <strong>Zoom Link:</strong> <a href={zoomLink} style={link}>{zoomLink}</a>
                                </Text>
                            )}
                        </Section>

                        <Text style={text}>
                            You can view full schedule details in your portal.
                        </Text>

                        <Button style={button} href={`${loginUrl}/login`}>
                            View Dashboard
                        </Button>
                    </Section>

                    <Text style={footer}>
                        Â© {studioName} â€¢ You received this email because you have an account with us.
                    </Text>
                </Container>
            </Body>
        </Html>
    )
}

// Styles
const main = {
    backgroundColor: '#f6f9fc',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Ubuntu, sans-serif',
}

const container = {
    backgroundColor: '#ffffff',
    margin: '0 auto',
    padding: '40px 20px',
    maxWidth: '560px',
    borderRadius: '8px',
}

const heading = {
    fontSize: '24px',
    fontWeight: '600' as const,
    textAlign: 'center' as const,
    margin: '0 0 30px',
    color: '#1a1a1a',
}

const section = {
    padding: '0 20px',
}

const greeting = {
    fontSize: '16px',
    color: '#333',
    margin: '0 0 16px',
}

const text = {
    fontSize: '14px',
    lineHeight: '24px',
    color: '#555',
    margin: '0 0 16px',
}

const detailsBox = {
    backgroundColor: '#f4f4f5',
    borderRadius: '8px',
    padding: '16px 20px',
    margin: '16px 0 24px',
    borderLeft: '4px solid #3b82f6',
}

const detailsRow = {
    fontSize: '15px',
    lineHeight: '24px',
    color: '#333',
    margin: '4px 0',
}

const link = {
    color: '#3b82f6',
    textDecoration: 'underline',
}

const button = {
    backgroundColor: '#3b82f6',
    borderRadius: '6px',
    color: '#fff',
    fontSize: '14px',
    fontWeight: '600' as const,
    textDecoration: 'none',
    textAlign: 'center' as const,
    display: 'block',
    padding: '12px 24px',
    margin: '24px auto',
}

const footer = {
    fontSize: '12px',
    color: '#8898aa',
    textAlign: 'center' as const,
    marginTop: '32px',
}

export default LessonScheduledEmail
</file>

<file path="components/emails/message-notification.tsx">
import {
    Body,
    Button,
    Container,
    Head,
    Heading,
    Html,
    Preview,
    Section,
    Text,
} from '@react-email/components'

interface MessageNotificationProps {
    senderName: string
    messageContent: string
    recipientName: string
}

export function MessageNotification({
    senderName,
    messageContent,
    recipientName,
}: MessageNotificationProps) {
    const loginUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'

    return (
        <Html>
            <Head />
            <Preview>New message from {senderName}</Preview>
            <Body style={main}>
                <Container style={container}>
                    <Heading style={heading}>ðŸŽ¹ Lionel Yu Piano Studio</Heading>

                    <Section style={section}>
                        <Text style={greeting}>Hi {recipientName},</Text>
                        <Text style={text}>
                            You have a new message from <strong>{senderName}</strong>:
                        </Text>
                        <Section style={messageBox}>
                            <Text style={messageText}>&quot;{messageContent}&quot;</Text>
                        </Section>
                        <Text style={text}>
                            Log in to your Lionel Yu Piano Studio portal to view and reply to this message.
                        </Text>
                        <Button style={button} href={`${loginUrl}/login`}>
                            View Message
                        </Button>
                    </Section>

                    <Text style={footer}>
                        Â© Lionel Yu Piano Studio Portal â€¢ You received this email because you have an account with us.
                    </Text>
                </Container>
            </Body>
        </Html>
    )
}

// Styles
const main = {
    backgroundColor: '#f6f9fc',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Ubuntu, sans-serif',
}

const container = {
    backgroundColor: '#ffffff',
    margin: '0 auto',
    padding: '40px 20px',
    maxWidth: '560px',
    borderRadius: '8px',
}

const heading = {
    fontSize: '24px',
    fontWeight: '600' as const,
    textAlign: 'center' as const,
    margin: '0 0 30px',
    color: '#1a1a1a',
}

const section = {
    padding: '0 20px',
}

const greeting = {
    fontSize: '16px',
    color: '#333',
    margin: '0 0 16px',
}

const text = {
    fontSize: '14px',
    lineHeight: '24px',
    color: '#555',
    margin: '0 0 16px',
}

const messageBox = {
    backgroundColor: '#f4f4f5',
    borderRadius: '8px',
    padding: '16px 20px',
    margin: '16px 0 24px',
    borderLeft: '4px solid #3b82f6',
}

const messageText = {
    fontSize: '15px',
    lineHeight: '24px',
    color: '#333',
    margin: '0',
    fontStyle: 'italic' as const,
}

const button = {
    backgroundColor: '#3b82f6',
    borderRadius: '6px',
    color: '#fff',
    fontSize: '14px',
    fontWeight: '600' as const,
    textDecoration: 'none',
    textAlign: 'center' as const,
    display: 'block',
    padding: '12px 24px',
    margin: '24px auto',
}

const footer = {
    fontSize: '12px',
    color: '#8898aa',
    textAlign: 'center' as const,
    marginTop: '32px',
}

export default MessageNotification
</file>

<file path="components/student/cancellation-modal.tsx">
"use client"

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { AlertTriangle, CheckCircle2, Loader2 } from "lucide-react"

interface CancellationModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onConfirmCancel: () => void
  lessonDate?: string  // YYYY-MM-DD format
  lessonTime?: string  // HH:MM format
  isLoading?: boolean
}

/**
 * Check if a lesson is within 24 hours (late cancellation)
 */
function isLateCancellation(lessonDate?: string, lessonTime?: string): boolean {
  if (!lessonDate) return false

  // Parse the lesson date and time as local time
  const timeStr = lessonTime || '12:00'
  const lessonDateTime = new Date(`${lessonDate}T${timeStr}:00`)
  const now = new Date()

  // Calculate hours difference
  const diffMs = lessonDateTime.getTime() - now.getTime()
  const diffHours = diffMs / (1000 * 60 * 60)

  // Late if less than 24 hours AND lesson is in the future
  return diffHours > 0 && diffHours < 24
}

export function CancellationModal({
  open,
  onOpenChange,
  onConfirmCancel,
  lessonDate,
  lessonTime,
  isLoading = false
}: CancellationModalProps) {
  const isLate = isLateCancellation(lessonDate, lessonTime)

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          {isLate ? (
            <>
              <div className="flex items-center gap-3 mb-2">
                <div className="flex items-center justify-center w-12 h-12 rounded-full bg-destructive/10">
                  <AlertTriangle className="h-6 w-6 text-destructive" />
                </div>
                <DialogTitle className="text-xl font-serif">Late Cancellation Fee</DialogTitle>
              </div>
              <DialogDescription className="text-base leading-relaxed pt-2">
                You are cancelling with less than 24 hours notice. A <strong className="text-foreground">$20 fee</strong>{" "}
                will be charged to preserve your lesson credit for future use.
              </DialogDescription>
            </>
          ) : (
            <>
              <div className="flex items-center gap-3 mb-2">
                <div className="flex items-center justify-center w-12 h-12 rounded-full bg-primary/10">
                  <CheckCircle2 className="h-6 w-6 text-primary" />
                </div>
                <DialogTitle className="text-xl font-serif">Cancel Lesson</DialogTitle>
              </div>
              <DialogDescription className="text-base leading-relaxed pt-2">
                You are cancelling with more than 24 hours notice. Your lesson credit will be fully refunded.
              </DialogDescription>
            </>
          )}
        </DialogHeader>

        <div className="bg-muted p-4 rounded-lg my-4">
          {isLate ? (
            <>
              <div className="flex justify-between items-center mb-2">
                <span className="text-sm text-muted-foreground">Late Cancellation Fee</span>
                <span className="text-lg font-semibold">$20.00</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-muted-foreground">Credit Status</span>
                <span className="text-sm font-medium text-success">Preserved</span>
              </div>
            </>
          ) : (
            <>
              <div className="flex justify-between items-center mb-2">
                <span className="text-sm text-muted-foreground">Cancellation Fee</span>
                <span className="text-lg font-semibold text-success">$0.00</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-muted-foreground">Credit Status</span>
                <span className="text-sm font-medium text-success">Refunded</span>
              </div>
            </>
          )}
        </div>

        <DialogFooter className="flex-col sm:flex-row gap-2">
          <Button variant="outline" onClick={() => onOpenChange(false)} className="w-full sm:w-auto" disabled={isLoading}>
            Keep Lesson
          </Button>
          <Button
            variant={isLate ? "destructive" : "default"}
            onClick={onConfirmCancel}
            className="w-full sm:w-auto"
            disabled={isLoading}
          >
            {isLoading ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Cancelling...
              </>
            ) : isLate ? (
              "Accept Fee & Cancel"
            ) : (
              "Confirm Cancellation"
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
</file>

<file path="components/student/chat-widget.tsx">
"use client"

import type React from "react"
import { useState, useRef, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Badge } from "@/components/ui/badge"
import { MessageCircle, X, Send, Music, Minimize2, Loader2, Paperclip } from "lucide-react"
import { sendMessage, getConversation, markMessagesAsRead, getAdminProfile, uploadChatAttachment } from "@/app/messages/actions"
import type { Message, MessageAttachment } from "@/lib/supabase/database.types"
import { ChatAttachmentPreview, ChatPendingAttachments } from "@/components/chat-attachment-preview"

interface ChatWidgetProps {
  studentId: string
  teacherName?: string
  unreadCount: number
}

export function ChatWidget({ studentId, teacherName, unreadCount: initialUnreadCount }: ChatWidgetProps) {
  const [isOpen, setIsOpen] = useState(false)
  const [messages, setMessages] = useState<Message[]>([])
  const [newMessage, setNewMessage] = useState("")
  const [adminId, setAdminId] = useState<string | null>(null)
  const [currentTeacherName, setCurrentTeacherName] = useState(teacherName)
  const [isLoading, setIsLoading] = useState(false)
  const [isSending, setIsSending] = useState(false)
  const [unreadCount, setUnreadCount] = useState(initialUnreadCount)

  // Attachment states
  const [pendingAttachments, setPendingAttachments] = useState<{ file: File; preview?: string; uploading?: boolean }[]>([])
  const fileInputRef = useRef<HTMLInputElement>(null)

  const messagesEndRef = useRef<HTMLDivElement>(null)

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
  }

  // Load data when widget opens
  useEffect(() => {
    if (!isOpen) return

    async function loadData() {
      setIsLoading(true)

      // Get admin profile
      const { admin } = await getAdminProfile()
      if (admin) {
        setAdminId(admin.id)
        if (admin.name) {
          setCurrentTeacherName(admin.name)
        }

        // Get conversation with admin
        const { messages: conversationMessages } = await getConversation(admin.id)
        setMessages(conversationMessages)

        // Mark messages as read
        await markMessagesAsRead(admin.id)
        setUnreadCount(0)
      }

      setIsLoading(false)

      // Scroll to bottom on load
      setTimeout(() => scrollToBottom(), 100)
    }

    loadData()
  }, [isOpen])

  // Removed auto-scroll useEffect that was triggered by polling

  // Poll for new messages when open
  useEffect(() => {
    if (!isOpen || !adminId) return

    const interval = setInterval(async () => {
      const { messages: newMessages } = await getConversation(adminId)
      setMessages(newMessages)
    }, 5000)

    return () => clearInterval(interval)
  }, [isOpen, adminId])

  const handleSendMessage = async () => {
    if ((!newMessage.trim() && pendingAttachments.length === 0) || !adminId) return

    const tempMessage = newMessage
    const tempAttachments = [...pendingAttachments]
    setNewMessage("")
    setPendingAttachments([])
    setIsSending(true)

    try {
      // Upload all pending attachments first
      const uploadedAttachments: MessageAttachment[] = []
      for (const pending of tempAttachments) {
        const formData = new FormData()
        formData.append('file', pending.file)
        const result = await uploadChatAttachment(formData)
        if (result.attachment) {
          uploadedAttachments.push(result.attachment)
        } else if (result.error) {
          console.error('Failed to upload attachment:', result.error)
        }
      }

      // Send message with attachments
      const result = await sendMessage(
        adminId,
        tempMessage.trim() || (uploadedAttachments.length > 0 ? 'ðŸ“Ž Attachment' : ''),
        uploadedAttachments.length > 0 ? uploadedAttachments : undefined
      )

      if (result.success && result.message) {
        setMessages((prev) => [...prev, result.message!])
        // Scroll to newly sent message
        setTimeout(() => scrollToBottom(), 100)
      } else if (result.error) {
        console.error('Failed to send message:', result.error)
        setNewMessage(tempMessage)
        setPendingAttachments(tempAttachments)
      }
    } catch (error) {
      console.error('Error sending message:', error)
      setNewMessage(tempMessage)
      setPendingAttachments(tempAttachments)
    } finally {
      setIsSending(false)
    }
  }

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files
    if (!files || files.length === 0) return

    const newAttachments = Array.from(files).map(file => {
      const isImage = file.type.startsWith('image/')
      return {
        file,
        preview: isImage ? URL.createObjectURL(file) : undefined,
        uploading: false
      }
    })

    setPendingAttachments(prev => [...prev, ...newAttachments].slice(0, 5)) // Max 5

    // Reset input
    if (fileInputRef.current) {
      fileInputRef.current.value = ''
    }
  }

  const handleRemoveAttachment = (index: number) => {
    setPendingAttachments(prev => {
      const attachment = prev[index]
      if (attachment?.preview) {
        URL.revokeObjectURL(attachment.preview)
      }
      return prev.filter((_, i) => i !== index)
    })
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault()
      handleSendMessage()
    }
  }

  const formatTimestamp = (timestamp: string) => {
    const date = new Date(timestamp)
    const now = new Date()
    const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))

    if (diffDays === 0) {
      return date.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" })
    } else if (diffDays === 1) {
      return "Yesterday"
    } else if (diffDays < 7) {
      return date.toLocaleDateString("en-US", { weekday: "short" })
    } else {
      return date.toLocaleDateString("en-US", { month: "short", day: "numeric" })
    }
  }

  const isFromStudent = (message: Message) => message.sender_id === studentId

  return (
    <>
      {/* Floating Action Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="fixed bottom-6 right-6 z-50 h-14 w-14 rounded-full bg-primary text-primary-foreground shadow-lg hover:bg-primary/90 transition-all duration-200 flex items-center justify-center hover:scale-105"
        aria-label="Open chat"
      >
        {isOpen ? (
          <X className="h-6 w-6" />
        ) : (
          <>
            <MessageCircle className="h-6 w-6" />
            {unreadCount > 0 && (
              <Badge
                variant="destructive"
                className="absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center text-xs"
              >
                {unreadCount}
              </Badge>
            )}
          </>
        )}
      </button>

      {/* Chat Window Overlay */}
      {isOpen && (
        <div className="fixed bottom-24 right-6 z-50 w-[380px] h-[500px] bg-card border-2 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-in slide-in-from-bottom-4 duration-200">
          {/* Header */}
          <div className="flex items-center justify-between p-4 border-b bg-primary text-primary-foreground">
            <div className="flex items-center gap-3">
              <div className="h-10 w-10 bg-primary-foreground/20 rounded-full flex items-center justify-center">
                <Music className="h-5 w-5" />
              </div>
              <div>
                <h3 className="font-serif font-semibold">{currentTeacherName || "Your Instructor"}</h3>
                <p className="text-xs text-primary-foreground/70">Your Instructor</p>
              </div>
            </div>
            <Button
              variant="ghost"
              size="icon"
              onClick={() => setIsOpen(false)}
              className="text-primary-foreground hover:bg-primary-foreground/20"
            >
              <Minimize2 className="h-4 w-4" />
            </Button>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-background">
            {isLoading ? (
              <div className="flex flex-col items-center justify-center h-full">
                <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                <p className="text-sm text-muted-foreground mt-2">Loading...</p>
              </div>
            ) : messages.length === 0 ? (
              <div className="flex flex-col items-center justify-center h-full text-center">
                <Music className="h-10 w-10 text-muted-foreground mb-3" />
                <p className="text-muted-foreground text-sm">No messages yet</p>
                <p className="text-xs text-muted-foreground">Start a conversation with your teacher</p>
              </div>
            ) : (
              messages.map((message) => (
                <div
                  key={message.id}
                  className={`flex ${isFromStudent(message) ? "justify-end" : "justify-start"}`}
                >
                  <div
                    className={`max-w-[80%] rounded-2xl px-3 py-2 ${isFromStudent(message)
                      ? "bg-primary text-primary-foreground rounded-br-sm"
                      : "bg-muted rounded-bl-sm"
                      }`}
                  >
                    {message.content && message.content !== 'ðŸ“Ž Attachment' && (
                      <p className="text-sm leading-relaxed">{message.content}</p>
                    )}

                    {/* Attachments */}
                    {message.attachments && message.attachments.length > 0 && (
                      <ChatAttachmentPreview attachments={message.attachments} compact />
                    )}

                    <p
                      className={`text-[10px] mt-1 ${isFromStudent(message) ? "text-primary-foreground/60" : "text-muted-foreground"
                        }`}
                    >
                      {formatTimestamp(message.created_at)}
                    </p>
                  </div>
                </div>
              ))
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Input */}
          <div className="border-t bg-card">
            {/* Pending Attachments Preview */}
            {pendingAttachments.length > 0 && (
              <ChatPendingAttachments
                attachments={pendingAttachments}
                onRemove={handleRemoveAttachment}
              />
            )}

            <div className="p-3 flex gap-2">
              {/* Hidden File Input */}
              <input
                type="file"
                ref={fileInputRef}
                onChange={handleFileSelect}
                accept="image/*,.pdf,.doc,.docx"
                multiple
                className="hidden"
              />

              {/* Attachment Button */}
              <Button
                variant="ghost"
                size="icon"
                onClick={() => fileInputRef.current?.click()}
                disabled={isSending || pendingAttachments.length >= 5 || !adminId}
                title="Add attachment"
                className="shrink-0"
              >
                <Paperclip className="h-4 w-4" />
              </Button>

              <Input
                placeholder="Type a message..."
                value={newMessage}
                onChange={(e) => setNewMessage(e.target.value)}
                onKeyDown={handleKeyDown}
                className="flex-1 text-sm"
                disabled={isSending || !adminId}
              />
              <Button
                size="icon"
                onClick={handleSendMessage}
                disabled={(!newMessage.trim() && pendingAttachments.length === 0) || isSending || !adminId}
              >
                {isSending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Send className="h-4 w-4" />}
              </Button>
            </div>
          </div>
        </div>
      )}
    </>
  )
}
</file>

<file path="components/student/makeup-scheduler.tsx">
"use client"

import { useState, useEffect } from "react"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import { Calendar, Clock, CheckCircle2, Loader2 } from "lucide-react"
import { getAvailableMakeupSlots, claimMakeupSlot, type MakeupSlot } from "@/app/actions/makeup-slots"
import { useToast } from "@/hooks/use-toast"

interface MakeupSchedulerProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  lessonId?: string
  onSuccess?: () => void
}

export function MakeupScheduler({ open, onOpenChange, lessonId, onSuccess }: MakeupSchedulerProps) {
  const { toast } = useToast()
  const [slots, setSlots] = useState<MakeupSlot[]>([])
  const [selectedSlot, setSelectedSlot] = useState<MakeupSlot | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [isSubmitting, setIsSubmitting] = useState(false)

  // Fetch available slots when modal opens
  useEffect(() => {
    if (open) {
      setIsLoading(true)
      setSelectedSlot(null)
      getAvailableMakeupSlots(5).then(({ slots: availableSlots }) => {
        setSlots(availableSlots)
        setIsLoading(false)
      })
    }
  }, [open])

  const handleConfirm = async () => {
    if (!selectedSlot || !lessonId) {
      // Skip option - just close
      onOpenChange(false)
      setSelectedSlot(null)
      return
    }

    setIsSubmitting(true)
    const result = await claimMakeupSlot(selectedSlot.id, lessonId)
    setIsSubmitting(false)

    if (result.error) {
      toast({
        variant: "destructive",
        title: "Reschedule Failed",
        description: result.error
      })
    } else if (result.success) {
      toast({
        title: "Lesson Rescheduled!",
        description: result.message
      })
      onOpenChange(false)
      setSelectedSlot(null)
      onSuccess?.()
    }
  }

  const handleSkip = () => {
    onOpenChange(false)
    setSelectedSlot(null)
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-2xl">
        <DialogHeader>
          <DialogTitle className="text-2xl font-serif">Choose Your Makeup Lesson</DialogTitle>
          <DialogDescription className="text-base">
            {slots.length > 0
              ? `We found ${slots.length} available slot${slots.length > 1 ? 's' : ''} for you. Select one to reschedule your lesson.`
              : "Select an option below."
            }
          </DialogDescription>
        </DialogHeader>

        <div className="grid gap-4 py-4">
          {isLoading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            </div>
          ) : slots.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              <Calendar className="h-12 w-12 mx-auto mb-3 opacity-50" />
              <p className="font-medium">No available slots at this time</p>
              <p className="text-sm">Your teacher will add more slots soon. Check back later!</p>
            </div>
          ) : (
            slots.map((slot) => (
              <Card
                key={slot.id}
                className={`p-4 cursor-pointer transition-all border-2 ${selectedSlot?.id === slot.id ? "border-primary bg-accent" : "border-border hover:border-primary/50"
                  }`}
                onClick={() => setSelectedSlot(slot)}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="flex flex-col items-center justify-center w-16 h-16 bg-primary text-primary-foreground rounded-lg">
                      <span className="text-xs font-medium uppercase">{slot.day?.slice(0, 3)}</span>
                      <span className="text-xl font-bold">{slot.date?.split(' ')[1]}</span>
                    </div>
                    <div>
                      <h3 className="font-semibold text-lg">{slot.day}</h3>
                      <div className="flex items-center gap-2 text-muted-foreground">
                        <Calendar className="h-4 w-4" />
                        <span className="text-sm">{slot.date}</span>
                        <Clock className="h-4 w-4 ml-2" />
                        <span className="text-sm">{slot.time}</span>
                      </div>
                    </div>
                  </div>
                  {selectedSlot?.id === slot.id && <CheckCircle2 className="h-6 w-6 text-primary" />}
                </div>
              </Card>
            ))
          )}

          {/* Skip Option - only show if there are slots */}
          {!isLoading && (
            <Card
              className={`p-4 cursor-pointer transition-all border-2 border-dashed ${selectedSlot === null
                  ? "border-muted-foreground bg-muted"
                  : "border-border hover:border-muted-foreground"
                }`}
              onClick={() => setSelectedSlot(null)}
            >
              <div className="text-center py-2">
                <h3 className="font-semibold text-lg mb-1">
                  {slots.length > 0 ? "None of these work" : "Cancel Rescheduling"}
                </h3>
                <p className="text-sm text-muted-foreground">
                  {slots.length > 0
                    ? "Skip this week and keep your current lesson time"
                    : "Go back without making changes"
                  }
                </p>
              </div>
            </Card>
          )}
        </div>

        <div className="flex gap-3 justify-end">
          <Button variant="outline" onClick={handleSkip}>
            Cancel
          </Button>
          <Button
            onClick={handleConfirm}
            disabled={isSubmitting || (slots.length > 0 && selectedSlot !== null && !selectedSlot)}
          >
            {isSubmitting ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Rescheduling...
              </>
            ) : selectedSlot ? (
              "Confirm Reschedule"
            ) : (
              "Close"
            )}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  )
}
</file>

<file path="components/student/messages-panel.tsx">
"use client"

import type React from "react"

import { useState, useRef, useEffect } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Badge } from "@/components/ui/badge"
import { Send, Music, Loader2, Paperclip } from "lucide-react"
import { sendMessage, getConversation, markMessagesAsRead, getAdminProfile, uploadChatAttachment } from "@/app/messages/actions"
import type { Message, MessageAttachment } from "@/lib/supabase/database.types"
import { ChatAttachmentPreview, ChatPendingAttachments } from "@/components/chat-attachment-preview"

interface MessagesPanelProps {
  studentId: string
  teacherName?: string
}

export function MessagesPanel({ studentId, teacherName }: MessagesPanelProps) {
  const [messages, setMessages] = useState<Message[]>([])
  const [newMessage, setNewMessage] = useState("")
  const [adminId, setAdminId] = useState<string | null>(null)
  const [currentTeacherName, setCurrentTeacherName] = useState(teacherName)
  const [isLoading, setIsLoading] = useState(true)
  const [isSending, setIsSending] = useState(false)

  // Attachment states
  const [pendingAttachments, setPendingAttachments] = useState<{ file: File; preview?: string; uploading?: boolean }[]>([])
  const fileInputRef = useRef<HTMLInputElement>(null)

  const messagesEndRef = useRef<HTMLDivElement>(null)

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
  }

  // Load admin profile and messages on mount
  useEffect(() => {
    async function loadData() {
      setIsLoading(true)

      // Get admin profile
      const { admin } = await getAdminProfile()
      if (admin) {
        setAdminId(admin.id)
        if (admin.name) {
          setCurrentTeacherName(admin.name)
        }

        // Get conversation with admin
        const { messages: conversationMessages } = await getConversation(admin.id)
        setMessages(conversationMessages)

        // Mark messages as read
        await markMessagesAsRead(admin.id)
      }

      setIsLoading(false)

      // Scroll to bottom after initial load
      setTimeout(() => scrollToBottom(), 100)
    }

    loadData()
  }, [])

  // Don't auto-scroll on every poll - only scroll when user sends a message
  // The scrollToBottom is now called explicitly in handleSendMessage

  // Poll for new messages every 5 seconds
  useEffect(() => {
    if (!adminId) return

    const interval = setInterval(async () => {
      const { messages: newMessages } = await getConversation(adminId)
      setMessages(newMessages)
    }, 5000)

    return () => clearInterval(interval)
  }, [adminId])

  const handleSendMessage = async () => {
    if ((!newMessage.trim() && pendingAttachments.length === 0) || !adminId) return

    const tempMessage = newMessage
    const tempAttachments = [...pendingAttachments]
    setNewMessage("")
    setPendingAttachments([])
    setIsSending(true)

    try {
      // Upload all pending attachments first
      const uploadedAttachments: MessageAttachment[] = []
      for (const pending of tempAttachments) {
        const formData = new FormData()
        formData.append('file', pending.file)
        const result = await uploadChatAttachment(formData)
        if (result.attachment) {
          uploadedAttachments.push(result.attachment)
        } else if (result.error) {
          console.error('Failed to upload attachment:', result.error)
        }
      }

      // Send message with attachments
      const result = await sendMessage(
        adminId,
        tempMessage.trim() || (uploadedAttachments.length > 0 ? 'ðŸ“Ž Attachment' : ''),
        uploadedAttachments.length > 0 ? uploadedAttachments : undefined
      )

      if (result.success && result.message) {
        setMessages((prev) => [...prev, result.message!])
        // Scroll to show the new message
        setTimeout(() => scrollToBottom(), 100)
      } else if (result.error) {
        alert(`Failed to send message: ${result.error}`)
        setNewMessage(tempMessage)
        setPendingAttachments(tempAttachments)
      }
    } catch (error) {
      console.error('Error sending message:', error)
      setNewMessage(tempMessage)
      setPendingAttachments(tempAttachments)
    } finally {
      setIsSending(false)
    }
  }

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files
    if (!files || files.length === 0) return

    const newAttachments = Array.from(files).map(file => {
      const isImage = file.type.startsWith('image/')
      return {
        file,
        preview: isImage ? URL.createObjectURL(file) : undefined,
        uploading: false
      }
    })

    setPendingAttachments(prev => [...prev, ...newAttachments].slice(0, 5)) // Max 5

    // Reset input
    if (fileInputRef.current) {
      fileInputRef.current.value = ''
    }
  }

  const handleRemoveAttachment = (index: number) => {
    setPendingAttachments(prev => {
      const attachment = prev[index]
      if (attachment?.preview) {
        URL.revokeObjectURL(attachment.preview)
      }
      return prev.filter((_, i) => i !== index)
    })
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault()
      handleSendMessage()
    }
  }

  const formatTimestamp = (timestamp: string) => {
    const date = new Date(timestamp)
    const now = new Date()
    const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))

    if (diffDays === 0) {
      return date.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" })
    } else if (diffDays === 1) {
      return `Yesterday ${date.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" })}`
    } else if (diffDays < 7) {
      return date.toLocaleDateString("en-US", { weekday: "short", hour: "numeric", minute: "2-digit" })
    } else {
      return date.toLocaleDateString("en-US", { month: "short", day: "numeric", hour: "numeric", minute: "2-digit" })
    }
  }

  // Determine if message is from current student (studentId) or admin
  const isFromStudent = (message: Message) => message.sender_id === studentId

  const unreadCount = messages.filter((m) => !m.is_read && !isFromStudent(m)).length

  return (
    <Card className="flex flex-col h-[600px]">
      <CardHeader className="border-b pb-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-10 w-10 bg-primary rounded-full flex items-center justify-center">
              <Music className="h-5 w-5 text-primary-foreground" />
            </div>
            <div>
              <CardTitle className="text-lg font-serif">{currentTeacherName || "Your Instructor"}</CardTitle>
              <p className="text-sm text-muted-foreground">Your Instructor</p>
            </div>
          </div>
          {unreadCount > 0 && <Badge variant="destructive">{unreadCount} new</Badge>}
        </div>
      </CardHeader>

      <CardContent className="flex-1 overflow-y-auto p-4 space-y-4">
        {isLoading ? (
          <div className="flex flex-col items-center justify-center h-full">
            <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            <p className="text-sm text-muted-foreground mt-2">Loading messages...</p>
          </div>
        ) : messages.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full text-center">
            <Music className="h-12 w-12 text-muted-foreground mb-4" />
            <p className="text-muted-foreground">No messages yet</p>
            <p className="text-sm text-muted-foreground">Start a conversation with your teacher</p>
          </div>
        ) : (
          messages.map((message) => (
            <div key={message.id} className={`flex ${isFromStudent(message) ? "justify-end" : "justify-start"}`}>
              <div
                className={`max-w-[80%] rounded-2xl px-4 py-2.5 ${isFromStudent(message)
                  ? "bg-primary text-primary-foreground rounded-br-md"
                  : "bg-muted rounded-bl-md"
                  }`}
              >
                {message.content && message.content !== 'ðŸ“Ž Attachment' && (
                  <p className="text-sm leading-relaxed">{message.content}</p>
                )}

                {/* Attachments */}
                {message.attachments && message.attachments.length > 0 && (
                  <ChatAttachmentPreview attachments={message.attachments} compact />
                )}

                <p
                  className={`text-xs mt-1 ${isFromStudent(message) ? "text-primary-foreground/70" : "text-muted-foreground"
                    }`}
                >
                  {formatTimestamp(message.created_at)}
                </p>
              </div>
            </div>
          ))
        )}
        <div ref={messagesEndRef} />
      </CardContent>

      <div className="border-t">
        {/* Pending Attachments Preview */}
        {pendingAttachments.length > 0 && (
          <ChatPendingAttachments
            attachments={pendingAttachments}
            onRemove={handleRemoveAttachment}
          />
        )}

        <div className="p-4 flex gap-2">
          {/* Hidden File Input */}
          <input
            type="file"
            ref={fileInputRef}
            onChange={handleFileSelect}
            accept="image/*,.pdf,.doc,.docx"
            multiple
            className="hidden"
          />

          {/* Attachment Button */}
          <Button
            variant="ghost"
            size="icon"
            onClick={() => fileInputRef.current?.click()}
            disabled={isSending || pendingAttachments.length >= 5 || !adminId}
            title="Add attachment"
          >
            <Paperclip className="h-4 w-4" />
          </Button>

          <Input
            placeholder="Type a message..."
            value={newMessage}
            onChange={(e) => setNewMessage(e.target.value)}
            onKeyDown={handleKeyDown}
            className="flex-1"
            disabled={isSending || !adminId}
          />
          <Button
            onClick={handleSendMessage}
            disabled={(!newMessage.trim() && pendingAttachments.length === 0) || isSending || !adminId}
          >
            {isSending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Send className="h-4 w-4" />}
            <span className="sr-only">Send message</span>
          </Button>
        </div>
        <p className="text-xs text-muted-foreground pb-4 text-center">Press Enter to send</p>
      </div>
    </Card>
  )
}
</file>

<file path="components/inquiry-form.tsx">
"use client"

import { useState } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"
import { Loader2 } from "lucide-react"
import { submitInquiry } from "@/app/actions/inquiries"
import { useToast } from "@/hooks/use-toast"

interface InquiryFormProps {
    onSuccess?: () => void
    className?: string
}

export function InquiryForm({ onSuccess, className }: InquiryFormProps) {
    const { toast } = useToast()
    const [isSubmitting, setIsSubmitting] = useState(false)

    // Form states
    const [formData, setFormData] = useState({
        name: "",
        email: "",
        phone: "",
        experience: "",
        goals: ""
    })

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
        const { name, value } = e.target
        setFormData(prev => ({ ...prev, [name]: value }))
    }

    const handleSelectChange = (value: string) => {
        setFormData(prev => ({ ...prev, experience: value }))
    }

    async function handleSubmit(e: React.FormEvent) {
        e.preventDefault()
        setIsSubmitting(true)

        try {
            const formDataObj = new FormData()
            Object.entries(formData).forEach(([key, value]) => {
                formDataObj.append(key, value)
            })

            const result = await submitInquiry(formDataObj)

            if (result.success) {
                // Clear form
                setFormData({
                    name: "",
                    email: "",
                    phone: "",
                    experience: "",
                    goals: ""
                })

                if (onSuccess) {
                    onSuccess()
                } else {
                    toast({
                        title: "Inquiry Sent",
                        description: "We'll get back to you shortly."
                    })
                }
            } else {
                toast({
                    variant: "destructive",
                    title: "Something went wrong",
                    description: result.error || "Please try again later."
                })
            }
        } catch (error) {
            toast({
                variant: "destructive",
                title: "Error",
                description: "An unexpected error occurred. Please try again."
            })
        } finally {
            setIsSubmitting(false)
        }
    }

    return (
        <form onSubmit={handleSubmit} className={`space-y-4 ${className}`}>
            <div className="space-y-2">
                <Label htmlFor="name">Full Name *</Label>
                <Input
                    id="name"
                    name="name"
                    required
                    placeholder="Your name"
                    value={formData.name}
                    onChange={handleChange}
                />
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="space-y-2">
                    <Label htmlFor="email">Email *</Label>
                    <Input
                        id="email"
                        name="email"
                        type="email"
                        required
                        placeholder="email@example.com"
                        value={formData.email}
                        onChange={handleChange}
                    />
                </div>
                <div className="space-y-2">
                    <Label htmlFor="phone">Phone (Optional)</Label>
                    <Input
                        id="phone"
                        name="phone"
                        type="tel"
                        placeholder="(555) 123-4567"
                        value={formData.phone}
                        onChange={handleChange}
                    />
                </div>
            </div>

            <div className="space-y-2">
                <Label htmlFor="experience">Experience Level *</Label>
                <Select required onValueChange={handleSelectChange} value={formData.experience}>
                    <SelectTrigger>
                        <SelectValue placeholder="Select your level" />
                    </SelectTrigger>
                    <SelectContent>
                        <SelectItem value="Beginner">Beginner (New to piano)</SelectItem>
                        <SelectItem value="Intermediate">Intermediate (Some experience)</SelectItem>
                        <SelectItem value="Advanced">Advanced (Several years experience)</SelectItem>
                        <SelectItem value="Returning">Returning after a break</SelectItem>
                    </SelectContent>
                </Select>
            </div>

            <div className="space-y-2">
                <Label htmlFor="goals">Musical Goals *</Label>
                <Textarea
                    id="goals"
                    name="goals"
                    required
                    placeholder="What would you like to achieve? (e.g. Learn classical, play for fun, prepare for exams)"
                    className="min-h-[100px]"
                    value={formData.goals}
                    onChange={handleChange}
                />
            </div>

            <div className="pt-4">
                <Button type="submit" disabled={isSubmitting} className="w-full">
                    {isSubmitting ? (
                        <>
                            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                            Sending...
                        </>
                    ) : (
                        "Submit Inquiry"
                    )}
                </Button>
            </div>
        </form>
    )
}
</file>

<file path="scripts/fix_resource_urls.ts">
import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import * as fs from 'fs';
import * as path from 'path';

// Load env vars manually since we're running as a standalone script
const envPath = path.resolve(__dirname, '../.env.local');
if (fs.existsSync(envPath)) {
    const envConfig = dotenv.parse(fs.readFileSync(envPath));
    for (const k in envConfig) {
        process.env[k] = envConfig[k];
    }
}

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_KEY;

if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
    console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_KEY');
    process.exit(1);
}

const OLD_PROJECT_ID = 'dmbnstbteqlhxyczlcst';
// Extract new project ID from URL (e.g. https://glexdzzmdkqpfbqqffyw.supabase.co -> glexdzzmdkqpfbqqffyw)
const NEW_PROJECT_ID = new URL(SUPABASE_URL).hostname.split('.')[0];

console.log(`Migrating URLs from project ${OLD_PROJECT_ID} to ${NEW_PROJECT_ID}...`);

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

async function fixResourceUrls() {
    // Fetch all resources that contain the old project ID
    const { data: resources, error } = await supabase
        .from('resources')
        .select('*')
        .ilike('file_url', `%${OLD_PROJECT_ID}%`);

    if (error) {
        console.error('Error fetching resources:', error);
        return;
    }

    console.log(`Found ${resources.length} resources with old URLs.`);

    for (const resource of resources) {
        const oldUrl = resource.file_url;
        const newUrl = oldUrl.replace(OLD_PROJECT_ID, NEW_PROJECT_ID);

        console.log(`Updating resource ${resource.id}:`);
        console.log(`  Old: ${oldUrl}`);
        console.log(`  New: ${newUrl}`);

        const { error: updateError } = await supabase
            .from('resources')
            .update({ file_url: newUrl })
            .eq('id', resource.id);

        if (updateError) {
            console.error(`  Failed to update resource ${resource.id}:`, updateError);
        } else {
            console.log(`  Success!`);
        }
    }

    console.log('Migration complete.');
}

fixResourceUrls();
</file>

<file path="supabase/alter_announcements_v2.sql">
-- Announcements v2: Add status and sent_at columns
-- Run this in the Supabase SQL Editor

alter table public.announcements
add column if not exists status text check (status in ('draft', 'sent')) default 'draft';

alter table public.announcements
add column if not exists sent_at timestamp with time zone;

-- Backfill: mark any existing rows as 'sent' since they were already sent
update public.announcements set status = 'sent', sent_at = created_at where status is null or status = 'draft';
</file>

<file path="supabase/create_announcements.sql">
-- Announcements Feature: Tables and RLS
-- Run this in the Supabase SQL Editor

-- 1. Store the actual message content
create table public.announcements (
  id uuid default gen_random_uuid() primary key,
  subject text not null,
  body text not null,
  teacher_id uuid references auth.users,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Link messages to specific students (Many-to-Many)
create table public.announcement_recipients (
  id uuid default gen_random_uuid() primary key,
  announcement_id uuid references public.announcements on delete cascade,
  student_id uuid references public.profiles(id) on delete cascade,
  is_read boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. RLS Policies
alter table public.announcements enable row level security;
alter table public.announcement_recipients enable row level security;

-- Admins can do everything
create policy "Admins full access announcements" on public.announcements
  for all using ( (select role from profiles where id = auth.uid()) = 'admin' );

create policy "Admins full access recipients" on public.announcement_recipients
  for all using ( (select role from profiles where id = auth.uid()) = 'admin' );

-- Students can VIEW announcements sent to them
create policy "Students view own announcements" on public.announcements
  for select using (
    exists (
      select 1 from announcement_recipients ar
      where ar.announcement_id = announcements.id
      and ar.student_id = auth.uid()
    )
  );

-- Students can view their own recipient records
create policy "Students view own recipient records" on public.announcement_recipients
  for select using ( student_id = auth.uid() );
</file>

<file path=".gitignore">
node_modules
.env.local
.next
.DS_Store
.vercel
.env*.local
migrate_db.sh
scripts/migrate.ts
scripts/test-connection.ts

# Google Credentials
piano-studio-scheduler-*.json
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
  typescript: {
    ignoreBuildErrors: true,
  },
  images: {
    unoptimized: true,
  },
  experimental: {
    serverActions: {
      bodySizeLimit: '10mb',
    },
  },
}

export default nextConfig
</file>

<file path="package.json">
{
  "name": "my-v0-project",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "build": "next build",
    "dev": "next dev",
    "lint": "eslint .",
    "start": "next start",
    "seed": "npx tsx scripts/seed.ts"
  },
  "dependencies": {
    "@hookform/resolvers": "^3.10.0",
    "@radix-ui/react-accordion": "1.2.2",
    "@radix-ui/react-alert-dialog": "1.1.4",
    "@radix-ui/react-aspect-ratio": "1.1.1",
    "@radix-ui/react-avatar": "1.1.2",
    "@radix-ui/react-checkbox": "1.1.3",
    "@radix-ui/react-collapsible": "1.1.2",
    "@radix-ui/react-context-menu": "2.2.4",
    "@radix-ui/react-dialog": "1.1.4",
    "@radix-ui/react-dropdown-menu": "2.1.4",
    "@radix-ui/react-hover-card": "1.1.4",
    "@radix-ui/react-label": "2.1.1",
    "@radix-ui/react-menubar": "1.1.4",
    "@radix-ui/react-navigation-menu": "1.2.3",
    "@radix-ui/react-popover": "1.1.4",
    "@radix-ui/react-progress": "1.1.1",
    "@radix-ui/react-radio-group": "1.2.2",
    "@radix-ui/react-scroll-area": "1.2.2",
    "@radix-ui/react-select": "2.1.4",
    "@radix-ui/react-separator": "1.1.1",
    "@radix-ui/react-slider": "1.2.2",
    "@radix-ui/react-slot": "1.1.1",
    "@radix-ui/react-switch": "1.1.2",
    "@radix-ui/react-tabs": "1.1.2",
    "@radix-ui/react-toast": "1.2.4",
    "@radix-ui/react-toggle": "1.1.1",
    "@radix-ui/react-toggle-group": "1.1.1",
    "@radix-ui/react-tooltip": "1.1.6",
    "@react-email/components": "^1.0.1",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.87.0",
    "@types/pg": "^8.16.0",
    "@vercel/analytics": "latest",
    "autoprefixer": "^10.4.20",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "1.0.4",
    "date-fns": "4.1.0",
    "dropbox": "^10.34.0",
    "embla-carousel-react": "8.5.1",
    "googleapis": "^170.0.0",
    "input-otp": "1.4.1",
    "lucide-react": "^0.454.0",
    "next": "16.0.7",
    "next-themes": "^0.4.6",
    "pg": "^8.16.3",
    "prettier": "^3.7.4",
    "react": "19.2.0",
    "react-day-picker": "9.8.0",
    "react-dom": "19.2.0",
    "react-hook-form": "^7.60.0",
    "react-resizable-panels": "^2.1.7",
    "recharts": "2.15.4",
    "resend": "^6.5.2",
    "sonner": "^1.7.4",
    "stripe": "^20.0.0",
    "tailwind-merge": "^2.5.5",
    "tailwindcss-animate": "^1.0.7",
    "vaul": "^1.1.2",
    "zod": "3.25.76"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.9",
    "@types/node": "^22",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "dotenv": "^17.2.3",
    "postcss": "^8.5",
    "tailwindcss": "^4.1.9",
    "tw-animate-css": "1.3.3",
    "typescript": "^5"
  }
}
</file>

<file path="vercel.json">
{
    "crons": [
        {
            "path": "/api/cron/process-recordings",
            "schedule": "0 10 * * *"
        },
        {
            "path": "/api/cron/reminders",
            "schedule": "*/10 * * * *"
        }
    ]
}
</file>

<file path=".github/workflows/cron.yml">
name: Trigger Reminders
on:
  schedule:
    - cron: '*/10 * * * *' # Run every 10 minutes
  workflow_dispatch: # Enable manual trigger
jobs:
  ping-api:
    runs-on: ubuntu-latest
    steps:
      - name: Call API Route
        run: |
          curl "https://lessons.musicalbasics.com/api/cron/reminders?key=${{ secrets.CRON_SECRET }}"
</file>

<file path="app/api/webhooks/stripe/route.ts">
import { headers } from 'next/headers'
import { NextResponse } from 'next/server'
import { createClient as createSupabaseClient } from '@supabase/supabase-js'
import Stripe from 'stripe'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!)
const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET!

// Use admin client for webhook (no user session available)
const supabaseAdmin = createSupabaseClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
)

export async function POST(req: Request) {
    const body = await req.text()
    const headersList = await headers()
    const signature = headersList.get('stripe-signature')

    let event: Stripe.Event

    try {
        event = stripe.webhooks.constructEvent(body, signature!, webhookSecret)
    } catch (err) {
        console.error('Webhook signature verification failed:', err)
        return NextResponse.json({ error: 'Webhook signature verification failed' }, { status: 400 })
    }

    // 1. Handle One-Time Purchases & First Subscription Payment
    if (event.type === 'checkout.session.completed') {
        const session = event.data.object as Stripe.Checkout.Session
        const userId = session.metadata?.userId
        const type = session.metadata?.type

        if (userId) {
            // CASE A: Balance Payment
            if (type === 'balance_payment') {
                const amountPaidCents = Number(session.metadata?.amountPaid || 0)
                const amountPaid = amountPaidCents / 100

                // Fetch current balance to subtract carefully
                const { data: profile } = await supabaseAdmin
                    .from('profiles')
                    .select('balance_due')
                    .eq('id', userId)
                    .single()

                // Reset balance (or subtract if partial payments were allowed, but here we assume full)
                const currentBalance = Number(profile?.balance_due || 0)
                const newBalance = Math.max(0, currentBalance - amountPaid)

                await supabaseAdmin
                    .from('profiles')
                    .update({ balance_due: newBalance })
                    .eq('id', userId)

                console.log(`âœ… Balance payment processed for user ${userId}: Paid $${amountPaid}`)
            }
            // CASE B: Standard Credit Purchase
            else {
                const creditsToAdd = Number(session.metadata?.credits || 0)
                if (creditsToAdd > 0) {
                    const { data: profile } = await supabaseAdmin
                        .from('profiles')
                        .select('credits')
                        .eq('id', userId)
                        .single()

                    const newBalance = (profile?.credits || 0) + creditsToAdd

                    await supabaseAdmin
                        .from('profiles')
                        .update({ credits: newBalance })
                        .eq('id', userId)

                    console.log(`âœ… Added ${creditsToAdd} credits to user ${userId} (Checkout)`)
                }
            }
        }
    }

    // 2. Handle Recurring Subscription Payments (Months 2, 3, 4...)
    if (event.type === 'invoice.payment_succeeded') {
        const invoice = event.data.object as Stripe.Invoice

        // We only care about subscription renewals, not the first payment
        // 'subscription_create' is handled by checkout.session.completed above
        if (invoice.billing_reason === 'subscription_cycle') {

            // Fetch the subscription to get the metadata we saved
            const subscriptionId = (invoice as any).subscription as string
            const subscription = await stripe.subscriptions.retrieve(subscriptionId)

            const userId = subscription.metadata?.userId
            const creditsToAdd = Number(subscription.metadata?.credits || 0) // Should be 4

            if (userId && creditsToAdd > 0) {
                const { data: profile } = await supabaseAdmin
                    .from('profiles')
                    .select('credits')
                    .eq('id', userId)
                    .single()

                const newBalance = (profile?.credits || 0) + creditsToAdd

                await supabaseAdmin
                    .from('profiles')
                    .update({ credits: newBalance })
                    .eq('id', userId)

                console.log(`âœ… Renewed subscription: Added ${creditsToAdd} credits to user ${userId}`)
            }
        }
    }

    return NextResponse.json({ received: true })
}
</file>

<file path="components/admin/announcement-modal.tsx">
"use client"

import { useState, useEffect } from "react"
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Checkbox } from "@/components/ui/checkbox"
import { Loader2, Send, Save } from "lucide-react"
import { sendAnnouncement, saveAnnouncementDraft } from "@/app/actions/announcements"
import { useToast } from "@/hooks/use-toast"
import type { StudentRoster } from "@/types/admin"

export interface AnnouncementData {
    id?: string
    subject: string
    body: string
    status: 'draft' | 'sent'
    recipient_ids: string[]
}

interface AnnouncementModalProps {
    open: boolean
    onOpenChange: (open: boolean) => void
    students: StudentRoster[]
    /** Pre-fill for editing a draft or viewing a sent announcement */
    initial?: AnnouncementData | null
    onComplete: () => void
}

export function AnnouncementModal({ open, onOpenChange, students, initial, onComplete }: AnnouncementModalProps) {
    const { toast } = useToast()
    const [subject, setSubject] = useState(initial?.subject || "")
    const [body, setBody] = useState(initial?.body || "")
    const [selectedStudents, setSelectedStudents] = useState<string[]>(initial?.recipient_ids || [])
    const [isSaving, setIsSaving] = useState(false)
    const [isSending, setIsSending] = useState(false)

    // Sync form state when initial data changes (clicking a different row)
    useEffect(() => {
        if (initial) {
            setSubject(initial.subject)
            setBody(initial.body)
            setSelectedStudents(initial.recipient_ids || [])
        } else {
            setSubject("")
            setBody("")
            setSelectedStudents([])
        }
    }, [initial])

    const isViewOnly = initial?.status === 'sent'
    const allSelected = selectedStudents.length === students.length && students.length > 0

    // Reset form when initial data changes (modal re-opens with different data)
    const handleOpenChange = (open: boolean) => {
        if (!open) {
            // Reset on close
            setSubject("")
            setBody("")
            setSelectedStudents([])
        }
        onOpenChange(open)
    }

    const handleSelectAll = () => {
        if (allSelected) {
            setSelectedStudents([])
        } else {
            setSelectedStudents(students.map(s => s.id))
        }
    }

    const handleToggleStudent = (studentId: string, checked: boolean) => {
        if (checked) {
            setSelectedStudents(prev => [...prev, studentId])
        } else {
            setSelectedStudents(prev => prev.filter(id => id !== studentId))
        }
    }

    const handleSaveDraft = async () => {
        if (!subject.trim()) return
        setIsSaving(true)
        const result = await saveAnnouncementDraft(subject.trim(), body.trim(), selectedStudents, initial?.id)
        setIsSaving(false)

        if (result.error) {
            toast({ variant: "destructive", title: "Error", description: result.error })
        } else {
            toast({ title: "Draft Saved", description: "You can resume editing anytime." })
            onComplete()
            handleOpenChange(false)
        }
    }

    const handleSend = async () => {
        if (!subject.trim() || !body.trim() || selectedStudents.length === 0) return
        setIsSending(true)
        const result = await sendAnnouncement(subject.trim(), body.trim(), selectedStudents, initial?.id)
        setIsSending(false)

        if (result.error) {
            toast({ variant: "destructive", title: "Send Failed", description: result.error })
        } else {
            toast({ title: "ðŸ“¢ Announcement Sent!", description: result.message })
            onComplete()
            handleOpenChange(false)
        }
    }

    return (
        <Dialog open={open} onOpenChange={handleOpenChange}>
            <DialogContent className="sm:max-w-2xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle className="text-xl font-serif">
                        {isViewOnly ? "View Announcement" : initial?.id ? "Edit Draft" : "New Announcement"}
                    </DialogTitle>
                </DialogHeader>

                <div className="space-y-5 pt-2">
                    {/* Subject */}
                    <div className="space-y-2">
                        <Label htmlFor="ann-subject" className="text-base">Subject</Label>
                        <Input
                            id="ann-subject"
                            placeholder="e.g. Recital next Saturday!"
                            value={subject}
                            onChange={e => setSubject(e.target.value)}
                            disabled={isViewOnly}
                        />
                    </div>

                    {/* Body */}
                    <div className="space-y-2">
                        <Label htmlFor="ann-body" className="text-base">Message</Label>
                        <Textarea
                            id="ann-body"
                            placeholder="Write your announcement here..."
                            value={body}
                            onChange={e => setBody(e.target.value)}
                            rows={6}
                            className="resize-none"
                            disabled={isViewOnly}
                        />
                    </div>

                    {/* Recipients */}
                    <div className="space-y-3">
                        <div className="flex items-center justify-between">
                            <Label className="text-base">
                                Recipients {selectedStudents.length > 0 && (
                                    <span className="text-muted-foreground font-normal">
                                        ({selectedStudents.length} selected)
                                    </span>
                                )}
                            </Label>
                            {!isViewOnly && (
                                <Button variant="ghost" size="sm" onClick={handleSelectAll}>
                                    {allSelected ? "Deselect All" : "Select All"}
                                </Button>
                            )}
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-[200px] overflow-y-auto border rounded-md p-3">
                            {students.map(student => {
                                const isSelected = selectedStudents.includes(student.id)
                                return (
                                    <div
                                        key={student.id}
                                        className={`flex items-center gap-2 p-1.5 rounded ${isViewOnly ? '' : 'hover:bg-accent cursor-pointer'}`}
                                        onClick={() => !isViewOnly && handleToggleStudent(student.id, !isSelected)}
                                    >
                                        <Checkbox
                                            checked={isSelected}
                                            onCheckedChange={(checked) =>
                                                !isViewOnly && handleToggleStudent(student.id, !!checked)
                                            }
                                            disabled={isViewOnly}
                                        />
                                        <span className="text-sm truncate">
                                            {student.name || student.email}
                                        </span>
                                    </div>
                                )
                            })}
                            {students.length === 0 && (
                                <p className="text-sm text-muted-foreground col-span-full text-center py-4">
                                    No students found
                                </p>
                            )}
                        </div>
                    </div>

                    {/* Actions */}
                    {!isViewOnly && (
                        <div className="flex justify-end gap-3 pt-2">
                            <Button
                                variant="outline"
                                onClick={handleSaveDraft}
                                disabled={isSaving || isSending || !subject.trim()}
                            >
                                {isSaving ? (
                                    <><Loader2 className="h-4 w-4 mr-2 animate-spin" /> Saving...</>
                                ) : (
                                    <><Save className="h-4 w-4 mr-2" /> Save Draft</>
                                )}
                            </Button>
                            <Button
                                onClick={handleSend}
                                disabled={isSending || isSaving || !subject.trim() || !body.trim() || selectedStudents.length === 0}
                                className="bg-indigo-600 hover:bg-indigo-500 text-white"
                            >
                                {isSending ? (
                                    <><Loader2 className="h-4 w-4 mr-2 animate-spin" /> Sending...</>
                                ) : (
                                    <><Send className="h-4 w-4 mr-2" /> Send Announcement</>
                                )}
                            </Button>
                        </div>
                    )}
                </div>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/admin/announcement-tab.tsx">
"use client"

import { useState, useEffect } from "react"
import { Card, CardContent } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Megaphone, Plus, Trash2, Loader2 } from "lucide-react"
import { getAnnouncements, deleteAnnouncementDraft } from "@/app/actions/announcements"
import { AnnouncementModal, type AnnouncementData } from "@/components/admin/announcement-modal"
import { useToast } from "@/hooks/use-toast"
import type { StudentRoster } from "@/types/admin"

interface AnnouncementTabProps {
    students: StudentRoster[]
}

type AnnouncementRow = {
    id: string
    subject: string
    body: string
    status: 'draft' | 'sent'
    created_at: string
    sent_at: string | null
    recipient_count: number
    recipient_ids: string[]
}

export function AnnouncementTab({ students }: AnnouncementTabProps) {
    const { toast } = useToast()
    const [announcements, setAnnouncements] = useState<AnnouncementRow[]>([])
    const [isLoading, setIsLoading] = useState(true)
    const [showModal, setShowModal] = useState(false)
    const [editData, setEditData] = useState<AnnouncementData | null>(null)
    const [deletingId, setDeletingId] = useState<string | null>(null)

    const fetchList = async () => {
        setIsLoading(true)
        const data = await getAnnouncements()
        setAnnouncements(data)
        setIsLoading(false)
    }

    useEffect(() => { fetchList() }, [])

    const handleNew = () => {
        setEditData(null)
        setShowModal(true)
    }

    const handleRowClick = (row: AnnouncementRow) => {
        setEditData({
            id: row.id,
            subject: row.subject,
            body: row.body,
            status: row.status,
            recipient_ids: row.recipient_ids
        })
        setShowModal(true)
    }

    const handleDelete = async (e: React.MouseEvent, id: string) => {
        e.stopPropagation()
        if (!confirm("Delete this draft?")) return
        setDeletingId(id)
        const result = await deleteAnnouncementDraft(id)
        setDeletingId(null)
        if (result.error) {
            toast({ variant: "destructive", title: "Error", description: result.error })
        } else {
            toast({ title: "Draft Deleted" })
            fetchList()
        }
    }

    const formatDate = (dateStr: string) => {
        return new Date(dateStr).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
        })
    }

    return (
        <div className="space-y-6 max-w-5xl">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Megaphone className="h-6 w-6 text-indigo-600" />
                    <h2 className="text-2xl font-serif font-semibold">Announcements</h2>
                </div>
                <Button onClick={handleNew} className="bg-indigo-600 hover:bg-indigo-500 text-white">
                    <Plus className="h-4 w-4 mr-2" />
                    New Announcement
                </Button>
            </div>

            {/* History List */}
            {isLoading ? (
                <div className="flex justify-center py-12">
                    <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
                </div>
            ) : announcements.length === 0 ? (
                <Card>
                    <CardContent className="flex flex-col items-center justify-center py-12 text-center">
                        <Megaphone className="h-12 w-12 text-muted-foreground/30 mb-4" />
                        <h3 className="font-semibold text-lg mb-2">No Announcements Yet</h3>
                        <p className="text-muted-foreground max-w-sm">
                            Click &quot;New Announcement&quot; to draft your first message to students.
                        </p>
                    </CardContent>
                </Card>
            ) : (
                <div className="space-y-2">
                    {announcements.map(a => (
                        <Card
                            key={a.id}
                            className="hover:shadow-md transition-shadow cursor-pointer border"
                            onClick={() => handleRowClick(a)}
                        >
                            <CardContent className="flex items-center justify-between p-4">
                                <div className="flex items-center gap-4 flex-1 min-w-0">
                                    {/* Status Badge */}
                                    <Badge
                                        variant={a.status === 'sent' ? 'default' : 'secondary'}
                                        className={a.status === 'sent'
                                            ? 'bg-green-100 text-green-700 hover:bg-green-100 border-green-200 shrink-0'
                                            : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-100 border-yellow-200 shrink-0'
                                        }
                                    >
                                        {a.status === 'sent' ? 'Sent' : 'Draft'}
                                    </Badge>

                                    {/* Subject */}
                                    <div className="flex-1 min-w-0">
                                        <p className="font-medium truncate">{a.subject || "(No subject)"}</p>
                                        <p className="text-xs text-muted-foreground">
                                            {formatDate(a.sent_at || a.created_at)} Â· {a.recipient_count} recipient{a.recipient_count === 1 ? '' : 's'}
                                        </p>
                                    </div>
                                </div>

                                {/* Delete button for drafts */}
                                {a.status === 'draft' && (
                                    <Button
                                        variant="ghost"
                                        size="sm"
                                        className="text-muted-foreground hover:text-destructive shrink-0 ml-2"
                                        onClick={(e) => handleDelete(e, a.id)}
                                        disabled={deletingId === a.id}
                                    >
                                        {deletingId === a.id ? (
                                            <Loader2 className="h-4 w-4 animate-spin" />
                                        ) : (
                                            <Trash2 className="h-4 w-4" />
                                        )}
                                    </Button>
                                )}
                            </CardContent>
                        </Card>
                    ))}
                </div>
            )}

            {/* Modal */}
            <AnnouncementModal
                open={showModal}
                onOpenChange={setShowModal}
                students={students}
                initial={editData}
                onComplete={fetchList}
            />
        </div>
    )
}
</file>

<file path="components/chat-attachment-preview.tsx">
"use client"

import { X, FileText, Download, Image as ImageIcon } from "lucide-react"
import { Button } from "@/components/ui/button"
import type { MessageAttachment } from "@/lib/supabase/database.types"

interface ChatAttachmentPreviewProps {
    attachments: MessageAttachment[]
    /** If true, shows remove buttons (for pre-send state) */
    editable?: boolean
    /** Callback when an attachment is removed (only used when editable=true) */
    onRemove?: (index: number) => void
    /** Compact mode for smaller display in message bubbles */
    compact?: boolean
}

function formatFileSize(bytes: number): string {
    if (bytes < 1024) return `${bytes} B`
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
}

export function ChatAttachmentPreview({
    attachments,
    editable = false,
    onRemove,
    compact = false
}: ChatAttachmentPreviewProps) {
    if (!attachments || attachments.length === 0) return null

    return (
        <div className={`flex flex-wrap gap-2 ${compact ? '' : 'mt-2'}`}>
            {attachments.map((attachment, index) => (
                <div key={`${attachment.url}-${index}`}>
                    {attachment.type === 'image' ? (
                        // Image Preview
                        <div className={`relative group ${compact ? 'max-w-[160px]' : 'max-w-[200px]'}`}>
                            <a
                                href={attachment.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="block"
                            >
                                <img
                                    src={attachment.url}
                                    alt={attachment.name}
                                    className={`rounded-lg object-cover border transition-opacity hover:opacity-90 ${compact ? 'max-h-[120px]' : 'max-h-[150px]'
                                        }`}
                                />
                            </a>
                            {editable && onRemove && (
                                <Button
                                    variant="destructive"
                                    size="icon"
                                    className="absolute -top-2 -right-2 h-6 w-6 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                                    onClick={() => onRemove(index)}
                                >
                                    <X className="h-3 w-3" />
                                </Button>
                            )}
                        </div>
                    ) : (
                        // File Preview
                        <div
                            className={`relative group flex items-center gap-2 border rounded-lg bg-muted/50 ${compact ? 'px-2 py-1.5' : 'px-3 py-2'
                                }`}
                        >
                            <div className={`shrink-0 ${compact ? 'text-muted-foreground' : 'text-primary'}`}>
                                <FileText className={compact ? 'h-4 w-4' : 'h-5 w-5'} />
                            </div>
                            <div className="min-w-0 flex-1">
                                <a
                                    href={attachment.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className={`block font-medium truncate hover:underline ${compact ? 'text-xs max-w-[100px]' : 'text-sm max-w-[140px]'
                                        }`}
                                    title={attachment.name}
                                >
                                    {attachment.name}
                                </a>
                                {!compact && (
                                    <p className="text-xs text-muted-foreground">
                                        {formatFileSize(attachment.size)}
                                    </p>
                                )}
                            </div>
                            {editable && onRemove ? (
                                <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-6 w-6 shrink-0"
                                    onClick={() => onRemove(index)}
                                >
                                    <X className="h-3 w-3" />
                                </Button>
                            ) : (
                                <a
                                    href={attachment.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="shrink-0 text-muted-foreground hover:text-foreground"
                                >
                                    <Download className={compact ? 'h-3 w-3' : 'h-4 w-4'} />
                                </a>
                            )}
                        </div>
                    )}
                </div>
            ))}
        </div>
    )
}

export interface PendingAttachment {
    id?: string
    file?: File
    libraryFile?: { url: string; name: string; type: string; size: number }
    preview?: string // For image previews (data URL)
    uploading?: boolean
}

interface ChatPendingAttachmentsProps {
    attachments: PendingAttachment[]
    onRemove: (index: number) => void
}

/** Preview component for attachments that are pending (not yet uploaded/sent) */
export function ChatPendingAttachments({
    attachments,
    onRemove
}: ChatPendingAttachmentsProps) {
    if (!attachments || attachments.length === 0) return null

    return (
        <div className="flex flex-wrap gap-2 p-2 border-t bg-muted/30">
            {attachments.map((attachment, index) => (
                <div key={`pending-${index}`} className="relative group">
                    {attachment.preview ? (
                        // Image with preview
                        <div className="relative">
                            <img
                                src={attachment.preview}
                                alt={attachment.file?.name || attachment.libraryFile?.name || 'Attachment'}
                                className={`h-16 w-16 object-cover rounded-lg border ${attachment.uploading ? 'opacity-50' : ''
                                    }`}
                            />
                            {attachment.uploading && (
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <div className="h-4 w-4 border-2 border-primary border-t-transparent rounded-full animate-spin" />
                                </div>
                            )}
                        </div>
                    ) : (
                        // File without preview
                        <div
                            className={`flex items-center gap-2 px-2 py-1.5 border rounded-lg bg-background ${attachment.uploading ? 'opacity-50' : ''
                                }`}
                        >
                            <FileText className="h-4 w-4 text-muted-foreground" />
                            <span className="text-xs truncate max-w-[80px]">
                                {attachment.file?.name || attachment.libraryFile?.name || 'Unknown file'}
                            </span>
                            {attachment.uploading && (
                                <div className="h-3 w-3 border-2 border-primary border-t-transparent rounded-full animate-spin" />
                            )}
                        </div>
                    )}
                    {!attachment.uploading && (
                        <Button
                            variant="destructive"
                            size="icon"
                            className="absolute -top-1.5 -right-1.5 h-5 w-5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                            onClick={() => onRemove(index)}
                        >
                            <X className="h-3 w-3" />
                        </Button>
                    )}
                </div>
            ))}
        </div>
    )
}
</file>

<file path="components/dynamic-landing-page.tsx">
"use client"

import { useEffect, useRef } from "react"

interface DynamicLandingPageProps {
    html: string
    script: string
}

export function DynamicLandingPage({ html, script }: DynamicLandingPageProps) {
    const scriptExecuted = useRef(false)

    useEffect(() => {
        // Execute scripts only once after mount
        if (script && !scriptExecuted.current) {
            scriptExecuted.current = true
            try {
                // Create and execute script
                const scriptEl = document.createElement('script')
                scriptEl.textContent = script
                document.body.appendChild(scriptEl)

                // Cleanup on unmount
                return () => {
                    if (scriptEl.parentNode) {
                        scriptEl.parentNode.removeChild(scriptEl)
                    }
                }
            } catch (error) {
                console.error('Script execution error:', error)
            }
        }
    }, [script])

    return (
        <div
            className="dynamic-landing-page"
            dangerouslySetInnerHTML={{ __html: html }}
        />
    )
}
</file>

<file path="components/static-landing-page.tsx">
"use client"

import Link from "next/link"
import { Button } from "@/components/ui/button"
import { Card, CardContent } from "@/components/ui/card"
import { Music, Clock, Calendar, Award, Facebook, Instagram, Mail } from "lucide-react"
import { InquiryModal } from "@/components/inquiry-modal"
import { useState } from "react"

export function StaticLandingPage() {
    const [showInquiryModal, setShowInquiryModal] = useState(false)

    return (
        <div className="min-h-screen bg-background">
            {/* Navigation */}
            <nav className="border-b bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/60 sticky top-0 z-50">
                <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <Music className="h-6 w-6" />
                        <span className="font-serif text-xl font-bold">Piano Studio</span>
                    </div>
                    <Link href="/login">
                        <Button variant="outline" size="sm">
                            Student Login
                        </Button>
                    </Link>
                </div>
            </nav>

            {/* Hero Section */}
            <section className="relative py-20 lg:py-32 overflow-hidden">
                {/* Background Piano Keys Pattern */}
                <div className="absolute inset-0 opacity-[0.03] pointer-events-none">
                    <div
                        className="w-full h-full"
                        style={{
                            backgroundImage: `repeating-linear-gradient(
                90deg,
                #000 0px,
                #000 60px,
                #fff 60px,
                #fff 70px,
                #000 70px,
                #000 100px,
                #fff 100px,
                #fff 110px
              )`,
                            backgroundSize: "100% 200px",
                        }}
                    />
                </div>

                <div className="container mx-auto px-4">
                    <div className="grid lg:grid-cols-2 gap-12 items-center">
                        {/* Left Content */}
                        <div className="space-y-8">
                            <div className="space-y-4">
                                <h1 className="font-serif text-5xl lg:text-6xl font-bold text-balance leading-tight">
                                    Master Piano with Excellence
                                </h1>
                                <p className="text-xl text-muted-foreground text-pretty leading-relaxed">
                                    Transform your musical journey with personalized instruction, flexible scheduling, and a proven system
                                    designed for serious students.
                                </p>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-4">
                                <Button size="lg" className="text-base h-12 px-8" onClick={() => setShowInquiryModal(true)}>
                                    Inquire for Lessons
                                </Button>
                                <Link href="/student">
                                    <Button variant="outline" size="lg" className="text-base h-12 px-8 w-full sm:w-auto bg-transparent">
                                        Student Portal
                                    </Button>
                                </Link>
                            </div>

                            {/* Stats */}
                            <div className="grid grid-cols-3 gap-6 pt-8 border-t">
                                <div>
                                    <div className="font-serif text-3xl font-bold">15+</div>
                                    <div className="text-sm text-muted-foreground">Years Teaching</div>
                                </div>
                                <div>
                                    <div className="font-serif text-3xl font-bold">200+</div>
                                    <div className="text-sm text-muted-foreground">Students Taught</div>
                                </div>
                                <div>
                                    <div className="font-serif text-3xl font-bold">98%</div>
                                    <div className="text-sm text-muted-foreground">Satisfaction Rate</div>
                                </div>
                            </div>
                        </div>

                        {/* Right Image */}
                        <div className="relative">
                            <div className="aspect-[4/5] rounded-lg overflow-hidden border-2 border-border shadow-2xl">
                                <img
                                    src="/professional-piano-teacher-at-grand-piano-in-elega.jpg"
                                    alt="Professional Piano Instruction"
                                    className="w-full h-full object-cover"
                                />
                            </div>
                            {/* Decorative Element */}
                            <div className="absolute -bottom-6 -left-6 w-32 h-32 bg-primary/10 rounded-full -z-10" />
                            <div className="absolute -top-6 -right-6 w-24 h-24 bg-primary/5 rounded-full -z-10" />
                        </div>
                    </div>
                </div>
            </section>

            {/* About Me Section */}
            <section className="py-20 bg-muted/30">
                <div className="container mx-auto px-4">
                    <div className="max-w-3xl mx-auto">
                        <div className="text-center space-y-4 mb-12">
                            <h2 className="font-serif text-4xl font-bold">About Your Teacher</h2>
                            <div className="h-1 w-20 bg-primary mx-auto" />
                        </div>

                        <div className="space-y-6 text-lg leading-relaxed">
                            <p>
                                With over 15 years of experience teaching piano to students of all ages and skill levels, I bring a
                                unique blend of classical training and modern pedagogy to every lesson. My approach is rooted in
                                building strong technical foundations while nurturing each student's individual musical voice.
                            </p>

                            <p>
                                I hold a Master's degree in Piano Performance from a prestigious conservatory and have performed
                                internationally as a soloist and chamber musician. But my greatest joy comes from witnessing the moment
                                when a student discovers their own musical potential.
                            </p>

                            <Card className="border-l-4 border-l-primary bg-background">
                                <CardContent className="pt-6">
                                    <p className="font-serif text-xl italic text-balance">
                                        "My teaching philosophy centers on three pillars: discipline, creativity, and joy. I believe that
                                        mastery comes from consistent practice, but the journey should always be filled with the excitement
                                        of musical discovery."
                                    </p>
                                </CardContent>
                            </Card>
                        </div>
                    </div>
                </div>
            </section>

            {/* Studio Policy Section */}
            <section className="py-20">
                <div className="container mx-auto px-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="text-center space-y-4 mb-12">
                            <h2 className="font-serif text-4xl font-bold">The Studio System</h2>
                            <p className="text-xl text-muted-foreground">Flexible consistency for serious students</p>
                            <div className="h-1 w-20 bg-primary mx-auto" />
                        </div>

                        <div className="grid md:grid-cols-3 gap-6">
                            {/* Credit-Based System */}
                            <Card className="border-2 hover:border-primary transition-colors">
                                <CardContent className="pt-6 space-y-4">
                                    <div className="h-12 w-12 bg-primary rounded-lg flex items-center justify-center">
                                        <Calendar className="h-6 w-6 text-primary-foreground" />
                                    </div>
                                    <h3 className="font-serif text-xl font-bold">Credit-Based Packages</h3>
                                    <p className="text-muted-foreground leading-relaxed">
                                        Purchase 4-lesson packages that work with your schedule. No rigid monthly commitmentsâ€”just
                                        consistent progress at your pace.
                                    </p>
                                </CardContent>
                            </Card>

                            {/* Flexible Rescheduling */}
                            <Card className="border-2 hover:border-primary transition-colors">
                                <CardContent className="pt-6 space-y-4">
                                    <div className="h-12 w-12 bg-primary rounded-lg flex items-center justify-center">
                                        <Clock className="h-6 w-6 text-primary-foreground" />
                                    </div>
                                    <h3 className="font-serif text-xl font-bold">Fair Cancellation Policy</h3>
                                    <p className="text-muted-foreground leading-relaxed">
                                        Life happens. Reschedule with 24+ hours notice at no charge. We'll find you a makeup slot that works
                                        for your week.
                                    </p>
                                </CardContent>
                            </Card>

                            {/* Professional Accountability */}
                            <Card className="border-2 hover:border-primary transition-colors">
                                <CardContent className="pt-6 space-y-4">
                                    <div className="h-12 w-12 bg-primary rounded-lg flex items-center justify-center">
                                        <Award className="h-6 w-6 text-primary-foreground" />
                                    </div>
                                    <h3 className="font-serif text-xl font-bold">Professional Standards</h3>
                                    <p className="text-muted-foreground leading-relaxed">
                                        Clear expectations, detailed lesson notes, and recorded sessions ensure you get maximum value from
                                        every minute of instruction.
                                    </p>
                                </CardContent>
                            </Card>
                        </div>

                        <Card className="mt-8 bg-primary/5 border-primary/20">
                            <CardContent className="pt-6">
                                <p className="text-center text-lg">
                                    <strong className="font-serif">The Result?</strong> Students make faster progress because they can
                                    maintain weekly momentum without the stress of rigid scheduling. It's the perfect balance of structure
                                    and flexibility.
                                </p>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            </section>

            {/* Testimonials Section */}
            <section className="py-20 bg-muted/30">
                <div className="container mx-auto px-4">
                    <div className="max-w-5xl mx-auto">
                        <div className="text-center space-y-4 mb-12">
                            <h2 className="font-serif text-4xl font-bold">What Students Say</h2>
                            <div className="h-1 w-20 bg-primary mx-auto" />
                        </div>

                        <div className="grid md:grid-cols-3 gap-6">
                            <Card className="bg-background">
                                <CardContent className="pt-6 space-y-4">
                                    <div className="flex gap-1">
                                        {[...Array(5)].map((_, i) => (
                                            <Music key={i} className="h-4 w-4 fill-primary text-primary" />
                                        ))}
                                    </div>
                                    <p className="text-muted-foreground italic leading-relaxed">
                                        "The credit system is brilliant! I travel for work and this is the only studio that accommodates my
                                        schedule without penalty. My technique has improved more in 6 months here than 2 years elsewhere."
                                    </p>
                                    <div className="pt-4 border-t">
                                        <p className="font-semibold">Sarah M.</p>
                                        <p className="text-sm text-muted-foreground">Adult Student, 2 years</p>
                                    </div>
                                </CardContent>
                            </Card>

                            <Card className="bg-background">
                                <CardContent className="pt-6 space-y-4">
                                    <div className="flex gap-1">
                                        {[...Array(5)].map((_, i) => (
                                            <Music key={i} className="h-4 w-4 fill-primary text-primary" />
                                        ))}
                                    </div>
                                    <p className="text-muted-foreground italic leading-relaxed">
                                        "My daughter loves her lessons! The recorded sessions are invaluable for practice at home. The
                                        teacher strikes the perfect balance between challenging her and keeping it fun."
                                    </p>
                                    <div className="pt-4 border-t">
                                        <p className="font-semibold">Jennifer L.</p>
                                        <p className="text-sm text-muted-foreground">Parent of Student, 3 years</p>
                                    </div>
                                </CardContent>
                            </Card>

                            <Card className="bg-background">
                                <CardContent className="pt-6 space-y-4">
                                    <div className="flex gap-1">
                                        {[...Array(5)].map((_, i) => (
                                            <Music key={i} className="h-4 w-4 fill-primary text-primary" />
                                        ))}
                                    </div>
                                    <p className="text-muted-foreground italic leading-relaxed">
                                        "Professional, organized, and incredibly talented. The online portal with lesson notes and sheet
                                        music keeps everything in one place. This is how modern music education should work."
                                    </p>
                                    <div className="pt-4 border-t">
                                        <p className="font-semibold">David K.</p>
                                        <p className="text-sm text-muted-foreground">Advanced Student, 1 year</p>
                                    </div>
                                </CardContent>
                            </Card>
                        </div>
                    </div>
                </div>
            </section>

            {/* CTA Section */}
            <section className="py-20 border-t">
                <div className="container mx-auto px-4">
                    <div className="max-w-3xl mx-auto text-center space-y-8">
                        <h2 className="font-serif text-4xl font-bold text-balance">Ready to Begin Your Musical Journey?</h2>
                        <p className="text-xl text-muted-foreground text-pretty">
                            Limited openings available for serious students. Schedule a consultation to discuss your goals and find
                            the perfect lesson time.
                        </p>
                        <Button size="lg" className="text-base h-12 px-8" onClick={() => setShowInquiryModal(true)}>
                            Inquire for Lessons
                        </Button>

                        <InquiryModal open={showInquiryModal} onOpenChange={setShowInquiryModal} />
                    </div>
                </div>
            </section>

            {/* Footer */}
            <footer className="border-t bg-muted/30">
                <div className="container mx-auto px-4 py-12">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-6">
                        <div className="flex items-center gap-2">
                            <Music className="h-6 w-6" />
                            <span className="font-serif text-lg font-bold">Piano Studio</span>
                        </div>

                        <div className="flex gap-6">
                            <a
                                href="https://facebook.com"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-muted-foreground hover:text-foreground transition-colors"
                            >
                                <Facebook className="h-5 w-5" />
                                <span className="sr-only">Facebook</span>
                            </a>
                            <a
                                href="https://instagram.com"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-muted-foreground hover:text-foreground transition-colors"
                            >
                                <Instagram className="h-5 w-5" />
                                <span className="sr-only">Instagram</span>
                            </a>
                            <a
                                href="mailto:contact@pianostudio.com"
                                className="text-muted-foreground hover:text-foreground transition-colors"
                            >
                                <Mail className="h-5 w-5" />
                                <span className="sr-only">Email</span>
                            </a>
                        </div>

                        <p className="text-sm text-muted-foreground">Â© 2025 Piano Studio. All rights reserved.</p>
                    </div>
                </div>
            </footer>
        </div>
    )
}
</file>

<file path="lib/google-calendar.ts">
import { google } from 'googleapis'

const auth = new google.auth.JWT({
    email: process.env.GOOGLE_CLIENT_EMAIL,
    key: (process.env.GOOGLE_PRIVATE_KEY || '').replace(/\\n/g, '\n'), // Fixes newline issues in Vercel/Env
    scopes: ['https://www.googleapis.com/auth/calendar'],
})

const calendar = google.calendar({ version: 'v3', auth })

export async function createGoogleCalendarEvent(
    studentName: string,
    date: string, // YYYY-MM-DD
    time: string, // HH:MM
    durationMinutes: number
) {
    try {
        // 2. Format Dates for Google (ISO format)
        const startDateTime = `${date}T${time}:00`
        const startDate = new Date(startDateTime)
        const endDate = new Date(startDate.getTime() + durationMinutes * 60000)

        const event = {
            summary: `${studentName} - Piano Lesson`,
            description: `Lesson scheduled via Studio Portal.`,
            start: {
                dateTime: startDateTime,
                timeZone: 'America/Los_Angeles', // âš ï¸ Check this matches your studio's timezone
            },
            end: {
                dateTime: endDate.toISOString().replace('.000Z', ''),
                timeZone: 'America/Los_Angeles',
            },
            colorId: '11', // 11 = Red (Tomato)
        }

        // 3. Push to Google
        const response = await calendar.events.insert({
            calendarId: process.env.GOOGLE_CALENDAR_ID || 'primary',
            requestBody: event,
        })

        console.log('âœ… Google Event Created:', response.data.id)
        return response.data.id // We return this so we can save it to Supabase

    } catch (error) {
        console.error('âŒ Google Calendar Error:', error)
        return null // Return null so the app doesn't crash if Google fails
    }
}
</file>

<file path="repomix.config.json">
{
    "ignore": {
        "useGitignore": true,
        "useDefaultPatterns": true,
        "customPatterns": [
            "tsconfig.tsbuildinfo",
            "_backup/**",
            "piano_backup.sql",
            "pnpm-lock.yaml",
            "public/**",
            ".next/**",
            "node_modules/**",
            "_temp/**",
            ".DS_Store",
            ".cursorrules",
            "components/ui/**",
            "supabase/migrations/**",
            "supabase/.branches/**",
            "supabase/.temp/**",
            "supabase/snippets/**",
            "hooks/**",
            "lib/utils.ts",
            "repomix-output.xml",
            "components.json",
            "tailwind.config.ts",
            "postcss.config.mjs",
            "next.config.ts",
            "tsconfig.json"
        ]
    }
}
</file>

<file path="app/actions/inquiries.ts">
"use server"

import { createClient } from "@/lib/supabase/server"
import { Resend } from "resend"

const resend = new Resend(process.env.RESEND_API_KEY)

export async function submitInquiry(formData: FormData) {
    const supabase = await createClient()

    const name = formData.get("name") as string
    const email = formData.get("email") as string
    const phone = formData.get("phone") as string
    const experience = formData.get("experience") as string
    const goals = formData.get("goals") as string

    if (!name || !email || !experience || !goals) {
        return { success: false, error: "Missing required fields" }
    }

    // 1. Prepare the "System Note" (We can keep this for the human/AI context)
    const contextNotes = `
**Inquiry Source:** Website Form
**Phone:** ${phone || 'N/A'}
    `.trim() // Combined for AI context

    try {
        // 2. Create the Student (Lead)
        const { data: student, error: dbError } = await supabase
            .from("crm_students")
            .insert({
                full_name: name,
                email: email,
                // user snippet did not have phone column, it is in notes
                notes: contextNotes,
                status: 'Lead',
                tags: ['Website Inquiry'],
                country_code: 'US',
                // --- NEW: Save to the dedicated column ---
                experience_level: experience
            })
            .select()
            .single()

        if (dbError || !student) {
            console.error("Database error:", dbError)
            return { success: false, error: "Failed to save inquiry" }
        }

        // 3. Post the "Musical Goals" as the First Message (Visible in Chat)
        // This ensures your CRM sees a "message" to reply to!
        const { error: messageError } = await supabase
            .from('crm_messages')
            .insert({
                student_id: student.id,
                sender_role: 'student',
                body_text: goals, // "Hello, I'm trying to learn..."
                created_at: new Date().toISOString()
            })

        if (messageError) {
            console.error('Message Creation Error:', messageError)
            // We don't fail the whole request since the student was created
        }

        // 2. Get Admin Email (from profiles where role=admin)
        // We'll fallback to a default if not found
        const { data: admin } = await supabase
            .from("profiles")
            .select("email, studio_name, name")
            .eq("role", "admin")
            .limit(1)
            .single()

        const adminEmail = admin?.email || "lionel@musicalbasics.com" // Fallback to a safe email or env var
        const studioName = admin?.studio_name || "Lionel Yu Piano Studio"

        // 3. Send Email Notification to Admin
        await resend.emails.send({
            from: 'Piano Studio Inquiries <system@updates.musicalbasics.com>',
            to: adminEmail,
            subject: `New Lesson Inquiry: ${name}`,
            html: `
                <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
                    <h2>New Student Inquiry</h2>
                    <p>You have received a new inquiry from your website.</p>
                    
                    <div style="background-color: #f4f4f4; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p><strong>Name:</strong> ${name}</p>
                        <p><strong>Email:</strong> <a href="mailto:${email}">${email}</a></p>
                        <p><strong>Phone:</strong> ${phone || "Not provided"}</p>
                        <p><strong>Experience:</strong> ${experience}</p>
                        <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">
                        <p><strong>Goals:</strong></p>
                        <p style="white-space: pre-wrap;">${goals}</p>
                    </div>

                    <p>
                        <a href="${process.env.NEXT_PUBLIC_APP_URL}/admin/inquiries" style="background-color: #3b82f6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">
                            View in Dashboard
                        </a>
                    </p>
                </div>
            `
        })

        // 4. Send Confirmation Email to Student (Optional - typically good practice)
        // For now, we skip to keep it simple as requested, but we could add it easily.

        return { success: true }

    } catch (error) {
        console.error("Inquiry submission error:", error)
        return { success: false, error: "Failed to submit inquiry" }
    }
}

export async function getInquiries() {
    const supabase = await createClient()

    const { data: inquiries, error } = await supabase
        .from("inquiries")
        .select("*")
        .order("created_at", { ascending: false })

    if (error) {
        console.error("Error fetching inquiries:", error)
        return { inquiries: [] }
    }

    return { inquiries }
}

export async function updateInquiryStatus(id: string, status: 'new' | 'contacted' | 'student' | 'archived') {
    const supabase = await createClient()

    try {
        const { error } = await supabase
            .from("inquiries")
            .update({ status })
            .eq("id", id)

        if (error) throw error

        return { success: true }
    } catch (error) {
        console.error("Error updating inquiry status:", error)
        return { success: false, error: "Failed to update status" }
    }
}
</file>

<file path="app/actions/pricing.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'

export type PricingPoint = {
    id: string
    plan_id: string
    label: string
    price: number
    credits: number
    type: 'one_time' | 'subscription'
    stripe_price_id?: string | null
    description?: string | null
}

export type PricingPlan = {
    id: string
    name: string
    description?: string | null
    points?: PricingPoint[]
}

/**
 * Get all pricing plans with their points (Admin)
 */
export async function getPricingPlans() {
    const supabase = await createClient()

    // Check admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    const { data: plans, error } = await supabase
        .from('pricing_plans')
        .select(`
            *,
            points:pricing_points(*)
        `)
        .order('name')

    if (error) return { error: error.message }
    return { plans }
}

/**
 * Get the specific pricing plan assigned to the current user
 */
export async function getStudentPricingPlan() {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) return { plan: null }

    // 1. Get student's assigned plan ID
    const { data: profile } = await supabase
        .from('profiles')
        .select('pricing_plan_id')
        .eq('id', user.id)
        .single()

    if (!profile?.pricing_plan_id) {
        // Fallback: If no plan assigned, fetch the first one or return null
        const { data: defaultPlan } = await supabase
            .from('pricing_plans')
            .select(`*, points:pricing_points(*)`)
            .limit(1)
            .single()

        // Sort points for default plan too
        if (defaultPlan && defaultPlan.points) {
            defaultPlan.points.sort((a: any, b: any) => {
                if (a.type === 'subscription' && b.type !== 'subscription') return -1;
                if (a.type !== 'subscription' && b.type === 'subscription') return 1;
                return a.price - b.price;
            })
        }
        return { plan: defaultPlan }
    }

    // 2. Fetch the plan details
    const { data: plan } = await supabase
        .from('pricing_plans')
        .select(`
            *,
            points:pricing_points(*)
        `)
        .eq('id', profile.pricing_plan_id)
        .single()

    // Sort points: subscriptions first, then by price
    if (plan && plan.points) {
        plan.points.sort((a: any, b: any) => {
            if (a.type === 'subscription' && b.type !== 'subscription') return -1;
            if (a.type !== 'subscription' && b.type === 'subscription') return 1;
            return a.price - b.price;
        })
    }

    return { plan }
}

/**
 * Admin: Create a new Plan
 */
export async function createPricingPlan(name: string, description?: string) {
    const supabase = await createClient()

    // Check Admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    // In a real app we'd verify admin role here

    const { data, error } = await supabase
        .from('pricing_plans')
        .insert({ name, description })
        .select()
        .single()

    revalidatePath('/admin')
    return { success: !error, error: error?.message, plan: data }
}

/**
 * Admin: Add a Pricing Point to a Plan
 */
export async function createPricingPoint(point: Omit<PricingPoint, 'id'>) {
    const supabase = await createClient()

    const { error } = await supabase
        .from('pricing_points')
        .insert(point)

    revalidatePath('/admin')
    revalidatePath('/student')
    return { success: !error, error: error?.message }
}

/**
 * Admin: Delete a Pricing Point
 */
export async function deletePricingPoint(id: string) {
    const supabase = await createClient()
    const { error } = await supabase.from('pricing_points').delete().eq('id', id)
    revalidatePath('/admin')
    return { success: !error, error: error?.message }
}

/**
 * Admin: Update a Pricing Point
 */
export async function updatePricingPoint(id: string, updates: Partial<PricingPoint>) {
    const supabase = await createClient()

    // Exclude id and plan_id from updates if present (though Partial allows them, good practice to be safe)
    const { id: _, plan_id: __, ...cleanUpdates } = updates as any

    const { error } = await supabase
        .from('pricing_points')
        .update(cleanUpdates)
        .eq('id', id)

    revalidatePath('/admin')
    revalidatePath('/student')
    revalidatePath('/student')
    return { success: !error, error: error?.message }
}



/**
 * Admin: Update a Pricing Plan
 */
export async function updatePricingPlan(id: string, name: string) {
    const supabase = await createClient()

    const { error } = await supabase
        .from('pricing_plans')
        .update({ name })
        .eq('id', id)

    revalidatePath('/admin')
    return { success: !error, error: error?.message }
}

/**
 * Admin: Delete a Pricing Plan
 */
export async function deletePricingPlan(id: string) {
    const supabase = await createClient()

    // Assuming ON DELETE CASCADE is set up in the database for related pricing points
    // If not, we should delete points first manually
    const { error } = await supabase.from('pricing_plans').delete().eq('id', id)

    revalidatePath('/admin')
    return { success: !error, error: error?.message }
}
</file>

<file path="app/api/webhooks/lesson-recording/route.ts">
import { NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'

export async function POST(req: Request) {
    // 1. Initialize "God Mode" Client â€” bypasses all RLS policies
    const supabase = createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    )

    const secret = req.headers.get('x-webhook-secret')

    if (secret !== process.env.PIANO_STUDIO_SECRET) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { studentId, recordingUrl } = await req.json()

    console.log(`[Webhook] Searching for lesson for student: ${studentId}`)

    // 2. Find the lesson â€” filter to yesterday+ so we don't match stale old lessons
    const yesterday = new Date()
    yesterday.setDate(yesterday.getDate() - 1)

    const { data: lesson, error } = await supabase
        .from('lessons')
        .select('id, date, time')
        .eq('student_id', studentId)
        .in('status', ['scheduled', 'logging'])
        .gte('date', yesterday.toISOString().split('T')[0])
        .order('date', { ascending: true })
        .order('time', { ascending: true })
        .limit(1)
        .single()

    if (error) {
        console.error('[Webhook] Database error:', error)
        return NextResponse.json({ error: error.message }, { status: 500 })
    }

    if (lesson) {
        console.log(`[Webhook] Found lesson ${lesson.id} on ${lesson.date}. Attaching video...`)

        // 3. Update the Video URL
        const { error: updateError } = await supabase
            .from('lessons')
            .update({
                video_url: recordingUrl
            })
            .eq('id', lesson.id)

        if (updateError) {
            console.error('[Webhook] Update failed:', updateError)
            return NextResponse.json({ error: 'Update failed' }, { status: 500 })
        }

        return NextResponse.json({ success: true, lessonId: lesson.id })
    } else {
        console.log('[Webhook] No matching scheduled lesson found.')
        return NextResponse.json({ message: 'No lesson found' }, { status: 200 })
    }
}
</file>

<file path="app/contact/page.tsx">
"use client"

import { InquiryForm } from "@/components/inquiry-form"
import { useState } from "react"
import { CheckCircle2, Music, Mail, Phone, MapPin } from "lucide-react"

export default function ContactPage() {
    const [isSuccess, setIsSuccess] = useState(false)

    return (
        <div className="min-h-screen bg-background">
            <div className="container mx-auto px-4 py-12 md:py-20 lg:py-24">
                <div className="max-w-5xl mx-auto grid md:grid-cols-2 gap-12 lg:gap-20 items-start">

                    {/* Left Column: Contact Info & Branding */}
                    <div className="space-y-8">
                        <div>
                            <h1 className="text-4xl md:text-5xl font-serif font-bold tracking-tight mb-4">
                                Get in Touch
                            </h1>
                            <p className="text-xl text-muted-foreground leading-relaxed">
                                Ready to start your musical journey? I'd love to hear from you. Fill out the form or reach out directly.
                            </p>
                        </div>

                        <div className="space-y-6">
                            <div className="flex items-center gap-4">
                                <div className="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                    <Mail className="h-5 w-5" />
                                </div>
                                <div>
                                    <p className="font-medium">Email</p>
                                    <p className="text-muted-foreground">support@musicalbasics.com</p>
                                </div>
                            </div>

                            <div className="flex items-start gap-4">
                                <div className="p-3 bg-secondary rounded-lg">
                                    <Music className="w-6 h-6" />
                                </div>
                                <div>
                                    <p className="font-medium">Studio</p>
                                    <p className="text-muted-foreground">Lionel Yu Piano Studio</p>
                                </div>
                            </div>
                        </div>

                        {/* Philosophy Card */}
                        <div className="bg-card border rounded-xl p-8 shadow-sm">
                            <h3 className="font-serif font-semibold text-xl mb-4">Teaching Philosophy</h3>
                            <p className="text-muted-foreground leading-relaxed">
                                "My teaching philosophy centers on three pillars: discipline, creativity, and joy. I believe that mastery comes from consistent practice, but the journey should always be filled with the excitement of musical discovery."
                            </p>
                        </div>
                    </div>

                    {/* Right Column: Inquiry Form */}
                    <div className="bg-card border rounded-xl shadow-sm p-6 md:p-8">
                        {isSuccess ? (
                            <div className="flex flex-col items-center justify-center py-20 text-center space-y-6">
                                <div className="h-20 w-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center animate-in fade-in zoom-in duration-300">
                                    <CheckCircle2 className="h-10 w-10" />
                                </div>
                                <div className="space-y-2">
                                    <h2 className="text-2xl font-serif font-semibold">Inquiry Sent!</h2>
                                    <p className="text-muted-foreground max-w-xs mx-auto">
                                        Thank you for reaching out. We have received your details and will get back to you within 24 hours.
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <InquiryForm
                                onSuccess={() => setIsSuccess(true)}
                                className="space-y-6"
                            />
                        )}
                    </div>

                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/admin/dashboard-tab.tsx">
"use client"

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Calendar, Clock, Music, Video, Upload, XCircle, Bell, MessageCircle, MonitorPlay } from "lucide-react"
import type { TodayLesson, LessonWithStudent } from "@/types/admin"

const CLASSROOM_URL = process.env.NEXT_PUBLIC_CLASSROOM_URL || "https://classroom.musicalbasics.com"

interface DashboardTabProps {
    lessons: TodayLesson[]
    adminZoomLink?: string | null
    onLog: (lesson: TodayLesson) => void
    onReschedule: (lesson: LessonWithStudent) => void
    onNoShow: (lesson: TodayLesson) => void
    onCancel: (lessonId: string, studentName: string) => void
    onRemind: (lesson: TodayLesson) => void
    onMessage: (studentId: string) => void
    isLoading?: boolean
}

export function DashboardTab({
    lessons,
    adminZoomLink,
    onLog,
    onReschedule,
    onNoShow,
    onCancel,
    onRemind,
    onMessage,
    isLoading = false
}: DashboardTabProps) {

    const getClassroomLink = (studentId: string, name?: string | null, email?: string | null) => {
        const params = new URLSearchParams({
            email: email || "",
            name: name || "",
        })
        return `${CLASSROOM_URL}/start/${studentId}?${params.toString()}`
    }

    // Helper functions
    const formatTime = (timeStr: string) => {
        const [hours, minutes] = timeStr.split(':').map(Number)
        const ampm = hours >= 12 ? 'PM' : 'AM'
        const displayHours = hours % 12 || 12
        return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`
    }

    const today = new Date()
    const formattedDate = today.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    })

    return (
        <Card>
            <CardHeader>
                <div className="flex items-center justify-between">
                    <div>
                        <CardTitle className="text-2xl font-serif">Today's Schedule</CardTitle>
                        <CardDescription className="flex items-center gap-2 mt-1">
                            <Calendar className="h-4 w-4" />
                            {formattedDate}
                        </CardDescription>
                    </div>
                    <Badge variant="secondary" className="text-base px-4 py-2">
                        {lessons.length} Lessons
                    </Badge>
                </div>
            </CardHeader>
            <CardContent>
                <div className="space-y-4">
                    {lessons.length === 0 ? (
                        <p className="text-center text-muted-foreground py-8">No lessons scheduled for today</p>
                    ) : (
                        lessons.map((lesson) => (
                            <Card key={lesson.id} className="border-2">
                                <CardContent className="flex items-center justify-between p-6">
                                    <div className="flex items-center gap-4">
                                        <div className="flex flex-col items-center justify-center h-14 w-14 bg-primary text-primary-foreground rounded-lg">
                                            <span className="text-xs font-medium">
                                                {formatTime(lesson.time).split(' ')[0]}
                                            </span>
                                            <span className="text-xs">{formatTime(lesson.time).split(' ')[1]}</span>
                                        </div>
                                        <div>
                                            <h3 className="font-semibold text-lg">{lesson.student.name || 'Student'}</h3>
                                            <div className="flex items-center gap-4 text-sm text-muted-foreground mt-1">
                                                <div className="flex items-center gap-1">
                                                    <Clock className="h-3 w-3" />
                                                    <span>{lesson.duration || 60} min</span>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <Music className="h-3 w-3" />
                                                    <span>{lesson.student.credits} credits left</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 flex-wrap justify-end max-w-[50%]">
                                        {(lesson.zoom_link || lesson.student.zoom_link || adminZoomLink) && (
                                            <Button
                                                size="sm"
                                                className="bg-blue-600 hover:bg-blue-700"
                                                asChild
                                            >
                                                <a
                                                    href={lesson.zoom_link || lesson.student.zoom_link || adminZoomLink || '#'}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    <Video className="h-4 w-4 mr-1" />
                                                    Zoom
                                                </a>
                                            </Button>
                                        )}
                                        <Button
                                            size="sm"
                                            className="bg-indigo-600 hover:bg-indigo-700 text-white border-0"
                                            onClick={() => window.open(getClassroomLink(lesson.student.id, lesson.student.name, lesson.student.email), '_blank')}
                                            title="Open Teacher Interface"
                                        >
                                            <MonitorPlay className="h-4 w-4 mr-1" />
                                            Room
                                        </Button>
                                        <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => onMessage(lesson.student.id)}
                                            disabled={isLoading}
                                        >
                                            <MessageCircle className="h-4 w-4 mr-1" />
                                            Message
                                        </Button>
                                        <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => onRemind(lesson)}
                                            disabled={isLoading}
                                        >
                                            <Bell className="h-4 w-4 mr-1" />
                                            Remind
                                        </Button>
                                        <Button
                                            size="sm"
                                            onClick={() => onLog(lesson)}
                                            disabled={isLoading}
                                        >
                                            <Upload className="h-4 w-4 mr-1" />
                                            Log
                                        </Button>
                                        <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => onReschedule(({ ...lesson, student_id: lesson.student.id } as any))}
                                            disabled={isLoading}
                                        >
                                            <Calendar className="h-4 w-4 mr-1" />
                                            Resched
                                        </Button>
                                        <Button
                                            size="sm"
                                            variant="destructive"
                                            onClick={() => onNoShow(lesson)}
                                            disabled={isLoading}
                                        >
                                            <XCircle className="h-4 w-4 mr-1" />
                                            No-Show
                                        </Button>
                                        <Button
                                            size="sm"
                                            variant="secondary"
                                            className="text-destructive hover:text-destructive"
                                            onClick={() => onCancel(lesson.id, lesson.student.name || 'Student')}
                                            disabled={isLoading}
                                        >
                                            Cancel
                                        </Button>
                                    </div>
                                </CardContent>
                            </Card>
                        ))
                    )}
                </div>
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/inquiry-modal.tsx">
"use client"

import { useState } from "react"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { CheckCircle2 } from "lucide-react"
import { Button } from "@/components/ui/button"
import { InquiryForm } from "./inquiry-form"

interface InquiryModalProps {
    open: boolean
    onOpenChange: (open: boolean) => void
}

export function InquiryModal({ open, onOpenChange }: InquiryModalProps) {
    const [isSuccess, setIsSuccess] = useState(false)

    const handleSuccess = () => {
        setIsSuccess(true)
    }

    const handleClose = () => {
        onOpenChange(false)
        // Reset state after transition
        setTimeout(() => {
            setIsSuccess(false)
        }, 300)
    }

    return (
        <Dialog open={open} onOpenChange={handleClose}>
            {/* CRITICAL FIX: 
               We removed 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2' 
               from the className below. The Dialog primitive handles this now.
            */}
            <DialogContent className="sm:max-w-[500px]">
                {isSuccess ? (
                    <div className="flex flex-col items-center justify-center py-10 text-center space-y-4">
                        <div className="h-16 w-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-2">
                            <CheckCircle2 className="h-8 w-8" />
                        </div>
                        <DialogTitle className="text-2xl font-serif">Inquiry Sent!</DialogTitle>
                        <DialogDescription className="text-base max-w-xs mx-auto">
                            Thank you for your interest. We have received your details and will contact you shortly to schedule a consultation.
                        </DialogDescription>
                        <Button className="mt-4" onClick={handleClose}>
                            Close
                        </Button>
                    </div>
                ) : (
                    <>
                        <DialogHeader>
                            <DialogTitle className="text-2xl font-serif">Inquire for Lessons</DialogTitle>
                            <DialogDescription>
                                Tell us about your musical goals. We'll get back to you within 24 hours.
                            </DialogDescription>
                        </DialogHeader>

                        <InquiryForm onSuccess={handleSuccess} className="py-2" />
                    </>
                )}
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="types/admin.ts">
import type { Profile, Lesson } from "@/lib/supabase/database.types"

// Extends Lesson type to safely handle zoom_link until types are regenerated
export type LessonWithZoom = Lesson & { zoom_link?: string | null }

export type LessonWithStudent = LessonWithZoom & {
    student: Profile
}

export type TodayLesson = LessonWithZoom & {
    student: Profile
}

export type StudentRoster = Profile & {
    last_lesson_date?: string
    lesson_day?: string | null
    lesson_time?: string | null
    balance_due?: number
}

export type Inquiry = {
    id: string
    name: string
    email: string
    phone: string | null
    experience: string
    goals: string
    status: 'new' | 'contacted' | 'student' | 'archived'
    created_at: string
}
</file>

<file path="app/admin/page.tsx">
import { redirect } from "next/navigation"
import { createClient } from "@/lib/supabase/server"
import { AdminDashboard } from "@/components/admin/admin-dashboard"
import type { TodayLesson, StudentRoster, LessonWithStudent } from "@/components/admin/admin-dashboard"
import { getInquiries } from "@/app/actions/inquiries"
import { getResources } from "@/app/actions/resources"

export default async function AdminPage() {
  const supabase = await createClient()

  // Check authentication
  const { data: { user }, error: authError } = await supabase.auth.getUser()

  if (authError || !user) {
    redirect("/login")
  }

  // Fetch admin profile and verify role
  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .single()

  if (profileError || !profile) {
    console.error("Profile fetch error:", profileError)
    redirect("/login")
  }

  // Role check: Only admins can access this page
  if (profile.role !== 'admin') {
    redirect("/student")
  }

  // Fetch scheduled lessons (future, including today and recent past to account for timezone)
  // We fetch starting from 7 days ago to cover any timezone offsets and ensuring "Today" is always included.

  const pastDate = new Date()
  pastDate.setDate(pastDate.getDate() - 7)
  const queryDate = pastDate.toISOString().split('T')[0]

  const { data: scheduledLessonsRaw } = await supabase
    .from("lessons")
    .select(`
            *,
            student:profiles!lessons_student_id_fkey(*)
        `)
    .eq("status", "scheduled")
    .gte("date", queryDate)
    .order("date", { ascending: true })
    .order("time", { ascending: true })

  const scheduledLessons: LessonWithStudent[] = (scheduledLessonsRaw || []).map(lesson => ({
    ...lesson,
    student: lesson.student
  }))

  // Fetch all completed lessons
  const { data: completedLessonsRaw } = await supabase
    .from("lessons")
    .select(`
            *,
            student:profiles!lessons_student_id_fkey(*)
        `)
    .eq("status", "completed")
    .order("date", { ascending: false })
    .order("time", { ascending: false })
    .limit(50)

  const completedLessons: LessonWithStudent[] = (completedLessonsRaw || []).map(lesson => ({
    ...lesson,
    student: lesson.student
  }))

  // Fetch all students (profiles with role = 'student')
  const { data: studentsRaw, error: studentsError } = await supabase
    .from("profiles")
    .select("*")
    .eq("role", "student")
    .order("name", { ascending: true })

  if (studentsError) {
    console.error("Students fetch error:", studentsError)
  }

  const students: StudentRoster[] = studentsRaw || []

  // Sort students by lesson_day (Sunday -> Saturday, then others)
  const dayOrder: Record<string, number> = {
    'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
    'Thursday': 4, 'Friday': 5, 'Saturday': 6
  }

  students.sort((a, b) => {
    const dayA = a.lesson_day ? dayOrder[a.lesson_day] : 99
    const dayB = b.lesson_day ? dayOrder[b.lesson_day] : 99

    if (dayA !== dayB) {
      return dayA - dayB
    }
    // Secondary sort by name
    return (a.name || '').localeCompare(b.name || '')
  })

  // Count unread messages (messages where admin is recipient and is_read is false)
  const totalUnread = 0

  // Fetch Inquiries
  const { inquiries } = await getInquiries()

  // Fetch Resources for the library selector
  const { resources } = await getResources()

  // Fetch Pricing Plans
  const { getPricingPlans } = await import("@/app/actions/pricing")
  const { plans: pricingPlans } = await getPricingPlans()

  return (
    <AdminDashboard
      admin={profile}
      scheduledLessons={scheduledLessons}
      completedLessons={completedLessons}
      students={students}
      totalUnread={totalUnread}
      inquiries={inquiries || []}
      resources={resources || []}
      pricingPlans={pricingPlans || []}
    />
  )
}
</file>

<file path="app/messages/actions.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'
import type { Message, MessageAttachment } from '@/lib/supabase/database.types'
import { Resend } from 'resend'
import { MessageNotification } from '@/components/emails/message-notification'
import { createClient as createSupabaseClient } from '@supabase/supabase-js'

// Initialize Resend (will be undefined if no API key)
const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null

// Allowed file types and size limits for chat attachments
const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
const ALLOWED_FILE_TYPES = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB
const MAX_ATTACHMENTS_PER_MESSAGE = 5

export type MessageWithProfile = Message & {
    sender_profile?: {
        name: string | null
        role: string
    }
}

/**
 * Send a message from the current user to another user
 * @param recipientId - The ID of the message recipient
 * @param content - The text content of the message
 * @param attachments - Optional array of attachments (images/files)
 */
export async function sendMessage(recipientId: string, content: string, attachments?: MessageAttachment[]) {
    const supabase = await createClient()

    // Get current user
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    // Validate attachments count
    if (attachments && attachments.length > MAX_ATTACHMENTS_PER_MESSAGE) {
        return { error: `Maximum ${MAX_ATTACHMENTS_PER_MESSAGE} attachments allowed per message` }
    }

    // Insert the message
    const { data, error } = await supabase
        .from('messages')
        .insert({
            sender_id: user.id,
            recipient_id: recipientId,
            content,
            is_read: false,
            attachments: attachments && attachments.length > 0 ? attachments : null
        })
        .select()
        .single()

    if (error) {
        console.error('Send message error:', error)
        return { error: error.message }
    }

    // Send email notification (non-blocking, with error handling)
    if (resend) {
        try {
            // Get sender's profile (current user)
            const { data: senderProfile } = await supabase
                .from('profiles')
                .select('name')
                .eq('id', user.id)
                .single()

            // Get recipient's profile
            const { data: recipientProfile } = await supabase
                .from('profiles')
                .select('name, email')
                .eq('id', recipientId)
                .single()

            if (recipientProfile?.email) {
                const rawSender = senderProfile?.name || 'Lionel Yu Piano Studio'
                const finalSenderName = rawSender === 'Professor Lionel' ? 'Professor Lionel Yu' : rawSender

                await resend.emails.send({
                    from: 'Lionel Yu Piano Studio <notifications@updates.musicalbasics.com>',
                    to: recipientProfile.email,
                    subject: `New message from ${finalSenderName}`,
                    react: MessageNotification({
                        senderName: finalSenderName,
                        messageContent: content.length > 200 ? content.substring(0, 200) + '...' : content,
                        recipientName: recipientProfile.name || 'Student',
                    }),
                })
                console.log('Email notification sent to:', recipientProfile.email)
            }
        } catch (emailError) {
            // Log error but don't block the message from being sent
            console.error('Failed to send email notification:', emailError)
        }
    }

    revalidatePath('/student')
    revalidatePath('/admin')

    return { success: true, message: data }
}

/**
 * Get messages between the current user and another user (conversation)
 */
export async function getConversation(partnerId: string): Promise<{ messages: Message[], error?: string }> {
    const supabase = await createClient()

    // Get current user
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { messages: [], error: 'Unauthorized' }
    }

    // Get all messages between these two users
    const { data, error } = await supabase
        .from('messages')
        .select('*')
        .or(`and(sender_id.eq.${user.id},recipient_id.eq.${partnerId}),and(sender_id.eq.${partnerId},recipient_id.eq.${user.id})`)
        .order('created_at', { ascending: true })

    if (error) {
        console.error('Get conversation error:', error)
        return { messages: [], error: error.message }
    }

    return { messages: data || [] }
}

/**
 * Mark messages from a sender as read
 */
export async function markMessagesAsRead(senderId: string) {
    const supabase = await createClient()

    // Get current user
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    // Update all unread messages from this sender to the current user
    const { error } = await supabase
        .from('messages')
        .update({ is_read: true })
        .eq('sender_id', senderId)
        .eq('recipient_id', user.id)
        .eq('is_read', false)

    if (error) {
        console.error('Mark as read error:', error)
        return { error: error.message }
    }

    revalidatePath('/student')
    revalidatePath('/admin')

    return { success: true }
}

/**
 * Get admin user's profile (for students to message)
 */
export async function getAdminProfile() {
    const supabase = await createClient()

    const { data, error } = await supabase
        .from('profiles')
        .select('id, name, email')
        .eq('role', 'admin')
        .order('created_at', { ascending: false })
        .limit(1)
        .single()

    if (error) {
        console.error('Get admin error:', error)
        return { admin: null }
    }

    return { admin: data }
}

/**
 * Get all students with their latest message (for admin chat sidebar)
 */
export async function getStudentsWithMessages() {
    const supabase = await createClient()

    // Get current user (admin)
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { students: [] }
    }

    // Get all student profiles
    const { data: students, error: studentsError } = await supabase
        .from('profiles')
        .select('*')
        .eq('role', 'student')
        .order('name')

    if (studentsError || !students) {
        return { students: [] }
    }

    // For each student, get their last message and unread count
    const studentsWithMessages = await Promise.all(
        students.map(async (student) => {
            // Get last message in conversation
            const { data: lastMessage } = await supabase
                .from('messages')
                .select('*')
                .or(`and(sender_id.eq.${user.id},recipient_id.eq.${student.id}),and(sender_id.eq.${student.id},recipient_id.eq.${user.id})`)
                .order('created_at', { ascending: false })
                .limit(1)
                .single()

            // Count unread messages from student to admin
            const { count: unreadCount } = await supabase
                .from('messages')
                .select('*', { count: 'exact', head: true })
                .eq('sender_id', student.id)
                .eq('recipient_id', user.id)
                .eq('is_read', false)

            return {
                ...student,
                lastMessage: lastMessage || null,
                unreadCount: unreadCount || 0
            }
        })
    )

    return { students: studentsWithMessages }
}

/**
 * Get unread message count for a user
 */
export async function getUnreadCount(): Promise<number> {
    const supabase = await createClient()

    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return 0
    }

    const { count } = await supabase
        .from('messages')
        .select('*', { count: 'exact', head: true })
        .eq('recipient_id', user.id)
        .eq('is_read', false)

    return count || 0
}

/**
 * Upload a file attachment for chat messages
 * Both students and admins can upload attachments
 */
export async function uploadChatAttachment(formData: FormData): Promise<{ attachment?: MessageAttachment; error?: string }> {
    const supabase = await createClient()

    // Get current user (both students and admins can upload)
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const file = formData.get('file') as File
    if (!file) {
        return { error: 'No file provided' }
    }

    // Validate file size
    if (file.size > MAX_FILE_SIZE) {
        return { error: `File size must be under ${MAX_FILE_SIZE / (1024 * 1024)}MB` }
    }

    // Determine file type category
    const isImage = ALLOWED_IMAGE_TYPES.includes(file.type)
    const isDocument = ALLOWED_FILE_TYPES.includes(file.type)

    if (!isImage && !isDocument) {
        return { error: 'Invalid file type. Allowed: images (JPEG, PNG, GIF, WebP) and documents (PDF, Word)' }
    }

    // Generate unique filename
    const timestamp = Date.now()
    const sanitizedName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_')
    const filePath = `chat-attachments/${user.id}/${timestamp}_${sanitizedName}`

    // Use Service Role Key to bypass RLS for storage
    const serviceKey = process.env.SUPABASE_SERVICE_KEY
    if (!serviceKey) {
        console.error('UPLOAD ERROR: SUPABASE_SERVICE_KEY is missing')
        return { error: 'Server configuration error: Missing service key' }
    }

    try {
        const supabaseAdmin = createSupabaseClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            serviceKey
        )

        console.log(`Attempting upload with service key for file: ${filePath}`)

        // Upload to Supabase Storage using Admin client
        const { data, error } = await supabaseAdmin.storage
            .from('lesson_materials')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false,
                contentType: file.type // Explicitly set content type
            })

        if (error) {
            console.error('Error uploading chat attachment (Supabase Error):', error)
            return { error: `Upload failed: ${error.message}` }
        }

        // Get public URL using Admin client
        const { data: { publicUrl } } = supabaseAdmin.storage
            .from('lesson_materials')
            .getPublicUrl(data.path)

        return {
            attachment: {
                type: isImage ? 'image' : 'file',
                url: publicUrl,
                name: file.name,
                size: file.size
            }
        }

    } catch (err: any) {
        console.error('Unexpected error during upload:', err)
        return { error: `Unexpected upload error: ${err.message || err}` }
    }
}
</file>

<file path="components/admin/admin-chat.tsx">
"use client"

import { useState, useRef, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Badge } from "@/components/ui/badge"
import { Send, Music, User, Search, Loader2, Paperclip, ArrowLeft, Folder } from "lucide-react"
import { sendMessage, getConversation, markMessagesAsRead, getStudentsWithMessages, uploadChatAttachment } from "@/app/messages/actions"
import type { Message, Profile, MessageAttachment } from "@/lib/supabase/database.types"
import { ChatAttachmentPreview, ChatPendingAttachments, type PendingAttachment } from "@/components/chat-attachment-preview"
import { LibraryFileSelector } from "@/components/admin/library-file-selector"

type StudentWithMessages = Profile & {
  lastMessage: Message | null
  unreadCount: number
}

interface AdminChatProps {
  initialStudentId?: string | null
  onClearInitialStudent?: () => void
}

export function AdminChat({ initialStudentId, onClearInitialStudent }: AdminChatProps) {
  const [students, setStudents] = useState<StudentWithMessages[]>([])
  const [selectedStudent, setSelectedStudent] = useState<StudentWithMessages | null>(null)
  const [messages, setMessages] = useState<Message[]>([])
  const [newMessage, setNewMessage] = useState("")
  const [searchQuery, setSearchQuery] = useState("")

  // Loading states
  const [isLoadingStudents, setIsLoadingStudents] = useState(true)
  const [isLoadingMessages, setIsLoadingMessages] = useState(false)
  const [isSending, setIsSending] = useState(false)

  // Attachment states - Modified to support both File objects and Library resources
  const [pendingAttachments, setPendingAttachments] = useState<PendingAttachment[]>([])
  const fileInputRef = useRef<HTMLInputElement>(null)

  const messagesEndRef = useRef<HTMLDivElement>(null)

  const scrollToBottom = () => {
    // Small timeout ensures DOM is updated before scrolling
    setTimeout(() => {
      messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
    }, 100)
  }

  // 1. Load students on mount
  useEffect(() => {
    async function loadStudents() {
      setIsLoadingStudents(true)
      try {
        const { students: studentData } = await getStudentsWithMessages()
        setStudents(studentData || [])
      } catch (error) {
        console.error("Failed to load students", error)
      } finally {
        setIsLoadingStudents(false)
      }
    }
    loadStudents()
  }, [])

  // Handle initialStudentId logic
  useEffect(() => {
    if (initialStudentId && students.length > 0) {
      const studentToSelect = students.find(s => s.id === initialStudentId)
      if (studentToSelect) {
        setSelectedStudent(studentToSelect)
        // Clear the initial ID from parent to prevent sticky state
        if (onClearInitialStudent) {
          onClearInitialStudent()
        }
      }
    }
  }, [initialStudentId, students, onClearInitialStudent])

  // 2. Load messages when student is selected
  useEffect(() => {
    if (!selectedStudent) return

    const studentId = selectedStudent.id

    async function loadMessages() {
      setIsLoadingMessages(true)
      try {
        const { messages: conversationMessages } = await getConversation(studentId)
        // CRITICAL FIX: Default to [] if null to prevent white screen crash
        setMessages(conversationMessages || [])
      } catch (error) {
        console.error("Failed to load conversation", error)
        setMessages([])
      } finally {
        setIsLoadingMessages(false)
        // Scroll to bottom after loading messages
        setTimeout(() => scrollToBottom(), 100)
      }

      // Mark as read in background
      await markMessagesAsRead(studentId)

      // Update local unread count immediately
      setStudents(prev => prev.map(s =>
        s.id === studentId ? { ...s, unreadCount: 0 } : s
      ))
    }

    loadMessages()
  }, [selectedStudent])

  // Removed auto-scroll useEffect triggered by polling

  // Poll for new messages
  useEffect(() => {
    if (!selectedStudent) return
    const interval = setInterval(async () => {
      const { messages: newMessages } = await getConversation(selectedStudent.id)
      if (newMessages) setMessages(newMessages)
    }, 5000)
    return () => clearInterval(interval)
  }, [selectedStudent])

  const handleSendMessage = async () => {
    if ((!newMessage.trim() && pendingAttachments.length === 0) || !selectedStudent) return

    const tempMessage = newMessage
    const tempAttachments = [...pendingAttachments]
    setNewMessage("")
    setPendingAttachments([])
    setIsSending(true)

    try {
      // Upload all pending attachments first
      const uploadedAttachments: MessageAttachment[] = []

      for (const pending of tempAttachments) {
        // Case 1: Library File (Already uploaded)
        if (pending.libraryFile) {
          uploadedAttachments.push({
            type: pending.libraryFile.type.includes('image') ? 'image' : 'file',
            url: pending.libraryFile.url,
            name: pending.libraryFile.name,
            size: pending.libraryFile.size
          })
          continue
        }

        // Case 2: New File Upload
        if (pending.file) {
          const formData = new FormData()
          formData.append('file', pending.file)
          const result = await uploadChatAttachment(formData)

          if (result.attachment) {
            uploadedAttachments.push(result.attachment)
          } else if (result.error) {
            console.error('Failed to upload attachment:', result.error)
            alert(`Failed to upload attachment: ${result.error}`)
            setIsSending(false)
            setNewMessage(tempMessage)
            setPendingAttachments(tempAttachments)
            return
          }
        }
      }

      // Send message with attachments
      const result = await sendMessage(
        selectedStudent.id,
        tempMessage.trim() || (uploadedAttachments.length > 0 ? 'ðŸ“Ž Attachment' : ''),
        uploadedAttachments.length > 0 ? uploadedAttachments : undefined
      )

      if (result.success && result.message) {
        setMessages(prev => [...prev, result.message!])
        setStudents(prev => prev.map(s =>
          s.id === selectedStudent.id
            ? { ...s, lastMessage: result.message! }
            : s
        ))
        // Scroll to newly sent message
        setTimeout(() => scrollToBottom(), 100)
      } else {
        setNewMessage(tempMessage)
        setPendingAttachments(tempAttachments)
        alert("Failed to send")
      }
    } catch (error) {
      console.error('Error sending message:', error)
      setNewMessage(tempMessage)
      setPendingAttachments(tempAttachments)
      alert("Failed to send message: " + (error instanceof Error ? error.message : "Unknown error"))
    } finally {
      setIsSending(false)
    }
  }

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files
    if (!files || files.length === 0) return

    const newAttachments: PendingAttachment[] = Array.from(files).map(file => {
      const isImage = file.type.startsWith('image/')
      return {
        id: Math.random().toString(36).substring(7),
        file,
        preview: isImage ? URL.createObjectURL(file) : undefined,
        uploading: false
      }
    })

    setPendingAttachments(prev => [...prev, ...newAttachments].slice(0, 5)) // Max 5

    // Reset input
    if (fileInputRef.current) {
      fileInputRef.current.value = ''
    }
  }

  const handleLibrarySelect = (file: { url: string; name: string; type: string; size: number }) => {
    // Check if ends with image extension or type includes image
    // Since we only get file_url sometimes, simple check
    const isImage = file.type.includes('image') || /\.(jpg|jpeg|png|gif|webp)$/i.test(file.url)

    const newAttachment: PendingAttachment = {
      id: Math.random().toString(36).substring(7),
      libraryFile: file,
      preview: isImage ? file.url : undefined, // Use URL directly for library images
      uploading: false
    }

    setPendingAttachments(prev => [...prev, newAttachment].slice(0, 5))
  }

  const handleRemoveAttachment = (index: number) => {
    setPendingAttachments(prev => {
      const attachment = prev[index]
      if (attachment?.preview) {
        URL.revokeObjectURL(attachment.preview)
      }
      return prev.filter((_, i) => i !== index)
    })
  }

  const filteredStudents = students.filter((student) =>
    (student.name || '').toLowerCase().includes(searchQuery.toLowerCase()),
  )
    .sort((a, b) => {
      // Get timestamps (default to 0 if no message exists)
      const timeA = a.lastMessage?.created_at ? new Date(a.lastMessage.created_at).getTime() : 0
      const timeB = b.lastMessage?.created_at ? new Date(b.lastMessage.created_at).getTime() : 0

      // Sort descending (newest first)
      return timeB - timeA
    })

  const totalUnread = students.reduce((acc, s) => acc + s.unreadCount, 0)
  const isFromAdmin = (message: Message) => selectedStudent ? message.sender_id !== selectedStudent.id : false

  // Format Date Logic
  const formatSidebarDate = (timestamp: string) => {
    const date = new Date(timestamp)
    const now = new Date()
    const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))

    if (diffDays === 0) {
      // Today: Show Time only
      return date.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" })
    } else if (diffDays === 1) {
      return "Yesterday"
    } else if (diffDays < 7) {
      // This week: Show Day Name (e.g., "Mon")
      return date.toLocaleDateString("en-US", { weekday: "short" })
    } else {
      // Older: Show Date (e.g., "Dec 12")
      return date.toLocaleDateString("en-US", { month: "short", day: "numeric" })
    }
  }

  const formatTimestamp = (timestamp: string) => {
    const date = new Date(timestamp)
    const now = new Date()
    const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))

    // Time options
    const timeOpts: Intl.DateTimeFormatOptions = { hour: "numeric", minute: "2-digit" }

    // Today: "3:45 PM"
    if (diffDays === 0) {
      return date.toLocaleTimeString("en-US", timeOpts)
    }

    // Yesterday: "Yesterday 3:45 PM"
    if (diffDays === 1) {
      return `Yesterday ${date.toLocaleTimeString("en-US", timeOpts)}`
    }

    // Older: "Dec 8, 3:45 PM"
    return `${date.toLocaleDateString("en-US", { month: "short", day: "numeric" })}, ${date.toLocaleTimeString("en-US", timeOpts)}`
  }

  return (
    // REPLACED <Card> with standard <div> to fix flex layout issues
    <div className="h-[600px] flex items-stretch overflow-hidden border rounded-xl bg-background shadow-sm">

      {/* LEFT SIDEBAR - Responsive visibility */}
      <div className={`
        flex-col border-r bg-muted/20 shrink-0 
        ${selectedStudent ? 'hidden md:flex' : 'flex w-full'} 
        md:w-[320px]
      `}>

        {/* Header */}
        <div className="p-4 border-b shrink-0 bg-background/50 backdrop-blur">
          <div className="flex items-center justify-between mb-3">
            <h3 className="font-serif font-semibold text-lg">Students</h3>
            {totalUnread > 0 && <Badge variant="destructive">{totalUnread} new</Badge>}
          </div>
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Search..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-9 h-9 bg-background"
            />
          </div>
        </div>

        {/* List - overflow-y-auto handles the scroll */}
        <div className="flex-1 overflow-y-auto p-2 space-y-1">
          {isLoadingStudents ? (
            <div className="flex justify-center py-8"><Loader2 className="h-6 w-6 animate-spin text-muted-foreground" /></div>
          ) : filteredStudents.length === 0 ? (
            <p className="text-center text-muted-foreground py-8 text-sm">No students found</p>
          ) : (
            filteredStudents.map((student) => (
              <button
                key={student.id}
                onClick={() => setSelectedStudent(student)}
                className={`w-full p-3 rounded-lg text-left transition-all flex items-start gap-3 border ${selectedStudent?.id === student.id
                  ? "bg-primary text-primary-foreground border-primary"
                  : "bg-transparent border-transparent hover:bg-muted"
                  }`}
              >
                <div className={`h-10 w-10 rounded-full flex items-center justify-center shrink-0 border ${selectedStudent?.id === student.id ? "bg-primary-foreground/20 border-transparent" : "bg-background border-border"
                  }`}>
                  <User className={selectedStudent?.id === student.id ? "text-primary-foreground" : "text-muted-foreground"} size={18} />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex justify-between items-center mb-0.5">
                    {/* Name and Badge Group */}
                    <div className="flex items-center gap-2 overflow-hidden">
                      <span className="font-medium truncate text-sm">
                        {student.name || 'Unknown'}
                      </span>
                      {student.unreadCount > 0 && selectedStudent?.id !== student.id && (
                        <Badge variant="destructive" className="h-5 px-1.5 text-[10px] rounded-full shrink-0">
                          {student.unreadCount}
                        </Badge>
                      )}
                    </div>

                    {/* Timestamp (New!) */}
                    {student.lastMessage && (
                      <span className="text-[10px] text-muted-foreground shrink-0 ml-2">
                        {formatSidebarDate(student.lastMessage.created_at)}
                      </span>
                    )}
                  </div>
                  <p className={`text-xs truncate mt-1 ${selectedStudent?.id === student.id ? "text-primary-foreground/80" : "text-muted-foreground"}`}>
                    {student.lastMessage?.content || "No messages"}
                  </p>
                </div>
              </button>
            ))
          )}
        </div>
      </div>

      {/* RIGHT CHAT AREA - Responsive visibility */}
      <div className={`
        flex-1 flex-col min-w-0 bg-background h-full 
        ${selectedStudent ? 'flex' : 'hidden md:flex'}
      `}>
        {selectedStudent ? (
          <>
            {/* Chat Header */}
            <div className="p-4 border-b flex items-center gap-3 shrink-0 bg-background/80 backdrop-blur z-10 h-[72px]">
              {/* Back Button for Mobile */}
              <Button
                variant="ghost"
                size="icon"
                className="md:hidden -ml-2"
                onClick={() => setSelectedStudent(null)}
              >
                <ArrowLeft className="h-5 w-5" />
              </Button>

              <div className="h-10 w-10 bg-primary/10 rounded-full flex items-center justify-center">
                <User className="h-5 w-5 text-primary" />
              </div>
              <div>
                <h3 className="font-serif font-semibold leading-none">{selectedStudent.name}</h3>
                <p className="text-xs text-muted-foreground mt-1">{selectedStudent.email}</p>
              </div>
            </div>

            {/* Messages List - This is the flexible scrolling area */}
            <div className="flex-1 overflow-y-auto p-4 bg-muted/5 space-y-6">
              {isLoadingMessages ? (
                <div className="h-full flex items-center justify-center">
                  <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                </div>
              ) : messages.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center text-muted-foreground opacity-50">
                  <Music className="h-12 w-12 mb-2" />
                  <p>No messages yet</p>
                  <p className="text-xs">Send a message to start the conversation.</p>
                </div>
              ) : (
                <>
                  {messages.map((msg) => (
                    <div key={msg.id} className={`flex ${isFromAdmin(msg) ? "justify-end" : "justify-start"}`}>
                      <div className={`max-w-[80%] px-4 py-2.5 rounded-2xl shadow-sm ${isFromAdmin(msg)
                        ? "bg-primary text-primary-foreground rounded-br-none"
                        : "bg-white border text-foreground rounded-bl-none"
                        }`}>
                        {/* The Message Text */}
                        {msg.content && msg.content !== 'ðŸ“Ž Attachment' && (
                          <p className="text-sm leading-relaxed">{msg.content}</p>
                        )}

                        {/* Attachments */}
                        {msg.attachments && msg.attachments.length > 0 && (
                          <ChatAttachmentPreview attachments={msg.attachments} compact />
                        )}

                        {/* The Timestamp - Right aligned, small, slightly transparent */}
                        <p className={`text-[10px] text-right mt-1 ${isFromAdmin(msg) ? "text-primary-foreground/70" : "text-muted-foreground"
                          }`}>
                          {formatTimestamp(msg.created_at)}
                        </p>
                      </div>
                    </div>
                  ))}
                  <div ref={messagesEndRef} />
                </>
              )}
            </div>

            {/* Input Area - Pinned to bottom */}
            <div className="border-t bg-background shrink-0">
              {/* Pending Attachments Preview */}
              {pendingAttachments.length > 0 && (
                <ChatPendingAttachments
                  attachments={pendingAttachments}
                  onRemove={handleRemoveAttachment}
                />
              )}

              <div className="p-4 flex gap-2 items-center">
                {/* Hidden File Input */}
                <input
                  type="file"
                  ref={fileInputRef}
                  onChange={handleFileSelect}
                  accept="image/*,.pdf,.doc,.docx"
                  multiple
                  className="hidden"
                />

                {/* Attachment Button */}
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => fileInputRef.current?.click()}
                  disabled={isSending || pendingAttachments.length >= 5}
                  title="Upload file"
                >
                  <Paperclip className="h-4 w-4" />
                </Button>

                {/* Library Button */}
                <LibraryFileSelector
                  onSelect={handleLibrarySelect}
                  trigger={
                    <Button
                      variant="ghost"
                      size="icon"
                      disabled={isSending || pendingAttachments.length >= 5}
                      title="Add from Library"
                    >
                      <Folder className="h-4 w-4" />
                    </Button>
                  }
                />

                <Input
                  value={newMessage}
                  onChange={e => setNewMessage(e.target.value)}
                  onKeyDown={e => e.key === "Enter" && !isSending && handleSendMessage()}
                  placeholder="Type a message..."
                  disabled={isSending}
                  className="flex-1"
                />
                <Button
                  onClick={handleSendMessage}
                  disabled={(!newMessage.trim() && pendingAttachments.length === 0) || isSending}
                  size="icon"
                >
                  {isSending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Send className="h-4 w-4" />}
                </Button>
              </div>
            </div>
          </>
        ) : (
          <div className="flex-1 flex flex-col items-center justify-center text-muted-foreground">
            <div className="h-20 w-20 bg-muted rounded-full flex items-center justify-center mb-4">
              <Music className="h-10 w-10 opacity-20" />
            </div>
            <p className="font-medium">Select a student</p>
            <p className="text-sm">Choose a conversation from the sidebar to start messaging.</p>
          </div>
        )}
      </div>
    </div>
  )
}
</file>

<file path="components/emails/LessonReminderEmail.tsx">
import {
    Body, Button, Container, Head, Heading, Html, Preview, Section, Text,
} from '@react-email/components'
import * as React from 'react'

interface LessonReminderEmailProps {
    studentName: string
    time: string
    zoomLink?: string | null
    classroomLink?: string | null
    variant: '24h' | '2h' | '15m' | 'exact'
    exactDuration?: string
}

export default function LessonReminderEmail({
    studentName,
    time,
    zoomLink,
    classroomLink,
    variant = '24h',
    exactDuration,
}: LessonReminderEmailProps) {
    const loginUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lessons.musicalbasics.com'

    // Dynamic Text based on the variant
    const content = {
        '24h': {
            subject: `Upcoming Lesson Tomorrow at ${time}`,
            heading: 'See you tomorrow! ðŸŽ¹',
            body: `Just a friendly reminder that you have a piano lesson scheduled for tomorrow at ${time}.`,
            btnText: 'View Schedule'
        },
        '2h': {
            subject: `Lesson in 2 Hours (${time})`,
            heading: 'Lesson starting soon',
            body: `Your piano lesson starts in about 2 hours. Now is a great time to warm up!`,
            btnText: 'View Portal'
        },
        '15m': {
            subject: `Join Now: Lesson starting at ${time}`,
            heading: 'Itâ€™s almost time! â°',
            body: `Your lesson is about to begin. Please verify your audio settings and click the link below to join.`,
            btnText: 'Join Zoom Meeting'
        },
        'exact': {
            subject: `Lesson Update: Starting in ${exactDuration}`,
            heading: 'Lesson Reminder ðŸŽ¹',
            body: `Just a quick note that your piano lesson is coming up in exactly ${exactDuration}.`,
            btnText: 'Join Zoom Meeting'
        }
    }

    const text = variant === 'exact' ? content['exact'] : content[variant]

    return (
        <Html>
            <Head />
            <Preview>{text.subject}</Preview>
            <Body style={main}>
                <Container style={container}>
                    <Heading style={heading}>{text.heading}</Heading>
                    <Section style={section}>
                        <Text style={greeting}>Hi {studentName},</Text>
                        <Text style={bodyText}>
                            {text.body}
                        </Text>

                        {/* Only show Zoom link prominently for the 15m warning */}
                        {variant === '15m' && zoomLink ? (
                            <Button style={joinButton} href={zoomLink}>
                                {text.btnText}
                            </Button>
                        ) : (
                            <>
                                <Button style={button} href={`${loginUrl}/login`}>
                                    {text.btnText}
                                </Button>
                                {zoomLink && (
                                    <Text style={zoomLinkText}>
                                        <strong>Zoom Link:</strong>{' '}
                                        <a href={zoomLink} style={{ color: '#3b82f6', textDecoration: 'underline' }}>
                                            {zoomLink}
                                        </a>
                                    </Text>
                                )}
                            </>
                        )}

                        {classroomLink && (
                            <Text style={zoomLinkText}>
                                <strong>Classroom Link:</strong>{' '}
                                <a href={classroomLink} style={{ color: '#10b981', textDecoration: 'underline' }}>
                                    {classroomLink}
                                </a>
                            </Text>
                        )}
                    </Section>
                </Container>
            </Body>
        </Html>
    )
}

const main = { backgroundColor: '#f6f9fc', fontFamily: '-apple-system, sans-serif' }
const container = { backgroundColor: '#ffffff', margin: '0 auto', padding: '40px 20px', maxWidth: '560px', borderRadius: '8px' }
const heading = { fontSize: '24px', fontWeight: '600', textAlign: 'center' as const, margin: '0 0 30px', color: '#1a1a1a' }
const section = { padding: '0 20px' }
const greeting = { fontSize: '16px', color: '#333', margin: '0 0 16px' }
const bodyText = { fontSize: '14px', lineHeight: '24px', color: '#555', margin: '0 0 16px' }
const button = { backgroundColor: '#3b82f6', borderRadius: '6px', color: '#fff', fontSize: '14px', fontWeight: '600', textDecoration: 'none', textAlign: 'center' as const, display: 'block', padding: '12px 24px', margin: '24px auto' }
const joinButton = {
    ...button,
    backgroundColor: '#10b981',
}
const zoomLinkText = { ...bodyText, fontSize: '14px', margin: '24px 0 0', textAlign: 'center' as const }
</file>

<file path="components/student/purchase-credits-modal.tsx">
"use client"

import { useState, useEffect } from "react"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Check, CreditCard, Repeat, Loader2, Sparkles } from "lucide-react"
import { createCheckoutSession } from "@/app/actions/stripe"
import { getStudentPricingPlan, type PricingPoint, type PricingPlan } from "@/app/actions/pricing"
import { useToast } from "@/hooks/use-toast"

interface PurchaseCreditsModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function PurchaseCreditsModal({ open, onOpenChange }: PurchaseCreditsModalProps) {
  const { toast } = useToast()
  const [loading, setLoading] = useState(true)
  const [plan, setPlan] = useState<PricingPlan | null>(null)
  const [selectedPointId, setSelectedPointId] = useState<string | null>(null)
  const [isProcessing, setIsProcessing] = useState(false)

  useEffect(() => {
    if (open) {
      setLoading(true)
      getStudentPricingPlan().then(({ plan }) => {
        setPlan(plan)
        // Select the first subscription option by default, or the first option
        if (plan?.points?.length) {
          const defaultOption = plan.points.find((p: PricingPoint) => p.type === 'subscription') || plan.points[0]
          setSelectedPointId(defaultOption.id)
        }
        setLoading(false)
      })
    }
  }, [open])

  const handleCheckout = async () => {
    if (!selectedPointId) return
    setIsProcessing(true)

    const result = await createCheckoutSession(selectedPointId)

    if (result.error) {
      toast({ variant: "destructive", title: "Error", description: result.error })
      setIsProcessing(false)
    } else if (result.url) {
      window.location.href = result.url
    }
  }

  const selectedPoint = plan?.points?.find(p => p.id === selectedPointId)

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="text-2xl font-serif">Purchase Credits</DialogTitle>
          <DialogDescription>
            {plan?.name ? `Plan: ${plan.name}` : "Select a package"}
          </DialogDescription>
        </DialogHeader>

        {loading ? (
          <div className="py-8 flex justify-center"><Loader2 className="animate-spin" /></div>
        ) : !plan || !plan.points?.length ? (
          <div className="py-8 text-center text-muted-foreground">No pricing options available. Please contact your teacher.</div>
        ) : (
          <div className="space-y-3 py-4">
            {plan.points.map((point) => (
              <div key={point.id} className="relative">
                {point.type === 'subscription' && (
                  <div className="absolute -top-2.5 left-4 bg-green-600 text-white text-[10px] uppercase font-bold px-2 py-0.5 rounded-full z-10 border border-white shadow-sm">
                    Recommended
                  </div>
                )}
                <button
                  onClick={() => setSelectedPointId(point.id)}
                  className={`w-full text-left p-4 rounded-lg border-2 transition-all relative overflow-hidden ${selectedPointId === point.id
                    ? (point.type === 'subscription' ? "border-green-600 bg-green-50/50" : "border-primary bg-primary/5")
                    : (point.type === 'subscription' ? "border-green-200 hover:border-green-600" : "border-border hover:border-primary/50")
                    }`}
                >
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="font-semibold text-lg flex flex-wrap items-center gap-2">
                        {point.label}
                        {point.type === 'subscription' && (
                          <span className="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wider font-bold">
                            Autopay
                          </span>
                        )}
                      </div>
                      <p className="text-sm text-muted-foreground">
                        {point.description || `${point.credits} Credits`}
                      </p>
                    </div>
                    <div className="text-right">
                      <span className="text-xl font-bold">${(point.price / 100).toFixed(0)}</span>
                      {point.type === 'subscription' && <span className="text-xs text-muted-foreground block">/mo</span>}
                    </div>
                  </div>
                </button>
              </div>
            ))}
          </div>
        )}

        <div className="border-t pt-4">
          <Button className="w-full" size="lg" onClick={handleCheckout} disabled={isProcessing || !selectedPointId}>
            {isProcessing ? <Loader2 className="animate-spin mr-2" /> : (
              selectedPoint?.type === 'subscription' ? "Start Subscription" : "Checkout"
            )}
          </Button>
          <p className="text-xs text-center text-muted-foreground mt-3">
            Purchased Lesson Credits Never Expire.
          </p>
        </div>
      </DialogContent>
    </Dialog >
  )
}
</file>

<file path="next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
</file>

<file path="app/actions/stripe.ts">
'use server'

import { createClient } from '@/lib/supabase/server'
import Stripe from 'stripe'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!)

export async function createCheckoutSession(pricingPointId: string) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) return { error: 'Unauthorized' }

    // 1. Fetch the Pricing Point details from DB
    const { data: point, error } = await supabase
        .from('pricing_points')
        .select('*')
        .eq('id', pricingPointId)
        .single()

    if (error || !point) {
        return { error: 'Invalid pricing option selected.' }
    }

    const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'
    const { data: profile } = await supabase
        .from('profiles')
        .select('email')
        .eq('id', user.id)
        .single()

    try {
        let sessionParams: Stripe.Checkout.SessionCreateParams;

        if (point.type === 'subscription') {
            if (!point.stripe_price_id) {
                return { error: 'System Error: Subscription Price ID missing.' }
            }

            sessionParams = {
                mode: 'subscription',
                payment_method_types: ['card'],
                customer_email: profile?.email || undefined,
                line_items: [{ price: point.stripe_price_id, quantity: 1 }],
                subscription_data: {
                    metadata: {
                        userId: user.id,
                        credits: point.credits.toString()
                    }
                },
                metadata: {
                    userId: user.id,
                    credits: point.credits.toString(),
                    type: 'subscription'
                },
                success_url: `${appUrl}/student?success=true`,
                cancel_url: `${appUrl}/student?canceled=true`,
            }
        } else {
            // One-time payment
            sessionParams = {
                mode: 'payment',
                payment_method_types: ['card'],
                customer_email: profile?.email || undefined,
                line_items: [{
                    price_data: {
                        currency: 'usd',
                        product_data: {
                            name: point.label,
                            description: point.description || `Includes ${point.credits} lesson credits`,
                        },
                        unit_amount: point.price, // Already in cents from DB
                    },
                    quantity: 1, // We treat it as 1 item
                }],
                metadata: {
                    userId: user.id,
                    credits: point.credits.toString(),
                    type: 'one-time'
                },
                success_url: `${appUrl}/student?success=true`,
                cancel_url: `${appUrl}/student?canceled=true`,
                payment_intent_data: {
                    capture_method: 'manual',
                },
            }
        }

        const session = await stripe.checkout.sessions.create(sessionParams)
        return { url: session.url }

    } catch (err: any) {
        console.error('Stripe error:', err)
        return { error: err.message }
    }
}

/**
 * Create a checkout session specifically for paying off the Outstanding Balance
 */
export async function createBalancePaymentSession() {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) return { error: 'Unauthorized' }

    // 1. Fetch current balance
    const { data: profile } = await supabase
        .from('profiles')
        .select('balance_due, email')
        .eq('id', user.id)
        .single()

    if (!profile || Number(profile.balance_due) <= 0) {
        return { error: 'No outstanding balance to pay.' }
    }

    const amountInCents = Math.round(Number(profile.balance_due) * 100)
    const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'

    try {
        const session = await stripe.checkout.sessions.create({
            mode: 'payment',
            payment_method_types: ['card'],
            customer_email: profile.email || undefined,
            line_items: [{
                price_data: {
                    currency: 'usd',
                    product_data: {
                        name: 'Outstanding Balance Payment',
                        description: 'Payment for miscellaneous charges (Sheet music, late fees, etc.)',
                    },
                    unit_amount: amountInCents,
                },
                quantity: 1,
            }],
            metadata: {
                userId: user.id,
                type: 'balance_payment', // Distinct type for webhook
                amountPaid: amountInCents.toString()
            },
            success_url: `${appUrl}/student?success=true`,
            cancel_url: `${appUrl}/student?canceled=true`,
            payment_intent_data: {
                capture_method: 'manual',
            },
        })

        return { url: session.url }
    } catch (err: any) {
        console.error('Stripe error:', err)
        return { error: err.message }
    }
}
</file>

<file path="app/student/page.tsx">
import { redirect } from "next/navigation"
import { createClient } from "@/lib/supabase/server"
import { StudentDashboard } from "@/components/student/student-dashboard"
import { getStudentEvents } from "@/app/actions/events"
import { getStudentResources } from "@/app/actions/resources"
import { getLatestAnnouncement } from "@/app/actions/announcements"

export default async function StudentPage() {
  const supabase = await createClient()

  // Check authentication
  const { data: { user }, error: authError } = await supabase.auth.getUser()

  if (authError || !user) {
    redirect("/login")
  }

  // Fetch profile data
  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .single()

  if (profileError || !profile) {
    console.error("Profile fetch error:", profileError)
    redirect("/login")
  }

  // Fetch teacher/admin profile for default Zoom link
  const { data: teacher } = await supabase
    .from("profiles")
    .select("zoom_link, studio_name, name")
    .eq("role", "admin")
    .limit(1)
    .single()

  // Fetch lessons for this student
  const { data: lessons, error: lessonsError } = await supabase
    .from("lessons")
    .select("*")
    .eq("student_id", user.id)
    .order("date", { ascending: false })

  if (lessonsError) {
    console.error("Lessons fetch error:", lessonsError)
  }

  // Find next scheduled lesson
  // 1. Get current time in UTC
  const now = new Date()

  // 2. Subtract 24 hours to create a safety buffer. 
  // This handles the case where it's Friday in UTC but still Thursday in PST.
  const yesterday = new Date(now.getTime() - (24 * 60 * 60 * 1000))
  const queryDate = yesterday.toISOString().split('T')[0]

  const upcomingLessons = (lessons || [])
    // Filter lessons >= "Yesterday" to be safe
    .filter(l => l.status === 'scheduled' && l.date >= queryDate)
    .sort((a, b) => {
      // Sort by Date first
      const dateCompare = a.date.localeCompare(b.date)
      if (dateCompare !== 0) return dateCompare
      // If same date, sort by Time
      return a.time.localeCompare(b.time)
    })

  const nextScheduledLesson = upcomingLessons[0]

  // Format next lesson for UI
  const nextLesson = nextScheduledLesson ? {
    id: nextScheduledLesson.id,
    date: nextScheduledLesson.date,
    time: formatTimeForDisplay(nextScheduledLesson.time),
    duration: nextScheduledLesson.duration || 60,
    rawTime: nextScheduledLesson.time,
    isConfirmed: nextScheduledLesson.is_confirmed || false
  } : null

  // Determine Zoom link: lesson-specific > student's profile > teacher's default
  const zoomLink = nextScheduledLesson?.zoom_link || profile.zoom_link || teacher?.zoom_link || null

  // Fetch events
  const { upcoming: upcomingEvents } = await getStudentEvents()

  // Fetch resources assigned to this student
  const { resources } = await getStudentResources()

  // Fetch latest announcement for this student
  const latestAnnouncement = await getLatestAnnouncement(user.id)

  return (
    <StudentDashboard
      profile={profile}
      lessons={lessons || []}
      nextLesson={nextLesson}
      zoomLink={zoomLink}
      studioName={teacher?.studio_name || "Piano Studio"}
      teacherName={teacher?.name || "Professor"}
      events={upcomingEvents}
      resources={resources}
      latestAnnouncement={latestAnnouncement}
    />
  )
}

// Helper to format time (HH:MM:SS -> h:mm AM/PM)
function formatTimeForDisplay(timeStr: string): string {
  const [hours, minutes] = timeStr.split(':').map(Number)
  const ampm = hours >= 12 ? 'PM' : 'AM'
  const displayHours = hours % 12 || 12
  return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`
}
</file>

<file path="components/admin/edit-student-modal.tsx">
"use client"

import { useState } from "react"
import { useRouter } from "next/navigation"
import { useFormStatus } from "react-dom"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"
import { Pencil, Loader2, Save } from "lucide-react"
import { updateStudent } from "@/app/actions/users"
import { useToast } from "@/hooks/use-toast"
import type { Profile } from "@/lib/supabase/database.types"
import { PricingPlan } from "@/app/actions/pricing"

function SubmitButton() {
    const { pending } = useFormStatus()

    return (
        <Button type="submit" disabled={pending} className="w-full">
            {pending ? (
                <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Saving...
                </>
            ) : (
                <>
                    <Save className="h-4 w-4 mr-2" />
                    Save Changes
                </>
            )}
        </Button>
    )
}

interface EditStudentModalProps {
    student: Profile
    pricingPlans: PricingPlan[]
}

export function EditStudentModal({ student, pricingPlans }: EditStudentModalProps) {
    const [open, setOpen] = useState(false)
    const [lessonDuration, setLessonDuration] = useState(
        String(student.lesson_duration || 30)
    )
    const [pricingPlanId, setPricingPlanId] = useState((student as any).pricing_plan_id || "")
    const [lessonTime, setLessonTime] = useState(
        (student as any).lesson_time || "15:30"
    )
    const [timezone, setTimezone] = useState(
        student.timezone || "America/Los_Angeles"
    )
    const { toast } = useToast()
    const router = useRouter()

    async function handleSubmit(formData: FormData) {
        // Add lesson duration from state
        formData.set('lessonDuration', lessonDuration)
        formData.set('lessonTime', lessonTime)
        formData.set('timezone', timezone)
        formData.set('pricingPlanId', pricingPlanId)

        try {
            const result = await updateStudent(formData)
            console.log("Update result:", result)

            if (result.error) {
                toast({
                    variant: "destructive",
                    title: "Error",
                    description: result.error
                })
            } else if (result.success) {
                toast({
                    title: "Student Updated",
                    description: result.message
                })
                setOpen(false)
                router.refresh()
            }
        } catch (e) {
            console.error("Submission error:", e)
            toast({
                variant: "destructive",
                title: "Error",
                description: "Failed to submit updates"
            })
        }
    }

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button variant="ghost" size="icon" className="h-8 w-8">
                    <Pencil className="h-4 w-4" />
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-md">
                <DialogHeader>
                    <DialogTitle className="text-2xl font-serif">Edit Student</DialogTitle>
                    <DialogDescription>
                        Update student information and lesson settings
                    </DialogDescription>
                </DialogHeader>

                <form action={handleSubmit} className="space-y-4 py-4">
                    <input type="hidden" name="id" value={student.id} />

                    <div className="space-y-2">
                        <Label htmlFor="name">Full Name</Label>
                        <Input
                            id="name"
                            name="name"
                            type="text"
                            defaultValue={student.name || ''}
                            required
                        />
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="publicId">Public ID (Optional)</Label>
                        <Input
                            id="publicId"
                            name="publicId"
                            type="text"
                            defaultValue={student.public_id || ''}
                            placeholder="e.g. 12345"
                        />
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="email">Email</Label>
                        <Input
                            id="email"
                            name="email"
                            type="email"
                            defaultValue={student.email || ''}
                            required
                        />
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="parentEmail">Parent Email (Optional - for CC)</Label>
                        <Input
                            id="parentEmail"
                            name="parentEmail"
                            type="email"
                            defaultValue={student.parent_email || ''}
                            placeholder="parent@example.com"
                        />
                    </div>

                    <div className="space-y-2">
                        <Label>Status</Label>
                        <Select
                            name="status"
                            defaultValue={student.status || 'active'}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder="Select status" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="active">Active</SelectItem>
                                <SelectItem value="inactive">Inactive</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>

                    <div className="space-y-2">
                        <Label>Time Zone</Label>
                        <Select
                            value={timezone}
                            onValueChange={setTimezone}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder="Select timezone" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="America/Los_Angeles">PT (Pacific Time)</SelectItem>
                                <SelectItem value="America/Denver">MT (Mountain Time)</SelectItem>
                                <SelectItem value="America/Chicago">CT (Central Time)</SelectItem>
                                <SelectItem value="America/New_York">ET (Eastern Time)</SelectItem>
                                <SelectItem value="Europe/London">UK Time</SelectItem>
                                <SelectItem value="Europe/Paris">Central Europe Time</SelectItem>
                                <SelectItem value="Australia/Sydney">AET (Australian Eastern Time)</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="credits">Current Credits</Label>
                        <Input
                            id="credits"
                            name="credits"
                            type="number"
                            defaultValue={student.credits}
                            required
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <Label htmlFor="lessonDay">Recurring Day</Label>
                            <select
                                id="lessonDay"
                                name="lessonDay"
                                defaultValue={(student as any).lesson_day || ""}
                                className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                            >
                                <option value="">None</option>
                                {['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => (
                                    <option key={day} value={day}>{day}</option>
                                ))}
                            </select>
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="lessonTime">Standard Time</Label>
                            <Input
                                id="lessonTime"
                                type="time"
                                value={lessonTime}
                                onChange={(e) => setLessonTime(e.target.value)}
                            />
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label>Lesson Duration</Label>
                        <Select
                            value={lessonDuration}
                            onValueChange={setLessonDuration}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder="Select duration" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="30">30 minutes</SelectItem>
                                <SelectItem value="45">45 minutes</SelectItem>
                                <SelectItem value="60">60 minutes</SelectItem>
                            </SelectContent>
                        </Select>
                        <p className="text-xs text-muted-foreground">
                            This determines the lesson length for scheduling
                        </p>
                    </div>

                    <div className="space-y-2">
                        <Label>Pricing Plan</Label>
                        <Select
                            value={pricingPlanId}
                            onValueChange={setPricingPlanId}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder="Select a pricing plan" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="none">No Specific Plan</SelectItem>
                                {pricingPlans.map(plan => (
                                    <SelectItem key={plan.id} value={plan.id}>
                                        {plan.name}
                                    </SelectItem>
                                ))}
                            </SelectContent>
                        </Select>
                        <p className="text-xs text-muted-foreground">
                            Determines the pricing options they see when buying credits
                        </p>
                    </div>

                    <div className="pt-4">
                        <SubmitButton />
                    </div>
                </form>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/admin/pricing-manager.tsx">
"use client"

import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { createPricingPlan, createPricingPoint, updatePricingPoint, deletePricingPoint, deletePricingPlan, updatePricingPlan, PricingPlan, PricingPoint } from "@/app/actions/pricing"
import { Plus, Trash2, Repeat, Pencil, MoreVertical, Check, X } from "lucide-react"
import { useToast } from "@/hooks/use-toast"
import { useRouter } from "next/navigation"
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"

interface PricingManagerProps {
    initialPlans: PricingPlan[]
}

export function PricingManager({ initialPlans }: PricingManagerProps) {
    const [plans, setPlans] = useState(initialPlans)
    const [newPlanName, setNewPlanName] = useState("")
    const { toast } = useToast()
    const router = useRouter()

    useEffect(() => {
        setPlans(initialPlans)
    }, [initialPlans])

    // New/Edit Point State
    const [pointLabel, setPointLabel] = useState("")
    const [pointPrice, setPointPrice] = useState("")
    const [pointCredits, setPointCredits] = useState("1")
    const [pointType, setPointType] = useState<"one_time" | "subscription">("one_time")
    const [stripeId, setStripeId] = useState("")
    const [editingPointId, setEditingPointId] = useState<string | null>(null)

    // Track which plan has the active form
    const [activePlanId, setActivePlanId] = useState<string | null>(null)
    const [isCreatingPlan, setIsCreatingPlan] = useState(false)

    // Plan Editing State
    const [editingPlanId, setEditingPlanId] = useState<string | null>(null)
    const [editingPlanName, setEditingPlanName] = useState("")

    const handleCreatePlan = async () => {
        if (!newPlanName || isCreatingPlan) return
        setIsCreatingPlan(true)
        const res = await createPricingPlan(newPlanName)
        if (res.success && res.plan) {
            // Optimistic update
            setPlans([...plans, res.plan])
            setNewPlanName("")
            toast({ title: "Plan Created", description: `Plan "${res.plan.name}" created.` })
            router.refresh()
        } else {
            toast({ variant: "destructive", title: "Error", description: res.error })
        }
        setIsCreatingPlan(false)
    }

    const startEditingPlan = (plan: PricingPlan) => {
        setEditingPlanId(plan.id)
        setEditingPlanName(plan.name)
    }

    const cancelEditingPlan = () => {
        setEditingPlanId(null)
        setEditingPlanName("")
    }

    const handleUpdatePlan = async (id: string) => {
        if (!editingPlanName.trim()) {
            toast({ variant: "destructive", title: "Error", description: "Plan name cannot be empty." })
            return
        }

        const res = await updatePricingPlan(id, editingPlanName)
        if (res.success) {
            toast({ title: "Plan Updated", description: "Plan name updated successfully." })
            setPlans(plans.map(p => p.id === id ? { ...p, name: editingPlanName } : p))
            setEditingPlanId(null)
            router.refresh()
        } else {
            toast({ variant: "destructive", title: "Error", description: res.error })
        }
    }

    const handleDeletePlan = async (id: string, name: string) => {
        if (confirm(`Are you sure you want to delete the plan "${name}"? This action cannot be undone.`)) {
            const res = await deletePricingPlan(id)
            if (res.success) {
                toast({ title: "Plan Deleted", description: `Plan "${name}" removed.` })
                setPlans(plans.filter(p => p.id !== id))
                router.refresh()
            } else {
                toast({ variant: "destructive", title: "Error", description: res.error })
            }
        }
    }

    const handleEditPoint = (point: PricingPoint) => {
        setActivePlanId(point.plan_id)
        setEditingPointId(point.id)
        setPointLabel(point.label)
        setPointPrice((point.price / 100).toString())
        setPointCredits(point.credits.toString())
        setPointType(point.type)
        setStripeId(point.stripe_price_id || "")
    }

    const handleSavePoint = async (planId: string) => {
        if (!pointLabel || !pointPrice) {
            toast({ variant: "destructive", title: "Error", description: "Label and Price are required" })
            return
        }

        if (pointType === 'subscription' && !stripeId) {
            toast({ variant: "destructive", title: "Error", description: "Stripe Price ID is required for subscriptions" })
            return
        }

        try {
            const priceInCents = Math.round(parseFloat(pointPrice) * 100)
            const credits = parseInt(pointCredits)

            let res
            if (editingPointId) {
                // Update existing
                res = await updatePricingPoint(editingPointId, {
                    label: pointLabel,
                    price: priceInCents,
                    credits: credits,
                    type: pointType,
                    stripe_price_id: stripeId || null
                })
            } else {
                // Create new
                res = await createPricingPoint({
                    plan_id: planId,
                    label: pointLabel,
                    price: priceInCents,
                    credits: credits,
                    type: pointType,
                    stripe_price_id: stripeId || null
                })
            }

            if (res.success) {
                toast({ title: editingPointId ? "Option Updated" : "Option Added", description: "Pricing option saved successfully." })
                // Reset form
                resetForm()
                // Refresh page/data
                router.refresh()
            } else {
                toast({ variant: "destructive", title: "Error", description: res.error })
            }
        } catch (e: any) {
            toast({ variant: "destructive", title: "Error", description: e.message })
        }
    }

    const resetForm = () => {
        setPointLabel("")
        setPointPrice("")
        setPointCredits("1")
        setStripeId("")
        setPointType("one_time")
        setActivePlanId(null)
        setEditingPointId(null)
    }

    const handleDeletePoint = async (id: string) => {
        if (confirm("Are you sure you want to delete this pricing option?")) {
            const res = await deletePricingPoint(id)
            if (res.success) {
                toast({ title: "Deleted", description: "Pricing option removed." })
                router.refresh()
            } else {
                toast({ variant: "destructive", title: "Error", description: res.error })
            }
        }
    }

    return (
        <div className="space-y-8">
            <div className="flex gap-4 items-end border-b pb-6">
                <div className="grid gap-2 w-full max-w-sm">
                    <Label>New Pricing Plan Name</Label>
                    <Input value={newPlanName} onChange={e => setNewPlanName(e.target.value)} placeholder="e.g. Adult Beginners" />
                </div>
                <Button onClick={handleCreatePlan} disabled={isCreatingPlan || !newPlanName}>
                    {isCreatingPlan ? "Creating..." : "Create Plan"}
                </Button>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
                {plans.map(plan => (
                    <Card key={plan.id} className="relative">
                        <CardHeader className="bg-muted/20 flex flex-row items-center justify-between pb-2">
                            {editingPlanId === plan.id ? (
                                <div className="flex items-center gap-2 w-full pr-8">
                                    <Input
                                        value={editingPlanName}
                                        onChange={(e) => setEditingPlanName(e.target.value)}
                                        className="h-8 bg-background"
                                    />
                                    <Button size="icon" variant="ghost" className="h-8 w-8 text-green-600 hover:text-green-700 hover:bg-green-100" onClick={() => handleUpdatePlan(plan.id)}>
                                        <Check className="h-4 w-4" />
                                    </Button>
                                    <Button size="icon" variant="ghost" className="h-8 w-8 text-muted-foreground hover:text-primary" onClick={cancelEditingPlan}>
                                        <X className="h-4 w-4" />
                                    </Button>
                                </div>
                            ) : (
                                <CardTitle className="text-lg">{plan.name}</CardTitle>
                            )}

                            {!editingPlanId && (
                                <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                        <Button variant="ghost" className="h-8 w-8 p-0">
                                            <MoreVertical className="h-4 w-4" />
                                        </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent align="end">
                                        <DropdownMenuItem onClick={() => startEditingPlan(plan)}>
                                            <Pencil className="mr-2 h-4 w-4" />
                                            Edit Name
                                        </DropdownMenuItem>
                                        <DropdownMenuItem className="text-destructive focus:text-destructive" onClick={() => handleDeletePlan(plan.id, plan.name)}>
                                            <Trash2 className="mr-2 h-4 w-4" />
                                            Delete Plan
                                        </DropdownMenuItem>
                                    </DropdownMenuContent>
                                </DropdownMenu>
                            )}
                        </CardHeader>
                        <CardContent className="pt-6 space-y-4">
                            {/* Existing Points */}
                            <div className="space-y-2">
                                {plan.points?.map(point => (
                                    <div key={point.id} className="flex justify-between items-center p-3 border rounded bg-background hover:bg-muted/10 transition-colors">
                                        <div>
                                            <div className="font-medium flex items-center gap-2">
                                                {point.label}
                                                {point.type === 'subscription' && <Repeat className="h-3 w-3 text-muted-foreground" />}
                                            </div>
                                            <div className="text-xs text-muted-foreground">
                                                ${(point.price / 100).toFixed(2)} â€¢ {point.credits} Credits â€¢ {point.type === 'subscription' ? 'Auto-renew' : 'One-time'}
                                            </div>
                                        </div>
                                        <div className="flex gap-1">
                                            <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-primary" onClick={() => handleEditPoint(point)}>
                                                <Pencil className="h-4 w-4" />
                                            </Button>
                                            <Button variant="ghost" size="icon" className="h-8 w-8 text-destructive hover:text-destructive" onClick={() => handleDeletePoint(point.id)}>
                                                <Trash2 className="h-4 w-4" />
                                            </Button>
                                        </div>
                                    </div>
                                ))}
                                {(!plan.points || plan.points.length === 0) && <p className="text-sm text-muted-foreground italic">No pricing points yet.</p>}
                            </div>

                            {/* Add/Edit Point Form */}
                            <div className="border-t pt-4 mt-4">
                                {activePlanId === plan.id ? (
                                    <div className="space-y-3 bg-muted/20 p-3 rounded-md">
                                        <div className="flex justify-between items-center">
                                            <h4 className="text-sm font-semibold">{editingPointId ? "Edit Pricing Option" : "New Pricing Option"}</h4>
                                            <Button variant="ghost" size="sm" onClick={resetForm}>Cancel</Button>
                                        </div>

                                        <div className="space-y-2">
                                            <Label className="text-xs">Label</Label>
                                            <Input placeholder="e.g. 4-Pack" value={pointLabel} onChange={e => setPointLabel(e.target.value)} className="bg-background" />
                                        </div>

                                        <div className="flex gap-2">
                                            <div className="w-1/2 space-y-2">
                                                <Label className="text-xs">Price ($)</Label>
                                                <Input type="number" placeholder="50" value={pointPrice} onChange={e => setPointPrice(e.target.value)} className="bg-background" />
                                            </div>
                                            <div className="w-1/2 space-y-2">
                                                <Label className="text-xs">Credits</Label>
                                                <Input type="number" placeholder="1" value={pointCredits} onChange={e => setPointCredits(e.target.value)} className="bg-background" />
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            <Label className="text-xs">Type</Label>
                                            <Select value={pointType} onValueChange={(v: any) => setPointType(v)}>
                                                <SelectTrigger className="bg-background"><SelectValue /></SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="one_time">One Time</SelectItem>
                                                    <SelectItem value="subscription">Subscription</SelectItem>
                                                </SelectContent>
                                            </Select>
                                        </div>

                                        {pointType === 'subscription' && (
                                            <div className="space-y-2">
                                                <Label className="text-xs">Stripe Price ID</Label>
                                                <Input placeholder="price_..." value={stripeId} onChange={e => setStripeId(e.target.value)} className="bg-background" />
                                                <p className="text-[10px] text-muted-foreground">Required for subscriptions.</p>
                                            </div>
                                        )}
                                        <Button size="sm" className="w-full mt-2" onClick={() => handleSavePoint(plan.id)}>
                                            {editingPointId ? "Update Option" : "Save Option"}
                                        </Button>
                                    </div>
                                ) : (
                                    <Button size="sm" variant="outline" className="w-full gap-2" onClick={() => {
                                        resetForm()
                                        setActivePlanId(plan.id)
                                    }}>
                                        <Plus className="h-4 w-4" /> Add Pricing Option
                                    </Button>
                                )}
                            </div>
                        </CardContent>
                    </Card>
                ))}
            </div>
        </div>
    )
}
</file>

<file path="lib/supabase/database.types.ts">
// Database types generated from schema.sql
// Run Supabase CLI for auto-generation: npx supabase gen types typescript

export type Json =
    | string
    | number
    | boolean
    | null
    | { [key: string]: Json | undefined }
    | Json[]

// Message attachment type for chat attachments
export type MessageAttachment = {
    type: 'image' | 'file'
    url: string
    name: string
    size: number
}

export interface Database {
    public: {
        Tables: {
            profiles: {
                Row: {
                    id: string
                    name: string | null
                    email: string | null
                    phone: string | null
                    role: 'student' | 'admin'
                    credits: number
                    credits_total: number
                    balance_due: number
                    zoom_link: string | null
                    stripe_customer_id: string | null
                    available_hours: Json | null
                    timezone: string | null
                    studio_name: string | null
                    parent_email: string | null
                    public_id: string | null
                    status: 'active' | 'inactive' | null
                    created_at: string
                    updated_at: string
                }
                Insert: {
                    id: string
                    name?: string | null
                    email?: string | null
                    phone?: string | null
                    role?: 'student' | 'admin'
                    credits?: number
                    credits_total?: number
                    balance_due?: number
                    zoom_link?: string | null
                    stripe_customer_id?: string | null
                    available_hours?: Json | null
                    timezone?: string | null
                    studio_name?: string | null
                    public_id?: string | null
                    status?: 'active' | 'inactive' | null
                    created_at?: string
                    updated_at?: string
                }
                Update: {
                    id?: string
                    name?: string | null
                    email?: string | null
                    phone?: string | null
                    role?: 'student' | 'admin'
                    credits?: number
                    credits_total?: number
                    balance_due?: number
                    zoom_link?: string | null
                    stripe_customer_id?: string | null
                    available_hours?: Json | null
                    timezone?: string | null
                    studio_name?: string | null
                    public_id?: string | null
                    status?: 'active' | 'inactive' | null
                    created_at?: string
                    updated_at?: string
                }
            }
            lessons: {
                Row: {
                    id: string
                    student_id: string
                    date: string
                    time: string
                    status: 'scheduled' | 'completed' | 'cancelled'
                    notes: string | null
                    video_url: string | null
                    sheet_music_url: string | null
                    duration: number
                    is_confirmed: boolean
                    credit_snapshot: number | null
                    credit_snapshot_before: number | null
                    zoom_link: string | null
                    created_at: string
                    updated_at: string
                }
                Insert: {
                    id?: string
                    student_id: string
                    date: string
                    time: string
                    status?: 'scheduled' | 'completed' | 'cancelled'
                    notes?: string | null
                    video_url?: string | null
                    sheet_music_url?: string | null
                    duration?: number
                    is_confirmed?: boolean
                    credit_snapshot?: number | null
                    credit_snapshot_before?: number | null
                    zoom_link?: string | null
                    created_at?: string
                    updated_at?: string
                }
                Update: {
                    id?: string
                    student_id?: string
                    date?: string
                    time?: string
                    status?: 'scheduled' | 'completed' | 'cancelled'
                    notes?: string | null
                    video_url?: string | null
                    sheet_music_url?: string | null
                    duration?: number
                    is_confirmed?: boolean
                    credit_snapshot?: number | null
                    credit_snapshot_before?: number | null
                    zoom_link?: string | null
                    created_at?: string
                    updated_at?: string
                }
            }
            messages: {
                Row: {
                    id: string
                    sender_id: string
                    recipient_id: string
                    content: string
                    is_read: boolean
                    attachments: MessageAttachment[] | null
                    created_at: string
                }
                Insert: {
                    id?: string
                    sender_id: string
                    recipient_id: string
                    content: string
                    is_read?: boolean
                    attachments?: MessageAttachment[] | null
                    created_at?: string
                }
                Update: {
                    id?: string
                    sender_id?: string
                    recipient_id?: string
                    content?: string
                    is_read?: boolean
                    attachments?: MessageAttachment[] | null
                    created_at?: string
                }
            }
            pricing_tiers: {
                Row: {
                    duration: number
                    single_price: number
                    pack_price: number
                    created_at: string
                    updated_at: string
                }
                Insert: {
                    duration: number
                    single_price: number
                    pack_price: number
                    created_at?: string
                    updated_at?: string
                }
                Update: {
                    duration?: number
                    single_price?: number
                    pack_price?: number
                    created_at?: string
                    updated_at?: string
                }
            }
        }
    }
}

// Convenience types
export type Profile = Database['public']['Tables']['profiles']['Row'] & {
    lesson_duration?: number
}
export type Lesson = Database['public']['Tables']['lessons']['Row']
export type Message = Database['public']['Tables']['messages']['Row']
export type PricingTier = Database['public']['Tables']['pricing_tiers']['Row']

// Extended types for UI components (matching mock-data structure)
export type StudentProfile = Profile & {
    next_lesson?: {
        date: string
        time: string
        duration: number
    }
}

export type LessonWithDetails = Lesson & {
    duration?: number
    teacher_notes?: string
    homework?: string
}
</file>

<file path="app/actions/users.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'
import { createClient as createSupabaseClient } from '@supabase/supabase-js'

/**
 * Create a new student (Admin only)
 * Uses SUPABASE_SERVICE_KEY to create auth user
 */
export async function createStudent(formData: FormData) {
    const name = formData.get('name') as string
    const email = formData.get('email') as string
    const parentEmail = formData.get('parentEmail') as string | null
    const phone = formData.get('phone') as string | null
    const credits = parseInt(formData.get('credits') as string) || 0
    const lessonDuration = parseInt(formData.get('lessonDuration') as string) || 30
    const lessonDay = formData.get('lessonDay') as string || null
    const password = formData.get('password') as string || 'piano123'

    // Validate required fields
    if (!name || !email) {
        return { error: 'Name and email are required' }
    }

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(email)) {
        return { error: 'Invalid email format' }
    }

    // Validate lesson duration
    if (![30, 45, 60].includes(lessonDuration)) {
        return { error: 'Invalid lesson duration. Must be 30, 45, or 60 minutes.' }
    }

    // Create admin client with service key
    const supabaseAdmin = createSupabaseClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    )

    try {
        // Step 1: Create user in Auth system
        const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
            email,
            password,
            email_confirm: true, // Auto-confirm so they can log in immediately
            user_metadata: { name }
        })

        if (authError) {
            console.error('Auth creation error:', authError)
            if (authError.message.includes('already been registered')) {
                return { error: 'A user with this email already exists' }
            }
            return { error: authError.message }
        }

        if (!authData.user) {
            return { error: 'Failed to create user' }
        }

        // Step 2: Auto-generate public_id from name
        const publicId = name.toLowerCase().replace(/ /g, '_')

        // Step 3: Create profile in public.profiles
        const { error: profileError } = await supabaseAdmin
            .from('profiles')
            .upsert({
                id: authData.user.id,
                name,
                email,
                parent_email: parentEmail || null,
                phone: phone || null,
                role: 'student',
                credits,
                credits_total: credits,
                balance_due: 0,
                lesson_duration: lessonDuration,
                lesson_day: lessonDay,
                public_id: publicId
            })

        if (profileError) {
            console.error('Profile creation error:', profileError)
            // Try to clean up the auth user if profile creation fails
            await supabaseAdmin.auth.admin.deleteUser(authData.user.id)
            return { error: 'Failed to create student profile: ' + profileError.message }
        }

        revalidatePath('/admin')

        return {
            success: true,
            message: `Student "${name}" created successfully!`,
            tempPassword: password
        }
    } catch (error) {
        console.error('Unexpected error:', error)
        return { error: 'An unexpected error occurred' }
    }
}

/**
 * Update an existing student (Admin only)
 * Uses SUPABASE_SERVICE_KEY to update auth and profile
 */
export async function updateStudent(formData: FormData) {
    const id = formData.get('id') as string
    const name = formData.get('name') as string
    const email = formData.get('email') as string
    const parentEmail = formData.get('parentEmail') as string | null
    const lessonDuration = parseInt(formData.get('lessonDuration') as string) || 30
    const lessonDay = formData.get('lessonDay') as string || null
    const lessonTime = formData.get('lessonTime') as string || null
    const publicId = formData.get('publicId') as string || null

    // Parse credits if present
    const creditsRaw = formData.get('credits')
    let credits: number | undefined = undefined
    if (creditsRaw !== null && creditsRaw !== '') {
        const parsed = parseInt(creditsRaw as string)
        if (!isNaN(parsed)) {
            credits = parsed
        }
    }


    // Validate required fields
    if (!id) {
        return { error: 'Student ID is required' }
    }

    if (!name || !email) {
        return { error: 'Name and email are required' }
    }

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(email)) {
        return { error: 'Invalid email format' }
    }

    // Validate lesson duration
    if (![30, 45, 60].includes(lessonDuration)) {
        return { error: 'Invalid lesson duration. Must be 30, 45, or 60 minutes.' }
    }

    // Create admin client for sensitive updates
    const supabaseAdmin = createSupabaseClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    )

    try {
        // Step 1: Update user email in Auth system
        const { error: authError } = await supabaseAdmin.auth.admin.updateUserById(id, {
            email,
        })

        if (authError) {
            console.error('Auth update error:', authError)
            // Continue if it's just an email conflict (might be same email)
            if (!authError.message.includes('email already exists')) {
                return { error: authError.message }
            }
        }

        // Step 2: Update profile in public.profiles
        const { error: profileError } = await supabaseAdmin
            .from('profiles')
            .update({
                name,
                email,
                parent_email: parentEmail || null,
                lesson_duration: lessonDuration,
                lesson_day: lessonDay,
                lesson_time: lessonTime,
                public_id: publicId,
                timezone: formData.get('timezone') as string || null,
                status: (formData.get('status') as 'active' | 'inactive') || null,
                pricing_plan_id: formData.get('pricingPlanId') as string || null,
                ...(credits !== undefined && { credits }), // Only update if provided
                updated_at: new Date().toISOString()
            })
            .eq('id', id)

        if (profileError) {
            console.error('Profile update error:', profileError)
            return { error: 'Failed to update student profile: ' + profileError.message }
        }

        revalidatePath('/admin')

        return {
            success: true,
            message: `Student "${name}" updated successfully!`
        }
    } catch (error) {
        console.error('Unexpected error:', error)
        return { error: 'An unexpected error occurred' }
    }
}

/**
 * Update teacher profile settings (Admin only via UI, checks auth)
 */
export async function updateProfileSettings(formData: FormData) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
        return { error: 'Not authenticated' }
    }

    const name = formData.get('name') as string
    const email = formData.get('email') as string
    const timezone = formData.get('timezone') as string
    const availableHoursStr = formData.get('availableHours') as string
    const studioName = formData.get('studioName') as string
    const password = formData.get('password') as string

    // Create admin client for sensitive updates
    const supabaseAdmin = createSupabaseClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    )

    try {
        const updates: any = {}
        const authUpdates: any = {}

        // 1. Update Profile Data
        if (name) updates.name = name
        if (timezone) updates.timezone = timezone
        if (studioName !== undefined) updates.studio_name = studioName
        if (formData.get('zoomLink') !== undefined) updates.zoom_link = formData.get('zoomLink') as string
        if (availableHoursStr) {
            try {
                updates.available_hours = JSON.parse(availableHoursStr)
            } catch (e) {
                console.error("Invalid JSON for available_hours")
            }
        }

        const { error: profileError } = await supabaseAdmin
            .from('profiles')
            .update({
                ...updates,
                updated_at: new Date().toISOString()
            })
            .eq('id', user.id)

        if (profileError) throw new Error('Profile update failed: ' + profileError.message)

        // 2. Update Auth Data (Email/Password)
        if (email && email !== user.email) authUpdates.email = email
        if (password) authUpdates.password = password

        if (Object.keys(authUpdates).length > 0) {
            const { error: authError } = await supabaseAdmin.auth.admin.updateUserById(user.id, authUpdates)
            if (authError) throw new Error('Auth update failed: ' + authError.message)
        }

        revalidatePath('/admin')
        return { success: true, message: 'Settings updated successfully' }

    } catch (error: any) {
        console.error('Update settings error:', error)
        return { error: error.message || 'Failed to update settings' }
    }
}

/**
 * Delete a student (Admin only)
 * Uses SUPABASE_SERVICE_KEY to remove from auth and database
 */
export async function deleteStudent(studentId: string) {
    if (!studentId) {
        return { error: 'Student ID is required' }
    }

    // Create admin client with service key
    const supabaseAdmin = createSupabaseClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    )

    try {
        const { error: deleteError } = await supabaseAdmin.auth.admin.deleteUser(studentId)

        if (deleteError) {
            console.error('Delete user error:', deleteError)
            return { error: 'Failed to delete user: ' + deleteError.message }
        }

        revalidatePath('/admin')
        return { success: true, message: 'Student and associated data deleted successfully' }

    } catch (error) {
        console.error('Unexpected error:', error)
        return { error: 'An unexpected error occurred during deletion' }
    }
}
</file>

<file path="app/actions/announcements.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'
import { createClient as createAdminClient } from '@supabase/supabase-js'
import { Resend } from 'resend'

const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null

function getAdminSupabase() {
    return createAdminClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        { auth: { autoRefreshToken: false, persistSession: false } }
    )
}

/**
 * Save or update a draft announcement (no emails sent).
 */
export async function saveAnnouncementDraft(
    subject: string,
    body: string,
    studentIds: string[],
    existingId?: string
) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    const adminDb = getAdminSupabase()

    const { data: profile } = await adminDb
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()
    if (profile?.role !== 'admin') return { error: 'Only admins can save drafts' }

    let announcementId = existingId

    if (existingId) {
        // Update existing draft
        const { error } = await adminDb
            .from('announcements')
            .update({ subject, body })
            .eq('id', existingId)
            .eq('status', 'draft')

        if (error) return { error: error.message }

        // Re-sync recipients: delete old, insert new
        await adminDb
            .from('announcement_recipients')
            .delete()
            .eq('announcement_id', existingId)
    } else {
        // Create new draft
        const { data: newAnn, error } = await adminDb
            .from('announcements')
            .insert({ subject, body, teacher_id: user.id, status: 'draft' })
            .select('id')
            .single()

        if (error || !newAnn) return { error: error?.message || 'Failed to create draft' }
        announcementId = newAnn.id
    }

    // Insert recipient links
    if (studentIds.length > 0 && announcementId) {
        await adminDb
            .from('announcement_recipients')
            .insert(studentIds.map(sid => ({
                announcement_id: announcementId,
                student_id: sid
            })))
    }

    revalidatePath('/admin')
    return { success: true, id: announcementId, message: 'Draft saved.' }
}

/**
 * Send an announcement. Creates or updates the record, sets status='sent', triggers emails.
 */
export async function sendAnnouncement(
    subject: string,
    body: string,
    studentIds: string[],
    existingId?: string
) {
    console.log('[Announcement-v4] sendAnnouncement called:', { subject, studentIds: studentIds.length, existingId })
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    const adminDb = getAdminSupabase()

    const { data: adminProfile } = await adminDb
        .from('profiles')
        .select('role, name, studio_name, email')
        .eq('id', user.id)
        .single()
    if (adminProfile?.role !== 'admin') return { error: 'Only admins can send announcements' }

    let announcementId = existingId

    if (existingId) {
        // Update and mark as sent
        const { error } = await adminDb
            .from('announcements')
            .update({ subject, body, status: 'sent', sent_at: new Date().toISOString() })
            .eq('id', existingId)

        if (error) return { error: error.message }

        // Re-sync recipients
        await adminDb
            .from('announcement_recipients')
            .delete()
            .eq('announcement_id', existingId)
    } else {
        // Create as sent
        const { data: newAnn, error } = await adminDb
            .from('announcements')
            .insert({
                subject, body,
                teacher_id: user.id,
                status: 'sent',
                sent_at: new Date().toISOString()
            })
            .select('id')
            .single()

        if (error || !newAnn) return { error: error?.message || 'Failed to create announcement' }
        announcementId = newAnn.id
    }

    // Insert recipient links
    if (studentIds.length > 0 && announcementId) {
        await adminDb
            .from('announcement_recipients')
            .insert(studentIds.map(sid => ({
                announcement_id: announcementId,
                student_id: sid
            })))
    }

    // Send individual emails per student (AWAITED, not fire-and-forget)
    if (resend && studentIds.length > 0) {
        try {
            console.log(`[Announcement] Starting email send for ${studentIds.length} students`)

            const { data: students } = await adminDb
                .from('profiles')
                .select('email, name')
                .in('id', studentIds)

            console.log(`[Announcement] Fetched ${students?.length || 0} student profiles`)

            if (students && students.length > 0) {
                const studioName = adminProfile?.studio_name || 'Lionel Yu Piano Studio'
                const portalUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lessons.musicalbasics.com'

                const emailPayloads = students
                    .filter(s => s.email)
                    .map(s => ({
                        from: `${studioName} <notifications@updates.musicalbasics.com>`,
                        to: s.email,
                        subject: `ðŸ“¢ ${subject}`,
                        html: `<div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
                            <h2 style="color: #333;">ðŸ“¢ ${subject}</h2>
                            <p style="color: #555; white-space: pre-wrap; line-height: 1.6;">${body}</p>
                            <hr style="border: none; border-top: 1px solid #eee; margin: 24px 0;" />
                            <p style="color: #999; font-size: 14px;">
                                View in your portal: <a href="${portalUrl}/student" style="color: #4f46e5;">Student Dashboard</a>
                            </p>
                        </div>`
                    }))

                console.log(`[Announcement] Sending ${emailPayloads.length} individual emails to:`, emailPayloads.map(e => e.to))

                const batchResult = await resend.batch.send(emailPayloads)
                console.log(`[Announcement] Batch result:`, JSON.stringify(batchResult))
            }
        } catch (emailError) {
            console.error('[Announcement] Email send failed:', emailError)
        }
    } else {
        console.log(`[Announcement] Skipping emails: resend=${!!resend}, studentIds.length=${studentIds.length}`)
    }

    revalidatePath('/admin')
    revalidatePath('/student')

    return {
        success: true,
        message: `Announcement sent to ${studentIds.length} student${studentIds.length === 1 ? '' : 's'}.`
    }
}

/**
 * Get all announcements (drafts + sent) for the admin history list.
 */
export async function getAnnouncements() {
    const adminDb = getAdminSupabase()

    const { data, error } = await adminDb
        .from('announcements')
        .select(`
            id, subject, body, status, created_at, sent_at,
            announcement_recipients ( student_id )
        `)
        .order('created_at', { ascending: false })

    if (error) {
        console.error('Failed to fetch announcements:', error)
        return []
    }

    return (data || []).map(a => ({
        id: a.id,
        subject: a.subject,
        body: a.body,
        status: a.status as 'draft' | 'sent',
        created_at: a.created_at,
        sent_at: a.sent_at,
        recipient_count: (a.announcement_recipients as any[])?.length || 0,
        recipient_ids: (a.announcement_recipients as any[])?.map((r: any) => r.student_id) || []
    }))
}

/**
 * Delete a draft announcement.
 */
export async function deleteAnnouncementDraft(announcementId: string) {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return { error: 'Unauthorized' }

    const adminDb = getAdminSupabase()

    const { error } = await adminDb
        .from('announcements')
        .delete()
        .eq('id', announcementId)
        .eq('status', 'draft')

    if (error) return { error: error.message }

    revalidatePath('/admin')
    return { success: true }
}

/**
 * Get the latest SENT announcement for a specific student (student dashboard).
 */
export async function getLatestAnnouncement(studentId: string) {
    const adminDb = getAdminSupabase()

    const { data, error } = await adminDb
        .from('announcement_recipients')
        .select(`
            announcement_id,
            announcements (
                id, subject, body, created_at, status
            )
        `)
        .eq('student_id', studentId)
        .order('created_at', { ascending: false })
        .limit(5)

    if (error) {
        console.error('Failed to fetch latest announcement:', error)
        return null
    }

    // Find the most recent SENT announcement
    const sent = (data || []).find(d => {
        const ann = d.announcements as any
        return ann?.status === 'sent'
    })

    if (!sent?.announcements) return null

    const ann = sent.announcements as any
    return {
        id: ann.id,
        subject: ann.subject,
        body: ann.body,
        created_at: ann.created_at
    }
}
</file>

<file path="app/actions/reminders.ts">
'use server'

import { createClient } from '@/lib/supabase/server'
import { Resend } from 'resend'
import LessonReminderEmail from '@/components/emails/LessonReminderEmail'
import { differenceInMinutes, format } from 'date-fns'

const resend = new Resend(process.env.RESEND_API_KEY)

export async function sendManualReminder(lessonId: string, variant: '24h' | '2h' | '15m' | 'exact') {
    console.log(`[ManualReminder] Starting ${variant} reminder for lesson ${lessonId}`)
    const supabase = await createClient()

    // 1. Fetch lesson details with Student Profile
    const { data: lesson, error } = await supabase
        .from('lessons')
        .select('*, student:profiles!student_id(*)') // Fetch linked student profile
        .eq('id', lessonId)
        .single()

    if (error || !lesson) {
        console.error('[ManualReminder] Fetch error:', error)
        return { error: 'Lesson not found' }
    }

    // Calculate exact time remaining (Shifted Reference Frame)
    // We treat both dates as "Wall Clock Time" in the Studio's Timezone (America/Los_Angeles)
    // regardless of the server's actual timezone (UTC).

    // 1. Lesson Date (Already in Wall Clock Time from DB)
    const lessonDate = new Date(`${lesson.date}T${lesson.time}`)

    // 2. Current Time (Shifted to LA Wall Clock Time)
    // toLocaleString returns "M/D/YYYY, HH:MM:SS" in the specified timezone
    const nowInStudioTimeStr = new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })
    const now = new Date(nowInStudioTimeStr)

    // Calculate total minutes difference
    const totalMinutes = differenceInMinutes(lessonDate, now)
    const hours = Math.floor(totalMinutes / 60)
    const mins = totalMinutes % 60

    let durationString = ""
    if (hours > 0) durationString += `${hours} hour${hours > 1 ? 's' : ''}`
    if (hours > 0 && mins > 0) durationString += " and "
    if (mins > 0) durationString += `${mins} minute${mins > 1 ? 's' : ''}`
    if (totalMinutes <= 0) durationString = "just a few moments"

    // 2. Prepare Email Subject based on variant
    const subjects = {
        '24h': 'Reminder: Piano Lesson Tomorrow',
        '2h': 'Reminder: Lesson starts in 2 hours',
        '15m': 'Join Now: Piano Lesson Starting!',
        'exact': `Lesson coming up in exactly ${durationString}`
    }

    try {
        // 3. Send Email
        console.log('[ManualReminder] Sending email to', lesson.student.email)

        // Fetch Studio Name from Admin Profile (Current User)
        // We can safely use auth.getUser() here because this is a Server Action called by a logged-in admin
        const { data: { user } } = await supabase.auth.getUser()
        let studioName = 'Lionel Yu Piano Studio'

        if (user) {
            const { data: adminProfile } = await supabase
                .from('profiles')
                .select('studio_name')
                .eq('id', user.id)
                .single()
            if (adminProfile?.studio_name) {
                studioName = adminProfile.studio_name
            }
        }

        const classroomBase = process.env.NEXT_PUBLIC_CLASSROOM_URL || 'https://classroom.musicalbasics.com'
        const classroomLink = lesson.student.public_id ? `${classroomBase}/${lesson.student.public_id}` : null

        const { data: emailData, error: emailError } = await resend.emails.send({
            from: `${studioName} <notifications@updates.musicalbasics.com>`,
            to: lesson.student.email,
            subject: subjects[variant],
            react: LessonReminderEmail({
                studentName: lesson.student.name,
                time: new Date(`${lesson.date}T${lesson.time}`).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }),
                zoomLink: lesson.zoom_link || lesson.student.zoom_link, // Fallback to student's default link
                classroomLink,
                variant: variant === 'exact' ? 'exact' : variant,
                exactDuration: durationString
            })
        })

        if (emailError) {
            console.error('[ManualReminder] Resend API Error:', emailError)
            return { error: `Failed to send email: ${emailError.message}` }
        }

        console.log('[ManualReminder] Email sent successfully:', emailData)

        // 4. Update Database (so Cron job doesn't double-send)
        if (variant !== 'exact') {
            const column = variant === '24h' ? 'reminder_24h_sent' : variant === '2h' ? 'reminder_2h_sent' : 'reminder_15m_sent'
            const { error: updateError } = await supabase.from('lessons').update({ [column]: true }).eq('id', lessonId)

            if (updateError) {
                console.error('[ManualReminder] Database update failed (RLS likely):', updateError)
            } else {
                console.log('[ManualReminder] Database updated successfully')
            }
        }

        return { success: true, message: `Sent ${variant} reminder to ${lesson.student.name}` }
    } catch (err) {
        console.error('[ManualReminder] Unexpected error:', err)
        return { error: 'An unexpected error occurred' }
    }
}
</file>

<file path="app/api/cron/reminders/route.ts">
import { NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'
import { Resend } from 'resend'
import LessonReminderEmail from '@/components/emails/LessonReminderEmail'
import { differenceInMinutes, addDays, format } from 'date-fns'

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
)

const resend = new Resend(process.env.RESEND_API_KEY)

export const dynamic = 'force-dynamic' // Ensure this route is not cached

export async function GET(request: Request) {
    const { searchParams } = new URL(request.url)
    if (searchParams.get('key') !== process.env.CRON_SECRET) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // 1. Establish Reference Time (Studio Time - America/Los_Angeles)
    // We treat 'now' as the Wall Clock time in the studio.
    const nowInStudioTimeStr = new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })
    const now = new Date(nowInStudioTimeStr)

    console.log(`[Cron] Checking reminders at ${now.toISOString()} (Studio Time)`)

    // 2. Fetch Relevant Lessons (Today and Tomorrow)
    // We only need to look at lessons happening today or tomorrow to cover 15m, 2h, and 24h windows.
    const todayStr = format(now, 'yyyy-MM-dd')
    const tomorrowStr = format(addDays(now, 1), 'yyyy-MM-dd')

    const { data: lessons, error } = await supabase
        .from('lessons')
        .select('*, profiles(email, name, public_id)')
        .in('date', [todayStr, tomorrowStr])
        .neq('status', 'cancelled') // Don't remind cancelled lessons

    if (error) {
        console.error('[Cron] Error fetching lessons:', error)
        return NextResponse.json({ error: error.message }, { status: 500 })
    }

    console.log(`[Cron] Found ${lessons?.length || 0} active lessons for ${todayStr} and ${tomorrowStr}`)

    let sent24h = 0
    let sent2h = 0
    let sent15m = 0

    if (lessons) {
        for (const lesson of lessons) {
            if (!lesson.profiles?.email) continue

            // Construct Lesson Wall Clock Time
            const lessonTime = new Date(`${lesson.date}T${lesson.time}`)
            const diffMinutes = differenceInMinutes(lessonTime, now)

            // --- 24 Hour Reminder ---
            // Window: 24h to 25h (1440 mins to 1500 mins)
            if (diffMinutes >= 1440 && diffMinutes < 1500 && !lesson.reminder_24h_sent) {
                console.log(`[Cron] Sending 24h reminder to ${lesson.profiles.email} (Diff: ${diffMinutes}m)`)
                const classroomBase = process.env.NEXT_PUBLIC_CLASSROOM_URL || 'https://classroom.musicalbasics.com'
                const classroomLink = lesson.profiles.public_id ? `${classroomBase}/${lesson.profiles.public_id}` : null
                const { error: emailError } = await resend.emails.send({
                    from: 'Lionel Yu Piano Studio <notifications@updates.musicalbasics.com>',
                    to: lesson.profiles.email,
                    subject: 'Reminder: Lesson Tomorrow',
                    react: LessonReminderEmail({
                        studentName: lesson.profiles.name || 'Student',
                        time: new Date(`${lesson.date}T${lesson.time}`).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }),
                        zoomLink: lesson.zoom_link,
                        classroomLink,
                        variant: '24h'
                    })
                })

                if (!emailError) {
                    await supabase.from('lessons').update({ reminder_24h_sent: true }).eq('id', lesson.id)
                    sent24h++
                } else {
                    console.error(`[Cron] Failed to send 24h email:`, emailError)
                }
            }

            // --- 2 Hour Reminder ---
            // Window: 2h to 3h (120 mins to 180 mins)
            if (diffMinutes >= 120 && diffMinutes < 180 && !lesson.reminder_2h_sent) {
                console.log(`[Cron] Sending 2h reminder to ${lesson.profiles.email} (Diff: ${diffMinutes}m)`)
                const classroomBase2h = process.env.NEXT_PUBLIC_CLASSROOM_URL || 'https://classroom.musicalbasics.com'
                const classroomLink2h = lesson.profiles.public_id ? `${classroomBase2h}/${lesson.profiles.public_id}` : null
                const { error: emailError } = await resend.emails.send({
                    from: 'Lionel Yu Piano Studio <notifications@updates.musicalbasics.com>',
                    to: lesson.profiles.email,
                    subject: 'Lesson in 2 Hours',
                    react: LessonReminderEmail({
                        studentName: lesson.profiles.name || 'Student',
                        time: new Date(`${lesson.date}T${lesson.time}`).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }),
                        zoomLink: lesson.zoom_link,
                        classroomLink: classroomLink2h,
                        variant: '2h'
                    })
                })

                if (!emailError) {
                    await supabase.from('lessons').update({ reminder_2h_sent: true }).eq('id', lesson.id)
                    sent2h++
                } else {
                    console.error(`[Cron] Failed to send 2h email:`, emailError)
                }
            }

            // --- 15 Minute Reminder ---
            // Window: 0 to 25 mins (widened to catch early)
            if (diffMinutes >= 0 && diffMinutes < 25 && !lesson.reminder_15m_sent) {
                console.log(`[Cron] Sending 15m reminder to ${lesson.profiles.email} (Diff: ${diffMinutes}m)`)
                const classroomBase15m = process.env.NEXT_PUBLIC_CLASSROOM_URL || 'https://classroom.musicalbasics.com'
                const classroomLink15m = lesson.profiles.public_id ? `${classroomBase15m}/${lesson.profiles.public_id}` : null
                const { error: emailError } = await resend.emails.send({
                    from: 'Lionel Yu Piano Studio <notifications@updates.musicalbasics.com>',
                    to: lesson.profiles.email,
                    subject: 'Lesson Starting Soon!',
                    react: LessonReminderEmail({
                        studentName: lesson.profiles.name || 'Student',
                        time: new Date(`${lesson.date}T${lesson.time}`).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }),
                        zoomLink: lesson.zoom_link,
                        classroomLink: classroomLink15m,
                        variant: '15m'
                    })
                })

                if (!emailError) {
                    await supabase.from('lessons').update({ reminder_15m_sent: true }).eq('id', lesson.id)
                    sent15m++
                } else {
                    console.error(`[Cron] Failed to send 15m email:`, emailError)
                }
            }
        }
    }

    console.log(`[Cron] Finished. Sent: 24h(${sent24h}), 2h(${sent2h}), 15m(${sent15m})`)
    return NextResponse.json({
        success: true,
        checked: now.toISOString(),
        stats: { sent24h, sent2h, sent15m }
    })
}
</file>

<file path="components/student/student-dashboard.tsx">
"use client"

import { useState, useEffect } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import {
    Calendar,
    Clock,
    Video,
    MonitorPlay,
    CreditCard,
    AlertCircle,
    Music,
    Download,
    CalendarX,
    CalendarClock,
    Users,
    FileText,
    PlayCircle,
    MessageCircle,
    Plus,
    CheckCircle,
    CheckCircle2,
    HelpCircle,
    Loader2,
    Megaphone,
} from "lucide-react"
import {
    mockEvents,
    mockTutorials,
    type Tutorial,
} from "@/lib/mock-data"
import { MakeupScheduler } from "./makeup-scheduler"
import { CancellationModal } from "./cancellation-modal"
import { LessonDetailModal } from "@/components/admin/lesson-detail-modal"
import { PurchaseCreditsModal } from "./purchase-credits-modal"
import { createBalancePaymentSession } from "@/app/actions/stripe"
import { MessagesPanel } from "./messages-panel"
import { ChatWidget } from "./chat-widget"
import { logout } from "@/app/login/actions"
import { cancelLesson, confirmAttendance } from "@/app/actions/lessons"
import { rsvpToEvent } from "@/app/actions/events"
import { notifyStudentJoined } from "@/app/actions/notifications"
import { useToast } from "@/hooks/use-toast"
import type { Profile, Lesson } from "@/lib/supabase/database.types"
import type { StudentEvent } from "@/app/actions/events"
import type { Resource } from "@/app/actions/resources"
import { EventSignupModal } from "./event-signup-modal"
import { LocalTimeDisplay } from "@/components/ui/local-time-display"

// Extended lesson type for UI compatibility
type UILesson = Lesson & {
    duration?: number
    teacher_notes?: string
    credit_snapshot?: number | null
    credit_snapshot_before?: number | null
}

export interface StudentDashboardProps {
    profile: Profile
    lessons: Lesson[]
    nextLesson: { id?: string; date: string; time: string; duration: number; rawTime?: string; isConfirmed?: boolean } | null
    zoomLink?: string | null
    studioName?: string
    teacherName?: string
    events?: StudentEvent[]
    resources?: Resource[]
    latestAnnouncement?: { id: string; subject: string; body: string; created_at: string } | null
}

// Category badge colors
const categoryColors: Record<string, string> = {
    'Sheet Music': 'bg-blue-100 text-blue-800',
    'Theory': 'bg-purple-100 text-purple-800',
    'Scales': 'bg-green-100 text-green-800',
    'Exercises': 'bg-orange-100 text-orange-800',
    'Recording': 'bg-pink-100 text-pink-800',
}

export function StudentDashboard({ profile, lessons, nextLesson, zoomLink, studioName = "Piano Studio", teacherName, events = [], resources = [], latestAnnouncement }: StudentDashboardProps) {
    const { toast } = useToast()

    // Classroom Link (prioritized over Zoom)
    const classroomBase = process.env.NEXT_PUBLIC_CLASSROOM_URL || "https://classroom.musicalbasics.com"
    const classroomUrl = profile.public_id ? `${classroomBase}/${profile.public_id}` : null

    // Transform lessons to UI format
    const uiLessons: UILesson[] = lessons.map(lesson => ({
        ...lesson,
        duration: 60, // Default duration
        teacher_notes: lesson.notes || undefined
    }))

    const completedLessons = uiLessons.filter((l) => l.status === "completed")


    // Find next scheduled lesson for cancellation
    // We use the nextLesson prop passed from the server which is already calculated correctly
    // The uiLessons array is sorted by date descending, so finding the first 'scheduled' one there would be wrong (it would be the latest one)

    // Mock messages for now (will be replaced with real data later)
    const unreadMessages = 1

    const [showMakeupScheduler, setShowMakeupScheduler] = useState(false)
    const [showCancellationModal, setShowCancellationModal] = useState(false)
    const [selectedLesson, setSelectedLesson] = useState<UILesson | null>(null)
    const [showLessonDetail, setShowLessonDetail] = useState(false)
    const [showPurchaseModal, setShowPurchaseModal] = useState(false)
    const [isPayingBalance, setIsPayingBalance] = useState(false)
    const [isCancelling, setIsCancelling] = useState(false)
    const [isConfirming, setIsConfirming] = useState(false)

    // Event Signup State
    const [showEventSignup, setShowEventSignup] = useState(false)
    const [selectedEvent, setSelectedEvent] = useState<StudentEvent | null>(null)

    // Local state for confirmation - allows instant UI feedback
    const [confirmationStatus, setConfirmationStatus] = useState<boolean>(!!nextLesson?.isConfirmed)

    // Sync local state if the prop changes (e.g. on page refresh)
    useEffect(() => {
        if (nextLesson) {
            setConfirmationStatus(!!nextLesson.isConfirmed)
        }
    }, [nextLesson])

    // const handleReschedule = () => {
    //     setShowMakeupScheduler(true)
    // }

    const handleCancel = () => {
        setShowCancellationModal(true)
    }

    const handleConfirmCancel = async () => {
        if (!nextLesson?.id) return

        setIsCancelling(true)
        const result = await cancelLesson(nextLesson.id)
        if (result.success) {
            toast({
                title: "Lesson Cancelled",
                description: result.message
            })
            setShowCancellationModal(false)
        } else {
            toast({
                variant: "destructive",
                title: "Error",
                description: result.error
            })
        }
        setIsCancelling(false)
    }

    const handleConfirmAttendance = async () => {
        if (!nextLesson?.id) {
            toast({ variant: "destructive", title: "Error", description: "Lesson ID missing" })
            return
        }
        setIsConfirming(true)

        const result = await confirmAttendance(nextLesson.id)

        if (result.success) {
            // Update local state immediately for instant feedback
            setConfirmationStatus(true)

            toast({
                title: "Attendance Confirmed",
                description: "Thanks for letting us know you'll be there!",
            })
        } else {
            toast({
                variant: "destructive",
                title: "Error",
                description: "Could not confirm attendance. Please try again."
            })
        }
        setIsConfirming(false)
    }

    const handleSignUpClick = (event: StudentEvent) => {
        setSelectedEvent(event)
        setShowEventSignup(true)
    }

    const handleSignupConfirm = async (eventId: string, message: string) => {
        const result = await rsvpToEvent(eventId, 'going', message)
        if (result.success) {
            toast({ title: "Signed Up!", description: "You have successfully RSVP'd to the event." })
            setShowEventSignup(false)
            setSelectedEvent(null)
        } else {
            toast({ variant: "destructive", title: "Error", description: result.error || "Failed to sign up" })
            throw new Error(result.error)
        }
    }

    const handleUnenroll = async (eventId: string) => {
        if (!confirm("Are you sure you want to unenroll from this event?")) return

        const result = await rsvpToEvent(eventId, 'not_going', '')
        if (result.success) {
            toast({ title: "Unenrolled", description: "You have been removed from the event." })
        } else {
            toast({ variant: "destructive", title: "Error", description: result.error || "Failed to unenroll" })
        }
    }
    const handleRenewPackage = () => {
        setShowPurchaseModal(true)
    }

    const handlePayBalance = async () => {
        setIsPayingBalance(true)
        const result = await createBalancePaymentSession()

        if (result.error) {
            toast({ variant: "destructive", title: "Error", description: result.error })
            setIsPayingBalance(false)
        } else if (result.url) {
            window.location.href = result.url
        }
    }

    const handleDownload = (resource: Resource) => {
        // Open file in new tab for download
        window.open(resource.file_url, '_blank')
    }

    const handleWatchTutorial = (tutorial: Tutorial) => {
        alert(`Opening tutorial: ${tutorial.title}`)
    }

    const needsRenewal = profile.credits <= 1

    // Format time for display (HH:MM:SS -> h:mm AM/PM)
    const formatTime = (timeStr: string) => {
        const [hours, minutes] = timeStr.split(':').map(Number)
        const ampm = hours >= 12 ? 'PM' : 'AM'
        const displayHours = hours % 12 || 12
        return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`
    }

    // Format date for display - parse as local time to avoid timezone shift
    const formatDate = (dateStr: string) => {
        // If date is in YYYY-MM-DD format (no time), parse as local time
        // to avoid UTC midnight conversion shifting to previous day
        let date: Date
        if (dateStr.length === 10 && dateStr.includes('-')) {
            // Parse YYYY-MM-DD as local time by adding T12:00:00
            date = new Date(dateStr + 'T12:00:00')
        } else {
            date = new Date(dateStr)
        }
        return date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        })
    }

    const [currentDate, setCurrentDate] = useState("")

    useEffect(() => {
        const date = new Date()
        setCurrentDate(date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }))
    }, [])

    return (
        <div className="min-h-screen bg-background">
            <header className="border-b bg-card sticky top-0 z-10">
                <div className="container mx-auto px-4 py-4">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="h-10 w-10 bg-primary rounded-full flex items-center justify-center">
                                <Music className="h-5 w-5 text-primary-foreground" />
                            </div>
                            <div>
                                <h1 className="text-xl font-serif font-semibold">{studioName}</h1>
                                <p className="text-sm text-muted-foreground">{profile.name || 'Student'}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            {currentDate && (
                                <div className="hidden md:block text-right">
                                    <p className="text-sm text-muted-foreground">Today is</p>
                                    <p className="font-medium">{currentDate}</p>
                                </div>
                            )}
                            <form action={logout}>
                                <Button variant="outline" type="submit">
                                    Sign Out
                                </Button>
                            </form>
                        </div>
                    </div>
                    {currentDate && (
                        <div className="md:hidden mt-3 pt-3 border-t">
                            <p className="text-sm text-muted-foreground">Today is <span className="font-medium text-foreground">{currentDate}</span></p>
                        </div>
                    )}
                </div>
            </header>

            <main className="container mx-auto px-4 py-8 space-y-8">

                {/* Confirmation Banner */}
                {nextLesson?.id && !confirmationStatus && (
                    <Card className="border-blue-200 bg-blue-50 dark:bg-blue-900/10 shadow-sm">
                        <CardContent className="flex flex-col sm:flex-row items-center justify-between p-6 gap-4">
                            <div className="flex items-center gap-4">
                                <div className="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center shrink-0 text-blue-600">
                                    <Calendar className="h-5 w-5" />
                                </div>
                                <div className="space-y-1 text-center sm:text-left">
                                    <h3 className="font-semibold text-blue-900 dark:text-blue-100">
                                        Upcoming Lesson Confirmation
                                    </h3>
                                    <p className="text-sm text-blue-700 dark:text-blue-300">
                                        Please confirm you will be attending your lesson on {formatDate(nextLesson.date)} at {nextLesson.time}.
                                    </p>
                                </div>
                            </div>
                            <Button
                                onClick={handleConfirmAttendance}
                                disabled={isConfirming}
                                className="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white shrink-0"
                            >
                                {isConfirming ? (
                                    <>
                                        <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                                        Confirming...
                                    </>
                                ) : (
                                    <>
                                        <CheckCircle className="h-4 w-4 mr-2" />
                                        Confirm Attendance
                                    </>
                                )}
                            </Button>
                        </CardContent>
                    </Card>
                )}

                {/* Renewal Banner */}
                {needsRenewal && (
                    <Card className="border-warning bg-warning/5">
                        <CardContent className="flex items-center justify-between p-6">
                            <div className="flex items-center gap-3">
                                <AlertCircle className="h-6 w-6 text-warning" />
                                <div>
                                    <h3 className="font-semibold text-warning-foreground">Low Credits</h3>
                                    <p className="text-sm text-muted-foreground">
                                        You have {profile.credits} credit{profile.credits === 1 ? "" : "s"} remaining.
                                        Renew now to continue lessons.
                                    </p>
                                </div>
                            </div>
                            <Button onClick={handleRenewPackage} className="bg-warning text-warning-foreground hover:bg-warning/90">
                                Renew Package
                            </Button>
                        </CardContent>
                    </Card>
                )}

                {/* Hero Section - Next Lesson */}
                <Card className="border-2 overflow-hidden">
                    <CardHeader className="pb-4 bg-muted/20 border-b">
                        <div className="flex items-center justify-between">
                            <CardTitle className="text-2xl font-serif">Next Lesson</CardTitle>

                            {/* STATUS BADGE */}
                            {nextLesson && (
                                confirmationStatus ? (
                                    <Badge className="bg-green-100 text-green-700 hover:bg-green-100 border-green-200 pl-1.5 pr-2.5 py-1">
                                        <CheckCircle2 className="w-3.5 h-3.5 mr-1" />
                                        Confirmed
                                    </Badge>
                                ) : (
                                    <Badge variant="outline" className="bg-yellow-50 text-yellow-700 border-yellow-200 pl-1.5 pr-2.5 py-1">
                                        <HelpCircle className="w-3.5 h-3.5 mr-1" />
                                        Unconfirmed
                                    </Badge>
                                )
                            )}
                        </div>
                    </CardHeader>
                    <CardContent className="space-y-6 pt-6">
                        {nextLesson ? (
                            <>
                                <div className="grid md:grid-cols-3 gap-6">
                                    <div className="flex items-center gap-3">
                                        <div className="flex items-center justify-center h-12 w-12 bg-primary/10 rounded-lg">
                                            <Calendar className="h-6 w-6 text-primary" />
                                        </div>
                                        <div>
                                            <p className="text-sm text-muted-foreground">Date</p>
                                            <p className="font-semibold">{formatDate(nextLesson.date)}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="flex items-center justify-center h-12 w-12 bg-primary/10 rounded-lg">
                                            <Clock className="h-6 w-6 text-primary" />
                                        </div>
                                        <div>
                                            <p className="text-sm text-muted-foreground">Time</p>
                                            <LocalTimeDisplay date={nextLesson.date} time={nextLesson.time} />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="flex items-center justify-center h-12 w-12 bg-primary/10 rounded-lg">
                                            <Music className="h-6 w-6 text-primary" />
                                        </div>
                                        <div>
                                            <p className="text-sm text-muted-foreground">Duration</p>
                                            <p className="font-semibold">{nextLesson.duration} minutes</p>
                                        </div>
                                    </div>
                                </div>

                                <Separator />

                                <div className="flex flex-wrap gap-3">

                                    {/* 1. PRIMARY ACTION: Join Classroom */}
                                    <Button
                                        size="lg"
                                        className="flex-1 min-w-[200px] bg-indigo-600 hover:bg-indigo-700 text-white border-0 shadow-md shadow-indigo-900/10"
                                        onClick={() => {
                                            notifyStudentJoined('classroom') // fire-and-forget
                                            window.open(`${process.env.NEXT_PUBLIC_CLASSROOM_URL || "https://classroom.musicalbasics.com"}/${profile.public_id}`, '_blank')
                                        }}
                                    >
                                        <MonitorPlay className="h-5 w-5 mr-2" />
                                        Join Classroom
                                    </Button>

                                    {/* 2. FALLBACK: Join Zoom Lesson */}
                                    {zoomLink ? (
                                        <Button
                                            size="lg"
                                            variant="outline"
                                            className="flex-1 min-w-[200px] text-zinc-600 dark:text-zinc-400"
                                            onClick={() => {
                                                notifyStudentJoined('zoom') // fire-and-forget
                                                window.open(zoomLink, '_blank')
                                            }}
                                        >
                                            <Video className="h-5 w-5 mr-2" />
                                            Zoom (Backup)
                                        </Button>
                                    ) : (
                                        <Button size="lg" variant="ghost" className="flex-1 min-w-[200px] text-muted-foreground" disabled>
                                            <Video className="h-5 w-5 mr-2 opacity-50" />
                                            No Zoom Link
                                        </Button>
                                    )}

                                    {/* 3. Existing Actions */}
                                    {/* <Button size="lg" variant="outline" onClick={handleReschedule}>
                                        <CalendarClock className="h-5 w-5 mr-2" />
                                        Reschedule
                                    </Button> */}
                                    <Button size="lg" variant="destructive" onClick={handleCancel}>
                                        <CalendarX className="h-5 w-5 mr-2" />
                                        Cancel
                                    </Button>
                                </div>
                            </>
                        ) : (
                            <div className="text-center py-8">
                                <p className="text-muted-foreground">No upcoming lesson scheduled</p>
                            </div>
                        )}
                    </CardContent>
                </Card>

                {/* Stats Bar */}
                <div className="flex flex-wrap gap-3">
                    <Card className="flex-1 min-w-[200px]">
                        <CardContent className="flex items-center justify-between p-4">
                            <div>
                                <p className="text-xs text-muted-foreground mb-0.5">Credits Remaining</p>
                                <p className="text-xl font-bold">
                                    {profile.credits}
                                </p>
                            </div>
                            <div className="flex items-center gap-2">
                                <Button size="sm" variant="outline" onClick={() => setShowPurchaseModal(true)} className="h-8">
                                    <Plus className="h-3 w-3 mr-1" />
                                    Buy
                                </Button>
                                <CreditCard className="h-6 w-6 text-primary" />
                            </div>
                        </CardContent>
                    </Card>

                    <Card className={`flex-1 min-w-[200px] ${Number(profile.balance_due) > 0 ? "border-destructive" : ""}`}>
                        <CardContent className="flex items-center justify-between p-4">
                            <div>
                                <p className="text-xs text-muted-foreground mb-0.5">Outstanding Balance</p>
                                <p className={`text-xl font-bold ${Number(profile.balance_due) > 0 ? "text-destructive" : ""}`}>
                                    ${Number(profile.balance_due).toFixed(2)}
                                </p>
                            </div>

                            {Number(profile.balance_due) > 0 ? (
                                <Button
                                    size="sm"
                                    variant="destructive"
                                    onClick={handlePayBalance}
                                    disabled={isPayingBalance}
                                    className="h-8"
                                >
                                    {isPayingBalance ? <Loader2 className="h-3 w-3 animate-spin" /> : "Pay Now"}
                                </Button>
                            ) : (
                                <AlertCircle className="h-6 w-6 text-success" />
                            )}
                        </CardContent>
                    </Card>
                </div>

                <div className="grid lg:grid-cols-3 gap-8">
                    {/* My Library */}
                    <div className="lg:col-span-2 space-y-6">
                        <Tabs defaultValue="lessons" className="w-full">
                            <TabsList className="grid w-full grid-cols-4 mb-6">
                                <TabsTrigger value="lessons" className="gap-2">
                                    <Music className="h-4 w-4" />
                                    <span className="hidden sm:inline">Lessons</span>
                                </TabsTrigger>
                                <TabsTrigger value="downloads" className="gap-2">
                                    <FileText className="h-4 w-4" />
                                    <span className="hidden sm:inline">Downloads</span>
                                </TabsTrigger>
                                <TabsTrigger value="tutorials" className="gap-2">
                                    <PlayCircle className="h-4 w-4" />
                                    <span className="hidden sm:inline">Tutorials (still under construction)</span>
                                </TabsTrigger>
                                <TabsTrigger value="messages" className="gap-2 relative">
                                    <MessageCircle className="h-4 w-4" />
                                    <span className="hidden sm:inline">Messages</span>
                                    {unreadMessages > 0 && (
                                        <span className="absolute -top-1 -right-1 h-2.5 w-2.5 bg-destructive rounded-full" />
                                    )}
                                </TabsTrigger>
                            </TabsList>

                            <TabsContent value="lessons" className="space-y-4">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-serif font-semibold">Past Lessons</h2>
                                    <Badge variant="secondary">{completedLessons.length} lessons</Badge>
                                </div>
                                <div className="grid gap-4">
                                    {completedLessons.map((lesson) => (
                                        <Card
                                            key={lesson.id}
                                            className="cursor-pointer hover:shadow-md transition-shadow border-2"
                                            onClick={() => {
                                                setSelectedLesson(lesson)
                                                setShowLessonDetail(true)
                                            }}
                                        >
                                            <CardContent className="flex items-center justify-between p-6">
                                                <div className="flex items-center gap-4">
                                                    <div className="h-14 w-14 bg-primary/10 rounded-lg flex items-center justify-center">
                                                        <Music className="h-6 w-6 text-primary" />
                                                    </div>
                                                    <div>
                                                        <h3 className="font-semibold mb-1">Lesson - {formatDate(lesson.date)}</h3>
                                                        <p className="text-sm text-muted-foreground line-clamp-1">
                                                            {lesson.teacher_notes || "No notes available"}
                                                        </p>
                                                        <div className="flex gap-3 mt-2">
                                                            {lesson.video_url && (
                                                                <Badge variant="secondary" className="text-xs">
                                                                    <Video className="h-3 w-3 mr-1" />
                                                                    Video
                                                                </Badge>
                                                            )}
                                                        </div>
                                                        {lesson.sheet_music_url && (
                                                            <div className="mt-3 pt-3 border-t" onClick={(e) => e.stopPropagation()}>
                                                                <p className="text-xs text-muted-foreground mb-2">ðŸ“„ Download Sheet Music:</p>
                                                                <Button
                                                                    variant="outline"
                                                                    size="sm"
                                                                    className="bg-primary/5 hover:bg-primary/10 border-primary/20"
                                                                    asChild
                                                                >
                                                                    <a href={lesson.sheet_music_url} download target="_blank" rel="noopener noreferrer">
                                                                        <Download className="h-4 w-4 mr-2" />
                                                                        {(() => {
                                                                            try {
                                                                                const url = new URL(lesson.sheet_music_url)
                                                                                const pathname = decodeURIComponent(url.pathname)
                                                                                const filename = pathname.split('/').pop() || 'Sheet Music.pdf'
                                                                                // Remove timestamp prefix if present (e.g., "1734567890123_")
                                                                                const cleanName = filename.replace(/^\d{10,}_/, '')
                                                                                return cleanName.length > 30 ? cleanName.slice(0, 27) + '...' : cleanName
                                                                            } catch {
                                                                                return 'Sheet Music.pdf'
                                                                            }
                                                                        })()}
                                                                    </a>
                                                                </Button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                {/* Credit Receipt Footer */}
                                                {lesson.credit_snapshot !== undefined && lesson.credit_snapshot !== null && (
                                                    <div className="text-xs text-muted-foreground mt-2 pt-2 border-t">
                                                        Credits spent: 1 â€¢ Remaining: {lesson.credit_snapshot}
                                                    </div>
                                                )}
                                                <Clock className="h-5 w-5 text-muted-foreground" />
                                            </CardContent>
                                        </Card>
                                    ))}
                                    {completedLessons.length === 0 && (
                                        <p className="text-center text-muted-foreground py-8">No completed lessons yet</p>
                                    )}
                                </div>
                            </TabsContent>

                            <TabsContent value="downloads" className="space-y-4">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-serif font-semibold">Practice Materials</h2>
                                    <Badge variant="secondary">{resources.length} files</Badge>
                                </div>
                                {resources.length === 0 ? (
                                    <Card className="border-2">
                                        <CardContent className="flex flex-col items-center justify-center py-12 text-center">
                                            <FileText className="h-12 w-12 text-muted-foreground/50 mb-4" />
                                            <h3 className="font-semibold text-lg mb-2">No Practice Materials Yet</h3>
                                            <p className="text-muted-foreground max-w-sm">
                                                Your teacher will add practice materials here for you to download.
                                            </p>
                                        </CardContent>
                                    </Card>
                                ) : (
                                    <div className="grid gap-4">
                                        {resources.map((resource) => (
                                            <Card key={resource.id} className="border-2 hover:shadow-md transition-shadow">
                                                <CardContent className="flex items-center justify-between p-6">
                                                    <div className="flex items-center gap-4 flex-1">
                                                        <div className="h-14 w-14 bg-primary/10 rounded-lg flex items-center justify-center">
                                                            {resource.file_type === 'mp3' || resource.file_type === 'wav' ? (
                                                                <Music className="h-6 w-6 text-primary" />
                                                            ) : (
                                                                <FileText className="h-6 w-6 text-primary" />
                                                            )}
                                                        </div>
                                                        <div className="flex-1">
                                                            <h3 className="font-semibold mb-1">{resource.title}</h3>
                                                            {resource.description && (
                                                                <p className="text-sm text-muted-foreground mb-2">{resource.description}</p>
                                                            )}
                                                            <Badge
                                                                variant="secondary"
                                                                className={`text-xs ${categoryColors[resource.category] || ''}`}
                                                            >
                                                                {resource.category}
                                                            </Badge>
                                                        </div>
                                                    </div>
                                                    <Button size="sm" onClick={() => handleDownload(resource)}>
                                                        <Download className="h-4 w-4 mr-2" />
                                                        Download
                                                    </Button>
                                                </CardContent>
                                            </Card>
                                        ))}
                                    </div>
                                )}
                            </TabsContent>

                            <TabsContent value="tutorials" className="space-y-4">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-serif font-semibold">Tutorials (still under construction)</h2>
                                    <Badge variant="secondary">{mockTutorials.length} videos</Badge>
                                </div>
                                <div className="grid gap-4">
                                    {mockTutorials.map((tutorial) => (
                                        <Card key={tutorial.id} className="border-2 hover:shadow-md transition-shadow">
                                            <CardContent className="p-6">
                                                <div className="flex gap-4">
                                                    <div className="relative w-40 h-24 bg-muted rounded-lg flex items-center justify-center overflow-hidden shrink-0">
                                                        {tutorial.thumbnail_url ? (
                                                            <img
                                                                src={tutorial.thumbnail_url || "/placeholder.svg"}
                                                                alt={tutorial.title}
                                                                className="w-full h-full object-cover"
                                                            />
                                                        ) : (
                                                            <PlayCircle className="h-10 w-10 text-muted-foreground" />
                                                        )}
                                                        <div className="absolute bottom-1 right-1 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">
                                                            {tutorial.duration}
                                                        </div>
                                                    </div>
                                                    <div className="flex-1">
                                                        <h3 className="font-semibold mb-1">{tutorial.title}</h3>
                                                        <p className="text-sm text-muted-foreground mb-3">{tutorial.description}</p>
                                                        <div className="flex items-center justify-between">
                                                            <Badge variant="outline" className="text-xs capitalize">
                                                                {tutorial.category.replace("-", " ")}
                                                            </Badge>
                                                            <Button size="sm" onClick={() => handleWatchTutorial(tutorial)}>
                                                                <PlayCircle className="h-4 w-4 mr-2" />
                                                                Watch
                                                            </Button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </CardContent>
                                        </Card>
                                    ))}
                                </div>
                            </TabsContent>

                            <TabsContent value="messages" className="space-y-4">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-serif font-semibold">Messages</h2>
                                    {unreadMessages > 0 && <Badge variant="secondary">{unreadMessages} unread</Badge>}
                                </div>
                                <MessagesPanel studentId={profile.id} teacherName={teacherName} />
                            </TabsContent>
                        </Tabs>
                    </div>

                    {/* Announcement Alert */}
                    <div className="space-y-4">
                        {latestAnnouncement && (
                            <Card className="border-indigo-200 bg-indigo-50 dark:bg-indigo-900/10 shadow-sm">
                                <CardContent className="p-4 space-y-2">
                                    <div className="flex items-center gap-2 text-indigo-700 dark:text-indigo-300">
                                        <Megaphone className="h-4 w-4 shrink-0" />
                                        <h3 className="font-semibold text-sm">{latestAnnouncement.subject}</h3>
                                    </div>
                                    <p className="text-sm text-indigo-600/80 dark:text-indigo-300/70 whitespace-pre-wrap leading-relaxed">
                                        {latestAnnouncement.body}
                                    </p>
                                    <p className="text-xs text-indigo-400">
                                        Posted {new Date(latestAnnouncement.created_at).toLocaleDateString('en-US', {
                                            month: 'short',
                                            day: 'numeric',
                                            year: 'numeric'
                                        })}
                                    </p>
                                </CardContent>
                            </Card>
                        )}

                        {/* Lesson & Credits History */}
                        <h2 className="text-2xl font-serif font-semibold">Lesson & Credits History</h2>
                        <div className="space-y-3">
                            {completedLessons.length === 0 ? (
                                <Card>
                                    <CardContent className="text-center py-8">
                                        <p className="text-muted-foreground">No completed lessons yet</p>
                                    </CardContent>
                                </Card>
                            ) : (
                                completedLessons.slice(0, 15).map((lesson) => (
                                    <Card key={lesson.id} className="hover:shadow-sm transition-shadow">
                                        <CardContent className="p-4 space-y-2">
                                            {/* Date */}
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <Music className="h-4 w-4 text-muted-foreground" />
                                                    <span className="text-sm font-medium">
                                                        {formatDate(lesson.date)}
                                                    </span>
                                                </div>
                                                <span className="text-xs text-muted-foreground">
                                                    {formatTime(lesson.time)}
                                                </span>
                                            </div>

                                            {/* Credit trail */}
                                            {(lesson.credit_snapshot !== undefined && lesson.credit_snapshot !== null) && (
                                                <div className="flex items-center gap-1.5 text-xs bg-muted/50 rounded px-2 py-1.5">
                                                    <span className="text-muted-foreground font-medium">Credits:</span>
                                                    <span className="font-mono font-semibold">
                                                        {(lesson as any).credit_snapshot_before ?? '?'}
                                                    </span>
                                                    <span className="text-muted-foreground">â†’</span>
                                                    <span className="text-red-500 font-mono font-semibold">-1</span>
                                                    <span className="text-muted-foreground">â†’</span>
                                                    <span className="font-mono font-semibold">
                                                        {lesson.credit_snapshot}
                                                    </span>
                                                </div>
                                            )}

                                            {/* Teacher notes */}
                                            {lesson.teacher_notes && (
                                                <p className="text-xs text-muted-foreground leading-relaxed line-clamp-2">
                                                    {lesson.teacher_notes}
                                                </p>
                                            )}
                                        </CardContent>
                                    </Card>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            </main>

            {/* Modals */}
            <MakeupScheduler
                open={showMakeupScheduler}
                onOpenChange={setShowMakeupScheduler}
                lessonId={nextLesson?.id}
                onSuccess={() => window.location.reload()}
            />

            <CancellationModal
                open={showCancellationModal}
                onOpenChange={setShowCancellationModal}
                onConfirm={handleConfirmCancel}
                isLoading={isCancelling}
                lesson={nextLesson || undefined}
            />

            {selectedLesson && (
                <LessonDetailModal
                    lesson={selectedLesson}
                    open={showLessonDetail}
                    onOpenChange={setShowLessonDetail}
                />
            )}

            <PurchaseCreditsModal open={showPurchaseModal} onOpenChange={setShowPurchaseModal} />

            <ChatWidget
                studentId={profile.id}
                unreadCount={unreadMessages}
                teacherName={teacherName}
            />

            <EventSignupModal
                event={selectedEvent}
                studentName={profile.name || "Student"}
                open={showEventSignup}
                onOpenChange={setShowEventSignup}
                onConfirm={handleSignupConfirm}
            />
        </div>
    )
}
</file>

<file path="app/actions/lessons.ts">
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'
import { Resend } from 'resend'
import { LessonScheduledEmail } from '@/components/emails/lesson-scheduled-email'
import { LessonCanceledEmail } from '@/components/emails/lesson-canceled-email'
import { LessonRescheduledEmail } from '@/components/emails/lesson-rescheduled-email'
import { createGoogleCalendarEvent } from '@/lib/google-calendar'
import { addDays, format } from 'date-fns'

// Initialize Resend
const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null

/**
 * Check if a time slot is available (not booked by ANY student)
 */
export async function checkAvailability(date: string, time: string, duration: number = 60, excludeLessonId?: string) {
    const supabase = await createClient()

    // Calculate end time of the proposed slot
    const startDateTime = new Date(`${date}T${time}`)
    const endDateTime = new Date(startDateTime.getTime() + duration * 60000)

    // We need to check for overlaps. 
    // A lesson overlaps if:
    // (StartA < EndB) AND (EndA > StartB)

    // Simplified: Check for exact match first (most common case in grid system)
    // For a real grid system, we usually stick to fixed slots.
    // Querying for *overlapping* intervals in SQL is cleaner but 'time' is stored as string 'HH:MM'.
    // So we fetch lessons on that date and filter in JS for overlap to be safe and simple given the schema.

    const { data: lessons } = await supabase
        .from('lessons')
        .select('id, time, duration, status')
        .eq('date', date)
        .neq('status', 'cancelled') // Cancelled lessons don't block

    if (!lessons) return true

    const isTaken = lessons.some(lesson => {
        if (excludeLessonId && lesson.id === excludeLessonId) return false

        const lessonStart = new Date(`${date}T${lesson.time}`)
        const lessonDuration = lesson.duration || 60
        const lessonEnd = new Date(lessonStart.getTime() + lessonDuration * 60000)

        // Check overlap
        const overlaps = (startDateTime < lessonEnd) && (endDateTime > lessonStart)
        return overlaps
    })

    return !isTaken
}

/**
 * Get all lessons within a specific date range (inclusive), joined with student profile
 */
export async function getLessonsForDateRange(startDate: string, endDate: string) {
    const supabase = await createClient()

    // Fetch lessons
    const { data: lessons, error: lessonsError } = await supabase
        .from('lessons')
        .select(`
            *,
            student:profiles!lessons_student_id_fkey (
                id,
                name,
                email
            )
        `)
        .gte('date', startDate)
        .lte('date', endDate)
        .neq('status', 'cancelled')
        .order('date', { ascending: true })
        .order('time', { ascending: true })

    if (lessonsError) {
        console.error('Error fetching lessons range:', lessonsError)
    }

    // Fetch events
    // converting startDate/endDate strings to ISO for comparison if needed, 
    // but Postgres matches string YYYY-MM-DD against timestamptz often fine. 
    // Safest is to explicitly cast or use range.
    // Events have 'start_time' (timestamptz).
    const startIso = `${startDate}T00:00:00`
    const endIso = `${endDate}T23:59:59`

    const { data: events, error: eventsError } = await supabase
        .from('events')
        .select(`
            *,
            event_invites (
                student_id,
                status,
                updated_at,
                student_notes,
                profiles (
                   name
                )
            )
        `)
        .gte('start_time', startIso)
        .lte('start_time', endIso)
        .order('start_time', { ascending: true })

    if (eventsError) {
        console.error('Error fetching events range:', eventsError)
    }

    return {
        lessons: lessons || [],
        events: events || []
    }
}

/**
 * Log a completed lesson - updates status to 'completed' and deducts 1 credit
 * Email notification is sent asynchronously (fire-and-forget) to not block the save
 */
export async function logLesson(
    lessonId: string,
    notes: string,
    videoUrl?: string,
    sheetMusicUrl?: string
) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can log lessons' }
    }

    // Get the lesson to find the student_id and date
    const { data: lesson, error: lessonFetchError } = await supabase
        .from('lessons')
        .select('student_id, status, date, time, duration, zoom_link')
        .eq('id', lessonId)
        .single()

    if (lessonFetchError || !lesson) {
        return { error: 'Lesson not found' }
    }

    const isAlreadyCompleted = lesson.status === 'completed'
    console.log('logLesson: Starting update', { lessonId, notes: notes?.substring(0, 50), isAlreadyCompleted })

    // STEP 1: Update the lesson in database FIRST (critical path)
    const { error: lessonError } = await supabase
        .from('lessons')
        .update({
            status: 'completed',
            notes,
            video_url: videoUrl || null,
            sheet_music_url: sheetMusicUrl || null
        })
        .eq('id', lessonId)

    if (lessonError) {
        console.error('logLesson: Update failed', lessonError)
        return { error: lessonError.message }
    }

    console.log('logLesson: Database update successful')

    // STEP 2: Deduct 1 credit ONLY if it wasn't already completed
    // Also save the new balance as credit_snapshot for receipt display
    if (!isAlreadyCompleted) {
        const { data: studentCredits } = await supabase
            .from('profiles')
            .select('credits')
            .eq('id', lesson.student_id)
            .single()

        if (studentCredits) {
            const startingBalance = studentCredits.credits
            const newBalance = startingBalance - 1

            // Update student's credit balance
            await supabase
                .from('profiles')
                .update({ credits: newBalance })
                .eq('id', lesson.student_id)

            // Save both snapshots: before and after
            await supabase
                .from('lessons')
                .update({
                    credit_snapshot_before: startingBalance,
                    credit_snapshot: newBalance
                })
                .eq('id', lessonId)

            console.log('logLesson: Credit deducted, snapshot saved:', startingBalance, '->', newBalance)
        }
    }

    // STEP 3: Auto-create next week's lesson (only on first completion)
    if (!isAlreadyCompleted && lesson.date && lesson.time) {
        try {
            const currentLessonDate = new Date(`${lesson.date}T00:00:00`)
            const nextWeekDate = addDays(currentLessonDate, 7)
            const nextWeekDateStr = format(nextWeekDate, 'yyyy-MM-dd')

            // Check if a lesson already exists for this student on that date
            const { data: existingLesson } = await supabase
                .from('lessons')
                .select('id')
                .eq('student_id', lesson.student_id)
                .eq('date', nextWeekDateStr)
                .neq('status', 'cancelled')
                .maybeSingle()

            if (!existingLesson) {
                const { error: createError } = await supabase
                    .from('lessons')
                    .insert({
                        student_id: lesson.student_id,
                        date: nextWeekDateStr,
                        time: lesson.time,
                        duration: lesson.duration || 60,
                        status: 'scheduled',
                        zoom_link: lesson.zoom_link || null,
                    })

                if (createError) {
                    console.error('logLesson: Auto-create next lesson failed:', createError)
                } else {
                    console.log(`logLesson: Auto-created next lesson for ${nextWeekDateStr} at ${lesson.time}`)
                }
            } else {
                console.log(`logLesson: Lesson already exists for ${nextWeekDateStr}, skipping auto-create`)
            }
        } catch (autoCreateError) {
            console.error('logLesson: Auto-create next lesson error:', autoCreateError)
        }
    }

    // STEP 4: Revalidate paths immediately so UI updates
    revalidatePath('/admin')
    revalidatePath('/student')

    // STEP 4: Fire-and-forget email (async IIFE, not awaited)
    // This ensures the function returns success immediately
    if (resend) {
        (async () => {
            try {
                // Fetch student details for email
                const { data: student } = await supabase
                    .from('profiles')
                    .select('name, email')
                    .eq('id', lesson.student_id)
                    .single()

                if (!student?.email) {
                    console.log('logLesson: No student email, skipping notification')
                    return
                }

                // Dynamic import to avoid client bundler issues
                const { LessonLoggedEmail } = await import('@/components/emails/lesson-logged-email')

                // Format date nicely
                const dateObj = new Date(`${lesson.date}T00:00:00`)
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                })

                // Extract sheet music filename from URL
                let sheetMusicFileName: string | undefined
                if (sheetMusicUrl) {
                    try {
                        const url = new URL(sheetMusicUrl)
                        const pathname = decodeURIComponent(url.pathname)
                        const filename = pathname.split('/').pop() || 'Sheet Music.pdf'
                        sheetMusicFileName = filename.replace(/^\d{10,}_/, '')
                    } catch {
                        sheetMusicFileName = 'Sheet Music.pdf'
                    }
                }

                await resend.emails.send({
                    from: 'Lionel Yu Piano Studio <notifications@updates.musicalbasics.com>',
                    to: student.email,
                    subject: `Lesson Notes: ${formattedDate}`,
                    react: LessonLoggedEmail({
                        studentName: student.name || 'Student',
                        date: formattedDate,
                        notes: notes,
                        sheetMusicUrl: sheetMusicUrl || undefined,
                        sheetMusicFileName
                    })
                })
                console.log('logLesson: Email sent to', student.email)
            } catch (emailError) {
                console.error('logLesson: Email failed (non-blocking):', emailError)
                // Don't throw - this is fire-and-forget
            }
        })()
    }

    console.log('logLesson: Returning success')
    return { success: true }
}


/**
 * Log a past lesson directly (ad-hoc) without scheduling it first
 * Creates a lesson with status 'completed' and deducts 1 credit
 */
export async function logPastLesson(
    studentId: string,
    date: string,
    time: string,
    duration: number = 60,
    notes: string,
    videoUrl?: string,
    sheetMusicUrl?: string
) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()
    // Verify student exists and get credits
    const { data: student, error: studentError } = await supabase
        .from('profiles')
        .select('name, credits, email')
        .eq('id', studentId)
        .eq('role', 'student')
        .single()

    if (studentError || !student) {
        return { error: 'Student not found' }
    }

    // Create the completed lesson
    const { data: newLesson, error: createError } = await supabase
        .from('lessons')
        .insert({
            student_id: studentId,
            date,
            time,
            duration,
            status: 'completed',
            notes,
            video_url: videoUrl || null,
            sheet_music_url: sheetMusicUrl || null
        })
        .select()
        .single()

    if (createError) {
        return { error: createError.message }
    }

    // Deduct 1 credit and save snapshots
    if (student) {
        const startingBalance = student.credits
        const newBalance = startingBalance - 1

        const { error: creditError } = await supabase
            .from('profiles')
            .update({ credits: newBalance })
            .eq('id', studentId)

        if (creditError) {
            console.error('Failed to deduct credit after logging lesson:', creditError)
        }

        // Save credit snapshots to the lesson
        if (newLesson) {
            await supabase
                .from('lessons')
                .update({
                    credit_snapshot_before: startingBalance,
                    credit_snapshot: newBalance
                })
                .eq('id', newLesson.id)

            console.log('logPastLesson: Credit snapshot saved:', startingBalance, '->', newBalance)
        }
    }

    // Auto-create next week's lesson
    if (date && time) {
        try {
            const currentLessonDate = new Date(`${date}T00:00:00`)
            const nextWeekDate = addDays(currentLessonDate, 7)
            const nextWeekDateStr = format(nextWeekDate, 'yyyy-MM-dd')

            const { data: existingLesson } = await supabase
                .from('lessons')
                .select('id')
                .eq('student_id', studentId)
                .eq('date', nextWeekDateStr)
                .neq('status', 'cancelled')
                .maybeSingle()

            if (!existingLesson) {
                await supabase
                    .from('lessons')
                    .insert({
                        student_id: studentId,
                        date: nextWeekDateStr,
                        time: time,
                        duration: duration || 60,
                        status: 'scheduled',
                    })
                console.log(`logPastLesson: Auto-created next lesson for ${nextWeekDateStr} at ${time}`)
            }
        } catch (autoCreateError) {
            console.error('logPastLesson: Auto-create next lesson error:', autoCreateError)
        }
    }

    revalidatePath('/admin')
    revalidatePath('/student')

    // Fire-and-forget email (async IIFE)
    if (resend) {
        (async () => {
            try {
                // Dynamic import to avoid client bundler issues
                const { LessonLoggedEmail } = await import('@/components/emails/lesson-logged-email')

                // Format date nicely
                const dateObj = new Date(`${date}T00:00:00`)
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                })

                // Extract sheet music filename from URL
                let sheetMusicFileName: string | undefined
                if (sheetMusicUrl) {
                    try {
                        const url = new URL(sheetMusicUrl)
                        const pathname = decodeURIComponent(url.pathname)
                        const filename = pathname.split('/').pop() || 'Sheet Music.pdf'
                        sheetMusicFileName = filename.replace(/^\d{10,}_/, '')
                    } catch {
                        sheetMusicFileName = 'Sheet Music.pdf'
                    }
                }

                await resend.emails.send({
                    from: 'Lionel Yu Piano Studio <notifications@updates.musicalbasics.com>',
                    to: student.email,
                    subject: `Lesson Notes: ${formattedDate}`,
                    react: LessonLoggedEmail({
                        studentName: student.name || 'Student',
                        date: formattedDate,
                        notes: notes,
                        sheetMusicUrl: sheetMusicUrl || undefined,
                        sheetMusicFileName
                    })
                })
                console.log('logPastLesson: Email sent to', student.email)
            } catch (emailError) {
                console.error('logPastLesson: Email failed (non-blocking):', emailError)
            }
        })()
    }

    return {
        success: true,
        message: `Lesson logged for ${student.name}. Credit deducted.`
    }
}

/**
 * Mark a lesson as no-show - updates status and deducts 1 credit (penalty)
 */
export async function markNoShow(lessonId: string) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can mark no-shows' }
    }

    // Get the lesson to find the student_id
    const { data: lesson, error: lessonFetchError } = await supabase
        .from('lessons')
        .select('student_id, status')
        .eq('id', lessonId)
        .single()

    if (lessonFetchError || !lesson) {
        return { error: 'Lesson not found' }
    }

    if (lesson.status !== 'scheduled') {
        return { error: 'Can only mark scheduled lessons as no-show' }
    }

    // Update the lesson status
    const { error: lessonError } = await supabase
        .from('lessons')
        .update({
            status: 'cancelled',
            notes: 'Marked as No-Show by teacher. Credit forfeited.'
        })
        .eq('id', lessonId)

    if (lessonError) {
        return { error: lessonError.message }
    }

    // Deduct 1 credit from the student (penalty - no refund)
    const { data: student } = await supabase
        .from('profiles')
        .select('credits')
        .eq('id', lesson.student_id)
        .single()

    if (student) {
        await supabase
            .from('profiles')
            .update({ credits: student.credits - 1 })
            .eq('id', lesson.student_id)
    }

    revalidatePath('/admin')
    revalidatePath('/student')
    return { success: true }
}

/**
 * Cancel a lesson - refunds credit only if cancelled >24 hours in advance
 * Uses admin client to bypass RLS for updates
 */
export async function cancelLesson(lessonId: string) {
    const supabase = await createClient()

    // Get current user
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    // Get the lesson
    const { data: lesson, error: lessonFetchError } = await supabase
        .from('lessons')
        .select('student_id, date, time, status')
        .eq('id', lessonId)
        .single()

    if (lessonFetchError || !lesson) {
        return { error: 'Lesson not found' }
    }

    // Get zoom_meeting_id if exists (fetch it)
    const { data: lessonDetails } = await supabase
        .from('lessons')
        .select('zoom_meeting_id')
        .eq('id', lessonId)
        .single()
    const zoomMeetingId = lessonDetails?.zoom_meeting_id

    // Verify user owns this lesson or is admin
    const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    const isAdmin = profile?.role === 'admin'
    const isOwner = lesson.student_id === user.id

    if (!isAdmin && !isOwner) {
        return { error: 'You can only cancel your own lessons' }
    }

    // CRITICAL: Check if already cancelled to prevent duplicate refunds
    if (lesson.status === 'cancelled') {
        return { error: 'This lesson has already been cancelled' }
    }

    if (lesson.status !== 'scheduled' && !isAdmin) {
        return { error: 'Can only cancel scheduled lessons' }
    }

    const { createClient: createAdminClient } = await import('@supabase/supabase-js')
    const supabaseAdmin = createAdminClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    )

    // Check if lesson is more than 24 hours away (use local time)
    const timeStr = lesson.time || '12:00'
    const lessonDateTime = new Date(`${lesson.date}T${timeStr}:00`)
    const now = new Date()
    const hoursUntilLesson = (lessonDateTime.getTime() - now.getTime()) / (1000 * 60 * 60)
    const isWithin24Hours = hoursUntilLesson > 0 && hoursUntilLesson < 24

    // IMPORTANT: If ADMIN cancels, they override the 24-hour rule (always refund unless they mark no-show)
    // If OWNER cancels, they are subject to 24-hour rule
    const shouldRefund = isAdmin || !isWithin24Hours

    // Step 1: DELETE the lesson row (prevents duplicate cancellation)
    const { error: deleteError } = await supabaseAdmin
        .from('lessons')
        .delete()
        .eq('id', lessonId)

    if (deleteError) {
        console.error('Delete lesson error:', deleteError)
        return { error: 'Failed to cancel lesson: ' + deleteError.message }
    }

    // Attempt to delete from Zoom
    if (zoomMeetingId) {
        try {
            const { deleteZoomMeeting } = await import('@/lib/zoom')
            const deleted = await deleteZoomMeeting(zoomMeetingId)
            if (deleted) console.log(`Zoom meeting ${zoomMeetingId} deleted.`)
        } catch (e) {
            console.error('Failed to delete Zoom meeting:', e)
        }
    }

    console.log(`Lesson ${lessonId} deleted. Refund: ${shouldRefund}`)

    // Send Cancellation Email
    if (resend) {
        try {
            // Fetch student email if not already present
            const { data: student } = await supabase
                .from('profiles')
                .select('name, email')
                .eq('id', lesson.student_id)
                .single()

            if (student?.email) {
                // Get Admin params
                const { data: adminProfile } = await supabase
                    .from('profiles')
                    .select('name, studio_name')
                    .eq('id', user.id)
                    .single()

                const studioName = adminProfile?.studio_name || 'Lionel Yu Piano Studio'

                // Format Date/Time
                const dateObj = new Date(`${lesson.date}T00:00:00`)
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                })

                const [hours, minutes] = (lesson.time || '12:00').split(':')
                const hourNum = parseInt(hours, 10)
                const ampm = hourNum >= 12 ? 'pm' : 'am'
                const hour12 = hourNum % 12 || 12
                const formattedTime = `${hour12}:${minutes}${ampm} PST`

                await resend.emails.send({
                    from: `${studioName} <notifications@updates.musicalbasics.com>`,
                    to: student.email,
                    subject: `Lesson Canceled: ${formattedDate} at ${formattedTime}`,
                    react: LessonCanceledEmail({
                        studentName: student.name || 'Student',
                        date: formattedDate,
                        time: formattedTime,
                        recipientName: student.name || 'Student',
                        studioName
                    })
                })
                console.log('Cancellation email sent to:', student.email)
            }
        } catch (emailError) {
            console.error('Failed to send cancellation email:', emailError)
        }
    }

    // Step 2: Revalidate paths to refresh UI
    revalidatePath('/admin')
    revalidatePath('/student')

    return {
        success: true,
        refunded: false,
        message: 'Lesson cancelled.'
    }
}

/**
 * Reschedule a lesson (admin only)
 * This updates the date/time of an existing lesson WITHOUT changing credit balance
 */
export async function rescheduleLesson(
    lessonId: string,
    newDate: string,
    newTime: string,
    newDuration: number = 60
) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can reschedule lessons' }
    }

    // Get the existing lesson
    const { data: lesson, error: lessonFetchError } = await supabase
        .from('lessons')
        .select('student_id, date, time')
        .eq('id', lessonId)
        .single()

    if (lessonFetchError || !lesson) {
        return { error: 'Lesson not found' }
    }

    // Fetch existing meeting ID
    const { data: lessonWithZoom } = await supabase
        .from('lessons')
        .select('zoom_meeting_id')
        .eq('id', lessonId)
        .single()

    // CONFLICT CHECK: Master Calendar
    const isAvailable = await checkAvailability(newDate, newTime, newDuration, lessonId)
    if (!isAvailable) {
        return { error: 'This time slot is already booked by another student.' }
    }

    // Update the lesson
    const { error: updateError } = await supabase
        .from('lessons')
        .update({
            date: newDate,
            time: newTime,
            duration: newDuration,
            // Status remains 'scheduled'
        })
        .eq('id', lessonId)

    if (updateError) {
        return { error: updateError.message }
    }

    // Update Zoom Meeting
    if (lessonWithZoom?.zoom_meeting_id) {
        try {
            const { updateZoomMeeting } = await import('@/lib/zoom')
            // Construct ISO time
            const startDateTime = `${newDate}T${newTime}:00`
            // Fetch student name for the topic if we haven't already (we need it for the email anyway)
            const { data: studentForZoom } = await supabase
                .from('profiles')
                .select('name')
                .eq('id', lesson.student_id)
                .single()

            const topic = studentForZoom?.name
                ? `${studentForZoom.name} - Piano Lesson`
                : 'Piano Lesson'

            await updateZoomMeeting(
                lessonWithZoom.zoom_meeting_id,
                topic,
                startDateTime,
                newDuration
            )
            console.log(`Zoom meeting ${lessonWithZoom.zoom_meeting_id} updated.`)
        } catch (e) {
            console.error('Failed to update Zoom meeting:', e)
        }
    }

    // Send Reschedule Email
    if (resend) {
        try {
            const { data: student } = await supabase
                .from('profiles')
                .select('name, email')
                .eq('id', lesson.student_id)
                .single()

            if (student?.email) {
                const { data: adminProfile } = await supabase
                    .from('profiles')
                    .select('name, studio_name')
                    .eq('id', user.id)
                    .single()

                const studioName = adminProfile?.studio_name || 'Lionel Yu Piano Studio'

                // Helper for formatting
                const formatDate = (d: string) => new Date(`${d}T00:00:00`).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
                const formatTime = (t: string) => {
                    const [h, m] = t.split(':')
                    const hn = parseInt(h, 10)
                    const ap = hn >= 12 ? 'pm' : 'am'
                    const h12 = hn % 12 || 12
                    return `${h12}:${m}${ap} PST`
                }

                const oldDateStr = formatDate(lesson.date)
                const oldTimeStr = formatTime(lesson.time)
                const newDateStr = formatDate(newDate)
                const newTimeStr = formatTime(newTime)

                await resend.emails.send({
                    from: `${studioName} <notifications@updates.musicalbasics.com>`,
                    to: student.email,
                    subject: `Lesson Rescheduled: ${newDateStr} at ${newTimeStr}`,
                    react: LessonRescheduledEmail({
                        studentName: student.name || 'Student',
                        oldDate: oldDateStr,
                        oldTime: oldTimeStr,
                        newDate: newDateStr,
                        newTime: newTimeStr,
                        newDuration: newDuration,
                        recipientName: student.name || 'Student',
                        studioName
                    })
                })
                console.log('Reschedule email sent to:', student.email)
            }
        } catch (emailError) {
            console.error('Failed to send reschedule email:', emailError)
        }
    }

    revalidatePath('/admin')
    revalidatePath('/student')

    return { success: true, message: 'Lesson rescheduled successfully' }
}

/**
 * Purchase credits (mock - no Stripe integration for testing)
 */
export async function purchaseCredits(credits: number) {
    const supabase = await createClient()

    // Get current user
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    // Get current profile
    const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('credits, credits_total')
        .eq('id', user.id)
        .single()

    if (profileError || !profile) {
        return { error: 'Profile not found' }
    }

    // Add credits
    const newCredits = profile.credits + credits
    const newTotal = profile.credits_total + credits

    const { error: updateError } = await supabase
        .from('profiles')
        .update({
            credits: newCredits,
            credits_total: newTotal
        })
        .eq('id', user.id)

    if (updateError) {
        return { error: updateError.message }
    }

    revalidatePath('/student')
    revalidatePath('/admin')

    return {
        success: true,
        newCredits,
        message: `Successfully added ${credits} credit${credits > 1 ? 's' : ''} to your account!`
    }
}

/**
 * Schedule a new lesson (admin only)
 */
export async function scheduleLesson(
    studentId: string,
    date: string,
    time: string,
    duration: number = 60
) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can schedule lessons' }
    }

    // Verify student exists
    const { data: student, error: studentError } = await supabase
        .from('profiles')
        .select('id, name, email, parent_email')
        .eq('id', studentId)
        .eq('role', 'student')
        .single()

    if (studentError || !student) {
        return { error: 'Student not found' }
    }

    // CONFLICT CHECK: Master Calendar
    const isAvailable = await checkAvailability(date, time, duration)
    if (!isAvailable) {
        return { error: 'This time slot is already booked by another student.' }
    }

    // Create Zoom meeting (Best Effort with Fallback)
    let zoomLink = null
    let zoomMeetingId = null

    try {
        const { createZoomMeeting } = await import('@/lib/zoom')
        // Format start time for Zoom: "YYYY-MM-DDTHH:MM:SS"
        const startDateTime = `${date}T${time}:00`
        const inviteeEmails = [student.email, student.parent_email].filter(Boolean) as string[]
        const zoomData = await createZoomMeeting(
            `${student.name} - Piano Lesson`,
            startDateTime,
            duration,
            inviteeEmails
        )
        if (zoomData) {
            zoomLink = zoomData.join_url
            zoomMeetingId = zoomData.id
            console.log('Zoom meeting created successfully:', zoomLink, zoomMeetingId)
        }
    } catch (zoomError) {
        console.error('Dynamic Zoom creation failed:', zoomError)
    }

    // Fallback: If dynamic generation failed (or returned null), try to use the Admin's static link
    if (!zoomLink) {
        console.log('Falling back to static Zoom link logic...')
        // Fetch Admin Profile to get static zoom_link
        const { data: adminProfile } = await supabase
            .from('profiles')
            .select('zoom_link')
            .eq('id', user.id)
            .single()

        if (adminProfile?.zoom_link) {
            zoomLink = adminProfile.zoom_link
            console.log('Using fallback static Zoom link:', zoomLink)
        } else {
            console.warn('No fallback Zoom link found in admin profile.')
        }
    }

    // --- NEW: Google Calendar Integration ---
    let googleEventId = null
    try {
        // Use the student name we fetched earlier
        const studentName = student.name || 'Student'

        console.log("ðŸ“… Creating Google Calendar Event...")
        googleEventId = await createGoogleCalendarEvent(
            studentName,
            date,
            time,
            duration
        )
    } catch (e) {
        console.error('Failed to create Google Event (Non-blocking):', e)
    }
    // ----------------------------------------

    // Prepare insert payload logic
    const lessonPayload: any = {
        student_id: studentId,
        date,
        time,
        status: 'scheduled',
        zoom_link: zoomLink,
        zoom_meeting_id: zoomMeetingId,
        google_event_id: googleEventId
    }

    // Initialize result variables
    let lesson = null
    let lessonError = null

    // We try to insert duration if the column exists (it's in Schema but check robustly)
    // The previous code had a retry block for duration, I will adapt it.

    const { data: lessonData, error: insertError } = await supabase
        .from('lessons')
        .insert({
            ...lessonPayload,
            duration,
            google_event_id: googleEventId
        })
        .select()
        .single()

    if (insertError) {
        // Fallback retry logic (e.g. if duration column is missing, though we think it is there)
        console.log('Insert with duration failed, trying without:', insertError.message)
        const { data: retryData, error: retryError } = await supabase
            .from('lessons')
            .insert(lessonPayload) // Still try saving zoom_link
            .select()
            .single()

        lesson = retryData
        lessonError = retryError
    } else {
        lesson = lessonData
    }

    if (lessonError) {
        // If it failed again, maybe zoom_link column is missing? 
        // Realistically we shoudln't blindly retry everything but preserving existing retry logic structure.
        console.error('Schedule lesson error:', lessonError)
        return { error: lessonError.message }
    }

    // CREDIT DEDUCTION REMOVED per requirements.
    // Credits are now only deducted when a lesson is logged (completed) or marked no-show.

    // Send Email Notifications
    console.log('Attempting to send email notifications...')
    console.log('Resend initialized:', !!resend)
    console.log('Student Email:', student.email)

    if (resend && student.email) {
        try {
            // Get Admin Profile for studio name (or use default)
            const { data: adminProfile } = await supabase
                .from('profiles')
                .select('name, studio_name')
                .eq('id', user.id)
                .single()

            const studioName = adminProfile?.studio_name || 'Lionel Yu Piano Studio'
            const rawName = adminProfile?.name || 'Teacher'
            const adminName = rawName === 'Professor Lionel' ? 'Professor Lionel Yu' : rawName

            // Format Date and Time for Email
            // Input date: YYYY-MM-DD
            // Input time: HH:MM (24h)
            const dateObj = new Date(`${date}T00:00:00`)
            const formattedDate = dateObj.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) // e.g., "Saturday, December 14, 2025" or we can construct manually to match user exact request "December 14, 2025"

            // Should strictly follow "December 14, 2025" as requested?
            // User said: "date should be December 14, 2025"
            const formattedDateStrict = dateObj.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            })

            // Format Time: 20:00 -> 8:00pm
            const [hours, minutes] = time.split(':')
            const hourNum = parseInt(hours, 10)
            const ampm = hourNum >= 12 ? 'pm' : 'am'
            const hour12 = hourNum % 12 || 12
            const formattedTime = `${hour12}:${minutes}${ampm} PST` // Adding PST as requested. Ideally dynamic but hardcoded for now is safer for exact request.

            const emailSubject = `Lesson Scheduled for ${student.name} on ${formattedDateStrict} at ${formattedTime}`

            // Email to Student
            console.log('Sending email to student:', student.email)
            const studentEmailResult = await resend.emails.send({
                from: `${studioName} <notifications@updates.musicalbasics.com>`,
                to: student.email,
                subject: emailSubject,
                react: LessonScheduledEmail({
                    studentName: student.name || 'Student',
                    date: formattedDateStrict,
                    time: formattedTime,
                    duration,
                    zoomLink,
                    recipientName: student.name || 'Student',
                    studioName
                })
            })
            console.log('Student email result:', studentEmailResult)

            // Email to Teacher (Confirmation)
            // We use user.email which is the admin's email since they are the one scheduling
            console.log('User (Teacher) Email:', user.email)
            if (user.email) {
                const teacherEmailResult = await resend.emails.send({
                    from: `${studioName} <notifications@updates.musicalbasics.com>`,
                    to: user.email,
                    subject: emailSubject,
                    react: LessonScheduledEmail({
                        studentName: student.name || 'Student',
                        date: formattedDateStrict,
                        time: formattedTime,
                        duration,
                        zoomLink,
                        recipientName: adminName,
                        studioName
                    })
                })
                console.log('Teacher email result:', teacherEmailResult)
            } else {
                console.warn('Teacher email not found (user.email is null)')
            }

            console.log(`Emails sent for lesson: ${date} ${time}`)

        } catch (emailError) {
            console.error('Failed to send email notifications:', emailError)
            // Don't block success return
        }
    }

    revalidatePath('/admin')
    revalidatePath('/student')

    return {
        success: true,
        lesson,
        message: `Lesson scheduled for ${student.name} on ${date} at ${time} (${duration} min)${zoomLink ? '. Zoom link created.' : '.'}`
    }
}

/**
 * Update a lesson (notes, video_url, sheet_music_url)
 * Sends email notification with updated info (fire-and-forget)
 */
export async function updateLesson(
    lessonId: string,
    notes: string,
    videoUrl?: string,
    sheetMusicUrl?: string
) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can update lessons' }
    }

    // Get the lesson to find student_id and date for email
    const { data: lesson, error: fetchError } = await supabase
        .from('lessons')
        .select('student_id, date')
        .eq('id', lessonId)
        .single()

    if (fetchError || !lesson) {
        return { error: 'Lesson not found' }
    }

    // Update the lesson
    const { error: lessonError } = await supabase
        .from('lessons')
        .update({
            notes,
            video_url: videoUrl || null,
            sheet_music_url: sheetMusicUrl || null
        })
        .eq('id', lessonId)

    if (lessonError) {
        return { error: lessonError.message }
    }

    console.log('updateLesson: Database update successful')

    // Revalidate paths immediately
    revalidatePath('/admin')
    revalidatePath('/student')

    // Fire-and-forget email notification
    if (resend) {
        (async () => {
            try {
                // Fetch student details
                const { data: student } = await supabase
                    .from('profiles')
                    .select('name, email')
                    .eq('id', lesson.student_id)
                    .single()

                if (!student?.email) {
                    console.log('updateLesson: No student email, skipping notification')
                    return
                }

                // Dynamic import to avoid client bundler issues
                const { LessonLoggedEmail } = await import('@/components/emails/lesson-logged-email')

                // Format date
                const dateObj = new Date(`${lesson.date}T00:00:00`)
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                })

                // Extract sheet music filename from URL
                let sheetMusicFileName: string | undefined
                if (sheetMusicUrl) {
                    try {
                        const url = new URL(sheetMusicUrl)
                        const pathname = decodeURIComponent(url.pathname)
                        const filename = pathname.split('/').pop() || 'Sheet Music.pdf'
                        // Remove timestamp prefix if present
                        sheetMusicFileName = filename.replace(/^\d{10,}_/, '')
                    } catch {
                        sheetMusicFileName = 'Sheet Music.pdf'
                    }
                }

                await resend.emails.send({
                    from: 'Lionel Yu Piano Studio <notifications@updates.musicalbasics.com>',
                    to: student.email,
                    subject: `Lesson Notes Updated: ${formattedDate}`,
                    react: LessonLoggedEmail({
                        studentName: student.name || 'Student',
                        date: formattedDate,
                        notes: notes,
                        sheetMusicUrl: sheetMusicUrl || undefined,
                        sheetMusicFileName
                    })
                })
                console.log('updateLesson: Email sent to', student.email)
            } catch (emailError) {
                console.error('updateLesson: Email failed (non-blocking):', emailError)
            }
        })()
    }

    return { success: true, message: 'Lesson updated successfully' }
}


/**
 * Upload a file to Supabase Storage
 */
export async function uploadFile(formData: FormData) {
    const supabase = await createClient()

    // Verify user is admin
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { error: 'Unauthorized' }
    }

    const { data: adminProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

    if (adminProfile?.role !== 'admin') {
        return { error: 'Only admins can upload files' }
    }

    const file = formData.get('file') as File
    if (!file) {
        return { error: 'No file provided' }
    }

    const fileExt = file.name.split('.').pop()
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`
    const filePath = `lesson-materials/${fileName}`

    const { data, error } = await supabase.storage
        .from('lesson-materials')
        .upload(filePath, file)

    if (error) {
        console.error('Upload error:', error)
        return { error: error.message }
    }

    // Get public URL
    const { data: { publicUrl } } = supabase.storage
        .from('lesson-materials')
        .getPublicUrl(filePath)

    return { success: true, url: publicUrl, path: data.path }
}


/**
 * Confirm attendance for a lesson (student only)
 * Updates is_confirmed to true
 * Uses admin client to bypass RLS
 */
export async function confirmAttendance(lessonId: string) {
    const supabase = await createClient()

    // Verify the user is authenticated and owns this lesson
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
        return { success: false, error: 'Unauthorized' }
    }

    // Use admin client to bypass RLS
    const { createClient: createAdminClient } = await import('@supabase/supabase-js')
    const supabaseAdmin = createAdminClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_KEY!
    )

    const { error } = await supabaseAdmin
        .from('lessons')
        .update({ is_confirmed: true })
        .eq('id', lessonId)
        .eq('student_id', user.id) // Security: only update if student owns the lesson

    if (error) {
        console.error('Confirmation error:', error)
        return { success: false, error: 'Failed to confirm attendance' }
    }

    revalidatePath('/student')
    return { success: true }
}

// Helper to get the next occurrence of a specific day of week
function getNextDayOfWeek(date: Date, dayName: string) {
    const dayOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
        .indexOf(dayName);
    const resultDate = new Date(date.getTime());
    resultDate.setDate(date.getDate() + (7 + dayOfWeek - date.getDay()) % 7);

    // If result is today, move to next week (assuming "Next" means future)
    if (resultDate.toDateString() === date.toDateString()) {
        resultDate.setDate(resultDate.getDate() + 7);
    }
    return resultDate;
}

export async function bulkScheduleLessons(studentId: string, count: number) {
    const supabase = await createClient()

    // 1. Fetch Student's Standard Slot
    const { data: student } = await supabase
        .from('profiles')
        .select('name, lesson_day, lesson_time, lesson_duration')
        .eq('id', studentId)
        .single()

    if (!student || !student.lesson_day || !student.lesson_time) {
        return { error: "Student does not have a standard day/time set." }
    }

    let successes = 0
    let failures = 0
    let lastDate = new Date() // Start calculating from today

    // 2. Loop 'count' times
    for (let i = 0; i < count; i++) {
        // Find next date
        const nextDateObj = getNextDayOfWeek(lastDate, student.lesson_day)

        // Fix: Use local date components to avoid timezone shifts (e.g. 8pm PST -> Next Day UTC)
        const year = nextDateObj.getFullYear()
        const month = String(nextDateObj.getMonth() + 1).padStart(2, '0')
        const day = String(nextDateObj.getDate()).padStart(2, '0')
        const dateStr = `${year}-${month}-${day}`

        // Call your existing scheduler (handles conflicts, Google Cal, Zoom, Email)
        const result = await scheduleLesson(
            studentId,
            dateStr,
            student.lesson_time,
            student.lesson_duration || 60
        )

        if (result.success) {
            successes++
        } else {
            failures++
            console.error(`Failed to schedule ${dateStr}:`, result.error)
        }

        // Advance cursor so next iteration finds the week after
        lastDate = nextDateObj
        // Small hack: add 1 day so getNextDayOfWeek doesn't find the same day again
        lastDate.setDate(lastDate.getDate() + 1)
    }

    return {
        success: true,
        message: `Scheduled ${successes} lessons. ${failures > 0 ? `(${failures} failed due to conflicts)` : ''}`
    }
}
</file>

<file path="components/admin/admin-dashboard.tsx">
"use client"
import { ScheduledTab } from "@/components/admin/scheduled-tab"
import { CompletedTab } from "@/components/admin/completed-tab"
import { RosterTab } from "@/components/admin/roster-tab"
import { InquiriesTab } from "@/components/admin/inquiries-tab"
import { AnnouncementTab } from "@/components/admin/announcement-tab"
import { MasterCalendar } from "./master-calendar"
import { ProfileSettingsDialog } from "@/components/profile-settings-dialog"
import React, { useState, useRef, Suspense, useMemo } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Separator } from "@/components/ui/separator"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Clock, Calendar, MessageCircle, LayoutDashboard, Plus, Loader2, Video, FileText, Pencil, Music, ShieldAlert, Star, Mail, DollarSign, Megaphone } from "lucide-react"
import { AdminChat } from "./admin-chat"
import { PricingManager } from "@/components/admin/pricing-manager"
import { PricingPlan } from "@/app/actions/pricing"
import { logout } from "@/app/login/actions"
import { logLesson, markNoShow, scheduleLesson, updateLesson, bulkScheduleLessons } from "@/app/actions/lessons"
import { useToast } from "@/hooks/use-toast"
import { uploadSheetMusic } from "@/app/actions/uploads"
import { deleteStudent } from "@/app/actions/users"
import { deleteEvent, type AdminEvent } from "@/app/actions/events"
import { sendManualReminder } from "@/app/actions/reminders"
import { CreateEventModal } from "@/components/admin/create-event-modal"
import type { Profile, Lesson } from "@/lib/supabase/database.types"
import type { Resource } from "@/app/actions/resources"
import type { CalendarLesson } from "./master-calendar"
import { DashboardTab } from "@/components/admin/dashboard-tab"
import type { LessonWithStudent, TodayLesson, StudentRoster, Inquiry } from "@/types/admin"

// Re-export types for compatibility if used elsewhere (e.g. page.tsx)
export type { LessonWithStudent, TodayLesson, StudentRoster, Inquiry }

type SortKey = 'name' | 'lesson_day' | 'credits'
type SortDirection = 'asc' | 'desc'
interface SortConfig {
    key: SortKey
    direction: SortDirection
}

export interface AdminDashboardProps {
    admin: Profile
    // todaysLessons removed - derived from scheduledLessons
    scheduledLessons: LessonWithStudent[]
    completedLessons: LessonWithStudent[]
    students: StudentRoster[]
    totalUnread: number
    inquiries: Inquiry[]
    resources: Resource[]
    pricingPlans: PricingPlan[]
}

export function AdminDashboard({ admin, scheduledLessons, completedLessons, students, totalUnread, inquiries, resources, pricingPlans }: AdminDashboardProps) {
    const { toast } = useToast()

    const [isMounted, setIsMounted] = useState(false)

    // Handle hydration mismatch by waiting for mount
    React.useEffect(() => {
        setIsMounted(true)
    }, [])

    // Client-side date calculation for robust timezone handling
    // We want YYYY-MM-DD in local time
    const now = new Date()
    const year = now.getFullYear()
    const month = String(now.getMonth() + 1).padStart(2, '0')
    const day = String(now.getDate()).padStart(2, '0')
    const todayStr = `${year}-${month}-${day}`

    // Derive Today's Lessons from the superset
    // Note: scheduleLessons from server should include "yesterday" (UTC) to safely cover "today" (PST)
    const todaysLessons = scheduledLessons
        .filter(l => l.date === todayStr)
        .map(l => ({ ...l, student: l.student })) // Ensure shape matches TodayLesson if needed

    // Filter "Upcoming" to likely show today + future
    const upcomingLessons = scheduledLessons.filter(l => l.date >= todayStr)


    const [showLogLessonModal, setShowLogLessonModal] = useState(false)
    const [showScheduleModal, setShowScheduleModal] = useState(false)
    const [showEditModal, setShowEditModal] = useState(false)
    const [selectedLesson, setSelectedLesson] = useState<TodayLesson | null>(null)
    const [editingLesson, setEditingLesson] = useState<LessonWithStudent | null>(null)
    const [selectedStudent, setSelectedStudent] = useState<StudentRoster | null>(null)
    const [selectedStudentForLog, setSelectedStudentForLog] = useState<StudentRoster | null>(null)
    const [lessonNotes, setLessonNotes] = useState("")
    const [videoUrl, setVideoUrl] = useState("")
    const [sheetMusicUrl, setSheetMusicUrl] = useState("")
    const [scheduleDate, setScheduleDate] = useState("")
    const [scheduleTime, setScheduleTime] = useState("15:00")
    const [scheduleDuration, setScheduleDuration] = useState<number>(60)
    const [isRescheduling, setIsRescheduling] = useState(false)
    const [rescheduleLessonId, setRescheduleLessonId] = useState<string | null>(null)
    const [logDate, setLogDate] = useState("")
    const [logTime, setLogTime] = useState("12:00")
    const [logDuration, setLogDuration] = useState<number>(60)
    const [isLoading, setIsLoading] = useState(false)
    const [isUploading, setIsUploading] = useState(false)
    const [showEventModal, setShowEventModal] = useState(false)
    const [editingEvent, setEditingEvent] = useState<AdminEvent | null>(null)
    const [calendarVersion, setCalendarVersion] = useState(0)
    const fileInputRef = useRef<HTMLInputElement>(null)

    const editFileInputRef = useRef<HTMLInputElement>(null)

    // Manual Reminder State
    const [showReminderModal, setShowReminderModal] = useState(false)
    const [lessonForReminder, setLessonForReminder] = useState<TodayLesson | null>(null)



    // State for Active Tab and Chat Selection
    const [activeTab, setActiveTab] = useState("dashboard")
    const [chatStudentId, setChatStudentId] = useState<string | null>(null)

    const handleJumpToMessage = (studentId: string) => {
        setChatStudentId(studentId)
        setActiveTab("messages")
    }

    const handleLogLesson = (lesson: TodayLesson) => {
        setSelectedLesson(lesson)
        setSelectedStudentForLog(null)
        setVideoUrl(lesson.video_url || '')
        setSheetMusicUrl(lesson.sheet_music_url || '')
        setLessonNotes(lesson.notes || '')
        setShowLogLessonModal(true)
    }

    const handleLogPastLesson = (student: StudentRoster) => {
        setSelectedStudentForLog(student)
        setSelectedLesson(null)
        // Set default date to today
        const today = new Date().toISOString().split('T')[0]
        setLogDate(today)
        setLogTime("12:00")
        setLogDuration(60)
        setShowLogLessonModal(true)
    }

    const handleSaveLesson = async () => {
        console.log('handleSaveLesson started', { selectedLesson, selectedStudentForLog })
        if (!selectedLesson && !selectedStudentForLog) return

        setIsLoading(true)

        let result;

        try {
            if (selectedLesson) {
                console.log('Calling logLesson', selectedLesson.id)
                result = await logLesson(
                    selectedLesson.id,
                    lessonNotes,
                    videoUrl || undefined,
                    sheetMusicUrl || undefined
                )
            } else if (selectedStudentForLog) {
                console.log('Calling logPastLesson', selectedStudentForLog.id)
                // Import dynamically to handle the new action
                const { logPastLesson } = await import("@/app/actions/lessons")
                result = await logPastLesson(
                    selectedStudentForLog.id,
                    logDate,
                    logTime,
                    logDuration,
                    lessonNotes,
                    videoUrl || undefined,
                    sheetMusicUrl || undefined
                )
            }
        } catch (e) {
            console.error('Error calling lesson action:', e)
            toast({
                variant: "destructive",
                title: "Error",
                description: "An unexpected error occurred"
            })
            setIsLoading(false)
            return
        }

        console.log('Action result:', result)
        setIsLoading(false)

        if (result?.error) {
            console.log('Showing error toast')
            toast({
                variant: "destructive",
                title: "Error",
                description: result.error
            })
        } else {
            console.log('Success, closing modal')

            // Auto-schedule check for Roster Log
            let autoScheduleMsg = ""
            if (selectedStudentForLog && selectedStudentForLog.lesson_day && selectedStudentForLog.lesson_time) {
                try {
                    console.log('Attempting auto-schedule for', selectedStudentForLog.name)
                    const scheduleRes = await bulkScheduleLessons(selectedStudentForLog.id, 1)
                    if (!scheduleRes.error) {
                        autoScheduleMsg = " Next lesson scheduled."
                    }
                } catch (err) {
                    console.error('Auto-schedule failed', err)
                }
            }

            toast({
                title: "Lesson Logged",
                description: `Successfully logged lesson. Credit deducted.${autoScheduleMsg}`
            })
            setShowLogLessonModal(false)
            setLessonNotes("")
            setVideoUrl("")
            setSheetMusicUrl("")
            setSelectedLesson(null)
            setSelectedStudentForLog(null)
            setCalendarVersion(v => v + 1)
        }
    }

    const handleMarkNoShow = async (lesson: TodayLesson) => {
        if (confirm(`Mark ${lesson.student.name} as No - Show ? This will deduct 1 credit without refund or makeup option.`)) {
            setIsLoading(true)
            const result = await markNoShow(lesson.id)
            setIsLoading(false)

            if (result.error) {
                toast({
                    variant: "destructive",
                    title: "Error",
                    description: result.error
                })
            } else {
                toast({
                    title: "No-Show Recorded",
                    description: `${lesson.student.name} marked as No - Show.Credit forfeited.`
                })
            }
        }
    }

    const handleOpenSchedule = (student: StudentRoster) => {
        setSelectedStudent(student)

        // Autofill date from student's recurring lesson day
        if (student.lesson_day) {
            const dayMap: Record<string, number> = {
                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                'Thursday': 4, 'Friday': 5, 'Saturday': 6
            }
            const targetDay = dayMap[student.lesson_day]
            if (targetDay !== undefined) {
                const today = new Date()
                const currentDay = today.getDay()
                let daysUntil = targetDay - currentDay
                if (daysUntil < 0) daysUntil += 7 // Pick today if it matches, otherwise next occurrence
                const nextDate = new Date(today)
                nextDate.setDate(today.getDate() + daysUntil)
                setScheduleDate(nextDate.toISOString().split('T')[0])
            } else {
                const tomorrow = new Date()
                tomorrow.setDate(tomorrow.getDate() + 1)
                setScheduleDate(tomorrow.toISOString().split('T')[0])
            }
        } else {
            const tomorrow = new Date()
            tomorrow.setDate(tomorrow.getDate() + 1)
            setScheduleDate(tomorrow.toISOString().split('T')[0])
        }

        // Autofill time and duration from student defaults
        setScheduleTime(student.lesson_time || "15:00")
        setScheduleDuration((student as any).lesson_duration || 60)
        setIsRescheduling(false)
        setRescheduleLessonId(null)
        setShowScheduleModal(true)
    }

    const openNewSchedule = () => {
        setSelectedStudent(null)
        const tomorrow = new Date()
        tomorrow.setDate(tomorrow.getDate() + 1)
        setScheduleDate(tomorrow.toISOString().split('T')[0])
        setScheduleTime("15:00")
        setScheduleDuration(60)
        setIsRescheduling(false)
        setRescheduleLessonId(null)
        setShowScheduleModal(true)
    }

    const handleReschedule = (lesson: LessonWithStudent) => {
        // Pre-fill modal with lesson details
        setIsRescheduling(true)
        setRescheduleLessonId(lesson.id)

        // Find the student object from the roster to ensure we have the full StudentRoster object if possible,
        // otherwise construct a minimal one or use the lesson.student
        const studentFromRoster = students.find(s => s.id === lesson.student_id)
        // We need a StudentRoster object (Profile + last_lesson_date), but lesson.student is just Profile.
        // Casting is safe enough here since we mainly need id and name for display/logic
        setSelectedStudent(studentFromRoster || (lesson.student as StudentRoster))

        setScheduleDate(lesson.date)
        setScheduleTime(lesson.time)
        setScheduleDuration(lesson.duration || 60)

        setShowScheduleModal(true)
    }

    const handleCancelLesson = async (lessonId: string, studentName: string) => {
        if (confirm(`Are you sure you want to cancel the lesson for ${studentName} ? The student will be fully refunded.`)) {
            setIsLoading(true)
            // Import dynamically or pass as prop if import fails, but since this is client component in app router we can use server actions directly
            const { cancelLesson } = await import("@/app/actions/lessons")

            const result = await cancelLesson(lessonId)
            setIsLoading(false)

            if (result.error) {
                toast({
                    variant: "destructive",
                    title: "Cancellation Failed",
                    description: result.error
                })
            } else {
                toast({
                    title: "Lesson Cancelled",
                    description: result.message
                })
                setCalendarVersion(v => v + 1)
            }
        }
    }

    const handleScheduleSubmit = async () => {
        if (!selectedStudent || !scheduleDate || !scheduleTime) return

        setIsLoading(true)

        if (isRescheduling && rescheduleLessonId) {
            // Import dynamically to avoid circular dependencies if any (though unlikely here)
            const { rescheduleLesson } = await import("@/app/actions/lessons")
            const result = await rescheduleLesson(rescheduleLessonId, scheduleDate, scheduleTime, scheduleDuration)

            if (result.error) {
                toast({
                    variant: "destructive",
                    title: "Rescheduling Failed",
                    description: result.error
                })
            } else {
                toast({
                    title: "Lesson Rescheduled",
                    description: result.message
                })
                setShowScheduleModal(false)
                setSelectedStudent(null)
                setIsRescheduling(false)
                setRescheduleLessonId(null)
                setCalendarVersion(v => v + 1)
            }
        } else {
            const result = await scheduleLesson(selectedStudent.id, scheduleDate, scheduleTime, scheduleDuration)

            if (result.error) {
                toast({
                    variant: "destructive",
                    title: "Scheduling Failed",
                    description: result.error
                })
            } else {
                toast({
                    title: "Lesson Scheduled",
                    description: result.message
                })
                setShowScheduleModal(false)
                setSelectedStudent(null)
                setCalendarVersion(v => v + 1)
            }
        }
        setIsLoading(false)
    }

    const handleEditLesson = (lesson: LessonWithStudent) => {
        setEditingLesson(lesson)
        setLessonNotes(lesson.notes || '')
        setVideoUrl(lesson.video_url || '')
        setSheetMusicUrl(lesson.sheet_music_url || '')
        setShowEditModal(true)
    }

    const handleSaveEdit = async () => {
        if (!editingLesson) return

        setIsLoading(true)
        const result = await updateLesson(
            editingLesson.id,
            lessonNotes,
            videoUrl,
            sheetMusicUrl
        )
        setIsLoading(false)

        if (result.error) {
            toast({
                variant: "destructive",
                title: "Update Failed",
                description: result.error
            })
        } else {
            toast({
                title: "Lesson Updated",
                description: result.message
            })
            setShowEditModal(false)
            setEditingLesson(null)
            setLessonNotes('')
            setVideoUrl('')
            setSheetMusicUrl('')
            setCalendarVersion(v => v + 1)
        }
    }

    const handleDeleteStudent = async (student: StudentRoster) => {
        if (confirm(`Are you sure you want to remove ${student.name}? This will delete all data associated with the student.`)) {
            setIsLoading(true)
            const result = await deleteStudent(student.id)
            setIsLoading(false)

            if (result.error) {
                toast({
                    variant: "destructive",
                    title: "Delete Failed",
                    description: result.error
                })
            } else {
                toast({
                    title: "Student Removed",
                    description: result.message
                })
                // Usually the revalidatePath in action handles refresh, but if not we might need router.refresh()
            }
        }
    }

    const handleEditEvent = (event: AdminEvent) => {
        setEditingEvent(event)
        setShowEventModal(true)
    }

    const handleDeleteEvent = async (event: AdminEvent) => {
        if (confirm(`Are you sure you want to delete "${event.title}"? This will remove all student invites.`)) {
            setIsLoading(true)
            const result = await deleteEvent(event.id)
            setIsLoading(false)

            if (!result.success) {
                toast({
                    variant: "destructive",
                    title: "Delete Failed",
                    description: result.error || "Unknown error"
                })
            } else {
                toast({
                    title: "Event Deleted",
                    description: "Event and invites have been removed."
                })
                setCalendarVersion(v => v + 1)
            }
        }
    }

    const onEditCalendarLesson = (lesson: CalendarLesson) => {
        // Fork in the Road Logic:
        // Future -> Reschedule
        // Past -> Log/Complete

        const now = new Date()
        const lessonDate = new Date(`${lesson.date}T${lesson.time}`) // ISO string for comparison

        if (lessonDate < now) {
            // Past: Open Log Lesson Modal
            // Adapt CalendarLesson to TodayLesson (needs 'student' as Profile)
            // We create a minimal Profile object sufficient for display
            const minimalStudentProfile: any = {
                id: lesson.student_id,
                name: lesson.student?.name || 'Unknown',
                email: lesson.student?.email || '',
                // Other fields are not critical for Log Modal display
                credits: 0,
            }

            const todayLessonAdapter: TodayLesson = {
                ...lesson,
                student: minimalStudentProfile,
                status: 'scheduled', // or 'completed' if we are re-logging? But usually it's 'scheduled' if it's on calendar
            } as any

            handleLogLesson(todayLessonAdapter)
        } else {
            // Future: Open Reschedule Modal
            const lessonWithId = { ...lesson } as any
            handleReschedule(lessonWithId)
        }
    }

    const onDeleteCalendarLesson = (lesson: CalendarLesson) => {
        const studentName = lesson.student?.name || 'Student'
        handleCancelLesson(lesson.id, studentName)
    }

    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>, isEdit = false) => {
        const file = e.target.files?.[0]
        if (!file) return

        if (!file.name.endsWith('.pdf')) {
            toast({
                variant: "destructive",
                title: "Invalid File",
                description: "Please upload a PDF file"
            })
            return
        }

        const lessonId = isEdit ? editingLesson?.id : selectedLesson?.id

        if (!lessonId && selectedStudentForLog) {
            toast({
                variant: "destructive",
                title: "Upload not supported yet",
                description: "Please save the lesson first, then edit it to upload materials."
            })
            return
        }

        if (!lessonId) {
            toast({
                variant: "destructive",
                title: "Upload Failed",
                description: "No lesson selected (save the lesson first)"
            })
            return
        }

        setIsUploading(true)

        try {
            // Prepare FormData for Server Action
            const formData = new FormData()
            formData.append('file', file)

            // Call Server Action
            const result = await uploadSheetMusic(formData, lessonId)

            if (result.error) {
                throw new Error(result.error)
            }

            if (result.url) {
                setSheetMusicUrl(result.url)
                toast({
                    title: "Upload Complete",
                    description: "PDF uploaded successfully"
                })
            }
        } catch (error) {
            console.error('Upload error:', error)
            toast({
                variant: "destructive",
                title: "Upload Failed",
                description: error instanceof Error ? error.message : "Unknown error occurred"
            })
        } finally {
            setIsUploading(false)
            if (isEdit && editFileInputRef.current) {
                editFileInputRef.current.value = ''
            } else if (fileInputRef.current) {
                fileInputRef.current.value = ''
            }
        }
    }

    const handleSendReminder = async (variant: '24h' | '2h' | '15m') => {
        if (!lessonForReminder) return
        setIsLoading(true)

        const result = await sendManualReminder(lessonForReminder.id, variant)

        setIsLoading(false)
        setShowReminderModal(false)

        if (result.error) {
            toast({ variant: "destructive", title: "Error", description: result.error })
        } else {
            toast({ title: "Email Sent", description: result.message })
        }
    }

    // Format time for display (HH:MM:SS -> h:mm AM/PM)
    const formatTime = (timeStr: string) => {
        const [hours, minutes] = timeStr.split(':').map(Number)
        const ampm = hours >= 12 ? 'PM' : 'AM'
        const displayHours = hours % 12 || 12
        return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`
    }

    // Format date for display
    const formatDate = (dateStr: string) => {
        const date = new Date(dateStr + 'T00:00:00')
        return date.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
        })
    }

    // Prevent hydration mismatch by not rendering until mounted
    if (!isMounted) {
        return null
    }

    return (
        <div className="min-h-screen bg-background">
            {/* Header */}
            <header className="border-b bg-card sticky top-0 z-10">
                <div className="container mx-auto px-4 py-4">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="h-10 w-10 bg-primary rounded-full flex items-center justify-center">
                                <Music className="h-5 w-5 text-primary-foreground" />
                            </div>
                            <div>
                                <h1 className="text-xl font-serif font-semibold">{admin.studio_name || "Teacher Admin Portal"}</h1>
                                <p className="text-sm text-muted-foreground">{admin.name || 'Admin'}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <Button variant="outline" asChild>
                                <a href="/admin/events" className="gap-2">
                                    <Calendar className="h-4 w-4" />
                                    Events
                                </a>
                            </Button>
                            <Button variant="outline" asChild>
                                <a href="/admin/library" className="gap-2">
                                    <FileText className="h-4 w-4" />
                                    Library
                                </a>
                            </Button>
                            <Button variant="outline" asChild>
                                <a href="/admin/editor2" className="gap-2">
                                    <Pencil className="h-4 w-4" />
                                    Site Builder
                                </a>
                            </Button>
                            <Button variant="outline" asChild>
                                <a href="/admin/logs" className="gap-2">
                                    <ShieldAlert className="h-4 w-4" />
                                    Logs
                                </a>
                            </Button>
                            <Button variant="outline" asChild>
                                <a href="/admin/reviews" className="gap-2">
                                    <Star className="h-4 w-4" />
                                    Reviews
                                </a>
                            </Button>
                            <ProfileSettingsDialog
                                profile={admin}
                                trigger={
                                    <Button variant="outline">
                                        Profile Settings
                                    </Button>
                                }
                            />
                            <form action={logout}>
                                <Button variant="ghost" type="submit">
                                    Sign Out
                                </Button>
                            </form>
                        </div>
                    </div>
                </div>
            </header>

            <main className="container mx-auto px-4 py-8">
                <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-8">
                    <TabsList className="w-full justify-start overflow-x-auto h-auto p-1">
                        <TabsTrigger value="dashboard" className="gap-2">
                            <LayoutDashboard className="h-4 w-4" />
                            <span className="hidden sm:inline">Today</span>
                        </TabsTrigger>
                        <TabsTrigger value="calendar" className="gap-2">
                            <Calendar className="h-4 w-4" />
                            <span className="hidden sm:inline">Calendar</span>
                        </TabsTrigger>
                        <TabsTrigger value="scheduled" className="gap-2">
                            <Clock className="h-4 w-4" />
                            <span className="hidden sm:inline">List</span>
                        </TabsTrigger>
                        <TabsTrigger value="completed" className="gap-2">
                            <Music className="h-4 w-4" />
                            <span className="hidden sm:inline">Completed</span>
                        </TabsTrigger>
                        <TabsTrigger value="messages" className="gap-2 relative">
                            <MessageCircle className="h-4 w-4" />
                            <span className="hidden sm:inline">Messages</span>
                            {totalUnread > 0 && (
                                <Badge
                                    variant="destructive"
                                    className="absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center text-xs"
                                >
                                    {totalUnread}
                                </Badge>
                            )}
                        </TabsTrigger>
                        <TabsTrigger value="inquiries" className="gap-2 relative">
                            <Mail className="h-4 w-4" />
                            <span className="hidden sm:inline">Inquiries</span>
                            {inquiries.filter(i => i.status === 'new').length > 0 && (
                                <Badge
                                    variant="destructive"
                                    className="absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center text-xs"
                                >
                                    {inquiries.filter(i => i.status === 'new').length}
                                </Badge>
                            )}
                        </TabsTrigger>
                        <TabsTrigger value="pricing" className="gap-2">
                            <DollarSign className="h-4 w-4" />
                            <span className="hidden sm:inline">Pricing</span>
                        </TabsTrigger>
                        <TabsTrigger value="announcements" className="gap-2">
                            <Megaphone className="h-4 w-4" />
                            <span className="hidden sm:inline">Announce</span>
                        </TabsTrigger>
                    </TabsList>

                    <TabsContent value="dashboard" className="space-y-8">
                        {/* Daily Schedule */}
                        <DashboardTab
                            lessons={todaysLessons}
                            adminZoomLink={admin.zoom_link}
                            onLog={handleLogLesson}
                            onReschedule={handleReschedule}
                            onNoShow={handleMarkNoShow}
                            onCancel={handleCancelLesson}
                            onRemind={(lesson) => {
                                setLessonForReminder(lesson)
                                setShowReminderModal(true)
                            }}
                            isLoading={isLoading}
                            onMessage={handleJumpToMessage}
                        />

                        {/* Student Roster */}
                        <RosterTab
                            students={students}
                            onLog={handleLogPastLesson}
                            onSchedule={handleOpenSchedule}
                            onDelete={handleDeleteStudent}
                            onMessage={handleJumpToMessage}
                            pricingPlans={pricingPlans}
                        />
                    </TabsContent>

                    {/* Scheduled Lessons Tab */}
                    <TabsContent value="scheduled" className="space-y-4">
                        <ScheduledTab
                            lessons={scheduledLessons}
                            adminZoomLink={admin.zoom_link || undefined}
                            onReschedule={handleReschedule}
                            onCancel={handleCancelLesson}
                            onScheduleNew={openNewSchedule}
                        />
                    </TabsContent>

                    {/* Completed Lessons Tab */}
                    <TabsContent value="completed" className="space-y-4">
                        <CompletedTab
                            lessons={completedLessons}
                            onEdit={handleEditLesson}
                        />
                    </TabsContent>

                    <TabsContent value="messages">
                        <AdminChat
                            initialStudentId={chatStudentId}
                            onClearInitialStudent={() => setChatStudentId(null)}
                        />
                    </TabsContent>

                    <TabsContent value="inquiries" className="m-0 h-full p-4 lg:p-10 overflow-auto">
                        <InquiriesTab inquiries={inquiries} />
                    </TabsContent>

                    <TabsContent value="pricing" className="p-4 lg:p-10">
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-2xl font-serif">Pricing Plans</CardTitle>
                                <CardDescription>Manage subscription plans and credit packages</CardDescription>
                            </CardHeader>
                            <CardContent>
                                <PricingManager initialPlans={pricingPlans} />
                            </CardContent>
                        </Card>
                    </TabsContent>

                    <TabsContent value="announcements" className="p-4 lg:p-10">
                        <AnnouncementTab students={students} />
                    </TabsContent>

                    <TabsContent value="calendar">
                        <Suspense fallback={
                            <div className="flex justify-center p-8">
                                <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                            </div>
                        }>
                            <Card>
                                <CardHeader>
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <CardTitle className="text-2xl font-serif">Master Calendar</CardTitle>
                                            <CardDescription>View all lessons and events</CardDescription>
                                        </div>
                                        <Button onClick={() => {
                                            setEditingEvent(null)
                                            setShowEventModal(true)
                                        }}>
                                            <Plus className="h-4 w-4 mr-2" />
                                            Create Event
                                        </Button>
                                    </div>
                                </CardHeader>
                                <CardContent>
                                    <MasterCalendar
                                        onEditLesson={onEditCalendarLesson}
                                        onDeleteLesson={onDeleteCalendarLesson}
                                        onEditEvent={handleEditEvent}
                                        onDeleteEvent={handleDeleteEvent}
                                        refreshTrigger={calendarVersion}
                                    />
                                </CardContent>
                            </Card>
                        </Suspense>
                    </TabsContent>
                </Tabs >
            </main >

            {/* Log Lesson Modal */}
            < Dialog open={showLogLessonModal} onOpenChange={setShowLogLessonModal} >
                <DialogContent className="sm:max-w-2xl">
                    <DialogHeader>
                        <DialogTitle className="text-2xl font-serif">Log Lesson</DialogTitle>
                        <DialogDescription>
                            Record notes and upload materials for {selectedLesson?.student.name || selectedStudentForLog?.name}
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-6 py-4">
                        {/* Date/Time selectors for Ad-Hoc Logging */}
                        {selectedStudentForLog && (
                            <div className="grid grid-cols-2 gap-4 border-b pb-4">
                                <div className="space-y-2">
                                    <Label htmlFor="log-date" className="text-base">Date</Label>
                                    <Input
                                        id="log-date"
                                        type="date"
                                        value={logDate}
                                        onChange={(e) => setLogDate(e.target.value)}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="log-time" className="text-base">Time</Label>
                                    <Input
                                        id="log-time"
                                        type="time"
                                        value={logTime}
                                        onChange={(e) => setLogTime(e.target.value)}
                                    />
                                </div>
                            </div>
                        )}


                        <div className="space-y-2">
                            <Label htmlFor="notes" className="text-base">
                                Teacher Notes
                            </Label>
                            <Textarea
                                id="notes"
                                placeholder="Enter your lesson notes, progress observations, and homework assignments..."
                                value={lessonNotes}
                                onChange={(e) => setLessonNotes(e.target.value)}
                                rows={6}
                                className="resize-none"
                            />
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="video" className="text-base">
                                Video Recording URL
                            </Label>
                            <Input
                                id="video"
                                type="url"
                                placeholder="https://storage.supabase.co/..."
                                value={videoUrl}
                                onChange={(e) => setVideoUrl(e.target.value)}
                            />
                            <p className="text-xs text-muted-foreground">Upload video to Supabase Storage and paste the URL here</p>
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="sheet-music" className="text-base">
                                Sheet Music PDF
                            </Label>
                            <div className="space-y-3">
                                {/* Library Selector */}
                                <div className="space-y-1">
                                    <Label className="text-xs text-muted-foreground">Select from Library</Label>
                                    <Select onValueChange={(url) => setSheetMusicUrl(url)}>
                                        <SelectTrigger>
                                            <SelectValue placeholder="Choose from Library..." />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {resources
                                                .filter(r => ['Sheet Music', 'Exercises', 'Theory'].includes(r.category))
                                                .map(resource => (
                                                    <SelectItem key={resource.id} value={resource.file_url}>
                                                        {resource.title} ({resource.category})
                                                    </SelectItem>
                                                ))}
                                        </SelectContent>
                                    </Select>
                                </div>

                                <div className="relative">
                                    <div className="absolute inset-0 flex items-center">
                                        <span className="w-full border-t" />
                                    </div>
                                    <div className="relative flex justify-center text-xs uppercase">
                                        <span className="bg-background px-2 text-muted-foreground">
                                            Or upload new
                                        </span>
                                    </div>
                                </div>

                                <div className="flex gap-2 items-center">
                                    <Input
                                        ref={fileInputRef}
                                        type="file"
                                        accept=".pdf"
                                        onChange={(e) => handleFileUpload(e, false)}
                                        className="flex-1"
                                        disabled={isUploading}
                                    />
                                    {isUploading && (
                                        <Loader2 className="h-4 w-4 animate-spin" />
                                    )}
                                </div>
                                <div className="text-xs text-muted-foreground">Or paste a URL directly:</div>
                                <Input
                                    type="url"
                                    placeholder="https://..."
                                    value={sheetMusicUrl}
                                    onChange={(e) => setSheetMusicUrl(e.target.value)}
                                />
                                {sheetMusicUrl && (
                                    <div className="flex items-center gap-2 text-sm text-green-600">
                                        <FileText className="h-4 w-4" />
                                        <a href={sheetMusicUrl} target="_blank" rel="noopener noreferrer" className="underline truncate max-w-xs">
                                            {resources.find(r => r.file_url === sheetMusicUrl)?.title || sheetMusicUrl.split('/').pop() || 'Sheet Music'}
                                        </a>
                                        <Button
                                            type="button"
                                            variant="ghost"
                                            size="sm"
                                            onClick={() => setSheetMusicUrl('')}
                                            className="h-6 px-2 text-red-500 hover:text-red-700"
                                        >
                                            Remove
                                        </Button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-3 justify-end">
                        <Button variant="outline" onClick={() => setShowLogLessonModal(false)} disabled={isLoading}>
                            Cancel
                        </Button>
                        <Button onClick={handleSaveLesson} disabled={isLoading}>
                            {isLoading ? 'Saving...' : 'Save Lesson'}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog >

            {/* Schedule Lesson Modal */}
            < Dialog open={showScheduleModal} onOpenChange={setShowScheduleModal} >
                <DialogContent className="sm:max-w-md">
                    <DialogHeader>
                        <DialogTitle className="text-2xl font-serif">
                            {isRescheduling ? 'Reschedule Lesson' : 'Schedule Lesson'}
                        </DialogTitle>
                        <DialogDescription>
                            {isRescheduling
                                ? `Update lesson details for ${selectedStudent?.name || 'Student'}`
                                : selectedStudent
                                    ? `Schedule a new lesson for ${selectedStudent.name}`
                                    : 'Select a student and choose lesson details'
                            }
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-4 py-4">
                        {/* Student Selector */}
                        <div className="space-y-2">
                            <Label htmlFor="student-select" className="text-base">
                                Student
                            </Label>
                            <select
                                id="student-select"
                                value={selectedStudent?.id || ''}
                                onChange={(e) => {
                                    const student = students.find(s => s.id === e.target.value)
                                    setSelectedStudent(student || null)
                                }}
                                className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                                disabled={isRescheduling}
                            >
                                <option value="">Select a student...</option>
                                {students.map((student) => (
                                    <option key={student.id} value={student.id}>
                                        {student.name} ({student.credits} credits)
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <Label htmlFor="date" className="text-base">
                                    Date
                                </Label>
                                <Input
                                    id="date"
                                    type="date"
                                    value={scheduleDate}
                                    onChange={(e) => setScheduleDate(e.target.value)}
                                    min={new Date().toISOString().split('T')[0]}
                                />
                            </div>
                            <div className="space-y-2">
                                <Label htmlFor="time" className="text-base">
                                    Time
                                </Label>
                                <Input
                                    id="time"
                                    type="time"
                                    value={scheduleTime}
                                    onChange={(e) => setScheduleTime(e.target.value)}
                                />
                            </div>
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="duration" className="text-base">
                                Duration (minutes)
                            </Label>
                            <select
                                id="duration"
                                value={scheduleDuration}
                                onChange={(e) => setScheduleDuration(Number(e.target.value))}
                                className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                            >
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">60 minutes</option>
                                <option value="90">90 minutes</option>
                            </select>
                        </div>
                    </div>

                    <div className="flex gap-3 justify-end">
                        <Button variant="outline" onClick={() => setShowScheduleModal(false)} disabled={isLoading}>
                            Cancel
                        </Button>
                        <Button onClick={handleScheduleSubmit} disabled={isLoading}>
                            {isLoading ? (
                                <>
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                    Saving...
                                </>
                            ) : (
                                isRescheduling ? 'Update Lesson' : 'Schedule Lesson'
                            )}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog >

            {/* Edit Lesson Modal */}
            < Dialog open={showEditModal} onOpenChange={setShowEditModal} >
                <DialogContent className="sm:max-w-2xl">
                    <DialogHeader>
                        <DialogTitle className="text-2xl font-serif">Edit Lesson</DialogTitle>
                        <DialogDescription>
                            Update lesson details for {editingLesson?.student.name}
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-6 py-4">
                        <div className="space-y-2">
                            <Label htmlFor="edit-notes" className="text-base">
                                Teacher Notes
                            </Label>
                            <Textarea
                                id="edit-notes"
                                placeholder="Enter your lesson notes, progress observations, and homework assignments..."
                                value={lessonNotes}
                                onChange={(e) => setLessonNotes(e.target.value)}
                                rows={6}
                                className="resize-none"
                            />
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="edit-video" className="text-base">
                                Video Recording URL
                            </Label>
                            <Input
                                id="edit-video"
                                type="url"
                                placeholder="https://..."
                                value={videoUrl}
                                onChange={(e) => setVideoUrl(e.target.value)}
                            />
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="edit-sheet-music" className="text-base">
                                Sheet Music PDF
                            </Label>
                            <div className="space-y-3">
                                {/* Library Selector */}
                                <div className="space-y-1">
                                    <Label className="text-xs text-muted-foreground">Select from Library</Label>
                                    <Select onValueChange={(url) => setSheetMusicUrl(url)}>
                                        <SelectTrigger>
                                            <SelectValue placeholder="Choose from Library..." />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {resources
                                                .filter(r => ['Sheet Music', 'Exercises', 'Theory'].includes(r.category))
                                                .map(resource => (
                                                    <SelectItem key={resource.id} value={resource.file_url}>
                                                        {resource.title} ({resource.category})
                                                    </SelectItem>
                                                ))}
                                        </SelectContent>
                                    </Select>
                                </div>

                                <div className="relative">
                                    <div className="absolute inset-0 flex items-center">
                                        <span className="w-full border-t" />
                                    </div>
                                    <div className="relative flex justify-center text-xs uppercase">
                                        <span className="bg-background px-2 text-muted-foreground">
                                            Or upload new
                                        </span>
                                    </div>
                                </div>

                                <div className="flex gap-2 items-center">
                                    <Input
                                        ref={editFileInputRef}
                                        type="file"
                                        accept=".pdf"
                                        onChange={(e) => handleFileUpload(e, true)}
                                        className="flex-1"
                                        disabled={isUploading}
                                    />
                                    {isUploading && (
                                        <Loader2 className="h-4 w-4 animate-spin" />
                                    )}
                                </div>
                                <div className="text-xs text-muted-foreground">Or paste a URL directly:</div>
                                <Input
                                    type="url"
                                    placeholder="https://..."
                                    value={sheetMusicUrl}
                                    onChange={(e) => setSheetMusicUrl(e.target.value)}
                                />
                                {sheetMusicUrl && (
                                    <div className="flex items-center gap-2 text-sm text-green-600">
                                        <FileText className="h-4 w-4" />
                                        <a href={sheetMusicUrl} target="_blank" rel="noopener noreferrer" className="underline truncate max-w-xs">
                                            {resources.find(r => r.file_url === sheetMusicUrl)?.title || sheetMusicUrl.split('/').pop() || 'Sheet Music'}
                                        </a>
                                        <Button
                                            type="button"
                                            variant="ghost"
                                            size="sm"
                                            onClick={() => setSheetMusicUrl('')}
                                            className="h-6 px-2 text-red-500 hover:text-red-700"
                                        >
                                            Remove
                                        </Button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-3 justify-end">
                        <Button variant="outline" onClick={() => setShowEditModal(false)} disabled={isLoading}>
                            Cancel
                        </Button>
                        <Button onClick={handleSaveEdit} disabled={isLoading}>
                            {isLoading ? (
                                <>
                                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                                    Saving...
                                </>
                            ) : (
                                <>
                                    <Pencil className="h-4 w-4 mr-2" />
                                    Save Changes
                                </>
                            )}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog >
            {/* Event Modal */}
            <CreateEventModal
                open={showEventModal}
                onOpenChange={setShowEventModal}
                eventToEdit={editingEvent}
                onEventCreated={() => {
                    // Refresh is handled by revalidatePath in action, but we might want to ensure state is clear
                    setEditingEvent(null)
                    setCalendarVersion(v => v + 1)
                }}
            />
            {/* Manual Reminder Modal */}
            <Dialog open={showReminderModal} onOpenChange={setShowReminderModal}>
                <DialogContent className="sm:max-w-sm">
                    <DialogHeader>
                        <DialogTitle>Send Reminder</DialogTitle>
                        <DialogDescription>
                            Manually trigger an email for {lessonForReminder?.student.name}
                        </DialogDescription>
                    </DialogHeader>
                    <div className="flex flex-col gap-3 py-4">
                        <Button
                            variant="default"
                            onClick={() => handleSendReminder('exact' as any)}
                            className="justify-start bg-blue-600 hover:bg-blue-700"
                        >
                            <Clock className="mr-2 h-4 w-4" />
                            Send "Exact Time Remaining"
                        </Button>

                        <Separator />

                        <Button variant="outline" onClick={() => handleSendReminder('24h')} className="justify-start">
                            <Clock className="mr-2 h-4 w-4" />
                            Send "Tomorrow" Reminder (24h)
                        </Button>
                        <Button variant="outline" onClick={() => handleSendReminder('2h')} className="justify-start">
                            <Clock className="mr-2 h-4 w-4" />
                            Send "Starting Soon" Reminder (2h)
                        </Button>
                        <Button variant="default" onClick={() => handleSendReminder('15m')} className="justify-start bg-green-600 hover:bg-green-700">
                            <Video className="mr-2 h-4 w-4" />
                            Send "Join Now" Link (Urgent)
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>
        </div >
    )
}
</file>

<file path="components/admin/roster-tab.tsx">
"use client"

import React, { useState, useMemo } from "react"
import { useRouter } from "next/navigation"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { AlertCircle, Upload, Plus, Trash2, ArrowUpDown, MessageCircle, MonitorPlay, CalendarClock, Loader2, Download, DollarSign, User } from "lucide-react"
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover"
import { bulkScheduleLessons } from "@/app/actions/lessons"
import { useToast } from "@/hooks/use-toast"

// We assume your Lesson App is hosted here (Change this if different!)
const CLASSROOM_URL = process.env.NEXT_PUBLIC_CLASSROOM_URL || "https://classroom.musicalbasics.com"
import type { StudentRoster } from "@/types/admin"
import { AddStudentModal } from "./add-student-modal"
import { ChargeStudentModal } from "./charge-student-modal"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { EditStudentModal } from "./edit-student-modal"
import { PricingPlan } from "@/app/actions/pricing"
import { StudentProfileSheet } from "./student-profile-sheet"

type SortKey = 'name' | 'lesson_day' | 'credits'
type SortDirection = 'asc' | 'desc'
interface SortConfig {
    key: SortKey
    direction: SortDirection
}

interface RosterTabProps {
    students: StudentRoster[]
    onLog: (student: StudentRoster) => void
    onSchedule: (student: StudentRoster) => void
    onDelete: (student: StudentRoster) => void
    onMessage: (studentId: string) => void
    pricingPlans: PricingPlan[]
}

function AutoScheduleButton({ student }: { student: StudentRoster }) {
    const { toast } = useToast()
    const router = useRouter()
    const [open, setOpen] = useState(false)
    const [isLoading, setIsLoading] = useState(false)

    if (!student.lesson_day || !student.lesson_time) return null

    return (
        <Popover open={open} onOpenChange={setOpen}>
            <PopoverTrigger asChild>
                <Button size="sm" variant="ghost" className="h-8 w-8 p-0 text-blue-600 hover:text-blue-700 hover:bg-blue-50">
                    {isLoading ? (
                        <Loader2 className="h-4 w-4 animate-spin" />
                    ) : (
                        <CalendarClock className="h-4 w-4" />
                    )}
                    <span className="sr-only">Auto-Schedule</span>
                </Button>
            </PopoverTrigger>
            <PopoverContent className="w-48 p-2" align="end">
                <div className="space-y-2">
                    <h4 className="font-medium text-xs text-muted-foreground uppercase tracking-wider px-2">
                        {student.lesson_day}s at {student.lesson_time}
                    </h4>
                    <div className="grid gap-1">
                        {[1, 2, 4].map((num) => (
                            <Button
                                key={num}
                                variant="ghost"
                                className="justify-start h-8 font-normal"
                                disabled={isLoading}
                                onClick={async () => {
                                    setIsLoading(true)
                                    toast({ title: "Scheduling...", description: "Please wait." })

                                    try {
                                        const res = await bulkScheduleLessons(student.id, num)
                                        if (res.error) {
                                            toast({ variant: "destructive", title: "Error", description: res.error })
                                        } else {
                                            toast({ title: "Done", description: res.message })
                                            setOpen(false) // Close the popover
                                            router.refresh()
                                        }
                                    } catch (e) {
                                        toast({ variant: "destructive", title: "Error", description: "Something went wrong" })
                                    } finally {
                                        setIsLoading(false)
                                    }
                                }}
                            >
                                Schedule Next {num}
                            </Button>
                        ))}
                    </div>
                </div>
            </PopoverContent>
        </Popover>
    )
}

export function RosterTab({ students, onLog, onSchedule, onDelete, onMessage, pricingPlans }: RosterTabProps) {
    const { toast } = useToast()
    const router = useRouter()
    const [sortConfig, setSortConfig] = useState<SortConfig>({ key: 'lesson_day', direction: 'asc' })

    const dayOrder: Record<string, number> = {
        'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
        'Thursday': 4, 'Friday': 5, 'Saturday': 6
    }

    // Helper to generate the Launcher Link
    const getClassroomLink = (student: StudentRoster) => {
        // We pass the ID. The Launcher (on the other app) handles the Auth.
        // We also pass metadata (name/email) just in case the cache is stale, 
        // ensuring the video interface always has the correct label.
        const params = new URLSearchParams({
            email: student.email || "",
            name: student.name || "",
        })
        return `${CLASSROOM_URL}/start/${student.id}?${params.toString()}`
    }

    const sortedStudents = useMemo(() => {
        return [...students].sort((a, b) => {
            const { key, direction } = sortConfig
            let comparison = 0

            if (key === 'name') {
                comparison = (a.name || '').localeCompare(b.name || '')
            } else if (key === 'lesson_day') {
                const dayA = a.lesson_day ? dayOrder[a.lesson_day] ?? 99 : 99
                const dayB = b.lesson_day ? dayOrder[b.lesson_day] ?? 99 : 99
                comparison = dayA - dayB
            } else if (key === 'credits') {
                comparison = (a.credits ?? 0) - (b.credits ?? 0)
            }

            return direction === 'asc' ? comparison : -comparison
        })
    }, [students, sortConfig])

    const handleSort = (key: SortKey) => {
        setSortConfig(prev => ({
            key,
            direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
        }))
    }

    return (
        <Card>
            <CardHeader>
                <div className="flex items-center justify-between">
                    <div>
                        <CardTitle className="text-2xl font-serif">Student Roster</CardTitle>
                        <CardDescription>Complete overview of all active students</CardDescription>
                    </div>
                    <div className="flex gap-2">
                        <Button variant="outline" onClick={() => {
                            const headers = ["Name", "Contact Email", "Weekday", "Credits"]
                            const csvContent = [
                                headers.join(","),
                                ...students.map(student => [
                                    `"${student.name || ''}"`,
                                    `"${student.email || ''}"`,
                                    `"${student.lesson_day || ''}"`,
                                    `"${student.credits}"`
                                ].join(","))
                            ].join("\n")

                            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" })
                            const link = document.createElement("a")
                            const url = URL.createObjectURL(blob)
                            link.setAttribute("href", url)
                            link.setAttribute("download", `student_roster_${new Date().toISOString().split('T')[0]}.csv`)
                            document.body.appendChild(link)
                            link.click()
                            document.body.removeChild(link)
                        }}>
                            <Download className="h-4 w-4 mr-2" />
                            Export CSV
                        </Button>
                        <AddStudentModal />
                    </div>
                </div>
            </CardHeader>
            <CardContent>
                <Tabs defaultValue="active" className="space-y-4">
                    <div className="flex items-center justify-between">
                        <TabsList>
                            <TabsTrigger value="active">Active</TabsTrigger>
                            <TabsTrigger value="inactive">Inactive</TabsTrigger>
                        </TabsList>
                    </div>

                    <TabsContent value="active" className="space-y-4">
                        <div className="rounded-md border">
                            <StudentTable
                                students={sortedStudents.filter(s => !s.status || s.status === 'active')}
                                sortConfig={sortConfig}
                                handleSort={handleSort}
                                onLog={onLog}
                                onSchedule={onSchedule}
                                onDelete={onDelete}
                                onMessage={onMessage}
                                getClassroomLink={getClassroomLink}
                                pricingPlans={pricingPlans}
                            />
                        </div>
                    </TabsContent>

                    <TabsContent value="inactive" className="space-y-4">
                        <div className="rounded-md border">
                            <StudentTable
                                students={sortedStudents.filter(s => s.status === 'inactive')}
                                sortConfig={sortConfig}
                                handleSort={handleSort}
                                onLog={onLog}
                                onSchedule={onSchedule}
                                onDelete={onDelete}
                                onMessage={onMessage}
                                getClassroomLink={getClassroomLink}
                                pricingPlans={pricingPlans}
                            />
                        </div>
                    </TabsContent>
                </Tabs>
            </CardContent>
        </Card>
    )
}

function StudentTable({
    students,
    sortConfig,
    handleSort,
    onLog,
    onSchedule,
    onDelete,
    onMessage,
    getClassroomLink,
    pricingPlans
}: {
    students: StudentRoster[]
    sortConfig: SortConfig
    handleSort: (key: SortKey) => void
    onLog: (student: StudentRoster) => void
    onSchedule: (student: StudentRoster) => void
    onDelete: (student: StudentRoster) => void
    onMessage: (studentId: string) => void
    getClassroomLink: (student: StudentRoster) => string
    pricingPlans: PricingPlan[]
}) {
    const [chargeStudent, setChargeStudent] = useState<StudentRoster | null>(null)
    const [profileStudent, setProfileStudent] = useState<StudentRoster | null>(null)

    return (
        <>
            <Table>
                <TableHeader>
                    <TableRow>
                        <TableHead className="w-[50px]"></TableHead>
                        <TableHead className="font-semibold">
                            <Button variant="ghost" size="sm" className="-ml-3 h-8 gap-1" onClick={() => handleSort('name')}>
                                Name
                                <ArrowUpDown className={`h-4 w-4 ${sortConfig.key === 'name' ? 'opacity-100' : 'opacity-40'}`} />
                            </Button>
                        </TableHead>
                        <TableHead className="font-semibold">Contact</TableHead>
                        <TableHead className="font-semibold">
                            <Button variant="ghost" size="sm" className="-ml-3 h-8 gap-1" onClick={() => handleSort('lesson_day')}>
                                Weekday
                                <ArrowUpDown className={`h-4 w-4 ${sortConfig.key === 'lesson_day' ? 'opacity-100' : 'opacity-40'}`} />
                            </Button>
                        </TableHead>
                        <TableHead className="font-semibold text-center">
                            <Button variant="ghost" size="sm" className="h-8 gap-1" onClick={() => handleSort('credits')}>
                                Credits
                                <ArrowUpDown className={`h-4 w-4 ${sortConfig.key === 'credits' ? 'opacity-100' : 'opacity-40'}`} />
                            </Button>
                        </TableHead>
                        <TableHead className="font-semibold text-center">Balance Due</TableHead>
                        <TableHead className="font-semibold">Status</TableHead>
                        <TableHead className="font-semibold text-right">Actions</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {students.length === 0 ? (
                        <TableRow>
                            <TableCell colSpan={8} className="text-center text-muted-foreground py-8">
                                No students found
                            </TableCell>
                        </TableRow>
                    ) : (
                        students.map((student) => (
                            <TableRow key={student.id} className={Number(student.balance_due) > 0 ? "bg-destructive/5" : ""}>
                                <TableCell>
                                    <EditStudentModal student={student} pricingPlans={pricingPlans} />
                                </TableCell>
                                <TableCell className="font-medium">
                                    <button
                                        className="hover:underline hover:text-blue-600 transition-colors text-left cursor-pointer"
                                        onClick={() => setProfileStudent(student)}
                                    >
                                        {student.name || 'Unknown'}
                                    </button>
                                </TableCell>
                                <TableCell>
                                    <div className="text-sm">
                                        <div>{student.email}</div>
                                        <div className="text-muted-foreground">{student.phone}</div>
                                    </div>
                                </TableCell>
                                <TableCell>
                                    {student.lesson_day ? (
                                        <Badge variant="outline">{student.lesson_day}</Badge>
                                    ) : (
                                        <span className="text-muted-foreground text-sm">-</span>
                                    )}
                                </TableCell>
                                <TableCell className="text-center">
                                    <Badge variant={student.credits <= 1 ? "destructive" : "secondary"}>
                                        {student.credits}
                                    </Badge>
                                </TableCell>
                                <TableCell className="text-center">
                                    {Number(student.balance_due) > 0 ? (
                                        <div className="flex items-center justify-center gap-1">
                                            <AlertCircle className="h-4 w-4 text-destructive" />
                                            <span className="font-semibold text-destructive">
                                                ${Number(student.balance_due).toFixed(2)}
                                            </span>
                                        </div>
                                    ) : (
                                        <span className="text-muted-foreground">$0.00</span>
                                    )}
                                </TableCell>
                                <TableCell>
                                    {student.credits === 0 ? (
                                        <Badge variant="outline" className="bg-warning/10 text-warning-foreground border-warning">
                                            Needs Renewal
                                        </Badge>
                                    ) : (
                                        <Badge variant="default">Active</Badge>
                                    )}
                                </TableCell>

                                <TableCell className="text-right">
                                    <div className="flex items-center justify-end gap-1">

                                        {/* --- NEW AUTO-SCHEDULE BUTTON --- */}
                                        {/* --- NEW AUTO-SCHEDULE BUTTON --- */}
                                        <AutoScheduleButton student={student} />
                                        {/* -------------------------------- */}
                                        {/* -------------------------------- */}

                                        {/* -------------------------------- */}
                                        <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => setChargeStudent(student)}
                                            title="Add Charge"
                                        >
                                            <DollarSign className="h-4 w-4" />
                                        </Button>

                                        {/* --- NEW BUTTON: JOIN CLASSROOM --- */}
                                        <Button
                                            size="sm"
                                            // We use 'secondary' or a distinct color like 'indigo' 
                                            className="bg-indigo-600 hover:bg-indigo-700 text-white border-0"
                                            onClick={() => window.open(getClassroomLink(student), '_blank')}
                                            title="Open Teacher Interface"
                                        >
                                            <MonitorPlay className="h-4 w-4 mr-1" />
                                            Room
                                        </Button>

                                        <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => onMessage(student.id)}
                                        >
                                            <MessageCircle className="h-4 w-4 mr-1" />
                                            Msg
                                        </Button>
                                        <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => onLog(student)}
                                        >
                                            <Upload className="h-4 w-4 mr-1" />
                                            Log
                                        </Button>
                                        <Button
                                            size="sm"
                                            variant="default"
                                            onClick={() => onSchedule(student)}
                                        >
                                            <Plus className="h-4 w-4 mr-1" />
                                            Schedule
                                        </Button>
                                        <Button
                                            size="sm"
                                            variant="destructive"
                                            className="px-2"
                                            onClick={() => onDelete(student)}
                                        >
                                            <Trash2 className="h-4 w-4" />
                                        </Button>
                                    </div>
                                </TableCell>
                            </TableRow>
                        ))
                    )}
                </TableBody>
            </Table>
            {chargeStudent && (
                <ChargeStudentModal
                    open={!!chargeStudent}
                    onOpenChange={(open) => !open && setChargeStudent(null)}
                    studentId={chargeStudent.id}
                    studentName={chargeStudent.name || 'Student'}
                />
            )
            }

            <StudentProfileSheet
                student={profileStudent}
                open={!!profileStudent}
                onOpenChange={(open) => !open && setProfileStudent(null)}
            />
        </>
    )
}
</file>

</files>
